
ALTER PROCEDURE [dbo].[Kra_Export_Fetch]
@fromdate varchar(20),
@todate varchar(20),
@ids varchar(max),
@mode varchar(10),
@authorizefor varchar(5),
@Userid varchar(10),
@Company varchar(500),
@Clienttype VarChar(10),
@Exporttype varchar(10),
@Exportmode varchar(10),
@IMType varchar(5),
@BatchNumber varchar(10)

---------Execution for Export Individual for NDML format
--exec [Kra_Export_Fetch] '2013-01-01','2013-10-10','64,66','NDML','U','457','''COR0000002''','I','NDML','Export','180','00000007'
---------Execution for Export NON-Individual for NDML format
--exec [Kra_Export_Fetch] '2013-01-01','2013-10-10','70,71,69','NDML','U','457','''COR0000002''','N','NDML','Export','180','00000001'
---------Execution for Export NON-Individual for DOTEX format
--exec [Kra_Export_Fetch] '2013-01-01','2013-10-17','70,71,79','DOTEX','NA','379','''COR0000002''','N','DOTEX','Export','188','00000006'

 

AS
BEGIN
Create Table #MainExport(FinalField varchar(max))
Declare @sql varchar(max),@authorizeValue int,@Staticloopcounter bigint,@Maxloopcounter bigint,@UpdatelinenumberCounter bigint,@Staticdotexloopcounter bigint,@Maxloopdotexcounter bigint,@MainId bigint,@KycRAID int
select @KycRAID=KycRA_ID from Master_KycRA where KycRA_ShortName=@Exporttype
select @authorizeValue = max(GlobalSettings_Value) from Config_GlobalSettings 
where GlobalSettings_Name='GS_KYCAUTH' and GlobalSettings_SegmentID=998
If(@Exportmode='Screen')
	Begin
		If (@mode<>'childgrid')
			Begin-----------Details main record to show in main grid
					Select @sql='
					Select  kycmain_id, ltrim(rtrim(isnull(KYCMain_FirstName,'' '')))+'' ''+
					ltrim(rtrim(isnull(KYCMain_MiddleName,'' '')))+'' ''+
					ltrim(rtrim(isnull(KYCMain_LastName,'' ''))) as Clientname,
					KYCMain_DocNo,KYCMain_ApplicationNumber,
					case when isnull(KYCMain_ClientType,''I'')=''I'' then ''Individual'' 
					else ''Non-Individual'' end as clienttype, 
					case when isnull(KYCMain_Gender,''M'')=''M'' then ''Male'' 
					else ''Female'' end as Gender,isnull(KYCMain_FatherSpouseName,'''') as fathername,
					isnull(Convert(varchar(11),KYCMain_ApplicationDate,106),'''') as Appdate,
					isnull(Convert(varchar(11),KYCMain_DateOfBirth,106),'''') as Dob,
					isnull(Convert(varchar(11),KYCMain_ExportDateTime,106),'''') as exportdate,
					isnull(KYCMain_BatchNumber,'''') as batchnumber,
					(select ltrim(rtrim(isnull(USER_name,'' '')))+'' [ ''+
					ltrim(rtrim(isnull(user_loginid,'' '')))+'' ] '' from tbl_master_user
					where user_id=KYCMain_exportUser) as username,
					case when isnull((select count(KYCDetail_MainID) from master_kycdetail
					where KYCMain_ID=KYCDetail_MainID),0)>0 then ''Yes'' else ''No'' end as partner
					 from Master_KYCMain
					where KYCMain_CreateUser in (select USER_ID from tbl_master_user where user_EntryProfile in (''C'',''P'',''F''))
					and  DATEADD(dd, 0, DATEDIFF(dd, 0, kycmain_applicationDate)) between '''+@fromdate+''' AND '''+@todate+'''
					and KYCMain_Companyid in ('+@Company+')
					and KYCMain_VerifiedUser is not null and KYCMain_VerifiedDateTime is not null 
					and KYCMain_ClientType='''+@Clienttype+'''
					
					'
					If (@authorizefor='A')
						Begin
							Set @sql=@sql+' and KYCMain_Exportdatetime is not null 
											and KYCMain_ExportUser is not null
											and KYCMain_BatchNumber is not null
											and KYCMain_KRAID= '''+cast(@KycRAID as varchar(max))+'''
											'
										   
						End
					If (@authorizefor='U')
						Begin
							Set @sql=@sql+' and KYCMain_Exportdatetime is  null 
											and KYCMain_ExportUser is  null
											and KYCMain_BatchNumber is  null'
										   
						End
					If (@authorizeValue=1)
						Begin
							Set @sql=@sql+'	and KYCMain_AuthUser1 is not null 
											and KYCMain_AuthDateTime1 is not null '
											
						End
					If (@authorizeValue=2)
						Begin
							Set @sql=@sql+'	and KYCMain_AuthUser1 is not null 
											and KYCMain_AuthDateTime1 is not null
											and KYCMain_AuthUser2 is not null 
											and KYCMain_AuthDateTime2 is not null 
											'
											
						End
					If (@authorizeValue=3)
						Begin
							Set @sql=@sql+'	and KYCMain_AuthUser1 is not null 
											and KYCMain_AuthDateTime1 is not null 
											and KYCMain_AuthUser2 is not null 
											and KYCMain_AuthDateTime2 is not null
											and KYCMain_AuthUser3 is not null 
											and KYCMain_AuthDateTime3 is not null'
											
						End
	--select '123'
						Exec (@sql)
						
					If(@authorizefor='A')
					  Begin
						   set @sql=''
						   select @sql='select distinct ISNULL(KYCMain_BatchNumber,'' '') as batchnumber,COUNT(KYCMain_BatchNumber) as Counting,
									   ''Cancel Batch'' as Cancelbatch from Master_KYCMain where KYCMain_CreateUser in (select USER_ID from tbl_master_user where user_EntryProfile in (''C'',''P'',''F''))
							and DATEADD(dd, 0, DATEDIFF(dd, 0, kycmain_applicationDate)) between '''+@fromdate+''' AND '''+@todate+'''
							and KYCMain_Companyid in ('+@Company+')
							and KYCMain_VerifiedUser is not null and KYCMain_BatchNumber is not null 
							and KYCMain_VerifiedDateTime is not null
							and KYCMain_ClientType='''+@Clienttype+''' 
							and KYCMain_KRAID= '''+cast(@KycRAID as varchar(max))+''''
							
							If (@authorizeValue=1)
								Begin
									Set @sql=@sql+'	and KYCMain_AuthUser1 is not null 
													and KYCMain_AuthDateTime1 is not null '
													
								End
							If (@authorizeValue=2)
								Begin
									Set @sql=@sql+'	and KYCMain_AuthUser1 is not null 
													and KYCMain_AuthDateTime1 is not null
													and KYCMain_AuthUser2 is not null 
													and KYCMain_AuthDateTime2 is not null 
													'
													
								End
							If (@authorizeValue=3)
								Begin
									Set @sql=@sql+'	and KYCMain_AuthUser1 is not null 
													and KYCMain_AuthDateTime1 is not null 
													and KYCMain_AuthUser2 is not null 
													and KYCMain_AuthDateTime2 is not null
													and KYCMain_AuthUser3 is not null 
													and KYCMain_AuthDateTime3 is not null'
													
								End
							Set @sql=@sql+' group by KYCMain_BatchNumber '
							Exec (@sql)	  	
								   	
				   
						END				
				End
		Else
			Begin----------Bind partner details for popup grid
					select kycdetail_id,isnull(KYCDetail_Name,'') as name,ISNULL(kycdetail_dinuid,'') as uidno,
					isnull(KYCDetail_PAN,'') as pan,
					(select pro_professionName from tbl_master_profession where KYCDetail_Relationship=pro_id)
					as relation 
					from Master_KYCDetail
					where KYCDetail_MainID in (select col from dbo.fnSplitReturnTable(@ids,','))
			End	
			--select Right(REPLICATE('0',8)+cast(isnull(max(ExportFiles_BatchNumber),0)+1 as varchar(8)),8) as batchnumber 
			--from Trans_ExportFiles where ExportFiles_Name like @Clienttype+'_Kra_'+@Exporttype+'%'
			
			--select Right(REPLICATE('0',8)+cast(Isnull(max(ExportFiles_BatchNumber),0)+1 as varchar(8)),8) as batchnumber 
			--from Trans_ExportFiles where ExportFiles_Name like @Clienttype+'_Kra_'+@Exporttype+'%' 
			--group by ExportFiles_ID
			
			
			select Right(REPLICATE('0',8)+cast(isnull(max(ExportFiles_BatchNumber),0)+1 as varchar(8)),8) as batchnumber 
			from Trans_ExportFiles where ExportFiles_Segment='1' and ExportFiles_Type='KRA_'+@Exporttype--@mode
		End
	Else-------------Export data Start from here
		Begin
				
			If(@mode='NDML')
				begin
				If(@Clienttype='I')
					
						Begin--------------Export Data for NDML (Client Type Individual)
							Create Table #TempNDMLExportdetailtable
							(Srlno int Identity,RecordType varchar(2),LineNumber char(7),TranStatus char(1),ApplicantName varchar(45),Filler1 varchar(205),
							FatherHusbandName varchar(45),Gender char(1),MaritalStatus char(1),DateofBirth varchar(8),Filler2 varchar(83),Pan varchar(10),
							PanexemptDoc varchar(75),UID varchar(16),IndividualStatus varchar(40),Filler3 varchar(75),Natioanality char(25),NationalityForOther varchar(50),
							IdentityProof char(30),IdentityProofOther varchar(75),CorAddress1 varchar(36),CorAddress2 varchar(36),CorAddress3 varchar(36),CorCityTownVillage varchar(36),
							CorPinCode varchar(10),CorState char(25),CorStateOther varchar(75),CorCountry char(30),CorAddressProof char(35),CorAddressProofOther varchar(75),OffPhone varchar(24),ResPhone varchar(24),
							Mobile varchar(15),Fax varchar(24),EmailID varchar(50),Filler4 varchar(50),CorsPermAddressFlag char(1),PerAddress1 varchar(36),PerAddress2 varchar(36),PerAddress3 varchar(36),PerCityTownVillage varchar(36),
							PerPinCode varchar(10),PerState char(35),PerStateOther varchar(75),PerCountry char(35),PerAddressProof char(35),PerAddressProofOther varchar(75),AnnualIncomeRange char(50),Networth varchar(50),NetWorthDate varchar(8),
							Filler5 varchar(3),PEP char(29),Occupation char(35),OccupationDetails varchar(75),AnyOtherInfo varchar(100),DeclaretionDate varchar(8),TrueDocCopies char(1),SelfCertifiedDoc char(1),DocRcvDate varchar(8),NoOfDoc char(2),SenderrefNo varchar(35),
							SenderrefNo2 varchar(35),Filler6 varchar(35),panexemptproof char(1),ValidationFlag varchar(50),kycmainid int)
							print '1'
							Insert Into #TempNDMLExportdetailtable
							Select '02',--1
							0,--2
							'A',--3
							Left(ISNULL(KYCMain_FirstName,'')+' '+ISNULL(KYCMain_MiddleName,'')+' '+ISNULL(KYCMain_LastName,'')+REPLICATE(' ',45),45),--4
							REPLICATE(' ',205),--5
							Left(ISNULL(KYCMain_FatherSpouseName,'')+REPLICATE(' ',45),45),--6
							isnull(KYCMain_Gender,'E'),--7
							isnull(KYCMain_MaritalStatus,'E'),--8
							isnull(CONVERT(VARCHAR(8), KYCMain_DateOfBirth, 112),'EEEEEEEE'),--9
							REPLICATE(' ',83),--10
							case when KYCMain_PANExempt='N' then KYCMain_PAN else REPLICATE(' ',10) end,--11
							case when KYCMain_PANExempt='N' then REPLICATE(' ',75) else
							(select top 1 left(isnull(KRAStaticData_Value,' ')+REPLICATE(' ',75),75) from Master_PANExemptCategory,Config_KRAStaticData
							where KRAStaticData_ID=PanExemptCategory_NDMLId and KRAStaticData_Type='PanExemptCategory'
							and KYCMain_PanExemptProof=PanExemptCategory_ID) end,--12
							left(isnull(KYCMain_UID,' ')+REPLICATE(' ',16),16),--13
							
							(select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from tbl_master_legalStatus,Config_KRAStaticData
							where KRAStaticData_ID=lgl_NDMLId and KRAStaticData_Type='IndividualStatus' 
							and KYCMain_TaxStatus=lgl_id),--14
							
							REPLICATE(' ',75),--15
							Case when KYCMain_Nationality<>'99' then
							(Select 
							(Select distinct top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) Code  
							from Config_KraStaticData Where KraStaticData_ID=Nationality_NDMLid)
							from tbl_master_Country,Master_Nationality Where
							Nationality_countryID=cou_id and cou_id=Nationality_CountryID) else '99' end,--16		
							 
							left(ISNULL(KYCMain_NationalityOther,'')+REPLICATE(' ',50),50),--17
							
							Case when KYCMain_IdentityProof<>'99' Then
							(select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from Master_IdentityProof,Config_KRAStaticData
							 where KRAStaticData_ID=IdentityProof_NDMLId and KRAStaticData_Type='IdentityProof' 
							 and KYCMain_IdentityProof=IdentityProof_ID) else '99' end,--18
							 
							 left(ISNULL(KYCMain_IdentityProofOther,'')+REPLICATE(' ',75),75),--19
							 left(ISNULL(KYCMain_CAddress1,'')+REPLICATE(' ',36),36),--20
							 
							 left(isnull(KYCMain_CAddress2,' ')+REPLICATE(' ',36),36),--21
							 left(isnull(KYCMain_CAddress3,' ')+REPLICATE(' ',36),36),--22
							 (Select left(ISNULL(city_name,' ')+REPLICATE(' ',36),36) from tbl_master_city where city_id=KYCMain_CCity),--23
							 left(KYCMain_CPin+REPLICATE(' ',10),10),--24
							 Case when KYCMain_CState<>'99' Then
							 (select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from tbl_master_state,Config_KRAStaticData
							  where KRAStaticData_ID=State_NDMLId and KRAStaticData_Type='State' 
							  and  KYCMain_CState=id) else '99'end,--25
							  
							  left(ISNULL(KYCMain_CStateOther,'')+REPLICATE(' ',75),75),--26
							  
							  Case when KYCMain_CCountry<>'99' Then
							 (select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',3),3) from tbl_master_country,Config_KRAStaticData
							 where KRAStaticData_ID=Country_NdmlID and KRAStaticData_Type='Country' 
							 and  KYCMain_CCountry=cou_id) else '99'end,--27
						     
							 Case when KYCMain_CAddressProof<>'99' Then
							(select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from Master_AddressProof,Config_KRAStaticData
						   where KRAStaticData_ID=AddressProof_NDMLId and KRAStaticData_Type='AddressProof' 
						   and  KYCMain_CAddressProof=AddressProof_ID)else '99' end,--28
						   left(ISNULL(KYCMain_CAddressProofOther,'')+REPLICATE(' ',75),75) ,--29
						   Case when KYCMain_OPhone='0' then
							left(REPLACE(KYCMain_OPhone,'0','')+REPLICATE(' ',24),24) 
							else left(KYCMain_OPhone+REPLICATE(' ',24),24) end,--30 left(isnull(KYCMain_OPhone,'')+REPLICATE(' ',24),24)
							
							Case when KYCMain_RPhone='0' then
						   left(REPLACE(KYCMain_RPhone,'0','')+REPLICATE(' ',24),24)
						   else left(KYCMain_RPhone+REPLICATE(' ',24),24) end,--31
						   
						   Case when KYCMain_Mobile='0' then
						   left(REPLACE(KYCMain_Mobile,'0','')+REPLICATE(' ',15),15)
						   else left(KYCMain_Mobile+REPLICATE(' ',15),15) end,--32
						   
						   Case when KYCMain_Fax='0' then
						   left(REPLACE(KYCMain_Fax,'0','')+REPLICATE(' ',24),24)
						   else left(KYCMain_Fax+REPLICATE(' ',24),24) end,--33
						   
						   left(KYCMain_EmailID+REPLICATE(' ',50),50),--34
						   REPLICATE(' ',50),--35
						   KYCMain_CPSame,--36
						   left(KYCMain_PAddress1+REPLICATE(' ',36),36),--37
						   left(KYCMain_PAddress2+REPLICATE(' ',36),36),--38
						   left(KYCMain_PAddress3+REPLICATE(' ',36),36),--39
						  (Select left(ISNULL(city_name,' ')+REPLICATE(' ',36),36) from tbl_master_city where city_id=KYCMain_PCity),--40
						  left(KYCMain_CPin+REPLICATE(' ',10),10),--41
						  (select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from tbl_master_state,Config_KRAStaticData
						   where KRAStaticData_ID=State_NDMLId and KRAStaticData_Type='State' 
						   and  KYCMain_PState=id),--42
						   left(KYCMain_PStateOther+REPLICATE(' ',75),75),--43
						  
						  case when KYCMain_PCountry<>'99' then
						  (select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',3),3) from tbl_master_country,Config_KRAStaticData
						  where KRAStaticData_ID=Country_NdmlID and KRAStaticData_Type='Country' 
						  and  KYCMain_PCountry=cou_id) else '99'
						  end,--44
						  
						  (select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from Master_AddressProof,Config_KRAStaticData
							where KRAStaticData_ID=AddressProof_NDMLId and KRAStaticData_Type='AddressProof' 
							and  KYCMain_PAddressProof=AddressProof_ID),--45
							left(KYCMain_PAddressProofOther+REPLICATE(' ',75),75),--46
							(select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from Master_AnnualIncome,Config_KRAStaticData
							 where KRAStaticData_ID=AnnualIncome_NDMLId and KRAStaticData_Type='Annual Income Code' 
							 and KYCMain_GAIncome=AnnualIncome_ID),--47
							 isnull(KYCMain_NetWorth,'0'),--48
							 CONVERT(VARCHAR(8), KYCMain_NetWorthDate, 112),--49
							 REPLICATE(' ',3),--50
							 (select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from Master_PoliticalConnection,Config_KRAStaticData
							where KRAStaticData_ID=PoliticalConnection_NDMLId and KRAStaticData_Type='PoliticalConnection' 
							and KYCMain_PeP=PoliticalConnection_ID),--51
							
							Case when KYCMain_Occupation<>'99' then
							(select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from tbl_master_profession,Config_KRAStaticData
							where KRAStaticData_ID=PRO_NDMLId and KRAStaticData_Type='Occupation' and KYCMain_Occupation=pro_id)
							else '99' end,--52
							left(KYCMain_OccupationOther+REPLICATE(' ',75),75),--53
							
							left(substring(ISNULL(KYCMain_OtherInfo,''),1,99)+REPLICATE(' ',100),100),--54
							CONVERT(VARCHAR(8), GETDATE(), 112),--55
							'Y',--56
							'Y',--57
							isnull(CONVERT(VARCHAR(8), KYCMain_ApplicationDate, 112),'EEEEEEEE'),--58
							
							(select left(cast(COUNT(doc_contactId) as varchar(10))+REPLICATE(' ',2),2) 
							from tbl_master_document where doc_contactId=KYCMain_ApplicationNumber),--59
							
							REPLICATE(' ',35),--60
							REPLICATE(' ',35),--61
							REPLICATE(' ',65),--62
							KYCMain_PANExempt,--63 for panexempt proof
							'',--64 validationflag
							KYCMain_ID--65 kycmainid not require for export//used for internal.
							from Master_KYCMain where KYCMain_ID in (select col from dbo.fnSplitReturnTable(@ids,','))
							-----------Validation Start
							print '2'
							Select @Maxloopcounter=MAX(Srlno) from #TempNDMLExportdetailtable
							
							
							Set @Staticloopcounter=1
							Set @UpdatelinenumberCounter=1
							While(@Staticloopcounter<=@Maxloopcounter)
								Begin
									If Exists(Select * from #TempNDMLExportdetailtable where (len(isnull(ApplicantName,''))>36 or len(isnull(ApplicantName,''))=0) and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set ApplicantName='Length must Be 1-36',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									Else
										Begin
											update #TempNDMLExportdetailtable set ApplicantName=left(ApplicantName+REPLICATE(' ',36),36)--Right(REPLICATE(' ',36)+ApplicantName,36)
											where Srlno=@Staticloopcounter
										End
									If Exists(Select * from #TempNDMLExportdetailtable where (len(isnull(FatherHusbandName,''))>45 or len(isnull(FatherHusbandName,''))=0) and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set FatherHusbandName='Length must Be 1-45',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									Else
										Begin
												update #TempNDMLExportdetailtable set FatherHusbandName=left(FatherHusbandName+REPLICATE(' ',45),45)
												where Srlno=@Staticloopcounter
										End
									If Exists(Select * from #TempNDMLExportdetailtable where (len(isnull(PanexemptDoc,''))>75 or len(isnull(PanexemptDoc,''))=0) and Srlno=@Staticloopcounter and panexemptproof='Y')
										Begin
											update #TempNDMLExportdetailtable set PanexemptDoc='Length must Be 1-75',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									Else
										Begin
												update #TempNDMLExportdetailtable set PanexemptDoc=left(PanexemptDoc+REPLICATE(' ',75),75)
												where Srlno=@Staticloopcounter
										End
									If Exists(Select * from #TempNDMLExportdetailtable where (len(isnull(NationalityForOther,''))>50 or len(isnull(NationalityForOther,''))=0) and Srlno=@Staticloopcounter and Natioanality='99')
										Begin
											update #TempNDMLExportdetailtable set NationalityForOther='Length must Be 1-50',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									Else
										Begin
												update #TempNDMLExportdetailtable set NationalityForOther=left(NationalityForOther+REPLICATE(' ',50),50)
												where Srlno=@Staticloopcounter
										End
										
									
										
									If Exists(Select * from #TempNDMLExportdetailtable where (len(isnull(IdentityProofOther,''))>75 or len(isnull(IdentityProofOther,''))=0) and Srlno=@Staticloopcounter and isnull(IdentityProof,'')='99')
										Begin
											update #TempNDMLExportdetailtable set IdentityProofOther='Length must Be 1-75',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									Else
										Begin
												update #TempNDMLExportdetailtable set IdentityProofOther=left(IdentityProofOther+REPLICATE(' ',75),75)
												where Srlno=@Staticloopcounter
										End
										
									If Exists(Select * from #TempNDMLExportdetailtable where (len(isnull(CorAddress1,''))>36 or len(isnull(CorAddress1,''))=0) and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set CorAddress1='Length must Be 1-36',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									Else
										Begin
												update #TempNDMLExportdetailtable set CorAddress1=left(CorAddress1+REPLICATE(' ',36),36)
												where Srlno=@Staticloopcounter
										End
										
									If Exists(Select * from #TempNDMLExportdetailtable where (len(isnull(CorStateOther,''))>75 or len(isnull(CorStateOther,''))=0) and Srlno=@Staticloopcounter and CorState='99')
										Begin
											update #TempNDMLExportdetailtable set CorStateOther='Length must Be 1-75',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									Else
										Begin
												update #TempNDMLExportdetailtable set CorStateOther=left(CorStateOther+REPLICATE(' ',75),75)
												where Srlno=@Staticloopcounter
										End
										
									If Exists(Select * from #TempNDMLExportdetailtable where (len(isnull(CorAddressProofOther,''))>75 or len(isnull(CorAddressProofOther,''))=0) and Srlno=@Staticloopcounter and isnull(CorAddressProof,'')='99')
										Begin
											update #TempNDMLExportdetailtable set CorAddressProofOther='Length must Be 1-75',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									Else
										Begin
												update #TempNDMLExportdetailtable set CorAddressProofOther=left(CorAddressProofOther+REPLICATE(' ',75),75)
												where Srlno=@Staticloopcounter
										End
										
										
										
										
									If Exists(Select * from #TempNDMLExportdetailtable where (len(isnull(PerStateOther,''))>75 or len(isnull(PerStateOther,''))=0) and Srlno=@Staticloopcounter and PerState='99')
										Begin
											update #TempNDMLExportdetailtable set PerStateOther='Length must Be 1-75',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									Else
										Begin
												update #TempNDMLExportdetailtable set PerStateOther=left(PerStateOther+REPLICATE(' ',75),75)
												where Srlno=@Staticloopcounter
										End
										
									If Exists(Select * from #TempNDMLExportdetailtable where (len(isnull(PerAddressProofOther,''))>75 or len(isnull(PerAddressProofOther,''))=0) and Srlno=@Staticloopcounter and LEN(isnull(PerAddressProof,''))=0)
										Begin
											update #TempNDMLExportdetailtable set PerAddressProofOther='Length must Be 1-75',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									Else
										Begin
												update #TempNDMLExportdetailtable set PerAddressProofOther=left(PerAddressProofOther+REPLICATE(' ',75),75)
												where Srlno=@Staticloopcounter
										End
										
									If Exists(Select * from #TempNDMLExportdetailtable where  Srlno=@Staticloopcounter and Networth<>'0')
										Begin
											update #TempNDMLExportdetailtable set Networth=(Select Right(Replicate('0',15)+SUBSTRING(Cast(Networth as Varchar),0,CHARINDEX('.',Cast(Networth as Varchar))),15)
											+Left(SUBSTRING(Cast(Networth as Varchar),CHARINDEX('.',Cast(Networth as Varchar))+1,Len(Cast(Networth as Varchar)))+REPLICATE('0',3),3))
											where Srlno=@Staticloopcounter
										End
									
										
									If Exists(Select * from #TempNDMLExportdetailtable where  len(isnull(AnnualIncomeRange,''))=0 and Srlno=@Staticloopcounter and Networth='0')
										Begin
											update #TempNDMLExportdetailtable set AnnualIncomeRange='Annual Income or Networth is Mandatory',NetWorthDate=REPLICATE(' ',8),
											ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									Else
										Begin
												update #TempNDMLExportdetailtable set AnnualIncomeRange=AnnualIncomeRange--+REPLICATE(' ',2),2)
												where Srlno=@Staticloopcounter
										End
									If Exists(Select * from #TempNDMLExportdetailtable where  isnull(Occupation,'')='99' and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set OccupationDetails='Occupation Details is Mandatory',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									Else
										Begin
												update #TempNDMLExportdetailtable set OccupationDetails=left(OccupationDetails+REPLICATE(' ',75),75)--+REPLICATE(' ',2),2)
												where Srlno=@Staticloopcounter
										End
										
									If Exists(Select * from #TempNDMLExportdetailtable where  len(isnull(IndividualStatus,''))=0 and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set IndividualStatus='IndividualStatus is Mandatory',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									If Exists(Select * from #TempNDMLExportdetailtable where  len(isnull(Natioanality,''))=0 and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set Natioanality='Natioanality is Mandatory',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									If Exists(Select * from #TempNDMLExportdetailtable where  len(isnull(IdentityProof,''))=0 and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set IdentityProof='IdentityProof is Mandatory',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									If Exists(Select * from #TempNDMLExportdetailtable where  len(isnull(CorState,''))=0 and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set CorState='State is Mandatory',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									If Exists(Select * from #TempNDMLExportdetailtable where  len(isnull(CorCountry,''))=0 and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set CorCountry='Country is Mandatory',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									If Exists(Select * from #TempNDMLExportdetailtable where  len(isnull(CorAddressProof,''))=0 and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set CorAddressProof='CorAddressProof is Mandatory',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									If Exists(Select * from #TempNDMLExportdetailtable where  len(isnull(PerState,''))=0 and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set PerState='PerState is Mandatory',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									If Exists(Select * from #TempNDMLExportdetailtable where  len(isnull(PerCountry,''))=0 and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set PerCountry='PerCountry is Mandatory',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									If Exists(Select * from #TempNDMLExportdetailtable where  len(isnull(PerAddressProof,''))=0 and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set PerAddressProof='PerAddressProof is Mandatory',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									If Exists(Select * from #TempNDMLExportdetailtable where  len(isnull(PEP,''))=0 and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set PEP='pep is Mandatory',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									If Exists(Select * from #TempNDMLExportdetailtable where  len(isnull(Occupation,''))=0 and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set Occupation='Occupation is Mandatory',ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									If Exists(Select * from #TempNDMLExportdetailtable where  Networth='0' and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailtable set Networth=left(Networth+REPLICATE(' ',18),18)--,ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
										--update #TempNDMLExportdetailtable set ValidationFlag='' where Srlno<>2
									If Exists(Select * from #TempNDMLExportdetailtable where Srlno=@Staticloopcounter )
										Begin
											update #TempNDMLExportdetailtable set LineNumber=Right(REPLICATE('0',7)+cast(@UpdatelinenumberCounter as varchar(7)),7)
											where  Srlno=@Staticloopcounter
											set @UpdatelinenumberCounter=@UpdatelinenumberCounter+1
										End
									update Master_KYCMain set KYCMain_ExportDateTime=GETDATE(),KYCMain_ExportUser=@Userid,
									KYCMain_BatchNumber=@BatchNumber,KYCMain_KRAID=@KycRAID from #TempNDMLExportdetailtable
									where 	Srlno=@Staticloopcounter and KYCMain_ID=kycmainid --and ValidationFlag=''
									Select @Staticloopcounter=@Staticloopcounter+1
								End----------While End
								
							exec [Kra_Export_Fetch] @fromdate,@todate,'','','A',@Userid,@Company ,@Clienttype,@Exporttype,'Screen',@IMType,@BatchNumber
							--insert into #MainExport
							--select * from #TempNDMLExportdetailtable
							
							
							
							
							Select cast('01' --as RecordType
							+Right(REPLICATE('0',8)+cast(@BatchNumber as varchar(8)),8) --as BatchNumber
							+'00' --as BranchCode
							+left((select isnull(cmp_KRAIntermediaryID,' ') from tbl_master_company 
							where cmp_internalid=REPLACE(@Company,'''',''))+REPLICATE(' ',5),5) --as IMID
							+Right(REPLICATE('0',2)+(select cast(isnull(KRAStaticData_Code,'') as varchar(2))  from Config_KRAStaticData where KRAStaticData_ID=@IMType),2) --as IMRole
							+(Select Right(REPLICATE('0',7)+cast(COUNT(*) as varchar(7)),7) from #TempNDMLExportdetailtable --where ValidationFlag=''
							) --as TotalRecord
							+CONVERT(VARCHAR(8), GETDATE(), 112) --as SenderDate
							+REPLICATE(' ',8) --as UserID
							+REPLICATE(' ',6) --as FileVersion
							+REPLICATE(' ',28) --as Filler
							as varchar(max))
							union all
							select CAST(cast(RecordType as varchar(2))+LineNumber+TranStatus+ApplicantName+Filler1+FatherHusbandName+
							Gender+MaritalStatus+DateofBirth+Filler2+Pan+PanexemptDoc+UID+IndividualStatus+Filler3+
							Natioanality+NationalityForOther+IdentityProof+IdentityProofOther+CorAddress1+CorAddress2+
							CorAddress3+CorCityTownVillage+CorPinCode+CorState+CorStateOther+CorCountry+CorAddressProof+
							CorAddressProofOther+OffPhone+ResPhone+Mobile+Fax+EmailID+Filler4+CorsPermAddressFlag+PerAddress1+
							PerAddress2+PerAddress3+PerCityTownVillage+PerPinCode+PerState+PerStateOther+PerCountry+PerAddressProof+
							PerAddressProofOther+AnnualIncomeRange+Networth+NetWorthDate+Filler5+PEP+Occupation+OccupationDetails+AnyOtherInfo+
							DeclaretionDate+TrueDocCopies+SelfCertifiedDoc+DocRcvDate+NoOfDoc+SenderrefNo+SenderrefNo2+Filler6  as varchar(max))
							from #TempNDMLExportdetailtable --where ValidationFlag=''
							--select * from #MainExport
							select COUNT(Srlno)  from #TempNDMLExportdetailtable
							--select COUNT(*) as total from #TempNDMLExportdetailtable
							--select COUNT(*) as success from #TempNDMLExportdetailtable where ValidationFlag=''
							--select COUNT(*) as fail from #TempNDMLExportdetailtable where ValidationFlag<>''
							--select Right(REPLICATE('0',8)+cast(@BatchNumber as varchar(8)),8) as batch
							--select * from #TempNDMLExportdetailtable where ValidationFlag<>''
							--Drop Table #TempNDMLExportdetailtable
							
						End
		 
				Else
					Begin
						Create Table #TempNDMLExportdetailnonindividual
							(Srlno int Identity,RecordType int,LineNumber char(7),TranStatus char(1),ApplicantName varchar(250),Filler1 varchar(47),
							Incorporationdate char(8),Incorporationplace char(75),businessdate char(8),Pan varchar(10),PanexemptDoc varchar(75),Regno varchar(16),
							NonIndividualStatus varchar(40),NonIndividualStatusoth varchar(75),Filler2 varchar(129),CorAddress1 varchar(36),CorAddress2 varchar(36),CorAddress3 varchar(36),
							CorCityTownVillage varchar(36),CorPinCode varchar(10),CorState char(25),CorStateOther varchar(75),CorCountry char(30),CorAddressProof char(35),CorAddressProofOther varchar(75),
							OffPhone varchar(24),ResPhone varchar(24),Mobile varchar(15),Fax varchar(24),EmailID varchar(50),Filler3 varchar(50),CorsPermAddressFlag char(1),PerAddress1 varchar(36),PerAddress2 varchar(36),
							PerAddress3 varchar(36),PerCityTownVillage varchar(36),PerPinCode varchar(10),PerState char(35),PerStateOther varchar(75),PerCountry char(35),PerAddressProof char(35),PerAddressProofOther varchar(75),
							AnnualIncomeRange char(50),Networth varchar(50),NetWorthDate varchar(8),ContactpersonCount varchar(40),PEP char(29),Filler4 char(77),AnyOtherInfo varchar(100),DeclaretionDate varchar(8),TrueDocCopies char(1),
							SelfCertifiedDoc char(1),DocRcvDate varchar(8),NoOfDoc char(2),SenderrefNo1 varchar(35),SenderrefNo2 varchar(35),Filler6 varchar(65),ValidationFlag varchar(50),kycmainid int)
							Insert into #TempNDMLExportdetailnonindividual
							Select '04',--1
							0,--2
							'A',--3
							Left(ISNULL(KYCMain_FirstName,'')+' '+ISNULL(KYCMain_MiddleName,'')+' '+ISNULL(KYCMain_LastName,'')+REPLICATE(' ',250),250),--4
							REPLICATE(' ',47),--5
							CONVERT(VARCHAR(8), KYCMain_DateOfInCorp, 112),--6
							(select left(ISNULL(city_name,'')+REPLICATE(' ',75),75)
							from tbl_master_city where city_id=KYCMain_PlaceOfInCorp),--7
							--left(isnull(KYCMain_PlaceOfInCorp,'')+REPLICATE(' ',75),75),
							CONVERT(VARCHAR(8), KYCMain_BusinessComDate, 112),--8
							case when KYCMain_PANExempt='N' then KYCMain_PAN else REPLICATE(' ',10) end,--9
							case when KYCMain_PANExempt='N' then REPLICATE(' ',75) else
							(select top 1 left(isnull(KRAStaticData_Value,'')+REPLICATE(' ',75),75) from Master_PANExemptCategory,Config_KRAStaticData
							where KRAStaticData_ID=PanExemptCategory_NDMLId and KRAStaticData_Type='PanExemptCategory'
							and KYCMain_PanExemptProof=PanExemptCategory_ID) end,--10
							left(isnull(KYCMain_CompRegn,'')+REPLICATE(' ',16),16),--11
							Case when KYCMain_TaxStatus<>'99' then 
							(select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from tbl_master_legalStatus,Config_KRAStaticData
							where KRAStaticData_ID=lgl_NDMLId and KRAStaticData_Type='NonIndividualStatus' 
							and KYCMain_TaxStatus=lgl_id) else '99' end,--12
							
							Case when KYCMain_TaxStatus='99' then 
							left(ISNULL(KYCMain_TaxStatusCompOther,'')+REPLICATE(' ',75),75) 
							else REPLICATE(' ',75) end,--13
							
							REPLICATE(' ',129),--14
							
							left(KYCMain_CAddress1+REPLICATE(' ',36),36),--15
							left(KYCMain_CAddress2+REPLICATE(' ',36),36),--16
							left(KYCMain_CAddress3+REPLICATE(' ',36),36),--17
							 (Select left(city_name+REPLICATE(' ',36),36) from tbl_master_city where city_id=KYCMain_CCity),--18
							 left(isnull(KYCMain_CPin,'')+REPLICATE(' ',10),10),--19
							 Case when KYCMain_CState<>'99' Then
							 (select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from tbl_master_state,Config_KRAStaticData
							  where KRAStaticData_ID=State_NDMLId and KRAStaticData_Type='State' 
							  and  KYCMain_CState=id) else '99'end,--20
							  
							  left(ISNULL(KYCMain_CStateOther,'')+REPLICATE(' ',75),75),--21
							  
							  Case when KYCMain_CCountry<>'99' Then
							 (select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',3),3) from tbl_master_country,Config_KRAStaticData
							 where KRAStaticData_ID=Country_NdmlID and KRAStaticData_Type='Country' 
							 and  KYCMain_CCountry=cou_id) else '99'end,--22
						     
							 Case when KYCMain_CAddressProof<>'99' Then
							(select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from Master_AddressProof,Config_KRAStaticData
						   where KRAStaticData_ID=AddressProof_NDMLId and KRAStaticData_Type='AddressProof' 
						   and  KYCMain_CAddressProof=AddressProof_ID)else '99' end,--23
						   left(ISNULL(KYCMain_CAddressProofOther,'')+REPLICATE(' ',75),75),--24
						   
						   Case when KYCMain_OPhone='0' then
							left(REPLACE(KYCMain_OPhone,'0','')+REPLICATE(' ',24),24) 
							else left(KYCMain_OPhone+REPLICATE(' ',24),24) end,--25 left(isnull(KYCMain_OPhone,'')+REPLICATE(' ',24),24)
							
							Case when KYCMain_RPhone='0' then
						   left(REPLACE(KYCMain_RPhone,'0','')+REPLICATE(' ',24),24)
						   else left(KYCMain_RPhone+REPLICATE(' ',24),24) end,--26
						   
						   Case when KYCMain_Mobile='0' then
						   left(REPLACE(KYCMain_Mobile,'0','')+REPLICATE(' ',15),15)
						   else left(KYCMain_Mobile+REPLICATE(' ',15),15) end,--27
						   
						   Case when KYCMain_Fax='0' then
						   left(REPLACE(KYCMain_Fax,'0','')+REPLICATE(' ',24),24)
						   else left(KYCMain_Fax+REPLICATE(' ',24),24) end,--28
						   
						   left(KYCMain_EmailID+REPLICATE(' ',50),50),--29
						   REPLICATE(' ',50),--30
							 KYCMain_CPSame,--31
							left(KYCMain_PAddress1+REPLICATE(' ',36),36),--32
						    left(KYCMain_PAddress2+REPLICATE(' ',36),36),--33
						    left(KYCMain_PAddress3+REPLICATE(' ',36),36),--34
						    (Select left(city_name+REPLICATE(' ',36),36) from tbl_master_city where city_id=KYCMain_PCity),--35
							ISNULL(KYCMain_CPin,''),--36
							(select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from tbl_master_state,Config_KRAStaticData
						   where KRAStaticData_ID=State_NDMLId and KRAStaticData_Type='State' 
						   and  KYCMain_PState=id),--37
						  left(KYCMain_PStateOther+REPLICATE(' ',36),36),--38
						  case when KYCMain_PCountry<>'99' then
						  (select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',3),3) from tbl_master_country,Config_KRAStaticData
						  where KRAStaticData_ID=Country_NdmlID and KRAStaticData_Type='Country' 
						  and  KYCMain_PCountry=cou_id) else '99'end,--39
						  (select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from Master_AddressProof,Config_KRAStaticData
							where KRAStaticData_ID=AddressProof_NDMLId and KRAStaticData_Type='AddressProof' 
							and  KYCMain_PAddressProof=AddressProof_ID),--40
							ISNULL(KYCMain_PAddressProofOther,'') ,--41
							(select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from Master_AnnualIncome,Config_KRAStaticData
							 where KRAStaticData_ID=AnnualIncome_NDMLId and KRAStaticData_Type='Annual Income Code' 
							 and KYCMain_GAIncome=AnnualIncome_ID),--42
							 isnull(KYCMain_NetWorth,'0'),--43
							 CONVERT(VARCHAR(8), KYCMain_NetWorthDate, 112),--44
							 (select left(cast(COUNT(KYCDetail_ID) as varchar(10))+REPLICATE(' ',3),3) 
							from Master_KYCDetail where KYCDetail_MainID=KYCMain_ID),--45
							(select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from Master_PoliticalConnection,Config_KRAStaticData
							where KRAStaticData_ID=PoliticalConnection_NDMLId and KRAStaticData_Type='PoliticalConnection' 
							and KYCMain_PeP=PoliticalConnection_ID),--46
							 REPLICATE(' ',77),--47
							 left(substring(ISNULL(KYCMain_OtherInfo,''),1,99)+REPLICATE(' ',100),100),--48
							 CONVERT(VARCHAR(8), GETDATE(), 112),--49
							 
							'Y',--50
							'Y',--51
							CONVERT(VARCHAR(8), KYCMain_ApplicationDate, 112),--52
							
							(select left(cast(COUNT(doc_contactId) as varchar(10))+REPLICATE(' ',2),2) 
							from tbl_master_document where doc_contactId=KYCMain_ApplicationNumber),--53
							
							REPLICATE(' ',35),--54
							REPLICATE(' ',35),--55
							REPLICATE(' ',65),--56
							--KYCMain_PANExempt,--63 for panexempt proof
							'',--57 validationflag
							KYCMain_ID--58 kycmainid not require for export//used for internal.
							from Master_KYCMain where KYCMain_ID in (select col from dbo.fnSplitReturnTable(@ids,','))
							
							----------------------------Detail Record Insertion Begin-----------------
							Create Table #NDMLPartnerdetail (Pautoid int identity,Pmainid int,Precordtype char(2),Plineno char(7),Pname char(255),
							Prelationship char(2),Prelationshipoth char(75),Ppan char(10),Ppanexempt char(75),Paddress1 char(36),Paddress2 char(36),
							Paddress3 char(36),Pcity char(36),Ppin char(10),Pstate char(2),Pstateoth char(75),Pcountry char(3),Pdin char(16),Pmasterpan char(10),Pfiller varchar(750))
							insert into #NDMLPartnerdetail
							select KYCDetail_MainID--1
							,'05'--2
							,''--3
							,Left(ISNULL(KYCdetail_Name,'')+REPLICATE(' ',259),259)--4
							,Case when KYCDetail_Relationship<>'99' then 
							(select top 1 isnull(KRAStaticData_Code,'') from tbl_master_profession,Config_KRAStaticData
							where KRAStaticData_ID=PRO_NDMLId and KRAStaticData_Type='NonIndividualStatus' 
							and KYCDetail_Relationship=pro_id) else '99' end--5
							,Case when KYCDetail_Relationship='99' then 
							left(ISNULL(KYCDetail_Relationship,''),75) 
							else '' end--6
							,ISNULL(KYCDetail_PAN,'')-----------7*****Note  Defect for except NDML
							,REPLICATE(' ',75)------------8
							,left(KYCDetail_Address1+REPLICATE(' ',36),36)--9
						    ,left(KYCDetail_Address2+REPLICATE(' ',36),36)--10
						    ,left(KYCDetail_Address3+REPLICATE(' ',36),36)--11
						    ,(Select left(city_name+REPLICATE(' ',36),36) from tbl_master_city where city_id=KYCDetail_City)--12
						    ,ISNULL(KYCDetail_PIN,'')----13
						    ,(select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) from tbl_master_state,Config_KRAStaticData
							where KRAStaticData_ID=State_NDMLId and KRAStaticData_Type='State' 
							and  KYCDetail_State=id)--14
							,left(KYCDetail_State+REPLICATE(' ',36),36)---------15
						   ,(select top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',3),3) from tbl_master_country,Config_KRAStaticData
							where KRAStaticData_ID=Country_NdmlID and KRAStaticData_Type='Country' 
							and  KYCDetail_Country=cou_id)---16,
							,left(KYCDetail_DinUid+REPLICATE(' ',16),16)---------17
							,''--------18
							,REPLICATE(' ',69)--19
							 from Master_KYCDetail where KYCDetail_MainID in (select col from dbo.fnSplitReturnTable(@ids,','))
							 
							 ----------------------------Detail Record Insertion End-----------------
							 insert into #MainExport
							Select cast('03' --as RecordType
							+Right(REPLICATE('0',8)+cast(@BatchNumber as varchar(8)),8) --as BatchNumber
							+'00' --as BranchCode
							+left((select isnull(cmp_KRAIntermediaryID,' ') from tbl_master_company 
							where cmp_internalid=REPLACE(@Company,'''',''))+REPLICATE(' ',5),5) --as IMID
							+Right(REPLICATE('0',2)+(select cast(isnull(KRAStaticData_Code,'') as varchar(2))  from Config_KRAStaticData where KRAStaticData_ID=@IMType),2) --as IMRole
							+(Select Right(REPLICATE('0',7)+cast(COUNT(*) as varchar(7)),7) from #TempNDMLExportdetailnonindividual --where ValidationFlag=''
							) --as TotalRecord
							+CONVERT(VARCHAR(8), GETDATE(), 112) --as SenderDate
							+REPLICATE(' ',8) --as UserID
							+REPLICATE(' ',6) --as FileVersion
							+REPLICATE(' ',28) --as Filler
							as varchar(max))
							--as header
							 Select @Maxloopcounter=MAX(Pautoid) from #NDMLPartnerdetail
							Set @Staticloopcounter=1
							Set @UpdatelinenumberCounter=1
							declare @detailmainid varchar(max)
							While(@Staticloopcounter<=@Maxloopcounter)
								Begin
									Select @detailmainid=kycmainid from #TempNDMLExportdetailnonindividual where Srlno=@Staticloopcounter
									update #NDMLPartnerdetail set Plineno=Right(REPLICATE('0',7)+cast(@UpdatelinenumberCounter as varchar(7)),7)
									where  Pautoid=@Staticloopcounter and Pmainid=@detailmainid
									
									
									
									
									set @UpdatelinenumberCounter=@UpdatelinenumberCounter+1
									Select @Staticloopcounter=@Staticloopcounter+1	
								End
							Select @Maxloopcounter=MAX(Srlno) from #TempNDMLExportdetailnonindividual
							Set @Staticloopcounter=1
							Set @UpdatelinenumberCounter=1
							declare @UpdatelinenumberCounterdetail int set @UpdatelinenumberCounterdetail=1
							While(@Staticloopcounter<=@Maxloopcounter)
								Begin
									Select @detailmainid=kycmainid from #TempNDMLExportdetailnonindividual where Srlno=@Staticloopcounter
									Update #NDMLPartnerdetail set Pmasterpan=Pan from #TempNDMLExportdetailnonindividual
									where kycmainid=Pmainid and Srlno=@Staticloopcounter
									If Exists(Select * from #TempNDMLExportdetailnonindividual,#NDMLPartnerdetail where Srlno=@Staticloopcounter and kycmainid=Pmainid)
										Begin
											
											update #NDMLPartnerdetail set Plineno=Right(REPLICATE('0',7)+cast(@UpdatelinenumberCounterdetail as varchar(7)),7)
											from #TempNDMLExportdetailnonindividual where kycmainid=Pmainid and Srlno=@Staticloopcounter
											
											--select Right(REPLICATE('0',7)+cast(@UpdatelinenumberCounterdetail as varchar(7)),7) from #NDMLPartnerdetail,#TempNDMLExportdetailnonindividual
											--where kycmainid=Pmainid and Srlno=@Staticloopcounter
											set @UpdatelinenumberCounterdetail=@UpdatelinenumberCounterdetail+1
										End
									
									If Exists(Select * from #TempNDMLExportdetailnonindividual where Srlno=@Staticloopcounter and ValidationFlag='')
										Begin
											update #TempNDMLExportdetailnonindividual set LineNumber=Right(REPLICATE('0',7)+cast(@UpdatelinenumberCounter as varchar(7)),7)
											where  Srlno=@Staticloopcounter
											set @UpdatelinenumberCounter=@UpdatelinenumberCounter+1
										End
										If Exists(Select * from #TempNDMLExportdetailnonindividual where  Networth='0' and Srlno=@Staticloopcounter)
										Begin
											update #TempNDMLExportdetailnonindividual set Networth=left(Networth+REPLICATE(' ',18),18)--,ValidationFlag='Error' 
											where Srlno=@Staticloopcounter
										End
									update Master_KYCMain set KYCMain_ExportDateTime=GETDATE(),KYCMain_ExportUser=@Userid,
									KYCMain_BatchNumber=@BatchNumber,KYCMain_KRAID=@KycRAID from #TempNDMLExportdetailnonindividual
									where 	Srlno=@Staticloopcounter and KYCMain_ID=kycmainid and ValidationFlag=''
									
									insert into #MainExport
									select cast('04'+isnull(LineNumber,'')+TranStatus+ApplicantName+Filler1+
									Incorporationdate+Incorporationplace+businessdate+Pan+PanexemptDoc+Regno+
									isnull(NonIndividualStatus,'')+NonIndividualStatusoth+Filler2+CorAddress1+CorAddress2+CorAddress3+
									CorCityTownVillage+CorPinCode+isnull(CorState,'')+CorStateOther+isnull(CorCountry,'')+isnull(CorAddressProof,'')+CorAddressProofOther+
									OffPhone+ResPhone+Mobile+Fax+EmailID+Filler3+CorsPermAddressFlag+PerAddress1+PerAddress2+
									PerAddress3+PerCityTownVillage+PerPinCode+isnull(PerState,'')+PerStateOther+isnull(PerCountry,'')+isnull(PerAddressProof,'')+PerAddressProofOther+
									isnull(AnnualIncomeRange,'')+Networth+NetWorthDate+ContactpersonCount+isnull(PEP,'')+Filler4+AnyOtherInfo+DeclaretionDate+TrueDocCopies+
									SelfCertifiedDoc+DocRcvDate+NoOfDoc+SenderrefNo1+SenderrefNo2+Filler6  as varchar(max))
									from #TempNDMLExportdetailnonindividual where kycmainid=@detailmainid
									union all
									select cast(Precordtype as varchar(2))+Plineno+Pname+
										isnull(Prelationship,'')+Prelationshipoth+Ppan+Ppanexempt+Paddress1+Paddress2+
										Paddress3+Pcity+Ppin+isnull(Pstate,'')+Pstateoth+isnull(Pcountry,'')+Pdin+Pmasterpan+Pfiller 
										 from #NDMLPartnerdetail where Pmainid=@detailmainid
									Select @Staticloopcounter=@Staticloopcounter+1
								End
								exec [Kra_Export_Fetch] @fromdate,@todate,'','','A',@Userid,@Company ,@Clienttype,@Exporttype,'Screen',@IMType,@BatchNumber
							
								select * from #MainExport
								select COUNT(Srlno)  from #TempNDMLExportdetailnonindividual
								drop table #NDMLPartnerdetail
					End
			End
			
			
			-------------DotEx Begin and NDML END-------------
			If(@mode='DOTEX')
				begin
				If(@Clienttype='I')
					Begin
						create table #DotEx_KYC_Individual
						(Srlno int identity,
						RecordType int,--1
						LineNumber varchar(7),--2
						Updateflag varchar(2),--3
						ApplicantName varchar(150),--4
						FatherHusbandName varchar(150),--5
						Gender char(1),--6
						MaritalStatus char(1),--7
						DOB varchar(11),--8
						PanExempt char(1),--9
						PAN char(10),--10
						PanExemptionProof char(2),--11
						[UID] varchar(12),--12
						StatusIndividual varchar(2),--13
						Nationality varchar(2),--14
						NationalityOther varchar(50),--15
						IdentityProof varchar(2),--16
						IdentityProofOther varchar(75),--17
						CAddress1 varchar(255),--18
						CAddress2 varchar(255),--19
						CAddress3 varchar(255),--20
						CityTownVillage varchar(50),--21-
						CPin varchar(10),--22
						CState varchar(2),--23
						CStateOther varchar(75),--24
						CCountry varchar(3),--25
						CAddressProof varchar(2),--26
						CAddressProofOther varchar(75),--27
						OffTelISD varchar(14),--28
						OffTelSTD varchar(10),--29
						OffTel varchar(24),--30
						ResTelISD varchar(14),--31
						ResTelSTD varchar(10),--32
						ResTel varchar(24),--33
						MobileISD varchar(14),--34
						MobileNo varchar(15),--35
						FaxTelISD varchar(14),--36
						FaxTelSTD varchar(10),--37
						FaxNo varchar(24),--38
						Email varchar(60),--39
						FlagForSameaddress char(1),--40
						PAddress1 varchar(255),--41
						PAddess2 varchar(255),--42
						PAddress3 varchar(255),--43
						PcitytownVillage varchar(50),--44
						PPinCode Varchar(10),--45
						PState varchar(2),--46
						Pstateother varchar(75),--47
						PCountry varchar(3),--48
						AddressProofPAddress char(2),--49
						AddressProofPAddressOther varchar(75),--50
						GrossIncome varchar(2),--51
						Networth varchar(18),--52
						NetWorthDate varchar(11),--53
						PEP varchar(2),--54
						Occupation varchar(2),--55
						OccupationDetails varchar(75),--56
						AnyOtherInfo varchar(100),---57
						DeclarationDate varchar(11),--58
						TrueDocCopies varchar(1),--59
						SelfCertifiedDoc char(1),--60
						DocRcvDate varchar(11),--61
						NoOfDocSubmitted varchar(2),--62
						SenderrefNo1 varchar(35),--63
						SenderrefNo2 varchar(35),--64
						KycAppliactionNo varchar(20),--65
						KycApplicationDate varchar(11),--66
						IntermediaryInternalRefNo varchar(20),--67
						BranchCode varchar(10),--68
						IPVFlag varChar(1),--69
						IPVDate varchar(11),--70
						IPVName varchar(150),--71
						IPVDesignation varchar(50),--72
						IPVOrganisation varchar(150),--73
						TMCode varchar(5),--74
						ClientCode varchar(10),--75
						Filler1 varchar(50),--76
						Filler2 varchar(50),--77
						Filler3 varchar(50),--78
						Filler4 varchar(50),
						kycmainid int)--79
						
						Insert into #DotEx_KYC_Individual

						select '20',--1
						'',--2
						'01',--3
						ISNULL(KYCMain_FirstName,'')+' '+isnull(KYCMain_MiddleName,'')+' '+ISNULL(KYCMain_LastName,''),--4
						ISNULL(KYCMain_FatherSpouseName,''),--5
						KYCMain_Gender, --6
						KYCMain_MaritalStatus ,--7
						CONVERT(varchar(8),KYCMain_DateOfBirth,112),--8
						KYCMain_PANExempt,--9
						--case when KYCMain_PANExempt='N' then KYCMain_PAN else REPLICATE(' ',1) end--9
						KYCMain_PAN,--10
						case when KYCMain_PANExempt='N' then '' else
								  (select top 1 left(krastaticdata_value,2) from Master_PANExemptCategory,Config_KRAStaticData
								   where KRAStaticData_ID=PanExemptCategory_ID)end,--11
						  left(ISNULL(kycmain_uid,''),12) UID,--12 
						 
						  (select top 1 krastaticdata_code from tbl_master_legalStatus,Config_KRAStaticData where KRAStaticData_ID=lgl_DotExID 
						  and KRAStaticData_Type='IndividualStatus' and kycmain_taxstatus=lgl_id),--13
						 
						Case when KYCMain_Nationality<>'99' then
						(Select 
						(Select distinct top 1 left(isnull(KRAStaticData_Code,' ')+REPLICATE(' ',2),2) Code  
						from Config_KraStaticData Where KraStaticData_ID=Nationality_DotExid)
						from tbl_master_Country,Master_Nationality Where
						Nationality_countryID=cou_id and cou_id=Nationality_CountryID) else '99' end,--14
						left(ISNULL(KYCMain_NationalityOther,''),50),--15
						  
						  case when KYCMain_IdentityProof<>'99' then
						  (select top 1 krastaticdata_code from Master_IdentityProof,Config_KRAStaticData where KRAStaticData_ID=IdentityProof_DotExID and KRAStaticData_Type='IdentityProof'
						  and KYCMain_IdentityProof=identityproof_id) else '99' end,--16
						  left(ISNULL(KYCMain_IdentityProofOther,''),75),--17 
						  left(ISNULL(KYCMain_CAddress1,''),255),--18
						  left(ISNULL(KYCMain_CAddress2,''),255),--19
						  LEFT(ISNULL(KYCMain_CAddress3,''),255),--20
						  (select ISNULL(city_name,'')from tbl_master_city where city_id=KYCMain_CCity),--21
						  LEFT(KYCMain_CPin,10),--22
						   LEFT(ISNULL(KYCMain_CState,''),2),--23
						  case when KYCMain_CState<>'99' then
						  (select top 1 krastaticdata_code from tbl_master_state,Config_KRAStaticData where KRAStaticData_ID=State_DotExID and KRAStaticData_Type='State'
						  and KYCMain_CState=id)else '99' end,--24
						  isnull(KYCMain_CCountry,''),--25
						  isnull(KYCMain_CAddressProof,''),--26
						 					  
						  case when KYCMain_CAddressProof<>'99' then
						  (select top 1 KRAStaticData_Code from Master_AddressProof,Config_KRAStaticData where KRAStaticData_ID=AddressProof_DotExID and KRAStaticData_Type='AdressProof' and KYCMain_CAddressProof=AddressProof_ID)else '99' end,--27
						  
						
						  
						  Case when ISNULL(KYCMain_OPhoneISD,'')='' then
						  Isnull(KYCMain_OPhoneISD,'') 
						  else KYCMain_OPhoneISD end,--28
						  Case when ISNULL(KYCMain_OPhoneSTD,'')='' then
						  Isnull(KYCMain_OPhoneSTD,'') 
						  else KYCMain_OPhoneSTD end,--29
						  Case when ISNULL(KYCMain_OPhone,'')='' then
						  Isnull(KYCMain_OPhone,'') 
						  else KYCMain_OPhone end,--30
						  Case when ISNULL(KYCMain_RPhoneISD,'')='' then
						  Isnull(KYCMain_RPhoneISD,'')
						  else KYCMain_RPhoneISD end,--31
						  Case when ISNULL(KYCMain_RPhoneSTD,'')='' then
						  Isnull(KYCMain_RPhoneSTD,'')
						  else KYCMain_RPhoneSTD end,--32
		  
						  Case when ISNULL(KYCMain_RPhone,'')='' then
						 Isnull(KYCMain_RPhone,'')
						  else KYCMain_RPhone end,--33
						  
						   Case when ISNULL(KYCMain_MobileISD,'')='' then
						  Isnull(KYCMain_MobileISD,'')
						  else KYCMain_MobileISD end,--34
						  
						  Case when ISNULL(KYCMain_Mobile,'')='' then
						 Isnull(KYCMain_Mobile,'')
						  else KYCMain_Mobile end,--35
						  
						  Case when ISNULL(KYCMain_FaxISD,'')='' then
						 Isnull(KYCMain_FaxISD,'') 
						  else KYCMain_FaxISD end,--36
						  
						  Case when ISNULL(KYCMain_FaxSTD,'')='' then
						  Isnull(KYCMain_FaxSTD,'')
						  else KYCMain_FaxSTD end,--37
						  
						  Case when ISNULL(KYCMain_Fax,'')='' then
						 Isnull(KYCMain_Fax,'') 
						  else KYCMain_Fax end,--38
						  
						  KYCMain_EmailID,--39
						  
						  KYCMain_CPSame,--40
						  ISNULL(KYCMain_PAddress1,''),--41
						  ISNULL(KYCMain_PAddress2,''),--42
						  isnull(KYCMain_PAddress3,''),--43
						  (select ISNULL(city_name,'')from tbl_master_city where city_id=KYCMain_PCity),--44
						  ISNULL(KYCMain_PPin,''),--45
						  ISNULL(KYCMain_PState,''),--46
						  (select top 1 KRAStaticData_Code from tbl_master_state,Config_KRAStaticData
						   where KRAStaticData_ID=State_DotExID and KRAStaticData_Type='State' and KYCMain_PState=id),--47
						   						   
						   ISNULL(kycmain_pcountry,''),--48
						   ISNULL(KYCMain_PAddressProof,''),--49
						   
						   (select top 1 KRAStaticData_Code from Master_AddressProof,Config_KRAStaticData
						   where KRAStaticData_ID=AddressProof_DotExID and KRAStaticData_Type='AddressProof' and KYCMain_PAddressProof=AddressProof_ID),--50
						   ISNULL(kycmain_GAIncome,''),--51
						 --  (select top 1 KRAStaticData_Code from Master_AnnualIncome,Config_KRAStaticData
							--where KRAStaticData_ID=AnnualIncome_DotExID and KRAStaticData_Type='Annual Income Code' and KYCMain_GAIncome=AnnualIncome_ID)--51
						    
							KYCMain_NetWorth,--52
						    
							CONVERT(varchar(8),KYCMain_NetWorthDate,112),--53
							ISNULL(kycmain_pep,''),--54
							ISNULL(kycmain_occupation,''),--55
					
						    
							case when KYCMain_Occupation<>'99' then
							(select top 1 KRAStaticData_Code from tbl_master_profession,Config_KRAStaticData 
							where KRAStaticData_ID=PRO_DotExID and KRAStaticData_Type='Occupation' and KYCMain_Occupation=pro_id)
							else '99' end,--56
						    

							left(SUBSTRING(ISNULL(KYCMain_OtherInfo,''),1,99),100),--57
							CONVERT(varchar(8),getdate(),112),--58
							'Y',--59
							'Y',--60
							CONVERT(varchar(8),KYCMain_ApplicationDate,112),--61
							(select cast(count(doc_contactId)as varchar(10)) 
							from tbl_master_document where doc_contactId=KYCMain_ApplicationNumber),--62
							'',--63
							'',--64
							KYCMain_ApplicationNumber,--65
							CONVERT(varchar(8),KYCMain_ApplicationDate,112),--66
							'',--67
							KYCMain_BranchID,--68
							'Y',--69
							CONVERT(varchar(11),KYCMain_IPVDate,112),--70
						 
							(select cnt_firstName from tbl_master_contact where cnt_internalId=KYCMain_IPVDoneBy),--71
						    
							(select deg_designation from tbl_master_designation,tbl_master_contact where deg_id=cnt_designation and cnt_internalId=KYCMain_IPVDoneBy ),--72
							'',--73
							'',---74
							KYCMain_CntID,--75,
							'',--76
							'',--77
							'',--78
							'',--79
							KYCMain_ID
							from master_kycmain where KYCMain_ID in (select col from dbo.fnSplitReturnTable(@ids,','))
							
							select @Maxloopcounter=MAX(Srlno) from #DotEx_KYC_Individual
							set @Staticloopcounter=1
							
							while(@Staticloopcounter<=@Maxloopcounter)
								begin
									update Master_KYCMain set KYCMain_ExportDateTime=GETDATE(),
									KYCMain_BatchNumber=@BatchNumber,KYCMain_ExportUser=@Userid,KYCMain_KRAID=@KycRAID
									from #DotEx_KYC_Individual where KYCMain_ID=kycmainid and Srlno=@Staticloopcounter
									Select @Staticloopcounter=@Staticloopcounter+1
								end
								
							
							exec [Kra_Export_Fetch] @fromdate,@todate,'','','A',@Userid,@Company ,@Clienttype,@Exporttype,'Screen',@IMType,@BatchNumber

							select '10'--as RecordType
							+'|'+CAST(@BatchNumber as varchar(3))--as BatchNumber
							
							+'|'+(select cast(KRAStaticData_Code as varchar(2)) from Config_KRAStaticData where KRAStaticData_ID=@IMType)--as IMRole 
							+'|'+left((select isnull(cmp_KRAIntermediaryID,' ') from tbl_master_company 
							where cmp_internalid=REPLACE(@Company,'''',''))+REPLICATE(' ',5),5) --as IMID
							+'|'+'00'--Branchcode
							+'|'+(select cast(COUNT(*) as varchar(7)) from Master_KYCMain)
							+'|'+CONVERT(VARCHAR(8), GETDATE(), 112) --as createdDate
							+'|'+''--filler
						    
							union all
						    
							 select CAST(RecordType as varchar(2))+'|'+ISNULL(LineNumber,'')+'|'+Updateflag+'|'+ApplicantName+'|'+FatherHusbandName+'|'+Gender+'|'+MaritalStatus+'|'+
							cast(DOB as varchar(15))+'|'+PanExempt+'|'+PAN+'|'+PanExemptionProof+'|'+UID+'|'+isnull(StatusIndividual,'')+'|'+isnull(Nationality,'')+'|'+isnull(IdentityProof,'')+'|'+IdentityProofOther+'|'+CAddress1+'|'+CAddress2+'|'+CAddress3+'|'+
							CityTownVillage+'|'+CPin+'|'+CState+'|'+isnull(CStateOther,'')+'|'+isnull(CCountry,'')+'|'+CAddressProof+'|'+isnull(CAddressProofOther,'')+'|'+OffTelISD+'|'+OffTelSTD+'|'+OffTel+'|'+ResTelISD+'|'+ResTelSTD+'|'+
							ResTel+'|'+MobileISD+'|'+MobileNo+'|'+FaxTelISD+'|'+FaxTelSTD+'|'+FaxNo+'|'+Email+'|'+FlagForSameaddress+'|'+PAddress1+'|'+PAddess2+'|'+PAddress3+'|'+PcitytownVillage+'|'+PPinCode+'|'+
							PState+'|'+isnull(Pstateother,'')+'|'+PCountry+'|'+AddressProofPAddress+'|'+isnull(AddressProofPAddressOther,'')+'|'+GrossIncome+'|'+Networth+'|'+NetWorthDate+'|'+PEP+'|'+Occupation+'|'+
							isnull(OccupationDetails,'')+'|'+AnyOtherInfo+'|'+DeclarationDate+'|'+TrueDocCopies+'|'+SelfCertifiedDoc+'|'+DocRcvDate+'|'+NoOfDocSubmitted+'|'+SenderrefNo1+'|'+SenderrefNo2+'|'+
							KycAppliactionNo+'|'+KycApplicationDate+'|'+IntermediaryInternalRefNo+'|'+BranchCode+'|'+IPVFlag+'|'+IPVDate+'|'+IPVName+'|'+isnull(IPVDesignation,'')+'|'+IPVOrganisation+'|'+
							TMCode+'|'+ClientCode+'|'+Filler1+'|'+Filler2+'|'+Filler3+'|'+Filler4 from #DotEx_KYC_Individual
						    
							select COUNT(Srlno)from #DotEx_KYC_Individual
							--select * from #DotEx_KYC_Individual
							drop table #DotEx_KYC_Individual
					End
				else
				Begin
						create table #DotEx_KYC_NonIndividual
						(Srlno int identity,
						RecordType int,--1
						LineNumber varchar(7),--2
						Updateflag varchar(2),--3
						ApplicantName varchar(150),--4
						DateofIncorporation date,--5
						PlaceofIncorporation varchar(75),--6
						DateofCommencementBusiness date,--7					
						PanExempt char(1),--8
						PAN char(10),--9
						PanExemptionProof char(2),--10
						RegistrationNo varchar(16),--11 yet to modified
						StatusNonIndividual varchar(2),--12
						StatusOther varchar(75),--13					
						CAddress1 varchar(255),--14
						CAddress2 varchar(255),--15
						CAddress3 varchar(255),--16
						CityTownVillage varchar(50),--17
						CPin varchar(10),--18
						CState varchar(2),--19
						CStateOther varchar(75),--20
						CCountry varchar(3),--21
						CAddressProof varchar(2),--22
						CAddressProofOther varchar(75),--23
						OffTelISD varchar(14),--24
						OffTelSTD varchar(10),--25
						OffTel varchar(24),--26
						ResTelISD varchar(14),--27
						ResTelSTD varchar(10),--28
						ResTel varchar(24),--29
						MobileISD varchar(14),--30
						MobileNo varchar(15),--31
						FaxTelISD varchar(14),--32
						FaxTelSTD varchar(10),--33
						FaxNo varchar(24),--34
						Email varchar(60),--35
						FlagForSameaddress char(1),--36
						RAddress1 varchar(255),--37
						RAddess2 varchar(255),--38
						RAddress3 varchar(255),--39
						RcitytownVillage varchar(50),--40
						RPinCode Varchar(10),--41
						RState varchar(2),--42
						Rstateother varchar(75),--43
						RCountry varchar(3),--44
						AddressProofRAddress char(2),--45
						AddressProofRAddressOther varchar(75),--46
						GrossIncome varchar(2),--47
						Networth varchar(18),--48
						NetWorthDate varchar(11),--49
						NumberofPPKTd int,--50
						PEP varchar(2),--51
						AnyOtherInfo varchar(100),---52
						DeclarationDate varchar(11),--53					
						TrueDocCopies varchar(1),--54
						SelfCertifiedDoc char(1),--55
						DocRcvDate varchar(11),--56
						NoOfDocSubmitted varchar(2),--57
						SenderrefNo1 varchar(35),--58
						SenderrefNo2 varchar(35),--59
						KycAppliactionNo varchar(20),--60
						KycApplicationDate varchar(11),--61
						IntermediaryInternalRefNo varchar(20),--62
						BranchCode varchar(10),--63
						IPVFlag varChar(1),--64
						IPVDate varchar(11),--65
						IPVName varchar(150),--66
						IPVDesignation varchar(50),--67
						IPVOrganisation varchar(150),--68
						TMCode varchar(5),--69
						ClientCode varchar(10),--70
						Filler1 varchar(50),--71
						Filler2 varchar(50),--72
						Filler3 varchar(50),--73
						Filler4 varchar(50),--74
								
						
						kycmainid int
						)--79
						
						Insert into #DotEx_KYC_NonIndividual

						select '40',--1
						'',--2
						'01',--3
						ISNULL(KYCMain_FirstName,'')+' '+isnull(KYCMain_MiddleName,'')+' '+ISNULL(KYCMain_LastName,''),--4
						ISNULL(KYCMain_DateOfInCorp,''),--5
						(select ISNULL(city_name,'')from tbl_master_city where city_id=KYCMain_PlaceOfInCorp), --6
						--KYCMain_PlaceOfInCorp, --6
						KYCMain_BusinessComDate ,--7						
						KYCMain_PANExempt,--8						
						KYCMain_PAN,--9
						KYCMain_PanExemptProof,--10
						'CIN',--11
						Case when KYCMain_TaxStatus<>'99' then 
							(select top 1 isnull(KRAStaticData_Code,'') from tbl_master_legalStatus,Config_KRAStaticData
								where KRAStaticData_ID=lgl_DotExID and KRAStaticData_Type='NonIndividualStatus' 
									and KYCMain_TaxStatus=lgl_id) else '99' end,--12
						Case when KYCMain_TaxStatus='99' then 
							left(ISNULL(KYCMain_TaxStatusCompOther,''),75) 
								else '' end,--13	
												
					    left(ISNULL(KYCMain_CAddress1,''),255),--14
					    left(ISNULL(KYCMain_CAddress2,''),255),--15
					    LEFT(ISNULL(KYCMain_CAddress3,''),255),--16
					    (select ISNULL(city_name,'')from tbl_master_city where city_id=KYCMain_CCity),--17
					    LEFT(KYCMain_CPin,10),--18
					    
					    case when KYCMain_CState<>'99' then
							(select top 1 krastaticdata_code from tbl_master_state,Config_KRAStaticData where KRAStaticData_ID=State_DotExID and KRAStaticData_Type='State'
								and KYCMain_CState=id)else '99' end,--19
				        Case when KYCMain_CState='99' then 
							left(ISNULL(KYCMain_CStateOther,''),75) 
								else '' end,--20	
					  
						case when KYCMain_CCountry<>'99'then
							(select top 1 KRAStaticData_Code from tbl_master_country,Config_KRAStaticData where KRAStaticData_ID=Country_DotExID and KRAStaticData_Type='Country'
								and KYCMain_CCountry=cou_id)else '99' end,--21
					 				 					  
						case when KYCMain_CAddressProof<>'99' then
							(select top 1 KRAStaticData_Code from Master_AddressProof,Config_KRAStaticData where KRAStaticData_ID=AddressProof_DotExID and KRAStaticData_Type='AdressProof' and KYCMain_CAddressProof=AddressProof_ID)else '99' end,--22
					   
					    case when KYCMain_CAddressProof='99'then
					   	    LEFT(isnull(KYCMain_CAddressProof,''),75)
					   			else '' end,--23		
					
						  Case when ISNULL(KYCMain_OPhoneISD,'')='' then
						  Isnull(KYCMain_OPhoneISD,'') 
						  else KYCMain_OPhoneISD end,--24
						  Case when ISNULL(KYCMain_OPhoneSTD,'')='' then
						  Isnull(KYCMain_OPhoneSTD,'') 
						  else KYCMain_OPhoneSTD end,--25
						  Case when ISNULL(KYCMain_OPhone,'')='' then
						  Isnull(KYCMain_OPhone,'') 
						  else KYCMain_OPhone end,--26
						  Case when ISNULL(KYCMain_RPhoneISD,'')='' then
						  Isnull(KYCMain_RPhoneISD,'')
						  else KYCMain_RPhoneISD end,--27
						  Case when ISNULL(KYCMain_RPhoneSTD,'')='' then
						  Isnull(KYCMain_RPhoneSTD,'')
						  else KYCMain_RPhoneSTD end,--28
		  
						  Case when ISNULL(KYCMain_RPhone,'')='' then
						  Isnull(KYCMain_RPhone,'')
						  else KYCMain_RPhone end,--29
						  
						  Case when ISNULL(KYCMain_MobileISD,'')='' then
						  Isnull(KYCMain_MobileISD,'')
						  else KYCMain_MobileISD end,--30
						  
						  Case when ISNULL(KYCMain_Mobile,'')='' then
						  Isnull(KYCMain_Mobile,'')
						  else KYCMain_Mobile end,--31
						  
						  Case when ISNULL(KYCMain_FaxISD,'')='' then
						  Isnull(KYCMain_FaxISD,'') 
						  else KYCMain_FaxISD end,--32
						  
						  Case when ISNULL(KYCMain_FaxSTD,'')='' then
						  Isnull(KYCMain_FaxSTD,'')
						  else KYCMain_FaxSTD end,--33
						  
						  Case when ISNULL(KYCMain_Fax,'')='' then
						  Isnull(KYCMain_Fax,'') 
						  else KYCMain_Fax end,--34
						  
						  KYCMain_EmailID,--35
						
						  KYCMain_CPSame,--36
						  ISNULL(KYCMain_PAddress1,''),--37
						  ISNULL(KYCMain_PAddress2,''),--38
						  isnull(KYCMain_PAddress3,''),--39
						  (select ISNULL(city_name,'')from tbl_master_city where city_id=KYCMain_PCity),--40
						  ISNULL(KYCMain_PPin,''),--41
						  ISNULL(KYCMain_PState,''),--42
						  (select top 1 KRAStaticData_Code from tbl_master_state,Config_KRAStaticData
						  where KRAStaticData_ID=State_DotExID and KRAStaticData_Type='State' and KYCMain_PState=id),--43
						   						   
						  ISNULL(kycmain_pcountry,''),--44
						  ISNULL(KYCMain_PAddressProof,''),--45
						   
						 (select top 1 KRAStaticData_Code from Master_AddressProof,Config_KRAStaticData
						  where KRAStaticData_ID=AddressProof_DotExID and KRAStaticData_Type='AddressProof' and KYCMain_PAddressProof=AddressProof_ID),--46
						  ISNULL(kycmain_GAIncome,''),--47
					
						  KYCMain_NetWorth,--48
						   
						  CONVERT(varchar(8),KYCMain_NetWorthDate,112),--49
						  '',--50
							ISNULL(kycmain_pep,''),--51
						
							left(SUBSTRING(ISNULL(KYCMain_OtherInfo,''),1,99),100),--52
							CONVERT(varchar(8),getdate(),112),--53
							
							'Y',--54
							'Y',--55
							
							CONVERT(varchar(8),KYCMain_ApplicationDate,112),--56
							(select cast(count(doc_contactId)as varchar(10)) 
							from tbl_master_document where doc_contactId=KYCMain_ApplicationNumber),--57
							'',--58
							'',--59
							KYCMain_ApplicationNumber,--60
							CONVERT(varchar(8),KYCMain_ApplicationDate,112),--61
							'',--62
							KYCMain_BranchID,--63
							'Y',--64
							CONVERT(varchar(11),KYCMain_IPVDate,112),--65						
						 
							(select cnt_firstName from tbl_master_contact where cnt_internalId=KYCMain_IPVDoneBy),--66
						    
							(select deg_designation from tbl_master_designation,tbl_master_contact where deg_id=cnt_designation and cnt_internalId=KYCMain_IPVDoneBy ),--67
							'',--68
							'',---69
							KYCMain_CntID,--70,
							'',--71
							'',--72
							'',--73
							'',--74
							KYCMain_ID
							from master_kycmain where KYCMain_ID in (select col from dbo.fnSplitReturnTable(@ids,','))
							
						create table #DotEx_KYC_NonIndividual_DetailRecord
						(
						Srlno int identity,RecordType int,LineNumber int,Name varchar(250),RelationshipwithApplicant varchar(2),relationshipwithApplicantOther varchar(75),PanExempt varchar(1),PanOfPW varchar(10),
						PanExemptionProof varchar(75),RAddress1 varchar(255),RAddress2 varchar(255),RAddress3 varchar(255),citytownvill varchar(50),pincode varchar(10),state varchar(2),stateother varchar(75),country varchar(3),
						dinuid int,pannonindividual varchar(10),Filler varchar(50),kycdetailsmainid int
						)
						Insert into #DotEx_KYC_NonIndividual_DetailRecord
						select '50',--1
						'',--2
						KYCDetail_Name,--3
						Case when KYCDetail_Relationship<>'99' then 
							(select top 1 isnull(KRAStaticData_Code,'') from tbl_master_profession,Config_KRAStaticData
							where KRAStaticData_ID=PRO_DotExID and KRAStaticData_Type='NonIndividualStatus' 
							and KYCDetail_Relationship=pro_id) else '99' end,--4
						Case when KYCDetail_Relationship='99' then 
							left(ISNULL(KYCDetail_Relationship,''),75) 
							else '' end,--5
						'Y',--6--yet to modified
						KYCDetail_PAN,--7--yet to modified
						'',--8--yet to modified
						KYCDetail_Address1,--9
						KYCDetail_Address2,--10
						KYCDetail_Address3,--11
						KYCDetail_City,--12
						KYCDetail_PIN,--13
						case when KYCDetail_State<>'99' then
						  (select top 1 KRAStaticData_Code from tbl_master_state,Config_KRAStaticData
						   where KRAStaticData_ID=State_DotExID and KRAStaticData_Type='State' and KYCDetail_State=id)else '99' end,--14
						Case when KYCDetail_State='99' then 
							left(ISNULL(KYCDetail_StateOther,''),75) 
							else '' end,--15
						case when KYCDetail_Country<>'99'then
							(select top 1 KRAStaticData_Code from tbl_master_country,Config_KRAStaticData
							where KRAStaticData_ID=Country_DotExID and KRAStaticData_Type='Country' and KYCDetail_Country=cou_id)else '99' end,--16
						KYCDetail_DinUid,
						KYCDetail_PAN,
						'',
						KYCDetail_MainID					
						from Master_KYCDetail
						
							
						select @Maxloopcounter=MAX(Srlno) from #DotEx_KYC_NonIndividual
							set @Staticloopcounter=1
							
							Insert Into #MainExport
								select '30'--as RecordType	
								+'|'+RIGHT(cast(@BatchNumber as varchar(8)),3) --as BatchNumber
								+'|'+Right(REPLICATE('0',2)+(select cast(isnull(KRAStaticData_Code,'') as varchar(2))  from Config_KRAStaticData where KRAStaticData_ID=@IMType),2) --as IMRole
								+'|'+left((select isnull(cmp_KRAIntermediaryID,' ') from tbl_master_company	where cmp_internalid=REPLACE(@Company,'''',''))+REPLICATE(' ',5),5) --as IMID				
								
								+'|'+'00'--Branchcode
								+'|'+(select cast(COUNT(*) as varchar(7)) from Master_KYCMain)
								+'|'+CONVERT(VARCHAR(8), GETDATE(), 112) --as createdDate
								+'|'+''--filler
								while(@Staticloopcounter<=@Maxloopcounter)
								begin
									Insert Into #MainExport
									select CAST(RecordType as varchar(2))+'|'+cast(LineNumber as varchar(7))+'|'+cast(Updateflag as varchar(2))+'|'+ApplicantName+'|'+cast(DateofIncorporation as varchar(14))+'|'+PlaceofIncorporation+'|'+cast(DateofCommencementBusiness as varchar(14))+'|'+
									PanExempt+'|'+PAN+'|'+cast(PanExemptionProof as varchar(2))+'|'+RegistrationNo+'|'+isnull(StatusNonIndividual,' ')+'|'+StatusOther+'|'+CAddress1+'|'+CAddress2+'|'+CAddress3+'|'+
									CityTownVillage+'|'+CPin+'|'+isnull(CState,'')+'|'+CStateOther+'|'+isnull(CCountry,'')+'|'+isnull(CAddressProof,'')+'|'+CAddressProofOther+'|'+cast(OffTelISD as varchar(14))+'|'+cast(OffTelSTD as varchar(14))+'|'+cast(OffTel as varchar(24))+'|'+cast(ResTelISD as varchar(14))+'|'+cast(ResTelSTD as varchar(10))+'|'+
									cast(ResTel as varchar(24))+'|'+isnull(cast(MobileISD as varchar(14)),'')+'|'+cast(MobileNo as varchar(15))+'|'+isnull(cast(FaxTelISD as varchar(14)),'')+'|'+isnull(cast(FaxTelSTD as varchar(10)),'')+'|'+FaxNo+'|'+Email+'|'+FlagForSameaddress+'|'+RAddress1+'|'+RAddess2+'|'+RAddress3+'|'+RcitytownVillage+'|'+RPinCode+'|'+
									RState+'|'+isnull(Rstateother,'')+'|'+RCountry+'|'+cast(AddressProofRAddress as varchar(2))+'|'+isnull(AddressProofRAddressOther,'')+'|'+GrossIncome+'|'+Networth+'|'+cast(NetWorthDate as varchar(14))+'|'+cast(NumberofPPKTd as varchar(3))+'|'+PEP+'|'+AnyOtherInfo+'|'+
									cast(DeclarationDate as varchar(15))+'|'+TrueDocCopies+'|'+SelfCertifiedDoc+'|'+cast(DocRcvDate as varchar(15))+'|'+cast(NoOfDocSubmitted as varchar(2))+'|'+SenderrefNo1+'|'+SenderrefNo2+'|'+
									KycAppliactionNo+'|'+cast(KycApplicationDate as varchar(15))+'|'+IntermediaryInternalRefNo+'|'+BranchCode+'|'+IPVFlag+'|'+cast(IPVDate as varchar(14))+'|'+IPVName+'|'+isnull(IPVDesignation,'')+'|'+IPVOrganisation+'|'+
									TMCode+'|'+ClientCode+'|'+Filler1+'|'+Filler2+'|'+Filler3+'|'+Filler4 from #DotEx_KYC_NonIndividual where Srlno=@Staticloopcounter --kycmainid in (select col from dbo.fnSplitReturnTable('68,59',','))
									
									select @MainId=kycmainid from #DotEx_KYC_NonIndividual where Srlno=@Staticloopcounter
									
									Insert Into #MainExport
									select CAST(RecordType as varchar(2))+'|'+ ISNULL(cast(LineNumber as varchar(2)),'')+'|'+Name+'|'+isnull(RelationshipwithApplicant,'')+'|'+RelationshipwithApplicantOther+'|'+PanExempt+'|'+
									PanOfPW+'|'+PanExemptionProof+'|'+RAddress1+'|'+RAddress2+'|'+RAddress3+'|'+citytownvill+'|'+pincode+'|'+isnull(state,'')+'|'+stateother+'|'+isnull(country,'')+'|'+cast(DinUid as varchar(12))+'|'+pannonindividual+'|'+Filler 
									from #DotEx_KYC_NonIndividual_DetailRecord  where kycdetailsmainid=@MainId
									
									update Master_KYCMain set KYCMain_ExportDateTime=GETDATE(),
									KYCMain_BatchNumber=@BatchNumber,KYCMain_ExportUser=@Userid,KYCMain_KRAID=@KycRAID
									from #DotEx_KYC_NonIndividual where KYCMain_ID=kycmainid and Srlno=@Staticloopcounter
									
													
									Select @Staticloopcounter=@Staticloopcounter+1
								end
								--select * from #MainExport
							
							--exec [Kra_Export_Fetch] @fromdate,@todate,'','','DOTEX',@Userid,@Company ,@Clienttype,@Exporttype,'DOTEX',@IMType,@BatchNumber
							exec [Kra_Export_Fetch] @fromdate,@todate,'','','A',@Userid,@Company ,@Clienttype,@Exporttype,'Screen',@IMType,@BatchNumber
							select * from #MainExport
							
						
							select COUNT(Srlno)from #DotEx_KYC_NonIndividual
							--select * from #DotEx_KYC_Individual
							--drop table #DotEx_KYC_NonIndividual
							--drop table #DotEx_KYC_NonIndividual_DetailRecord
							--drop table #MainExport
							--drop table #DotEx_KYC_Individual
					End
			End	
			-------------CVL Begin and DOTEX END-------------
			If(@mode='CVL')
				begin
					Declare @cvlimid varchar(30)
					select @cvlimid=isnull(KRA_IntermediaryID,' ') from Config_KRA 
									where KRA_CompanyID=REPLACE(@Company,'''','') and KRA_Agency=1
					If(@Clienttype='I')
						Begin
							Create Table #CVLMainindividual 
							(Autoid int identity,updateflag char(2),poscode varchar(20),entitytype char(1),Appno varchar(20), Appdate varchar(10),Panno varchar(20),
							Pancopyflag char(1),panexempt char(1),panexemtcategory char(2),proofid char(2),Inpersonverification char(1),Inpersonverificationdate varchar(10),
							Gender char(1),Appname varchar(100),Fathername varchar(100),Regnumber varchar(50),Incorpordateofbirth varchar(10),commencementdt varchar(10),
							Nationality char(2),Nationalityoth char(3),companystatus char(2),companystatusoth varchar(100),ResidentialINDstatus char(1),ResidentialNONINDstatus char(2),
							AadharorUid char(12),Coradd1 varchar(120),coradd2 varchar(120),coradd3 varchar(120),corrcity varchar(30),corpin char(10),corstate char(20),corcountry char(3),
							offcisd char(10),offcstd char(10),offcno char(20),resisd char(10),resstd char(10),resno char(20),mobileisd char(10),mobileno char(20),faxisd char(10),faxstd char(10),
							faxno char(20),emailid varchar(100),corraddproof char(2),corraddproofrefid varchar(100),corraddproofrefdate varchar(10),Addressflag char(1),peradd1 varchar(120),peradd2 varchar(120),
							peradd3 varchar(120),percity varchar(30),perpin char(20),perstate char(20),percountry char(3),peraddproof char(2),peraddproofrefid varchar(100),peraddproofrefdate varchar(10),grossannualincome char(2),
							occupationdetail char(2),occupationdetailoth varchar(50),polconnection char(4),docsubmissiondetail char(1),refno varchar(20),barnchcode char(10),maritalstatus char(2),networth numeric(30,2),networthdate varchar(10),
							incorporationplace varchar(100),Anyothinfo varchar(100),filler1 char(20),filler2 char(20),filler3 char(20),kycmainid bigint)
							
							insert into #CVLMainindividual
							select '01',----1
							@cvlimid,----2
							'I',---3
							isnull(KYCMain_ApplicationNumber,''),----4
							isnull(CONVERT(VARCHAR(10),KYCMain_ApplicationDate,103),''),----5
							ISNULL(KYCMain_PAN,''),---6
							case when KYCMain_PANExempt='N' then 'Y' else 'N' end,----7
							isnull(KYCMain_PANExempt,''),----8
							case when KYCMain_PANExempt='N' then '' else
							(select top 1 isnull(KRAStaticData_Value,'') from Master_PANExemptCategory,Config_KRAStaticData
							where KRAStaticData_ID=PanExemptCategory_CVLID and KRAStaticData_Type='PanExemptCategory'
							and KYCMain_PanExemptProof=PanExemptCategory_ID and KRAStaticData_KRAId=1) end,----------9
							case when KYCMain_IdentityProof<>'99' then
							(select top 1 krastaticdata_code from Master_IdentityProof,Config_KRAStaticData where KRAStaticData_ID=IdentityProof_DotExID and KRAStaticData_Type='IdentityProof'
							and KYCMain_IdentityProof=identityproof_id) else '99' end,--------10
							KYCMain_IPVDone,---------11
							isnull(CONVERT(VARCHAR(10),KYCMain_IPVDate,103),''),---------12
							KYCMain_Gender,---------13
							ISNULL(KYCMain_FirstName,'')+' '+isnull(KYCMain_MiddleName,'')+' '+ISNULL(KYCMain_LastName,''),-----14
							ISNULL(KYCMain_FatherSpouseName,''),----15
							'',--------16
							isnull(CONVERT(VARCHAR(10),KYCMain_DateOfBirth,103),''),---------17
							'',----------18
							case when KYCMain_Nationality<>'99' then '01' else '02' end,--------19
							case when KYCMain_Nationality='99' then 
							(select top 1 Country_CvlID from tbl_master_country where ltrim(rtrim(KYCMain_NationalityOther))=ltrim(rtrim(cou_country))) 
							else '' end,---------20
							'',-------21
							'',-------22
							(select top 1 isnull(KRAStaticData_Code,' ') from tbl_master_legalStatus,Config_KRAStaticData
							where KRAStaticData_ID=lgl_CVLID and KRAStaticData_Type='IndividualStatus' 
							and KYCMain_TaxStatus=lgl_id and KRAStaticData_KRAId=1),------23
							'',----24
							ISNULL(KYCMain_UID,''),------25
							ISNULL(KYCMain_CAddress1,''),------26
							ISNULL(KYCMain_CAddress2,''),------27
							ISNULL(KYCMain_CAddress3,''),------28
							(select ISNULL(city_name,'')from tbl_master_city where city_id=KYCMain_CCity),------29
							isnull(KYCMain_CPin,''),------30
							(select top 1 krastaticdata_code from tbl_master_state,Config_KRAStaticData where KRAStaticData_ID=State_CVLID 
							and KRAStaticData_Type='State' and KYCMain_CState=id and KRAStaticData_KRAId=1),------31
							(select top 1 KRAStaticData_Code from tbl_master_country,Config_KRAStaticData where KRAStaticData_ID=Country_CVLID 
							and KRAStaticData_Type='Country'
							and KYCMain_CCountry=cou_id and KRAStaticData_KRAId=1),------32
							ISNULL(KYCMain_OPhoneISD,''),------33
							ISNULL(KYCMain_OPhoneSTD,''),------34
							ISNULL(KYCMain_OPhone,''),------35
							ISNULL(KYCMain_RPhoneISD,''),------36
							ISNULL(KYCMain_RPhoneSTD,''),------37
							ISNULL(KYCMain_RPhone,''),------38
							ISNULL(KYCMain_MobileISD,''),------39
							ISNULL(KYCMain_Mobile,''),------40
							ISNULL(KYCMain_FaxISD,''),------41
							ISNULL(KYCMain_FaxSTD,''),------42
							ISNULL(KYCMain_Fax,''),------43
							ISNULL(KYCMain_EmailID,''),----44
							(select top 1 KRAStaticData_Code from Master_AddressProof,Config_KRAStaticData
						  where KRAStaticData_ID=AddressProof_CVLID and KRAStaticData_Type='AddressProof' 
						  and KYCMain_CAddressProof=AddressProof_ID and KRAStaticData_KRAId=1),--45
						  '',--------46
						  '',----------47
						  isnull(KYCMain_CPSame,''),----------48
						  ISNULL(KYCMain_PAddress1,''),------49
							ISNULL(KYCMain_PAddress2,''),------50
							ISNULL(KYCMain_PAddress3,''),------51
							(select ISNULL(city_name,'')from tbl_master_city where city_id=KYCMain_PCity),------52
							isnull(KYCMain_PPin,''),------53
							(select top 1 krastaticdata_code from tbl_master_state,Config_KRAStaticData where KRAStaticData_ID=State_CVLID 
							and KRAStaticData_Type='State' and KYCMain_PState=id and KRAStaticData_KRAId=1),------54
							(select top 1 KRAStaticData_Code from tbl_master_country,Config_KRAStaticData where KRAStaticData_ID=Country_CVLID 
							and KRAStaticData_Type='Country'
							and KYCMain_PCountry=cou_id and KRAStaticData_KRAId=1),------55
							(select top 1 KRAStaticData_Code from Master_AddressProof,Config_KRAStaticData
						  where KRAStaticData_ID=AddressProof_CVLID and KRAStaticData_Type='AddressProof' 
						  and KYCMain_PAddressProof=AddressProof_ID and KRAStaticData_KRAId=1),--56
						  '',---------57
						  '',---------58
							  (select top 1 isnull(KRAStaticData_Code,' ') from Master_AnnualIncome,Config_KRAStaticData
							  where KRAStaticData_ID=AnnualIncome_CVLID and KRAStaticData_Type='Annual Income Code' 
							  and KYCMain_GAIncome=AnnualIncome_ID and KRAStaticData_KRAId=1),--59
							  case when KYCMain_Occupation<>'99' then
							 (select top 1 KRAStaticData_Code from tbl_master_profession,Config_KRAStaticData 
							where KRAStaticData_ID=PRO_CVLID and KRAStaticData_Type='Occupation' and KYCMain_Occupation=pro_id and KRAStaticData_KRAId=1)
							else '99' end,--60
							isnull(KYCMain_OccupationOther,''),--61
							(select top 1 isnull(KRAStaticData_Code,' ') from Master_PoliticalConnection,Config_KRAStaticData
							where KRAStaticData_ID=PoliticalConnection_CVLID and KRAStaticData_Type='PoliticalConnection' 
							and KYCMain_PeP=PoliticalConnection_ID and KRAStaticData_KRAId=1),--62
							'T',----63
							ISNULL(KYCMain_DocNo,''),----64
							'',----65
							case when KYCMain_MaritalStatus='S' then '02' else '01' end,---66
							isnull(KYCMain_NetWorth,0),---67
							isnull(CONVERT(VARCHAR(10),KYCMain_NetWorthDate,103),''),---------68
							--(select ISNULL(city_name,'')from tbl_master_city where city_id=KYCMain_PlaceOfInCorp)
							'',----69
							isnull(KYCMain_OtherInfo,''),----70
							'',---71
							'',---72
							'',----73
							KYCMain_ID----for internal use
							from Master_KYCMain
							where KYCMain_ID in (select col from dbo.fnSplitReturnTable(@ids,','))
							insert into #MainExport
							select '<ROOT>'
							union all
							select'<HEADER>'
							union all
							select'<COMPANY_CODE>'+ltrim(rtrim(isnull(@cvlimid,'')))+'</COMPANY_CODE>'
							union all
							select'<BATCH_DATE>'+ltrim(rtrim(isnull(CONVERT(VARCHAR(10),GETDATE(),103),'')))+'</BATCH_DATE>'
							union all
							select'</HEADER>'
							
							select @Maxloopcounter=MAX(Autoid) from #CVLMainindividual
							set @Staticloopcounter=1
							while(@Staticloopcounter<=@Maxloopcounter)
								begin
									insert into #MainExport
									select '<KYCDATA>'
									union all
									select'<APP_UPDTFLG>'+ltrim(rtrim(isnull(updateflag,'')))+'</APP_UPDTFLG>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_POS_CODE>'+ltrim(rtrim(isnull(poscode,'')))+'</APP_POS_CODE>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_TYPE>'+ltrim(rtrim(isnull(entitytype,'')))+'</APP_TYPE>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_NO>'+ltrim(rtrim(isnull(Appno,'')))+'</APP_NO>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_DATE>'+ltrim(rtrim(isnull(Appdate,'')))+'</APP_DATE>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PAN_NO>'+ltrim(rtrim(isnull(Panno,'')))+'</APP_PAN_NO>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PAN_COPY>'+ltrim(rtrim(isnull(Pancopyflag,'')))+'</APP_PAN_COPY>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_EXMT>'+ltrim(rtrim(isnull(panexempt,'')))+'</APP_EXMT>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									
									
									union all
									select '<APP_EXMT_CAT>'+ltrim(rtrim(isnull(panexemtcategory,'')))+'</APP_EXMT_CAT>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_EXMT_ID_PROOF>'+ltrim(rtrim(isnull(proofid,'')))+'</APP_EXMT_ID_PROOF>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_IPV_FLAG>'+ltrim(rtrim(isnull(Inpersonverification,'')))+'</APP_IPV_FLAG>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_IPV_DATE>'+ltrim(rtrim(isnull(Inpersonverificationdate,'')))+'</APP_IPV_DATE>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_GEN>'+ltrim(rtrim(isnull(Gender,'')))+'</APP_GEN>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_NAME>'+ltrim(rtrim(isnull(Appname,'')))+'</APP_NAME>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_F_NAME>'+ltrim(rtrim(isnull(Fathername,'')))+'</APP_F_NAME>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_REGNO>'+ltrim(rtrim(isnull(Regnumber,'')))+'</APP_REGNO>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_DOB_INCORP>'+ltrim(rtrim(isnull(Incorpordateofbirth,'')))+'</APP_DOB_INCORP>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COMMENCE_DT>'+ltrim(rtrim(isnull(commencementdt,'')))+'</APP_COMMENCE_DT>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_NATIONALITY>'+ltrim(rtrim(isnull(Nationality,'')))+'</APP_NATIONALITY>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OTH_NATIONALITY>'+ltrim(rtrim(isnull(Nationalityoth,'')))+'</APP_OTH_NATIONALITY>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COMP_STATUS>'+ltrim(rtrim(isnull(companystatus,'')))+'</APP_COMP_STATUS>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OTH_COMP_STATUS>'+ltrim(rtrim(isnull(companystatusoth,'')))+'</APP_OTH_COMP_STATUS>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_RES_STATUS>'+ltrim(rtrim(isnull(ResidentialINDstatus,'')))+'</APP_RES_STATUS>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_RES_STATUS_PROOF>'+ltrim(rtrim(isnull(ResidentialNONINDstatus,'')))+'</APP_RES_STATUS_PROOF>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_UID_NO>'+ltrim(rtrim(isnull(AadharorUid,'')))+'</APP_UID_NO>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_ADD1>'+ltrim(rtrim(isnull(Coradd1,'')))+'</APP_COR_ADD1>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_ADD2>'+ltrim(rtrim(isnull(coradd2,'')))+'</APP_COR_ADD2>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_ADD3>'+ltrim(rtrim(isnull(coradd3,'')))+'</APP_COR_ADD3>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_CITY>'+ltrim(rtrim(isnull(corrcity,'')))+'</APP_COR_CITY>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_PINCD>'+ltrim(rtrim(isnull(corpin,'')))+'</APP_COR_PINCD>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_STATE>'+ltrim(rtrim(isnull(corstate,'')))+'</APP_COR_STATE>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_CTRY>'+ltrim(rtrim(isnull(corcountry,'')))+'</APP_COR_CTRY>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OFF_ISD>'+ltrim(rtrim(isnull(offcisd,'')))+'</APP_OFF_ISD>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OFF_STD>'+ltrim(rtrim(isnull(offcstd,'')))+'</APP_OFF_STD>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OFF_NO>'+ltrim(rtrim(isnull(offcno,'')))+'</APP_OFF_NO>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_RES_ISD>'+ltrim(rtrim(isnull(resisd,'')))+'</APP_RES_ISD>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_RES_STD>'+ltrim(rtrim(isnull(resstd,'')))+'</APP_RES_STD>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_RES_NO>'+ltrim(rtrim(isnull(resno,'')))+'</APP_RES_NO>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_MOB_ISD>'+ltrim(rtrim(isnull(mobileisd,'')))+'</APP_MOB_ISD>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_MOB_NO>'+ltrim(rtrim(isnull(mobileno,'')))+'</APP_MOB_NO>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_FAX_ISD>'+ltrim(rtrim(isnull(faxisd,'')))+'</APP_FAX_ISD>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_FAX_STD>'+ltrim(rtrim(isnull(faxstd,'')))+'</APP_FAX_STD>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_FAX_NO>'+ltrim(rtrim(isnull(faxno,'')))+'</APP_FAX_NO>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_EMAIL>'+ltrim(rtrim(isnull(emailid,'')))+'</APP_EMAIL>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_ADD_PROOF>'+ltrim(rtrim(isnull(corraddproof,'')))+'</APP_COR_ADD_PROOF>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_ADD_REF>'+ltrim(rtrim(isnull(corraddproofrefid,'')))+'</APP_COR_ADD_REF>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_ADD_DT>'+ltrim(rtrim(isnull(corraddproofrefdate,'')))+'</APP_COR_ADD_DT>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_ADD_FLAG>'+ltrim(rtrim(isnull(Addressflag,'')))+'</APP_PER_ADD_FLAG>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_ADD1>'+ltrim(rtrim(isnull(peradd1,'')))+'</APP_PER_ADD1>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_ADD2>'+ltrim(rtrim(isnull(peradd2,'')))+'</APP_PER_ADD2>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_ADD3>'+ltrim(rtrim(isnull(peradd3,'')))+'</APP_PER_ADD3>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_CITY>'+ltrim(rtrim(isnull(percity,'')))+'</APP_PER_CITY>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_PINCD>'+ltrim(rtrim(isnull(perpin,'')))+'</APP_PER_PINCD>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_STATE>'+ltrim(rtrim(isnull(perstate,'')))+'</APP_PER_STATE>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_CTRY>'+ltrim(rtrim(isnull(percountry,'')))+'</APP_PER_CTRY>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_ADD_PROOF>'+ltrim(rtrim(isnull(peraddproof,'')))+'</APP_PER_ADD_PROOF>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_ADD_REF>'+ltrim(rtrim(isnull(peraddproofrefid,'')))+'</APP_PER_ADD_REF>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_ADD_DT>'+ltrim(rtrim(isnull(peraddproofrefdate,'')))+'</APP_PER_ADD_DT>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_INCOME>'+ltrim(rtrim(isnull(grossannualincome,'')))+'</APP_INCOME>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OCC>'+ltrim(rtrim(isnull(occupationdetail,'')))+'</APP_OCC>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OTH_OCC>'+ltrim(rtrim(isnull(occupationdetailoth,'')))+'</APP_OTH_OCC>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_POL_CONN>'+ltrim(rtrim(isnull(polconnection,'')))+'</APP_POL_CONN>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_DOC_PROOF>'+ltrim(rtrim(isnull(docsubmissiondetail,'')))+'</APP_DOC_PROOF>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_INTERNAL_REF>'+ltrim(rtrim(isnull(refno,'')))+'</APP_INTERNAL_REF>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_BRANCH_CODE>'+ltrim(rtrim(isnull(barnchcode,'')))+'</APP_BRANCH_CODE>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_MAR_STATUS>'+ltrim(rtrim(isnull(maritalstatus,'')))+'</APP_MAR_STATUS>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_NETWRTH>'+ltrim(rtrim(isnull(cast(networth as varchar(max)),0)))+'</APP_NETWRTH>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_NETWORTH_DT>'+ltrim(rtrim(isnull(networthdate,'')))+'</APP_NETWORTH_DT>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_INCORP_PLC>'+ltrim(rtrim(isnull(incorporationplace,'')))+'</APP_INCORP_PLC>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OTHERINFO>'+ltrim(rtrim(isnull(Anyothinfo,'')))+'</APP_OTHERINFO>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_FILLER1>'+ltrim(rtrim(isnull(filler1,'')))+'</APP_FILLER1>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_FILLER2>'+ltrim(rtrim(isnull(filler2,'')))+'</APP_FILLER2>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_FILLER3>'+ltrim(rtrim(isnull(filler3,'')))+'</APP_FILLER3>'
									from #CVLMainindividual where Autoid=@Staticloopcounter
									union all
									select '</KYCDATA>'
									update Master_KYCMain set KYCMain_ExportDateTime=GETDATE(),
									KYCMain_BatchNumber=@BatchNumber,KYCMain_ExportUser=@Userid,KYCMain_KRAID=@KycRAID
									from #CVLMainindividual where KYCMain_ID=kycmainid and Autoid=@Staticloopcounter
									Select @Staticloopcounter=@Staticloopcounter+1
								End
							insert into #MainExport
							
							select'<FOOTER>'
							union all
							select'<NO_OF_KYC_RECORDS>'+ISNULL(cast(@Maxloopcounter as varchar(max)),'')+'</NO_OF_KYC_RECORDS>'
							union all
							select'<NO_OF_ADDLDATA_RECORDS>'+''+'</NO_OF_ADDLDATA_RECORDS>'
							union all
							select'</FOOTER>'
							union all
							select'</ROOT>'
							exec [Kra_Export_Fetch] @fromdate,@todate,'','','A',@Userid,@Company ,@Clienttype,@Exporttype,'Screen',@IMType,@BatchNumber
							select * from #MainExport
							select COUNT(Autoid) from #CVLMainindividual
						End------------Indivudual CVL End
					Else
						Begin
							Create Table #CVLMainnonindividual 
							(Autoid int identity,updateflag char(2),poscode varchar(20),entitytype char(1),Appno varchar(20), Appdate varchar(10),Panno varchar(20),
							Pancopyflag char(1),panexempt char(1),panexemtcategory char(2),proofid char(2),Inpersonverification char(1),Inpersonverificationdate varchar(10),
							Gender char(1),Appname varchar(100),Fathername varchar(100),Regnumber varchar(50),Incorpordateofbirth varchar(10),commencementdt varchar(10),
							Nationality char(2),Nationalityoth char(3),companystatus char(2),companystatusoth varchar(100),ResidentialINDstatus char(1),ResidentialNONINDstatus char(2),
							AadharorUid char(12),Coradd1 varchar(120),coradd2 varchar(120),coradd3 varchar(120),corrcity varchar(30),corpin char(10),corstate char(20),corcountry char(3),
							offcisd char(10),offcstd char(10),offcno char(20),resisd char(10),resstd char(10),resno char(20),mobileisd char(10),mobileno char(20),faxisd char(10),faxstd char(10),
							faxno char(20),emailid varchar(100),corraddproof char(2),corraddproofrefid varchar(100),corraddproofrefdate varchar(10),Addressflag char(1),peradd1 varchar(120),peradd2 varchar(120),
							peradd3 varchar(120),percity varchar(30),perpin char(20),perstate char(20),percountry char(3),peraddproof char(2),peraddproofrefid varchar(100),peraddproofrefdate varchar(10),grossannualincome char(2),
							occupationdetail char(2),occupationdetailoth varchar(50),polconnection char(4),docsubmissiondetail char(1),refno varchar(20),barnchcode char(10),maritalstatus char(2),networth numeric(30,2),networthdate varchar(10),
							incorporationplace varchar(100),Anyothinfo varchar(100),filler1 char(20),filler2 char(20),filler3 char(20),kycmainid bigint)
							
							Create Table #CVLpartnerdetail
							(Pautoid int identity,Pupdateflag char(2),Pmasterpan char(20),Pdetailpan char(20),Pdirectorname varchar(100),Pdinuid char(20),
							Prelationship char(2),Ppolconnection char(4),Pfiller1 char(20),Pfiller2 char(20),Pfiller3 char(20),Pmainid bigint)
							
							insert into #CVLMainnonindividual
							select '01',----1
							@cvlimid,----2
							'N',---3
							isnull(KYCMain_ApplicationNumber,''),----4
							isnull(CONVERT(VARCHAR(10),KYCMain_ApplicationDate,103),''),----5
							ISNULL(KYCMain_PAN,''),---6
							case when KYCMain_PANExempt='N' then 'Y' else 'N' end,----7
							isnull(KYCMain_PANExempt,''),----8
							case when KYCMain_PANExempt='N' then '' else
							(select top 1 isnull(KRAStaticData_Value,'') from Master_PANExemptCategory,Config_KRAStaticData
							where KRAStaticData_ID=PanExemptCategory_CVLID and KRAStaticData_Type='PanExemptCategory'
							and KYCMain_PanExemptProof=PanExemptCategory_ID and KRAStaticData_KRAId=1) end,----------9
							case when KYCMain_IdentityProof<>'99' then
							(select top 1 krastaticdata_code from Master_IdentityProof,Config_KRAStaticData where KRAStaticData_ID=IdentityProof_DotExID and KRAStaticData_Type='IdentityProof'
							and KYCMain_IdentityProof=identityproof_id) else '99' end,--------10
							'',---------11
							'',---------12
							'',---------13
							ISNULL(KYCMain_FirstName,'')+' '+isnull(KYCMain_MiddleName,'')+' '+ISNULL(KYCMain_LastName,''),-----14
							'',----15
							ISNULL(KYCMain_CompRegn,''),--------16
							isnull(CONVERT(VARCHAR(10),KYCMain_DateOfInCorp,103),''),---------17
							isnull(CONVERT(VARCHAR(10),KYCMain_BusinessComDate,103),''),----------18
							'',--------19
							'',---------20
							case when KYCMain_TaxStatus<>'99' then 
							(select top 1 isnull(KRAStaticData_Code,' ') from tbl_master_legalStatus,Config_KRAStaticData
							where KRAStaticData_ID=lgl_CVLID and KRAStaticData_Type='NonIndividualStatus' 
							and KYCMain_TaxStatus=lgl_id and KRAStaticData_KRAId=1) else '' end,-------21taxstatus
							Case when KYCMain_TaxStatus='99' then 
							left(ISNULL(KYCMain_TaxStatusCompOther,''),75) 
							else '' end,-------22
							'',------23
							'',----24
							'',------25
							ISNULL(KYCMain_CAddress1,''),------26
							ISNULL(KYCMain_CAddress2,''),------27
							ISNULL(KYCMain_CAddress3,''),------28
							(select ISNULL(city_name,'')from tbl_master_city where city_id=KYCMain_CCity),------29
							isnull(KYCMain_CPin,''),------30
							(select top 1 krastaticdata_code from tbl_master_state,Config_KRAStaticData where KRAStaticData_ID=State_CVLID 
							and KRAStaticData_Type='State' and KYCMain_CState=id and KRAStaticData_KRAId=1),------31
							(select top 1 KRAStaticData_Code from tbl_master_country,Config_KRAStaticData where KRAStaticData_ID=Country_CVLID 
							and KRAStaticData_Type='Country'
							and KYCMain_CCountry=cou_id and KRAStaticData_KRAId=1),------32
							ISNULL(KYCMain_OPhoneISD,''),------33
							ISNULL(KYCMain_OPhoneSTD,''),------34
							ISNULL(KYCMain_OPhone,''),------35
							ISNULL(KYCMain_RPhoneISD,''),------36
							ISNULL(KYCMain_RPhoneSTD,''),------37
							ISNULL(KYCMain_RPhone,''),------38
							ISNULL(KYCMain_MobileISD,''),------39
							ISNULL(KYCMain_Mobile,''),------40
							ISNULL(KYCMain_FaxISD,''),------41
							ISNULL(KYCMain_FaxSTD,''),------42
							ISNULL(KYCMain_Fax,''),------43
							ISNULL(KYCMain_EmailID,''),----44
							(select top 1 KRAStaticData_Code from Master_AddressProof,Config_KRAStaticData
							where KRAStaticData_ID=AddressProof_CVLID and KRAStaticData_Type='AddressProof' 
							and KYCMain_CAddressProof=AddressProof_ID and KRAStaticData_KRAId=1),--45
							'',--------46
							'',----------47
							isnull(KYCMain_CPSame,''),----------48
							ISNULL(KYCMain_PAddress1,''),------49
							ISNULL(KYCMain_PAddress2,''),------50
							ISNULL(KYCMain_PAddress3,''),------51
							(select ISNULL(city_name,'')from tbl_master_city where city_id=KYCMain_PCity),------52
							isnull(KYCMain_PPin,''),------53
							(select top 1 krastaticdata_code from tbl_master_state,Config_KRAStaticData where KRAStaticData_ID=State_CVLID 
							and KRAStaticData_Type='State' and KYCMain_PState=id and KRAStaticData_KRAId=1),------54
							(select top 1 KRAStaticData_Code from tbl_master_country,Config_KRAStaticData where KRAStaticData_ID=Country_CVLID 
							and KRAStaticData_Type='Country'
							and KYCMain_PCountry=cou_id and KRAStaticData_KRAId=1),------55
							(select top 1 KRAStaticData_Code from Master_AddressProof,Config_KRAStaticData
							where KRAStaticData_ID=AddressProof_CVLID and KRAStaticData_Type='AddressProof' 
							and KYCMain_PAddressProof=AddressProof_ID and KRAStaticData_KRAId=1),--56
							'',---------57
							'',---------58
							(select top 1 isnull(KRAStaticData_Code,' ') from Master_AnnualIncome,Config_KRAStaticData
							where KRAStaticData_ID=AnnualIncome_CVLID and KRAStaticData_Type='Annual Income Code' 
							and KYCMain_GAIncome=AnnualIncome_ID and KRAStaticData_KRAId=1),--59
							'',--60
							'',--61
							'',--62
							'T',----63
							ISNULL(KYCMain_DocNo,''),----64
							'',----65
							'',---66
							isnull(KYCMain_NetWorth,0),---67
							isnull(CONVERT(VARCHAR(10),KYCMain_NetWorthDate,103),''),---------68
							--(select ISNULL(city_name,'')from tbl_master_city where city_id=KYCMain_PlaceOfInCorp)
							'',----69
							isnull(KYCMain_OtherInfo,''),----70
							'',---71
							'',---72
							'',----73
							KYCMain_ID----for internal use
							from Master_KYCMain
							where KYCMain_ID in (select col from dbo.fnSplitReturnTable(@ids,','))
							
							
							insert into #CVLpartnerdetail
							select '01',----1
							ISNULL(KYCMain_PAN,''),----2
							ISNULL(KYCDetail_PAN,''),----3 
							ISNULL(KYCDetail_Name,''),-----4
							ISNULL(KYCDetail_DinUid,''),----5
							Case when KYCDetail_Relationship<>'99' then 
							(select top 1 isnull(KRAStaticData_Code,'') from tbl_master_profession,Config_KRAStaticData
							where KRAStaticData_ID=PRO_CVLID and KRAStaticData_Type='NonIndividualStatus' 
							and KYCDetail_Relationship=pro_id) else '99' end,--5
							(select top 1 isnull(KRAStaticData_Code,' ') from Master_PoliticalConnection,Config_KRAStaticData
							where KRAStaticData_ID=PoliticalConnection_CVLID and KRAStaticData_Type='PoliticalConnection' 
							and KYCDetail_PeP=PoliticalConnection_ID),----6
							'',----7
							'',----8
							'',----9
							KYCMain_ID------for internal use
							from Master_KYCDetail,Master_KYCMain where KYCDetail_MainID in (select col from dbo.fnSplitReturnTable(@ids,','))
							and KYCMain_ID=KYCDetail_MainID
							insert into #MainExport
							select '<ROOT>'
							union all
							select'<HEADER>'
							union all
							select'<COMPANY_CODE>'+ltrim(rtrim(isnull(@cvlimid,'')))+'</COMPANY_CODE>'
							union all
							select'<BATCH_DATE>'+ltrim(rtrim(isnull(CONVERT(VARCHAR(10),GETDATE(),103),'')))+'</BATCH_DATE>'
							union all
							select'</HEADER>'
							
							select @Maxloopcounter=MAX(Autoid) from #CVLMainnonindividual
							set @Staticloopcounter=1
							while(@Staticloopcounter<=@Maxloopcounter)
								begin
									insert into #MainExport
									select '<KYCDATA>'
									union all
									select'<APP_UPDTFLG>'+ltrim(rtrim(isnull(updateflag,'')))+'</APP_UPDTFLG>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_POS_CODE>'+ltrim(rtrim(isnull(poscode,'')))+'</APP_POS_CODE>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_TYPE>'+ltrim(rtrim(isnull(entitytype,'')))+'</APP_TYPE>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_NO>'+ltrim(rtrim(isnull(Appno,'')))+'</APP_NO>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_DATE>'+ltrim(rtrim(isnull(Appdate,'')))+'</APP_DATE>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PAN_NO>'+ltrim(rtrim(isnull(Panno,'')))+'</APP_PAN_NO>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PAN_COPY>'+ltrim(rtrim(isnull(Pancopyflag,'')))+'</APP_PAN_COPY>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_EXMT>'+ltrim(rtrim(isnull(panexempt,'')))+'</APP_EXMT>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									
									
									union all
									select '<APP_EXMT_CAT>'+ltrim(rtrim(isnull(panexemtcategory,'')))+'</APP_EXMT_CAT>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_EXMT_ID_PROOF>'+ltrim(rtrim(isnull(proofid,'')))+'</APP_EXMT_ID_PROOF>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_IPV_FLAG>'+ltrim(rtrim(isnull(Inpersonverification,'')))+'</APP_IPV_FLAG>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_IPV_DATE>'+ltrim(rtrim(isnull(Inpersonverificationdate,'')))+'</APP_IPV_DATE>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_GEN>'+ltrim(rtrim(isnull(Gender,'')))+'</APP_GEN>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_NAME>'+ltrim(rtrim(isnull(Appname,'')))+'</APP_NAME>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_F_NAME>'+ltrim(rtrim(isnull(Fathername,'')))+'</APP_F_NAME>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_REGNO>'+ltrim(rtrim(isnull(Regnumber,'')))+'</APP_REGNO>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_DOB_INCORP>'+ltrim(rtrim(isnull(Incorpordateofbirth,'')))+'</APP_DOB_INCORP>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COMMENCE_DT>'+ltrim(rtrim(isnull(commencementdt,'')))+'</APP_COMMENCE_DT>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_NATIONALITY>'+ltrim(rtrim(isnull(Nationality,'')))+'</APP_NATIONALITY>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OTH_NATIONALITY>'+ltrim(rtrim(isnull(Nationalityoth,'')))+'</APP_OTH_NATIONALITY>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COMP_STATUS>'+ltrim(rtrim(isnull(companystatus,'')))+'</APP_COMP_STATUS>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OTH_COMP_STATUS>'+ltrim(rtrim(isnull(companystatusoth,'')))+'</APP_OTH_COMP_STATUS>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_RES_STATUS>'+ltrim(rtrim(isnull(ResidentialINDstatus,'')))+'</APP_RES_STATUS>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_RES_STATUS_PROOF>'+ltrim(rtrim(isnull(ResidentialNONINDstatus,'')))+'</APP_RES_STATUS_PROOF>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_UID_NO>'+ltrim(rtrim(isnull(AadharorUid,'')))+'</APP_UID_NO>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_ADD1>'+ltrim(rtrim(isnull(Coradd1,'')))+'</APP_COR_ADD1>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_ADD2>'+ltrim(rtrim(isnull(coradd2,'')))+'</APP_COR_ADD2>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_ADD3>'+ltrim(rtrim(isnull(coradd3,'')))+'</APP_COR_ADD3>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_CITY>'+ltrim(rtrim(isnull(corrcity,'')))+'</APP_COR_CITY>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_PINCD>'+ltrim(rtrim(isnull(corpin,'')))+'</APP_COR_PINCD>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_STATE>'+ltrim(rtrim(isnull(corstate,'')))+'</APP_COR_STATE>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_CTRY>'+ltrim(rtrim(isnull(corcountry,'')))+'</APP_COR_CTRY>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OFF_ISD>'+ltrim(rtrim(isnull(offcisd,'')))+'</APP_OFF_ISD>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OFF_STD>'+ltrim(rtrim(isnull(offcstd,'')))+'</APP_OFF_STD>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OFF_NO>'+ltrim(rtrim(isnull(offcno,'')))+'</APP_OFF_NO>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_RES_ISD>'+ltrim(rtrim(isnull(resisd,'')))+'</APP_RES_ISD>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_RES_STD>'+ltrim(rtrim(isnull(resstd,'')))+'</APP_RES_STD>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_RES_NO>'+ltrim(rtrim(isnull(resno,'')))+'</APP_RES_NO>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_MOB_ISD>'+ltrim(rtrim(isnull(mobileisd,'')))+'</APP_MOB_ISD>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_MOB_NO>'+ltrim(rtrim(isnull(mobileno,'')))+'</APP_MOB_NO>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_FAX_ISD>'+ltrim(rtrim(isnull(faxisd,'')))+'</APP_FAX_ISD>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_FAX_STD>'+ltrim(rtrim(isnull(faxstd,'')))+'</APP_FAX_STD>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_FAX_NO>'+ltrim(rtrim(isnull(faxno,'')))+'</APP_FAX_NO>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_EMAIL>'+ltrim(rtrim(isnull(emailid,'')))+'</APP_EMAIL>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_ADD_PROOF>'+ltrim(rtrim(isnull(corraddproof,'')))+'</APP_COR_ADD_PROOF>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_ADD_REF>'+ltrim(rtrim(isnull(corraddproofrefid,'')))+'</APP_COR_ADD_REF>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_COR_ADD_DT>'+ltrim(rtrim(isnull(corraddproofrefdate,'')))+'</APP_COR_ADD_DT>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_ADD_FLAG>'+ltrim(rtrim(isnull(Addressflag,'')))+'</APP_PER_ADD_FLAG>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_ADD1>'+ltrim(rtrim(isnull(peradd1,'')))+'</APP_PER_ADD1>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_ADD2>'+ltrim(rtrim(isnull(peradd2,'')))+'</APP_PER_ADD2>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_ADD3>'+ltrim(rtrim(isnull(peradd3,'')))+'</APP_PER_ADD3>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_CITY>'+ltrim(rtrim(isnull(percity,'')))+'</APP_PER_CITY>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_PINCD>'+ltrim(rtrim(isnull(perpin,'')))+'</APP_PER_PINCD>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_STATE>'+ltrim(rtrim(isnull(perstate,'')))+'</APP_PER_STATE>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_CTRY>'+ltrim(rtrim(isnull(percountry,'')))+'</APP_PER_CTRY>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_ADD_PROOF>'+ltrim(rtrim(isnull(peraddproof,'')))+'</APP_PER_ADD_PROOF>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_ADD_REF>'+ltrim(rtrim(isnull(peraddproofrefid,'')))+'</APP_PER_ADD_REF>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_PER_ADD_DT>'+ltrim(rtrim(isnull(peraddproofrefdate,'')))+'</APP_PER_ADD_DT>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_INCOME>'+ltrim(rtrim(isnull(grossannualincome,'')))+'</APP_INCOME>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OCC>'+ltrim(rtrim(isnull(occupationdetail,'')))+'</APP_OCC>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OTH_OCC>'+ltrim(rtrim(isnull(occupationdetailoth,'')))+'</APP_OTH_OCC>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_POL_CONN>'+ltrim(rtrim(isnull(polconnection,'')))+'</APP_POL_CONN>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_DOC_PROOF>'+ltrim(rtrim(isnull(docsubmissiondetail,'')))+'</APP_DOC_PROOF>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_INTERNAL_REF>'+ltrim(rtrim(isnull(refno,'')))+'</APP_INTERNAL_REF>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_BRANCH_CODE>'+ltrim(rtrim(isnull(barnchcode,'')))+'</APP_BRANCH_CODE>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_MAR_STATUS>'+ltrim(rtrim(isnull(maritalstatus,'')))+'</APP_MAR_STATUS>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_NETWRTH>'+ltrim(rtrim(isnull(cast(networth as varchar(max)),0)))+'</APP_NETWRTH>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_NETWORTH_DT>'+ltrim(rtrim(isnull(networthdate,'')))+'</APP_NETWORTH_DT>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_INCORP_PLC>'+ltrim(rtrim(isnull(incorporationplace,'')))+'</APP_INCORP_PLC>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_OTHERINFO>'+ltrim(rtrim(isnull(Anyothinfo,'')))+'</APP_OTHERINFO>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_FILLER1>'+ltrim(rtrim(isnull(filler1,'')))+'</APP_FILLER1>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_FILLER2>'+ltrim(rtrim(isnull(filler2,'')))+'</APP_FILLER2>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '<APP_FILLER3>'+ltrim(rtrim(isnull(filler3,'')))+'</APP_FILLER3>'
									from #CVLMainnonindividual where Autoid=@Staticloopcounter
									union all
									select '</KYCDATA>'
									select @MainId=kycmainid from #CVLMainnonindividual where Autoid=@Staticloopcounter
									select @Maxloopdotexcounter=COUNT(Pmainid) from #CVLpartnerdetail where Pmainid=@MainId
									select @Staticdotexloopcounter=1
									declare @srlcounter bigint
									while(@Staticdotexloopcounter<=@Maxloopdotexcounter)
										Begin
											select @srlcounter=Pautoid from #CVLpartnerdetail where Pmainid=@MainId
											insert into #MainExport
											select '<ADDITIONALDATA>'
											union all
											select '<APP_ADDLDATA_UPDTFLG>'+ltrim(rtrim(isnull(Pupdateflag,'')))+'</APP_ADDLDATA_UPDTFLG>'
											from #CVLpartnerdetail where Pautoid=@srlcounter and Pmainid=@MainId
											union all
											select'<APP_ENTITY_PAN>'+ltrim(rtrim(isnull(Pmasterpan,'')))+'</APP_ENTITY_PAN>'
											from #CVLpartnerdetail where Pautoid=@srlcounter and Pmainid=@MainId
											union all
											select '<APP_ADDLDATA_PAN>'+ltrim(rtrim(isnull(Pdetailpan,'')))+'</APP_ADDLDATA_PAN>'
											from #CVLpartnerdetail where Pautoid=@srlcounter and Pmainid=@MainId
											union all
											select '<APP_ADDLDATA_NAME>'+ltrim(rtrim(isnull(Pdirectorname,'')))+'</APP_ADDLDATA_NAME>'
											from #CVLpartnerdetail where Pautoid=@srlcounter and Pmainid=@MainId
											union all
											select '<APP_ADDLDATA_DIN_UID>'+ltrim(rtrim(isnull(Pdinuid,'')))+'</APP_ADDLDATA_DIN_UID>'
											from #CVLpartnerdetail where Pautoid=@srlcounter and Pmainid=@MainId
											union all
											select '<APP_ADDLDATA_RELATIONSHIP>'+ltrim(rtrim(isnull(Prelationship,'')))+'</APP_ADDLDATA_RELATIONSHIP>'
											from #CVLpartnerdetail where Pautoid=@srlcounter and Pmainid=@MainId
											union all
											select '<APP_ADDLDATA_POLCONN>'+ltrim(rtrim(isnull(Ppolconnection,'')))+'</APP_ADDLDATA_POLCONN>'
											from #CVLpartnerdetail where Pautoid=@srlcounter and Pmainid=@MainId
											union all
											select '<APP_ADDLDATA_FILLER1>'+ltrim(rtrim(isnull(Pfiller1,'')))+'</APP_ADDLDATA_FILLER1>'
											from #CVLpartnerdetail where Pautoid=@srlcounter and Pmainid=@MainId
											union all
											select '<APP_ADDLDATA_FILLER2>'+ltrim(rtrim(isnull(Pfiller2,'')))+'</APP_ADDLDATA_FILLER2>'
											from #CVLpartnerdetail where Pautoid=@srlcounter and Pmainid=@MainId
											union all
											select '<APP_ADDLDATA_FILLER3>'+ltrim(rtrim(isnull(Pfiller3,'')))+'</APP_ADDLDATA_FILLER3>'
											from #CVLpartnerdetail where Pautoid=@srlcounter and Pmainid=@MainId
											union all
											select '</ADDITIONALDATA>'
											
											set @Staticdotexloopcounter=@Staticdotexloopcounter+1
											set @srlcounter=@srlcounter+1
										end
									update Master_KYCMain set KYCMain_ExportDateTime=GETDATE(),
									KYCMain_BatchNumber=@BatchNumber,KYCMain_ExportUser=@Userid,KYCMain_KRAID=@KycRAID
									from #CVLMainnonindividual where KYCMain_ID=kycmainid and Autoid=@Staticloopcounter
									Select @Staticloopcounter=@Staticloopcounter+1
								End
							insert into #MainExport
							
							select'<FOOTER>'
							union all
							select'<NO_OF_KYC_RECORDS>'+ISNULL(cast(@Maxloopcounter as varchar(max)),'')+'</NO_OF_KYC_RECORDS>'
							union all
							select'<NO_OF_ADDLDATA_RECORDS>'+(select cast(COUNT(Pautoid) as varchar(max)) from #CVLpartnerdetail)+'</NO_OF_ADDLDATA_RECORDS>'
							union all
							select'</FOOTER>'
							union all
							select'</ROOT>'
							exec [Kra_Export_Fetch] @fromdate,@todate,'','','A',@Userid,@Company ,@Clienttype,@Exporttype,'Screen',@IMType,@BatchNumber
							select * from #MainExport
							select COUNT(Autoid) from #CVLMainnonindividual
							
						End------------CVL Nonindividual End
				End----------CVL END
						
			
				
			End-------------Export data End here
			---------------Fetch Batch number-------------------
								
		
End	
	




		

