
ALTER procedure [dbo].[TradeRegister]
@Companyid varchar(15),
@FromDate varchar(35),
@ToDate varchar(35),
@TradeType varchar(5),
@RptType varchar(50),
@BranchHierchy varchar(max),
@GrpType VARCHAR(20),
@GrpId VARCHAR(max),
@Clients varchar(max),
@TradeCategory varchar(20),
@Terminalid varchar(20),
@CtClid varchar(20),
@Scrip varchar(max),
@Segment varchar(30),
@Settno varchar(150),
@SettType varchar(150),
@TradeTime varchar(500),
@Parameter varchar(max),
@OrderBy varchar(10),
@SecurityType varchar(15),
@Header  varchar(max),
@Footer varchar(max),
@Broker varchar (5),
@groupbyvalue varchar(20)
AS
BEGIN
SET NOCOUNT ON

-----------------------------------------------------Notes---------------------------------------------------------------
----Note 1 : Adding New ReportType 'CntrScreen' That will Return Contract No Detail And The Trade Detail (2014-05-14)
---Where @RptType='CntrScreen~1' Here 1 is a ContractNo. You Can Pass 'All' inspite of 1.

----Note 2 : Adding FOIdentifier filter Option in @Scrip variable
------------Where @Scrip='123,234,345,456,568~FUTSTK,OPTIDX,FUTIDX.OPTSTK'
				----------[customertrades_ProductSereiesID(@Scrip)]~[Equity_FOIdentifier(@FOIdentifier)]----	  

----Note 3 : Adding Average View [AvgView] in Final Temp Table 
------------For Screen to Show Detail for Trade Average----

--------------------------------------------------------------------------------------------------------------------------
Declare @SqlSelect varchar(max),@SqlWhere varchar(max),@ContractNo Varchar(10),@CustomisedRptType Varchar(20),@FOIdentifier Varchar(50)

Set @CustomisedRptType=dbo.fnSplit(@RptType,'~',1)

if(@CustomisedRptType='CntrScreen')---See Note 1.
Begin
	Set @ContractNo=dbo.fnSplit(@RptType,'~',2)
	Set @RptType=@CustomisedRptType
End
---------------Start Note 2-----------------------------------------

Set @FOIdentifier=''
Set @FOIdentifier=dbo.fnSplit(@Scrip,'~',2)
Set @Scrip=dbo.fnSplit(@Scrip,'~',1)
if( @FOIdentifier<>'')
	Begin
		Declare @FOSegID varchar(50),@CMSegID varchar(50),@FilteredScrip varchar(max)
		
		select @CMSegID=coalesce(@FOSegID+',','')+Convert(varchar,exch_internalId) 
		from tbl_master_companyExchange where exch_segmentId='CM'
		and exch_internalId in(select col from dbo.fnSplitReturnTable(@Segment,','))
		
		select @FOSegID=coalesce(@FOSegID+',','')+Convert(varchar,exch_internalId) 
		from tbl_master_companyExchange where exch_segmentId='FO'
		and exch_internalId in(select col from dbo.fnSplitReturnTable(@Segment,','))

		if(@Scrip='ALL')
			Begin
				
				Select @FilteredScrip=coalesce(@FilteredScrip+',','')+Convert(varchar,Equity_SeriesID) 
				From (Select Equity_SeriesID From 
							(Select CustomerTrades_ProductSeriesID Equity_SeriesID From Trans_CustomerTrades
							Where CustomerTrades_CompanyID=@Companyid
									and CustomerTrades_TradeDate between @FromDate and @ToDate
									and CustomerTrades_ExchangeSegment in (select col from dbo.fnSplitReturnTable(@CMSegID,','))			
							) CMSeriesIDFromCustomerTrades
				
						Union All	
				
					Select Equity_SeriesID From 
							(Select CustomerTrades_ProductSeriesID From Trans_CustomerTrades
							Where CustomerTrades_CompanyID=@Companyid
									and CustomerTrades_TradeDate between @FromDate and @ToDate
									and CustomerTrades_ExchangeSegment in (select col from dbo.fnSplitReturnTable(@FOSegID,','))			
							) FOSeriesIDFromCustomerTrades
							
							inner join
							
							(Select Equity_SeriesID From master_equity 
							 where Equity_FOIdentifier in (select col from dbo.fnSplitReturnTable(@FOIdentifier,','))
								and Equity_ExchSegmentID in 
									(Select 
											(Select ExchangeSegment_ID From Master_ExchangeSegments 
												Where ExchangeSegment_ExchangeID=Exchange_ID 
														and ExchangeSegment_Code=Exch_SegmentID
											) 
									 from (Select Exch_CompID,Exch_InternalID,Exh_ShortName,Exch_SegmentID 
											from Tbl_Master_Exchange,Tbl_Master_CompanyExchange 
											Where Exh_CntId=Exch_ExchID
										  ) as T1,Master_Exchange
									 Where Exchange_ShortName=Exh_ShortName
											and Exch_SegmentID='FO'
											and Exch_CompID=@Companyid)
							) FOSeriesIDFromEquity
							
							on CustomerTrades_ProductSeriesID=Equity_SeriesID
							
					) AllEquity
				
				Set @Scrip=@FilteredScrip	
-----Select @Scrip AllScrip									
			End
		Else
			Begin
		
				Select @FilteredScrip=coalesce(@FilteredScrip+',','')+Convert(varchar,Equity_SeriesID) 
				From ----FO filtered Series ID with FOIdentifier-----
				(Select distinct Equity_SeriesID From master_equity 
				 where Equity_FOIdentifier in (select col from dbo.fnSplitReturnTable(@FOIdentifier,','))
					and Equity_ExchSegmentID in (Select 
														(Select ExchangeSegment_ID 
														 From Master_ExchangeSegments 
														 Where ExchangeSegment_ExchangeID=Exchange_ID 
																and ExchangeSegment_Code=Exch_SegmentID
														) 
												 from
														(Select Exch_CompID,Exch_InternalID,Exh_ShortName,Exch_SegmentID 
														from Tbl_Master_Exchange,Tbl_Master_CompanyExchange 
														Where Exh_CntId=Exch_ExchID) as T1,Master_Exchange
												Where Exchange_ShortName=Exh_ShortName
														and Exch_SegmentID='FO'
														and Exch_CompID=@Companyid
												)----exchange
					and Equity_SeriesID in (select col from dbo.fnSplitReturnTable(@Scrip,','))
												
				Union ALL
					----CM Filtered Series IDS----------
				Select Equity_SeriesID From master_equity 
				where Equity_ExchSegmentID in (Select 
														(Select ExchangeSegment_ID From Master_ExchangeSegments 
														 Where ExchangeSegment_ExchangeID=Exchange_ID 
																and ExchangeSegment_Code=Exch_SegmentID) 
													from
														(Select Exch_CompID,Exch_InternalID,Exh_ShortName,Exch_SegmentID 
														 from Tbl_Master_Exchange,Tbl_Master_CompanyExchange 
														 Where Exh_CntId=Exch_ExchID) as T1,Master_Exchange
													Where Exchange_ShortName=Exh_ShortName
														and Exch_SegmentID='CM'
														and Exch_CompID=@Companyid)----exchange
					and Equity_SeriesID in (select col from dbo.fnSplitReturnTable(@Scrip,','))
				)  Equity			
				
				Set @Scrip=@FilteredScrip
-----Select @Scrip FilteredScrip				
			End
	End
	
---------------End Note 2-----------------------------------------

---------------------------------------Temp Table Creation Begin
---------------CustomerTrades Fetch
Create Table #TbCustomertrades(CustTransactionid varchar(30),OriginalCustTransactionid varchar(30),Date datetime,
Segmentid varchar(20),SegmentName varchar(15),SettNo varchar(15),
Customerid varchar(15),Productid varchar(20),CustomerName varchar(150),ScripName varchar(150),
MktPrice numeric(28,4),BuyQty numeric(28,0),SaleQty numeric(28,0),BrkgType varchar(8),
UnitBrkg numeric(28,4),TotBrkg numeric(28,2),SrvTaxBrkg numeric(28,2),SrvTaxMode varchar(3)
,NetRatePerUnit numeric(28,4),NetAmnt numeric(28,2),NetValue numeric(28,2),
OrderNumber varchar(20),OrderEntryTime varchar(20),TradeNumber varchar(20),TradeEntryTime Datetime,
ExchCustomerUcc varchar(15),Terminalid varchar(20),CntrNo varchar(30),
Grpid varchar(20),GrpName varchar(150),GrpEmail varchar(100),
TabName varchar(150),StatusOrder int,SecurityType varchar(15))
--------------Exchange Details Fetch
Create Table #TbExchange(CustId varchar(40),ExchUcc varchar(30),OrderNo varchar(30),
						TradeNo varchar(30),EntryTime Datetime,OrderEntry varchar(30),Scrip varchar(150),
						Terminal varchar(30))
---------------------------------------Temp Table Creation End
------------All Record Fetch From CustomerTrades
Select @SqlSelect='Select CustomerTrades_ID,CustomerTrades_OriginalTransactionID,CustomerTrades_TradeDate
,convert(varchar(11),CustomerTrades_TradeDate,106)
,CustomerTrades_ExchangeSegment
,(Case When EXCH_EXCHID=''EXN0000002'' And EXCH_SEGMENTID=''CM'' Then ''NSE-CM''
	   When EXCH_EXCHID=''EXN0000002'' And EXCH_SEGMENTID=''FO'' Then ''NSE-FO''
	   When EXCH_EXCHID=''EXB0000001'' And EXCH_SEGMENTID=''CM'' Then ''BSE-CM''
	   When EXCH_EXCHID=''EXB0000001'' And EXCH_SEGMENTID=''FO'' Then ''BSE-FO''
	   When EXCH_EXCHID=''EXC0000001'' And EXCH_SEGMENTID=''CM'' Then ''CSE-CM''
	   When EXCH_EXCHID=''EXM0000002'' And EXCH_SEGMENTID=''CM'' Then ''MCXSX-CM''
	   When EXCH_EXCHID=''EXM0000002'' And EXCH_SEGMENTID=''FO'' Then ''MCXSX-FO''
	   Else Null End)
,CustomerTrades_SettlementNumber+CustomerTrades_SettlementType
,CustomerTrades_CustomerID
,CustomerTrades_ProductSeriesID
,CustomerTrades_UnitPrice
,Case When CustomerTrades_UnitPriceQuantity<0 Then Abs(CustomerTrades_UnitPriceQuantity) Else 0 End
,Case When CustomerTrades_UnitPriceQuantity>0 Then Abs(CustomerTrades_UnitPriceQuantity) Else 0 End
,Case When CustomerTrades_BrokerageType=''D'' Then ''Dlv'' 
	  When CustomerTrades_BrokerageType=''S'' Then ''Sqr'' 
	  Else CustomerTrades_BrokerageType End
,CustomerTrades_UnitBrokerage
,CustomerTrades_TotalBrokerage
,(isnull(CustomerTrades_ServiceTaxOnBrkg,0)+isnull(CustomerTrades_EduCessOnBrkg,0)+isnull(CustomerTrades_HgrEduCessOnBrkg,0))
,CustomerTrades_ServiceTaxMode
,CustomerTrades_NetRatePerUnit
,isnull(CustomerTrades_NetValue,0)
,Case When CustomerTrades_ServiceTaxMode=''E'' Then 
	  isnull(CustomerTrades_NetValue,0)-(isnull(CustomerTrades_ServiceTaxOnBrkg,0)+isnull(CustomerTrades_EduCessOnBrkg,0)+isnull(CustomerTrades_HgrEduCessOnBrkg,0))
	  Else isnull(CustomerTrades_NetValue,0) End
,CustomerTrades_Contractnotenumber
,(isnull(rtrim(cnt_firstName),'''') +'' ''+isnull(rtrim(cnt_middleName),'''')+'' ''+isnull(rtrim(cnt_lastName),''''))+''[''+rtrim(cnt_UCC)+'']''
'
If(@GrpType IN ('BRANCH','BRANCHGROUP'))
	Begin
		Select @SqlSelect=@SqlSelect+' 
						   ,branch_id
						   ,isnull(rtrim(branch_description),'+char(39)+''+char(39)+')+'' [''+isnull(rtrim(branch_code),'+char(39)+''+char(39)+')+'']''
						   ,branch_cpEmail'
	End
Else 
	Begin
		Select @SqlSelect=@SqlSelect+' 
						   ,gpm_id
						   ,isnull(rtrim(GPM_DESCRIPTION),'+char(39)+''+char(39)+')+'' [''+isnull(rtrim(GPM_CODE),'+char(39)+''+char(39)+')+'']''
						   ,gpm_emailID'
	End

Select @SqlWhere=',3 From Trans_CustomerTrades,Tbl_Master_Contact,Tbl_Master_CompanyExchange,'
IF(@GrpType='BRANCH')
Begin
	Select @SqlWhere=@SqlWhere+'tbl_master_branch 
	where cnt_branchid=branch_id'
	IF(@GrpId<>'ALL')
	Begin
		Select @SqlWhere=@SqlWhere+' AND cnt_branchid IN ('+@GrpId+')'	
	End
End
Else IF(@GrpType='BRANCHGROUP')
Begin
	Select @SqlWhere=@SqlWhere+'tbl_master_branch  
	where cnt_branchid=branch_id '
	IF(@GrpId<>'ALL')
	Begin
		Select @SqlWhere=@SqlWhere+' AND cnt_branchid in(select distinct branchgroupmembers_branchid 
						   from trans_branchgroupmembers where 
						   branchgroupmembers_branchgroupid in('+@GrpId+'))'	
	End
	Else 
	Begin
		Select @SqlWhere=@SqlWhere+' AND cnt_branchid in(select distinct branchgroupmembers_branchid 
						   from trans_branchgroupmembers)'	
	End
End
Else
Begin
	Select @SqlWhere=@SqlWhere+'tbl_master_groupmaster,tbl_trans_group
	where cnt_internalid=grp_contactid
	AND gpm_type='''+@GrpType+'''
	AND grp_groupmaster=gpm_id
	AND GRP_GROUPTYPE='''+@GrpType+''''
	If @GrpId<>'ALL'
	Begin
		Select @SqlWhere=@SqlWhere+' and gpm_id in ('+@GrpId+')'
	End
End
Select @SqlWhere=@SqlWhere+'
AND CustomerTrades_ExchangeSegment=EXCH_INTERNALID and CustomerTrades_CustomerID=cnt_internalid
AND exch_compid='''+@Companyid+'''
AND cnt_BranchID IN ('+@BranchHierchy+')
AND ISNULL(Customertrades_Tradecategory,''NOR'') Not IN (''ARS'',''ART'',''CFS'',''CFT'')
AND CustomerTrades_TradeDate between  '''+@FromDate+''' and '''+@ToDate+''''
If @TradeType='0'-----Trade Type :Only Delivery
Begin
	 Select @SqlWhere=@SqlWhere+' and (CustomerTrades_NDIdentifier<>''Y'' or CustomerTrades_NDIdentifier is null)'
End
If @TradeType='1'-----Trade Type :Only ND
Begin
	 Select @SqlWhere=@SqlWhere+' and CustomerTrades_NDIdentifier=''Y'''
End
If @TradeType='2'-----Trade Type :Only Confirmed
Begin
	 Select @SqlWhere=@SqlWhere+' and CustomerTrades_CustodianTradeIdentifier=''Y'''
End
If @TradeType='4'-----Trade Type :Show Only Zero Brkg Trades
Begin
	 Select @SqlWhere=@SqlWhere+'	and CustomerTrades_TotalBrokerage=0
									and ISNULL(CustomerTrades_TradeCategory,''NOR'') NOT IN (''CFS'',''CFT'',''ARS'',''ART'',''AUC'')
									and isnull(cnt_clienttype,''Retail'')<>''Pro Trading'''
End 
If @TradeCategory='Only Null' ----------Trade Category :Only Null
Begin
	 Select @SqlWhere=@SqlWhere+' and Customertrades_Tradecategory is null'
End
If @TradeCategory not in ('All','Only Null') ----------Trade Category :Selected 
Begin
	 Select @SqlWhere=@SqlWhere+' and Customertrades_Tradecategory like '''+@TradeCategory+'%'''
End
If @Clients<>'ALL'
Begin
	Select @SqlWhere=@SqlWhere+' and CustomerTrades_CustomerID IN('+ @Clients +')'
End
If @Clients='ALL'
Begin
	Select @SqlWhere=@SqlWhere+' and CustomerTrades_CustomerID like '''+@Broker+'%'''
End
--If @Broker<>'NA'
--Begin
--	Select @SqlWhere=@SqlWhere+' and CustomerTrades_CustomerID like '''+@Broker+'%'''
--End
If @Scrip<>'ALL'
Begin
	Select @SqlWhere=@SqlWhere+' and CustomerTrades_ProductSeriesID in ('+ @Scrip +')'
End
If @Settno<>'ALL'
Begin
	Select @SqlWhere=@SqlWhere+' and CustomerTrades_SettlementNumber in ('+ @Settno +') '
End
If @SettType<>'ALL'
Begin
	Select @SqlWhere=@SqlWhere+' and CustomerTrades_SettlementType in ('+ @SettType +') '
End
If @Segment<>'ALL'
Begin
	Select @SqlWhere=@SqlWhere+' and CustomerTrades_ExchangeSegment in ('+ @Segment +')'
End
Select @SqlWhere=@SqlWhere+' and CustomerTrades_COMPANYID ='''+@Companyid+''''
 Insert Into  #TbCustomertrades
(CustTransactionid,OriginalCustTransactionid,Date,TabName
,Segmentid,SegmentName,SettNo,Customerid,Productid,MktPrice,BuyQty,SaleQty,BrkgType
,UnitBrkg,TotBrkg,SrvTaxBrkg,SrvTaxMode,NetRatePerUnit,NetAmnt,NetValue,CntrNo,
 CustomerName,Grpid,GrpName,GrpEmail,StatusOrder)
 Exec (@SqlSelect+@SqlWhere)




--------------Exchange Details Fetch
SELECT @SqlSelect='SELECT  
ExchangeTrades_CUSTTRANSACTIONID,EXCHANGETRADES_CUSTOMERUCC,
ExchangeTrades_OrderNumber,ExchangeTrades_TradeNumber,
ExchangeTrades_TradeEntryTime,
convert(varchar(8),cast(ExchangeTrades_OrderEntryTime as datetime),114),
CASE WHEN isnull( ExchangeTrades_SecurityStrikePrice,0.0)=0.0 AND ExchangeTrades_SecurityExpiry IS NULL
THEN isnull(rtrim(ExchangeTrades_SecuritySymbol),'''')+'' ''+ISNULL(cast(ExchangeTrades_SecuritySeries as varchar(10)),ISNULL(ExchangeTrades_SECURITYCode,''''))
WHEN isnull(ExchangeTrades_SecurityStrikePrice,0.0)=0.0 AND ExchangeTrades_SecurityExpiry IS NOT NULL
THEN isnull(rtrim(ExchangeTrades_SecuritySymbol),'''')+'' ''+convert(varchar(9),ExchangeTrades_SecurityExpiry,6)+'' ''+ISNULL(cast(ExchangeTrades_SecuritySeries as varchar(10)),ISNULL(ExchangeTrades_SECURITYCode,''''))
ELSE isnull(rtrim(ExchangeTrades_SecuritySymbol),'''')+'' ''+convert(varchar(9),ExchangeTrades_SecurityExpiry,6)+'' ''+ISNULL(cast(ExchangeTrades_SecuritySeries as varchar(10)),ISNULL(ExchangeTrades_SECURITYCode,''''))+
	 '' ''+cast(cast(round(ExchangeTrades_SecurityStrikePrice,2) as numeric(28,2)) as varchar)  
END,EXCHANGETRADES_Terminalid From Trans_ExchangeTrades 
WHERE ExchangeTrades_Id in (	Select MIN(EXCHANGETRADES_ID)  From Trans_ExchangeTrades 
							    Where 
								 ExchangeTrades_TradeDate between  '''+@FromDate+''' and '''+@ToDate+''' 
								 and '+@TradeTime+''
		IF @Terminalid<>'ALL'
		BEGIN
		   SELECT @SqlSelect=@SqlSelect+' and ExchangeTrades_TERMINALID='''+@Terminalid+''''
		END
		IF @CtClid<>'ALL'
		BEGIN
		   SELECT @SqlSelect=@SqlSelect+' and ExchangeTrades_CTCLID='''+@CtClid+''''
		END
		IF @TradeType='0'-----Trade Type :Only Delivery
		BEGIN
		   SELECT @SqlSelect=@SqlSelect+' and (ExchangeTrades_NDFlag<>''Y'' or ExchangeTrades_NDFlag is null) '
		END
		IF @TradeType='1'-----Trade Type :Only ND
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' and ExchangeTrades_NDFlag=''Y'''
		END
		IF @TradeType='2'-----Trade Type :Only Confirmed
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' and and ExchangeTrades_CustodialFlag=''Y'' '
		END
		If @TradeCategory='Only Null' ----------Trade Category :Only Null
		Begin
			 SELECT @SqlSelect=@SqlSelect+' and ExchangeTrades_Tradecategory is null'
		End
		If @TradeCategory not in ('All','Only Null') ----------Trade Category :Selected 
		Begin
			 SELECT @SqlSelect=@SqlSelect+' and ExchangeTrades_Tradecategory like '''+@TradeCategory+'%'''
		End
		IF @Scrip<>'ALL'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+'  AND ExchangeTrades_ProductSeriesID in ('+ @Scrip +')'
		END
		IF @Settno <>'ALL'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' AND ExchangeTrades_SettlementNumber in ('+ @Settno +') '
		END
		IF @SettType<>'ALL'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' AND ExchangeTrades_SettlementType in ('+ @SettType +') '
		END
		IF @Segment<>'ALL'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' AND ExchangeTrades_Segment in ('+ @Segment +')'
		END
		SELECT @SqlSelect=@SqlSelect+' AND ExchangeTrades_COMPANYID ='''+@Companyid+'''
		Group By ExchangeTrades_CUSTTRANSACTIONID) '

Insert Into #TbExchange(CustId,ExchUcc,OrderNo,TradeNo,EntryTime,OrderEntry,Scrip,Terminal) 
exec(@SqlSelect)


------Update Record From #TbExchange Respect To CustTransactionid and Customertradeid
UPDATE #TbCustomertrades SET  ExchCustomerUcc=ExchUcc,OrderNumber=OrderNo,TradeNumber=TradeNo
							 ,TradeEntryTime=EntryTime
							 ,OrderEntryTime=OrderEntry,ScripName=Scrip,Terminalid=Terminal
From #TbExchange Where CustTransactionid =CustId AND OriginalCustTransactionid  is  null

------Update Record From #TbExchange Respect To CustTransactionid and OrginalTransactionId
UPDATE #TbCustomertrades SET  ExchCustomerUcc=ExchUcc,OrderNumber=OrderNo,TradeNumber=TradeNo
							 ,TradeEntryTime=EntryTime
							 ,OrderEntryTime=OrderEntry,ScripName=Scrip,Terminalid=Terminal
From #TbExchange Where CustId=OriginalCustTransactionid  AND OriginalCustTransactionid  is not null

----------------Security Fetch Begin
If @SecurityType='All'
Begin
	Update #TbCustomertrades Set SecurityType='Approved' From Trans_ApprovedSecurities
	Where ApprovedSecurities_ProductSeriesid=PRODUCTID
		
	Update #TbCustomertrades Set SecurityType='Illiquid' From Trans_IlliquidScrips
	Where IlliquidScrips_ProductSeriesID=PRODUCTID
End
If @SecurityType='Approved'
Begin
	Update #TbCustomertrades Set SecurityType='Approved' From Trans_ApprovedSecurities
	Where ApprovedSecurities_ProductSeriesid=PRODUCTID
		
	Delete From #TbCustomertrades Where SecurityType is null
End
If @SecurityType='UnApproved'
Begin
	Update #TbCustomertrades Set SecurityType='UnApproved' Where  ProductId 
	not in (Select Distinct ApprovedSecurities_ProductSeriesid From Trans_ApprovedSecurities)
	
	Delete From #TbCustomertrades Where SecurityType is null
End
If @SecurityType='Illiquid'
Begin
	Update #TbCustomertrades Set SecurityType='Illiquid' From Trans_IlliquidScrips
	Where IlliquidScrips_ProductSeriesID=PRODUCTID
		
	Delete From #TbCustomertrades Where SecurityType is null
End
If @SecurityType='liquid'
Begin
	Update #TbCustomertrades Set SecurityType='liquid' From Trans_IlliquidScrips
	Where IlliquidScrips_ProductSeriesID<>PRODUCTID
		
	Delete From #TbCustomertrades Where SecurityType is null
End
----------------Security Fetch End
If @RptType='PDF'--------------------------Report Type Only View In Pdf Begin
Begin
			Alter Table #TbCustomertrades Add Quantity numeric(28,0),CLIENTADDRESS1 varchar(150),CLIENTADDRESS2 varchar(150)

			update #TbCustomertrades set Quantity=CASE WHEN qty=0 THEN NULL ELSE QTY END from
			(Select Customerid as client,Productid  as product ,
			sum(isnull(SaleQty ,0)-isnull(BuyQty,0)) as qty
			From #TbCustomertrades Group By CustomerID,Productid ) as kk
			Where Customerid=client and Productid =product
			
			UPDATE #TbCustomertrades SET CLIENTADDRESS1=(select top 1 (isnull(rtrim(ltrim(add_address1)),'')+' '+isnull(rtrim(ltrim(add_address2)),''))),
							CLIENTADDRESS2=(select top 1 (isnull(rtrim(ltrim(add_address3)),'')+' '+isnull(rtrim(ltrim(add_pin)),'')+','+
											(select top 1 isnull(city_name,'') from tbl_master_city where city_id=add_city))) 

			FROM  tbl_master_address WHERE
			add_cntID=CustomerID AND add_entity='Customer/Client' AND 
			add_addressType=(select top 1 add_addressType from 
			(select add_addressType,
					case when rtrim(ltrim(add_addressType))='Correspondence' then 1
					when rtrim(ltrim(add_addressType))='Registered' then 2
					when rtrim(ltrim(add_addressType))='Residence' then 3
					else 4 end as addreorder
					from tbl_master_address where 
			add_cntID=CustomerID
			and add_entity='Customer/Client') tb
			order by addreorder)

			Select @SqlSelect='Select 
			(select Top 1(cmp_panNo) from tbl_master_company where cmp_internalid='''+@companyid+''')as cmppanno,
			isnull((Select top 1 phf_countryCode+''-''+phf_areaCode+''-''+phf_phoneNumber from tbl_master_phonefax where  PHF_TYPE=''Work'' AND phf_cntId='''+@companyid+'''),'''')as cmpphno,
			isnull((Select top 1 phf_countryCode+''-''+phf_areaCode+''-''+phf_phoneNumber from tbl_master_phonefax where  PHF_TYPE=''Fax'' AND phf_cntId='''+@companyid+'''),'''')as cmpfax,
			(select Top 1(eml_email) from tbl_master_email where eml_cntid='''+@companyid+''' and eml_type=''Official'')as cmpemail,
			(select Top 1(cmp_Name) from tbl_master_company where cmp_internalid='''+@companyid+''')as cmpname,
			
			(select top 1(isnull(add_address1,'' '')+'' ''+
						isnull(add_address2,'' '')+'' ''+isnull(add_address3,'' '')+'',''+
							isnull(city_name,'' '')+''-''+ isnull(add_pin,'' '')) 
								from tbl_master_address,tbl_master_company,tbl_master_city
									where cmp_internalid=add_cntid and cmp_internalid='''+@companyid+'''
										and add_city=city_id and add_cntID='''+@companyid+''' 
											AND add_entity=''Company'' AND add_addressType=''Office'')as cmpaddress,
			(select Top 1(cmp_serviceTaxNo) from tbl_master_company where cmp_internalid='''+@companyid+''')as cmpservicetax ,
			CLIENTADDRESS1,CLIENTADDRESS2,
			CustTransactionid  as custid,
			convert(varchar(11),Date ,6) as TradeDate,
			null as ExchangeSegment,SegmentName  as segmentname,
			left(SettNo ,7) as SettlementNumber,right(rtrim(SettNo) ,1) as SettlementType 
			,Customerid as CustomerID,SettNo  as settno,
			Productid  as ProductSeriesID,MktPrice  as MKTPRICE 
			,BuyQty  as Bought,SaleQty  as Sold,BrkgType  as brkgtype,UnitBrkg  as UnitBrokerage,
			NetRatePerUnit  as NetRatePerUnit,
			case when isnull(NetAmnt ,0)<0 then ''-''+dbo.fn_FormatNumber(CAST(isnull(ABS(NetAmnt ),0) AS VARCHAR(8000)),''N'') else dbo.fn_FormatNumber(CAST(isnull(NetAmnt ,0) AS VARCHAR(8000)),''N'') end as NetValue,NetAmnt  as NetValue1,
			dbo.fn_FormatNumber(CAST(isnull(TotBrkg ,0) AS VARCHAR(8000)),''N'') as TotalBrokerage,TotBrkg  as TotalBrokerage1,
			dbo.fn_FormatNumber(CAST(isnull(SrvTaxBrkg ,0) AS VARCHAR(8000)),''N'') as servicetax,SrvTaxBrkg  as servicetax1,
			SrvTaxMode  as ServiceTaxMode,
		    case when isnull(NetValue ,0)<0 then ''-''+dbo.fn_FormatNumber(CAST(isnull(ABS(NetValue ),0) AS VARCHAR(8000)),''N'') else dbo.fn_FormatNumber(CAST(isnull(NetValue ,0) AS VARCHAR(8000)),''N'') end as netamount ,NetValue  as netamount1 ,
			OrderNumber as OrderNumber,TradeNumber  as TradeNumber
			,TradeEntryTime  as TradeEntryTime,OrderEntryTime  as OrderEntryTime,ScripName  as Symbol
			,ExchCustomerUcc  as EXCHGECUSTOMERUCC,
			CustomerName as CLIENTNAME,Grpid  as grpid,GrpName  as grpname,GrpEmail  as grpemail,
			Boughtsum,Soldsum,TotalBrokeragesum,NetValueesum,netamntesum,servicetaxsum,
			case when isnull(Quantity,0)<0 then ''-''+dbo.fn_FormatNumber(CAST(isnull(ABS(Quantity),0) AS VARCHAR(8000)),''Y'') else dbo.fn_FormatNumber(CAST(isnull(Quantity,0) AS VARCHAR(8000)),''Y'') end as Quantity,
			Terminalid
			From 
			#TbCustomertrades
			 Left Outer Join
			(select CustomerID as client,
			 dbo.fn_FormatNumber(CAST(sum(isnull(BuyQty ,0)) AS VARCHAR(8000)),''Y'') as Boughtsum,
			 dbo.fn_FormatNumber(CAST(sum(isnull(SaleQty ,0)) AS VARCHAR(8000)),''Y'') as Soldsum,
			 dbo.fn_FormatNumber(CAST(sum(isnull(TotBrkg ,0)) AS VARCHAR(8000)),''N'') as TotalBrokeragesum,
			 case when sum(isnull(NetValue ,0))<0 then ''-''+dbo.fn_FormatNumber(CAST(ABS(sum(isnull(NetValue ,0))) AS VARCHAR(8000)),''N'') else dbo.fn_FormatNumber(CAST(sum(isnull(NetValue ,0)) AS VARCHAR(8000)),''N'') end as netamntesum ,
			 case when sum(isnull(NetAmnt ,0))<0 then ''-''+dbo.fn_FormatNumber(CAST(ABS(sum(isnull(NetAmnt ,0))) AS VARCHAR(8000)),''N'') else dbo.fn_FormatNumber(CAST(sum(isnull(NetAmnt ,0)) AS VARCHAR(8000)),''N'') end as NetValueesum,
			 dbo.fn_FormatNumber(CAST(sum(isnull(SrvTaxBrkg ,0)) AS VARCHAR(8000)),''N'') as servicetaxsum
			 From #TbCustomertrades group by CustomerID) as bb

			on(CustomerID=client ) 
			ORDER BY CustomerName ,ScripName ,cast(Date  as datetime),TradeEntryTime '
			exec(@SqlSelect)

End
--------------------------Report Type Only View In Pdf End
if @RptType='dos' --------------------------Report Type Only View In Dos Begin
BEGIN
Alter Table #TbCustomertrades Add Quantity numeric(28,0),CLIENTADDRESS1 varchar(150),CLIENTADDRESS2 varchar(150),cname varchar(200),cphone varchar(200),cemail varchar(150)

			update #TbCustomertrades set Quantity=CASE WHEN qty=0 THEN NULL ELSE QTY END from
			(Select Customerid as client,Productid  as product ,
			sum(isnull(SaleQty ,0)-isnull(BuyQty,0)) as qty
			From #TbCustomertrades Group By CustomerID,Productid ) as kk
			Where Customerid=client and Productid =product
			
			UPDATE #TbCustomertrades SET CLIENTADDRESS1=(select top 1 (isnull(rtrim(ltrim(add_address1)),'')+' '+isnull(rtrim(ltrim(add_address2)),''))),
							CLIENTADDRESS2=(select top 1 (isnull(rtrim(ltrim(add_address3)),'')+' '+isnull(rtrim(ltrim(add_pin)),'')+','+
											(select top 1 isnull(city_name,'') from tbl_master_city where city_id=add_city))) 

			FROM  tbl_master_address WHERE
			add_cntID=CustomerID AND add_entity='Customer/Client' AND 
			add_addressType=(select top 1 add_addressType from 
			(select add_addressType,
					case when rtrim(ltrim(add_addressType))='Correspondence' then 1
					when rtrim(ltrim(add_addressType))='Registered' then 2
					when rtrim(ltrim(add_addressType))='Residence' then 3
					else 4 end as addreorder
					from tbl_master_address where 
			add_cntID=CustomerID
			and add_entity='Customer/Client') tb
			order by addreorder)

			IF @Segment<>'ALL'
			Begin
				UPDATE #TbCustomertrades SET cname=( select top 1 isnull(LTRIM(RTRIM(isnull(cnt_firstname,'')))+'  '+LTRIM(RTRIM(isnull(cnt_middlename,'  ')))+LTRIM(RTRIM(isnull(cnt_lastname,''))),'') from tbl_master_contact where cnt_internalid=(select top 1 exch_ComplianceOfficer from tbl_Master_CompanyeXchange where exch_internalID in (select * from fnSplitReturnTable(@Segment,',')))),-- As CompilanceofficerName
							cphone=( select top 1 isnull(LTRIM(RTRIM(isnull(phf_countrycode,'')))+'  '+LTRIM(RTRIM(isnull(phf_areacode,'  ')))+LTRIM(RTRIM(isnull(phf_phonenumber,''))),'') from tbl_master_phonefax where phf_cntid=(select top 1 exch_ComplianceOfficer from tbl_Master_CompanyeXchange where exch_internalID in (select * from fnSplitReturnTable(@Segment,',')))), --As CompilanceofficerPhone,
						cemail=( Select top 1 LTRIM(RTRIM(isnull(eml_email,''))) from tbl_master_email where eml_cntid=(select top 1 exch_ComplianceOfficer from tbl_Master_CompanyeXchange where exch_internalID in (select * from fnSplitReturnTable(@Segment,',')))) --As Compilanceofficeremail
			End
		else
		begin
			UPDATE #TbCustomertrades SET cname=( select top 1 isnull(LTRIM(RTRIM(isnull(cnt_firstname,'')))+'  '+LTRIM(RTRIM(isnull(cnt_middlename,'  ')))+LTRIM(RTRIM(isnull(cnt_lastname,''))),'') from tbl_master_contact where cnt_internalid=(select top 1 exch_ComplianceOfficer from tbl_Master_CompanyeXchange where exch_internalID in (24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40))),-- As CompilanceofficerName
							cphone=( select top 1 isnull(LTRIM(RTRIM(isnull(phf_countrycode,'')))+'  '+LTRIM(RTRIM(isnull(phf_areacode,'  ')))+LTRIM(RTRIM(isnull(phf_phonenumber,''))),'') from tbl_master_phonefax where phf_cntid=(select top 1 exch_ComplianceOfficer from tbl_Master_CompanyeXchange where exch_internalID in (24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40))), --As CompilanceofficerPhone,
						cemail=( Select top 1 LTRIM(RTRIM(isnull(eml_email,''))) from tbl_master_email where eml_cntid=(select top 1 exch_ComplianceOfficer from tbl_Master_CompanyeXchange where exch_internalID in (24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40))) --As Compilanceofficeremail
		end
			Select @SqlSelect='Select cname,cphone,cemail,
			(select Top 1(cmp_panNo) from tbl_master_company where cmp_internalid='''+@companyid+''')as cmppanno,
			isnull((Select top 1 phf_countryCode+''-''+phf_areaCode+''-''+phf_phoneNumber from tbl_master_phonefax where   phf_cntId='''+@companyid+'''),'''')as cmpphno,
			isnull((Select top 1 phf_countryCode+''-''+phf_areaCode+''-''+phf_phoneNumber from tbl_master_phonefax where  PHF_TYPE=''Fax'' AND phf_cntId='''+@companyid+'''),'''')as cmpfax,
			(select Top 1(eml_email) from tbl_master_email where eml_cntid='''+@companyid+''' and eml_type=''Official'')as cmpemail,
			(select Top 1(cmp_Name) from tbl_master_company where cmp_internalid='''+@companyid+''')as cmpname,
			(select HeaderFooter_Content from Master_HeaderFooter where HeaderFooter_ID='''+@Header+''') as header,
			(select HeaderFooter_Content from Master_HeaderFooter where HeaderFooter_ID='''+@Footer+''') as footer,
			(select top 1(isnull(add_address1,'' '')+'' ''+
						isnull(add_address2,'' '')+'' ''+isnull(add_address3,'' '')+'',''+
							isnull(city_name,'' '')+''-''+ isnull(add_pin,'' '')) 
								from tbl_master_address,tbl_master_company,tbl_master_city
									where cmp_internalid=add_cntid and cmp_internalid='''+@companyid+'''
										and add_city=city_id and add_cntID='''+@companyid+''' 
											AND add_entity=''Company'' AND add_addressType=''Office'')as cmpaddress,
			(select Top 1(cmp_serviceTaxNo) from tbl_master_company where cmp_internalid='''+@companyid+''')as cmpservicetax ,
			CLIENTADDRESS1,CLIENTADDRESS2,
			CustTransactionid  as custid,
			convert(varchar(11),Date ,6) as TradeDate,
			null as ExchangeSegment,SegmentName  as segmentname,
			left(SettNo ,7) as SettlementNumber,right(rtrim(SettNo) ,1) as SettlementType 
			,Customerid as CustomerID,SettNo  as settno,
			Productid  as ProductSeriesID,MktPrice  as MKTPRICE 
			,BuyQty  as Bought,SaleQty  as Sold,BrkgType  as brkgtype,UnitBrkg  as UnitBrokerage,
			NetRatePerUnit  as NetRatePerUnit,
			case when isnull(NetAmnt ,0)<0 then ''-''+dbo.fn_FormatNumber(CAST(isnull(ABS(NetAmnt ),0) AS VARCHAR(8000)),''N'') else dbo.fn_FormatNumber(CAST(isnull(NetAmnt ,0) AS VARCHAR(8000)),''N'') end as NetValue,NetAmnt  as NetValue1,
			dbo.fn_FormatNumber(CAST(isnull(TotBrkg ,0) AS VARCHAR(8000)),''N'') as TotalBrokerage,TotBrkg  as TotalBrokerage1,
			dbo.fn_FormatNumber(CAST(isnull(SrvTaxBrkg ,0) AS VARCHAR(8000)),''N'') as servicetax,SrvTaxBrkg  as servicetax1,
			SrvTaxMode  as ServiceTaxMode,
		    case when isnull(NetValue ,0)<0 then ''-''+dbo.fn_FormatNumber(CAST(isnull(ABS(NetValue ),0) AS VARCHAR(8000)),''N'') else dbo.fn_FormatNumber(CAST(isnull(NetValue ,0) AS VARCHAR(8000)),''N'') end as netamount ,NetValue  as netamount1 ,
			OrderNumber as OrderNumber,TradeNumber  as TradeNumber
			,TradeEntryTime  as TradeEntryTime,OrderEntryTime  as OrderEntryTime,ScripName  as Symbol
			,ExchCustomerUcc  as EXCHGECUSTOMERUCC,
			CustomerName as CLIENTNAME,Grpid  as grpid,GrpName  as grpname,GrpEmail  as grpemail,
			Boughtsum,Soldsum,TotalBrokeragesum,NetValueesum,netamntesum,servicetaxsum,
			case when isnull(Quantity,0)<0 then ''-''+dbo.fn_FormatNumber(CAST(isnull(ABS(Quantity),0) AS VARCHAR(8000)),''Y'') else dbo.fn_FormatNumber(CAST(isnull(Quantity,0) AS VARCHAR(8000)),''Y'') end as Quantity,
			Terminalid
			From 
			#TbCustomertrades
			 Left Outer Join
			(select CustomerID as client,
			 dbo.fn_FormatNumber(CAST(sum(isnull(BuyQty ,0)) AS VARCHAR(8000)),''Y'') as Boughtsum,
			 dbo.fn_FormatNumber(CAST(sum(isnull(SaleQty ,0)) AS VARCHAR(8000)),''Y'') as Soldsum,
			 dbo.fn_FormatNumber(CAST(sum(isnull(TotBrkg ,0)) AS VARCHAR(8000)),''N'') as TotalBrokeragesum,
			 case when sum(isnull(NetValue ,0))<0 then ''-''+dbo.fn_FormatNumber(CAST(ABS(sum(isnull(NetValue ,0))) AS VARCHAR(8000)),''N'') else dbo.fn_FormatNumber(CAST(sum(isnull(NetValue ,0)) AS VARCHAR(8000)),''N'') end as netamntesum ,
			 case when sum(isnull(NetAmnt ,0))<0 then ''-''+dbo.fn_FormatNumber(CAST(ABS(sum(isnull(NetAmnt ,0))) AS VARCHAR(8000)),''N'') else dbo.fn_FormatNumber(CAST(sum(isnull(NetAmnt ,0)) AS VARCHAR(8000)),''N'') end as NetValueesum,
			 dbo.fn_FormatNumber(CAST(sum(isnull(SrvTaxBrkg ,0)) AS VARCHAR(8000)),''N'') as servicetaxsum
			 From #TbCustomertrades group by CustomerID) as bb
			on(CustomerID=client ) 
			ORDER BY CustomerName ,ScripName ,cast(Date  as datetime),TradeEntryTime '
			exec(@SqlSelect)
end
--------------------------Report Type Only View In Dos End
IF(@RptType='Export') --------------------------Report Type Excel Begin
	Begin
		-----------If Terminalid 
		If @Terminalid<>'All'
		Begin
			Delete From #TbCustomertrades Where OrderNumber is null 
		End
		If @CtClid<>'All'
		Begin
			Delete From #TbCustomertrades Where OrderNumber is null 
		End
		If @TradeTime<>'All'
		Begin
			Delete From #TbCustomertrades Where OrderNumber is null 
		End
		---------------Parameter Selection
		Declare @SelectTerminalid varchar(20),@SelectTradeCode varchar(20),
				@SelectOrderNo varchar(20),@SelectOrderEntryTime varchar(20),
				@SelectTradeNo varchar(20),@SelectTradeEntryTime varchar(20),
				@SelectCntrNo varchar(20)
				
		Select @SelectTerminalid=dbo.fnSplit(@Parameter,'~', 1)
		Select @SelectTradeCode=dbo.fnSplit(@Parameter,'~', 2)
		Select @SelectOrderNo=dbo.fnSplit(@Parameter,'~', 3)
		Select @SelectOrderEntryTime=dbo.fnSplit(@Parameter,'~', 4)
		Select @SelectTradeNo=dbo.fnSplit(@Parameter,'~', 5)
		Select @SelectTradeEntryTime=dbo.fnSplit(@Parameter,'~', 6)
		Select @SelectCntrNo=dbo.fnSplit(@Parameter,'~', 7)
		
		-----------------------------------------Sum Begin
		--------------Insert Per Group
		Insert Into  #TbCustomertrades(TabName,Customerid,CustomerName,Grpid,GrpName,GrpEmail,StatusOrder,ScripName)

		Select Distinct  
		Case When @GrpType In ('BRANCH','BRANCHGROUP') Then 'Branch :'+GrpName Else 'Group :'+GrpName End
		,null,null,Grpid,GrpName,GrpEmail,1,'Test' From #TbCustomertrades Where StatusOrder =3
		Union All
		Select Distinct case when @groupbyvalue in ('Broker') then  'Broker :'+CustomerName else 'Client :'+CustomerName end,Customerid,CustomerName,Grpid,GrpName,GrpEmail,2,'Test' 
		From #TbCustomertrades Where StatusOrder =3
		---------------------Per Product
		If @OrderBy='1'----Group+Client+Instrument+TradeDate
		Begin
				 Insert Into  #TbCustomertrades
				 (TabName,Segmentid,SegmentName,Customerid,Productid,CustomerName,ScripName,Grpid,GrpName,GrpEmail,StatusOrder
				 ,BuyQty,SaleQty,TotBrkg,SrvTaxBrkg,NetAmnt,NetValue)

				 Select 'Total:',Segmentid,SegmentName,Customerid,Productid,CustomerName,ScripName,Grpid,GrpName,GrpEmail,4,
				 Sum(isnull(BuyQty,0)) as BuyQtySum,Sum(isnull(SaleQty ,0)) as SaleQtySum,
				 Sum(isnull(TotBrkg,0)) as TotBrkgSum,Sum(isnull(SrvTaxBrkg,0)) as SrvTaxBrkgSum,
				 Sum(isnull(NetAmnt,0)) as NetAmntSum,Sum(isnull(NetValue,0)) as NetValueSum
				 From #TbCustomertrades Where StatusOrder =3
				 Group By Segmentid,SegmentName,Customerid,Productid,CustomerName,ScripName,Grpid,GrpName,GrpEmail
				 
		End
		If @OrderBy='2'----Group+Client+TradeDate+Instrument
		Begin
				  Insert Into  #TbCustomertrades
				 (TabName,Segmentid,SegmentName,Customerid,Date,CustomerName,Grpid,GrpName,GrpEmail,StatusOrder
				 ,BuyQty,SaleQty,TotBrkg,SrvTaxBrkg,NetAmnt,NetValue)
--
				 Select 'Total:',Segmentid,SegmentName,Customerid,Date,CustomerName,Grpid,GrpName,GrpEmail,4,
				 Sum(isnull(BuyQty,0)) as BuyQtySum,Sum(isnull(SaleQty ,0)) as SaleQtySum,
				 Sum(isnull(TotBrkg,0)) as TotBrkgSum,Sum(isnull(SrvTaxBrkg,0)) as SrvTaxBrkgSum,
				 Sum(isnull(NetAmnt,0)) as NetAmntSum,Sum(isnull(NetValue,0)) as NetValueSum
				 From #TbCustomertrades Where StatusOrder =3 
				Group By Segmentid,SegmentName,Customerid,Date,CustomerName,Grpid,GrpName,GrpEmail
		End
		----------Per Client Sum
		Insert Into  #TbCustomertrades
		(TabName,Customerid,CustomerName,Grpid,GrpName,GrpEmail,StatusOrder,ScripName,Productid,SegmentName
		,BuyQty,SaleQty,TotBrkg,SrvTaxBrkg,NetAmnt,NetValue)

		Select case when @groupbyvalue in ('Broker') then  'Broker Total:' else 'Client Total:' end,Customerid,CustomerName,Grpid,GrpName,GrpEmail,5,'ZZZZZZZZZZZ','ZZZZZZZZZZZ','ZZZZZZZZZZZ',
		Sum(isnull(BuyQty,0)) as BuyQtySum,Sum(isnull(SaleQty ,0)) as SaleQtySum,
				 Sum(isnull(TotBrkg,0)) as TotBrkgSum,Sum(isnull(SrvTaxBrkg,0)) as SrvTaxBrkgSum,
				 Sum(isnull(NetAmnt,0)) as NetAmntSum,Sum(isnull(NetValue,0)) as NetValueSum
		From #TbCustomertrades Where StatusOrder =3 Group By Customerid,CustomerName,Grpid,GrpName,GrpEmail
		----------Per Group Sum
		Insert Into  #TbCustomertrades
		(TabName,Grpid,GrpName,GrpEmail,StatusOrder,Customerid,CustomerName,SegmentName
		,BuyQty,SaleQty,TotBrkg,SrvTaxBrkg,NetAmnt,NetValue)

		Select 'Group/Branch Total:',Grpid,GrpName,GrpEmail,6,'ZZZZZZZZZZZ','ZZZZZZZZZZZ','ZZZZZZZZZZZ',
		Sum(isnull(BuyQty,0)) as BuyQtySum,Sum(isnull(SaleQty ,0)) as SaleQtySum,
				 Sum(isnull(TotBrkg,0)) as TotBrkgSum,Sum(isnull(SrvTaxBrkg,0)) as SrvTaxBrkgSum,
				 Sum(isnull(NetAmnt,0)) as NetAmntSum,Sum(isnull(NetValue,0)) as NetValueSum
		From #TbCustomertrades Where StatusOrder =3 Group By Grpid,GrpName,GrpEmail
		----------Per Grand
		Insert Into  #TbCustomertrades
		(TabName,Grpid,GrpName,GrpEmail,StatusOrder,Customerid,CustomerName,SegmentName
		,BuyQty,SaleQty,TotBrkg,SrvTaxBrkg,NetAmnt,NetValue)

		Select 'Grand Total:','ZZZZZZZZZZZ','ZZZZZZZZZZZ','ZZZZZZZZZZZ',7,'ZZZZZZZZZZZ','ZZZZZZZZZZZ','ZZZZZZZZZZZ',
		Sum(isnull(BuyQty,0)) as BuyQtySum,Sum(isnull(SaleQty ,0)) as SaleQtySum,
				 Sum(isnull(TotBrkg,0)) as TotBrkgSum,Sum(isnull(SrvTaxBrkg,0)) as SrvTaxBrkgSum,
				 Sum(isnull(NetAmnt,0)) as NetAmntSum,Sum(isnull(NetValue,0)) as NetValueSum
		From #TbCustomertrades Where StatusOrder =3 
		-----------------------------------------Sum End		
		--------------Record Fetch		
		Select @SqlSelect='  
							Select Customerid,isnull(CustomerName,''''),Case When len(GrpEmail)=0 Then null Else GrpEmail End as GrpEmail,Grpid,
							TabName as [Trade Date],
							Case When (TabName=''Total:'' or TabName=''Client Total:'' or TabName=''Group/Branch Total:''  or TabName=''Grand Total:''  or TabName=''Broker Total:'') Then ''''  
								  When SecurityType is null Then ScripName Else ScripName+'' [''+SecurityType+'']'' End  as [Scrip]
							'
		IF @Segment='ALL'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' 
			,Case When (isnull(SegmentName,''ZZZZZZZZZZZ'')=''ZZZZZZZZZZZ'' or TabName=''Total:'' or TabName=''Client Total:'' or TabName=''Grand Total:'' or TabName=''Broker Total:'') Then '''' Else SegmentName End as [Segmnt]'
		END
		IF @Settno='ALL' or @SettType='ALL'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,isnull(SettNo,'''') as [Sett]'
		END
		
		IF @SelectTerminalid<>'N'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,isnull(Terminalid,'''')  as [Terminal]'
		END
		IF @SelectTradeCode<>'N'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,isnull(ExchCustomerUcc,'''')  as [TrdCode]'
		END
		IF @SelectOrderNo<>'N'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,isnull(''''''''+Cast(OrderNumber as Varchar),'''')  as [Order]'
		END
		IF @SelectOrderEntryTime<>'N'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,isnull(OrderEntryTime,'''')  as [OrderTime]'
		END
		IF @SelectTradeNo<>'N'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,isnull(TradeNumber,'''')  as [TradeNo]'
		END
		IF @SelectTradeEntryTime<>'N'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,isnull(convert(varchar(8),cast(TradeEntryTime as datetime),114),'''')  as [TradeTime]'
		END
		IF @SelectCntrNo<>'N'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,isnull(CntrNo,0)  as [CntrNo.]'
		END
		SELECT @SqlSelect=@SqlSelect+'
										,Case When isnull(BuyQty,0)=0 Then 0 Else isnull(BuyQty,0) End as [Buy Qty]
										,Case When isnull(SaleQty,0)=0 Then 0 Else isnull(SaleQty,0) End as [Sale Qty]
										,Case When isnull(MktPrice,0)=0 Then 0.0000 Else isnull(MktPrice,0) End as [Mkt Price]
										,isnull(BrkgType,'''') as [Type]
										,Case When isnull(UnitBrkg,0)=0 Then 0.0000 Else isnull(UnitBrkg,0) End as [Brkg]
										,isnull(TotBrkg,0) as [Tot Brkg]
										,isnull(NetRatePerUnit,0) as [Net Rate]
										,Case When isnull(NetAmnt,0)=0 Then 0.00
											  When isnull(NetAmnt,0)<0 Then 
													-1*isnull(abs(NetAmnt),0) 
											  Else
													isnull(NetAmnt,0)
											  End as [Net Value]
										,isnull(SrvTaxBrkg,0) as [SrvTax]
										,isnull(SrvTaxMode,'''') as [Mode]
										,Case When isnull(NetValue,0)=0 Then 0.00
											  When isnull(NetValue,0)<0 Then 
													-1*isnull(abs(NetValue),0)
											  Else
													isnull(NetValue,0)
											  End as [Net Amnt]

										From #TbCustomertrades Order By 
									'
		If @OrderBy='1'----Group+Client+Instrument+TradeDate
		Begin
				SELECT @SqlSelect=@SqlSelect+' GrpName,CustomerName,SegmentName,ScripName,StatusOrder,Date '
		End
		If @OrderBy='2'----Group+Client+TradeDate+Instrument
		Begin
				SELECT @SqlSelect=@SqlSelect+' GrpName,CustomerName,SegmentName,Date,StatusOrder,TradeEntryTime,ScripName '
		End		
		--------------Begin Modify for Excel Export on the Original Result Set -----------------
		
		Create Table #XLExport_TradeRegister (Customerid varchar(15),CustomerName varchar(150),GrpEmail varchar(100),Grpid varchar(20),[Trade Date] varchar(150))
		
		Declare @Dsql_Alter nVarchar(Max)		
		Set @Dsql_Alter='Alter Table #XLExport_TradeRegister Add [Scrip] varchar(150)'
		if(@Segment='ALL')
			Set  @Dsql_Alter=@Dsql_Alter +',[Segmnt] varchar(15) '
		if(@SettType='ALL' OR @Settno ='ALL')
			Set  @Dsql_Alter=@Dsql_Alter +',[Sett] varchar(15) '
		
		---Start Filter for @parameter
		if(@SelectTerminalid<>'N')
			Set @Dsql_Alter=@Dsql_Alter + ',[Terminal] varchar(20) '
		if(@SelectTradeCode<>'N')
			Set @Dsql_Alter=@Dsql_Alter + ',[TrdCode] varchar(15) '
		if(@SelectOrderNo<>'N')
			Set @Dsql_Alter=@Dsql_Alter + ',[Order] varchar(20) '
		if(@SelectOrderEntryTime<>'N')
			Set @Dsql_Alter=@Dsql_Alter + ',[OrderTime] varchar(20) '		
		if(@SelectTradeNo<>'N')
			Set @Dsql_Alter=@Dsql_Alter + ',[TradeNo] varchar(20) '
		if(@SelectTradeEntryTime<>'N')
			Set @Dsql_Alter=@Dsql_Alter + ',[TradeTime] varchar(15) '
		if(@SelectCntrNo<>'N')
			Set @Dsql_Alter=@Dsql_Alter + ',[CntrNo.] varchar(30) '	
		---End Filter for @parameter
		
		Set @Dsql_Alter=@Dsql_Alter + ',[Buy Qty] varchar(8000),[Sale Qty] varchar(8000),[Mkt Price] numeric(28,4) null,[Type] varchar(8),[Brkg] numeric(28,4) null,[Tot Brkg] numeric(28,2) null,
										[Net Rate] numeric(28,4) null,[Net Value] numeric(28,2) null,[SrvTax] numeric(28,2) null,[Mode] varchar(3),[Net Amnt] numeric(28,2) null'
		
		--Create Table #XLExport_TradeRegister(Customerid varchar(15),CustomerName varchar(150),GrpEmail varchar(100),Grpid varchar(20),[Trade Date] varchar(150),[Scrip] varchar(150),
		--			[Terminal] varchar(20),[TrdCode] varchar(15),[Order] varchar(20),[OrderTime] varchar(20),[TradeNo] varchar(20),[TradeTime] varchar(15),[CntrNo.] varchar(30),
		--			[Buy Qty] varchar(8000),[Sale Qty] varchar(8000),[Mkt Price] varchar(8000),[Type] varchar(8),[Brkg] varchar(8000),[Tot Brkg] varchar(8000),
		--			[Net Rate] varchar(8000),[Net Value] varchar(8000),[SrvTax] varchar(8000),[Mode] varchar(3),[Net Amnt] varchar(8000))
											
		Exec Sp_ExecuteSql @Dsql_Alter
		
		Insert into #XLExport_TradeRegister
			exec (@SqlSelect)			
		--Select * From  #XLExport_TradeRegister		
			
		Declare @Dsql_Select nvarchar(max)														
		Set @Dsql_Select=' Select Case When CustomerName like ''ZZ%'' Then '''' Else CustomerName End As [CustomerName],
								  [Trade Date],				
								  Case When [Scrip]=''Test'' Then '''' Else [Scrip] End As [Scrip] '
		IF(@Segment='ALL')		
			Set @Dsql_Select=@Dsql_Select+',[Segmnt] '
		if(@SettType='ALL' OR @Settno ='ALL')
			Set @Dsql_Select=@Dsql_Select+',[Sett] '													
				---Start Filter for @parameter
		if(@SelectTerminalid<>'N')
				Set @Dsql_Select=@Dsql_Select+',[Terminal] '				
		if (@SelectTradeCode<>'N')		
				Set @Dsql_Select=@Dsql_Select+',[TrdCode] '
		if(@SelectOrderNo<>'N')		
				Set @Dsql_Select=@Dsql_Select+',[Order] '
		if(@SelectOrderEntryTime<>'N')		
				Set @Dsql_Select=@Dsql_Select+',[OrderTime] '
		if(@SelectTradeNo<>'N')		
				Set @Dsql_Select=@Dsql_Select+',[TradeNo] '
		if(@SelectTradeEntryTime<>'N')		
				Set @Dsql_Select=@Dsql_Select+',[TradeTime] '
		if(@SelectCntrNo<>'N')		
				Set @Dsql_Select=@Dsql_Select+',case when [CntrNo.]<>0 then [CntrNo.] Else NULL end [CntrNo.] '
				
		Set @Dsql_Select=@Dsql_Select+',case when [Buy Qty]<>0 then [Buy Qty] Else NULL end [Buy Qty]
									   ,case when [Sale Qty]<>0 then [Sale Qty] Else NULL end [Sale Qty]	
									   ,case when isnull([Mkt Price],0)=0 then NULL  when [Mkt Price]<0 then ''-''+dbo.fn_FormatNumber(cast(abs([Mkt Price]) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast([Mkt Price] as varchar(8000)),''N'')  end as [Mkt Price]
									   ,[Type],case when isnull([Brkg],0)=0 then NULL  when [Brkg]<0 then ''-''+dbo.fn_FormatNumber(cast(abs([Brkg]) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast([Brkg] as varchar(8000)),''N'')  end as [Brkg]   
									   ,case when isnull([Tot Brkg],0)=0 then NULL  when [Tot Brkg]<0 then ''-''+dbo.fn_FormatNumber(cast(abs([Tot Brkg]) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast([Tot Brkg] as varchar(8000)),''N'')  end as [Tot Brkg]
									   ,case when isnull([Net Rate],0)=0 then NULL  when [Net Rate]<0 then ''-''+dbo.fn_FormatNumber(cast(abs([Net Rate]) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast([Net Rate] as varchar(8000)),''N'')  end as [Net Rate]
									   ,case when isnull([Net Value],0)=0 then NULL  when [Net Value]<0 then ''-''+dbo.fn_FormatNumber(cast(abs([Net Value]) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast([Net Value] as varchar(8000)),''N'')  end as [Net Value]
									   ,case when isnull([SrvTax],0)=0 then NULL  when [SrvTax]<0 then ''-''+dbo.fn_FormatNumber(cast(abs([SrvTax]) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast([SrvTax] as varchar(8000)),''N'')  end as [SrvTax]
									   ,[Mode],case when isnull([Net Amnt],0)=0 then NULL  when [Net Amnt]<0 then ''-''+dbo.fn_FormatNumber(cast(abs([Net Amnt]) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast([Net Amnt] as varchar(8000)),''N'')  end as [Net Amnt]														   
			 From #XLExport_TradeRegister'			
		
		Exec Sp_ExecuteSql @Dsql_Select	
		
		--IF(@Segment='ALL')
		--	Begin
		--		  IF(@SettType<>'ALL' AND @Settno <>'ALL')
		--			Begin 
		--					Alter Table  #XLExport_TradeRegister
		--					Add [Segmnt] varchar(15)							
		--					--Insert into #XLExport_TradeRegister(Customerid,CustomerName,GrpEmail,Grpid,[Trade Date],[Scrip],[Segmnt],
		--					--						[Terminal],[TrdCode],[Order],[OrderTime],[TradeNo],[TradeTime],[CntrNo.],
		--					--						[Buy Qty],[Sale Qty],[Mkt Price],[Type],[Brkg],[Tot Brkg],[Net Rate],[Net Value],[SrvTax],[Mode],[Net Amnt])
		--					--		exec (@SqlSelect)	
		--					Insert into #XLExport_TradeRegister
		--						exec (@SqlSelect)
														
		--					Select 
		--						Case When CustomerName like 'ZZ%' Then '' Else CustomerName End As [CustomerName],[Trade Date],
		--						Case When [Scrip]='Test' Then '' Else [Scrip] End As [Scrip],[Segmnt],													
		--						[Terminal],[TrdCode],[Order],[OrderTime],[TradeNo],[TradeTime],[CntrNo.],
		--						[Buy Qty],[Sale Qty],[Mkt Price],[Type],[Brkg],[Tot Brkg],[Net Rate],[Net Value],[SrvTax],[Mode],[Net Amnt]					
		--					From #XLExport_TradeRegister
		--			End
		--		Else
		--			Begin 
		--					Alter Table  #XLExport_TradeRegister
		--					Add [Segmnt] varchar(15),[Sett] varchar(15)
		--					Insert into #XLExport_TradeRegister(Customerid,CustomerName,GrpEmail,Grpid,[Trade Date],[Scrip],[Segmnt],[Sett],
		--											[Terminal],[TrdCode],[Order],[OrderTime],[TradeNo],[TradeTime],[CntrNo.],
		--											[Buy Qty],[Sale Qty],[Mkt Price],[Type],[Brkg],[Tot Brkg],[Net Rate],[Net Value],[SrvTax],[Mode],[Net Amnt])
		--							exec (@SqlSelect)	
							
		--					Select 
		--						Case When CustomerName like 'ZZ%' Then '' Else CustomerName End As [CustomerName],[Trade Date],
		--						Case When [Scrip]='Test' Then '' Else [Scrip] End As [Scrip],[Segmnt],[Sett],
		--						[Terminal],[TrdCode],[Order],[OrderTime],[TradeNo],[TradeTime],[CntrNo.],
		--						[Buy Qty],[Sale Qty],[Mkt Price],[Type]
		--						,[Brkg],[Tot Brkg],[Net Rate],[Net Value],[SrvTax],[Mode],[Net Amnt]					
		--					From #XLExport_TradeRegister
		--			End	
		--	End	
		--Else
		--	Begin
		--		  IF(@SettType<>'ALL' AND @Settno <>'ALL')
		--			Begin 
		--					Insert Into #XLExport_TradeRegister Exec(@SqlSelect)							
		--					Select
		--						Case When CustomerName like 'ZZ%' Then '' Else CustomerName End As [CustomerName],[Trade Date],
		--						Case When [Scrip]='Test' Then '' Else [Scrip] End As [Scrip],
		--						[Terminal],[TrdCode],[Order],[OrderTime],[TradeNo],[TradeTime],[CntrNo.],
		--						[Buy Qty],[Sale Qty],[Mkt Price],[Type],[Brkg],[Tot Brkg],[Net Rate],[Net Value],[SrvTax],[Mode],[Net Amnt]					
		--					From #XLExport_TradeRegister
		--			End
		--		Else
		--			Begin 
		--					Alter Table  #XLExport_TradeRegister
		--					Add [Sett] varchar(15)
		--					Insert into #XLExport_TradeRegister(Customerid,CustomerName,GrpEmail,Grpid,[Trade Date],[Scrip],[Sett],
		--											[Terminal],[TrdCode],[Order],[OrderTime],[TradeNo],[TradeTime],[CntrNo.],
		--											[Buy Qty],[Sale Qty],[Mkt Price],[Type],[Brkg],[Tot Brkg],[Net Rate],[Net Value],[SrvTax],[Mode],[Net Amnt])
		--							exec (@SqlSelect)							
		--					Select
		--						Case When CustomerName like 'ZZ%' Then '' Else CustomerName End As [CustomerName],[Trade Date],
		--						Case When [Scrip]='Test' Then '' Else [Scrip] End As [Scrip],[Sett],
		--						[Terminal],[TrdCode],[Order],[OrderTime],[TradeNo],[TradeTime],[CntrNo.],
		--						[Buy Qty],[Sale Qty],[Mkt Price],[Type],[Brkg],[Tot Brkg],[Net Rate],[Net Value],[SrvTax],[Mode],[Net Amnt]					
		--					From #XLExport_TradeRegister
		--			End	
		--	END
		Drop Table #XLExport_TradeRegister	
		-------------End Modify for Excel Export on the Original Result Set--------------
	End --------------------------Report Type Excel End
Else 
Begin--------------------------Report Type <>Pdf Begin
		----- if Report Type CntrScreen 
		if(@RptType='CntrScreen')---See Note 1.
		Begin
			Declare @WhichCall_ClientID_ContractNumber Varchar(250)
			Set @WhichCall_ClientID_ContractNumber=@RptType+'~'+@Clients+'~'+@ContractNo
			
			Exec [Sp_ContractRegister]
			@Companyid,@Segment,@FromDate,@ToDate,@WhichCall_ClientID_ContractNumber
			
			Delete From #TbCustomertrades Where CntrNo<>@ContractNo
		End
		
		-----------If Terminalid 
		If @Terminalid<>'All'
		Begin
			Delete From #TbCustomertrades Where OrderNumber is null 
		End
		If @CtClid<>'All'
		Begin
			Delete From #TbCustomertrades Where OrderNumber is null 
		End
		If @TradeTime<>'All'
		Begin
			Delete From #TbCustomertrades Where OrderNumber is null 
		End
		---------------Parameter Selection
		--Declare @SelectTerminalid varchar(20),@SelectTradeCode varchar(20),
		--		@SelectOrderNo varchar(20),@SelectOrderEntryTime varchar(20),
		--		@SelectTradeNo varchar(20),@SelectTradeEntryTime varchar(20),
		--		@SelectCntrNo varchar(20)

		Select @SelectTerminalid=dbo.fnSplit(@Parameter,'~', 1)
		Select @SelectTradeCode=dbo.fnSplit(@Parameter,'~', 2)
		Select @SelectOrderNo=dbo.fnSplit(@Parameter,'~', 3)
		Select @SelectOrderEntryTime=dbo.fnSplit(@Parameter,'~', 4)
		Select @SelectTradeNo=dbo.fnSplit(@Parameter,'~', 5)
		Select @SelectTradeEntryTime=dbo.fnSplit(@Parameter,'~', 6)
		Select @SelectCntrNo=dbo.fnSplit(@Parameter,'~', 7)

		-----------------------------------------Sum Begin
		--------------Insert Per Group
		Insert Into  #TbCustomertrades(TabName,Customerid,CustomerName,Grpid,GrpName,GrpEmail,StatusOrder,ScripName)
		Select Distinct  
		Case When @GrpType In ('BRANCH','BRANCHGROUP') Then 'Branch :'+GrpName Else 'Group :'+GrpName End
		,null,null,Grpid,GrpName,GrpEmail,1,'Test' From #TbCustomertrades Where StatusOrder =3
		Union All
		Select Distinct case when @groupbyvalue in ('Broker') then  'Broker :'+CustomerName else 'Client :'+CustomerName end,Customerid,CustomerName,Grpid,GrpName,GrpEmail,2,'Test' 
		From #TbCustomertrades Where StatusOrder =3
		---------------------Per Product
		If @OrderBy='1'----Group+Client+Instrument+TradeDate
		Begin
				 Insert Into  #TbCustomertrades
				 (TabName,Segmentid,SegmentName,Customerid,Productid,CustomerName,ScripName,Grpid,GrpName,GrpEmail,StatusOrder
				 ,BuyQty,SaleQty,TotBrkg,SrvTaxBrkg,NetAmnt,NetValue)

				 Select 'Total:',Segmentid,SegmentName,Customerid,Productid,CustomerName,ScripName,Grpid,GrpName,GrpEmail,4,
				 Sum(isnull(BuyQty,0)) as BuyQtySum,Sum(isnull(SaleQty ,0)) as SaleQtySum,
				 Sum(isnull(TotBrkg,0)) as TotBrkgSum,Sum(isnull(SrvTaxBrkg,0)) as SrvTaxBrkgSum,
				 Sum(isnull(NetAmnt,0)) as NetAmntSum,Sum(isnull(NetValue,0)) as NetValueSum
				 From #TbCustomertrades Where StatusOrder =3
				 Group By Segmentid,SegmentName,Customerid,Productid,CustomerName,ScripName,Grpid,GrpName,GrpEmail
				 
		End
		If @OrderBy='2'----Group+Client+Instrument+TradeDate
		Begin
				  Insert Into  #TbCustomertrades
				 (TabName,Segmentid,SegmentName,Customerid,Date,CustomerName,Grpid,GrpName,GrpEmail,StatusOrder
				 ,BuyQty,SaleQty,TotBrkg,SrvTaxBrkg,NetAmnt,NetValue)

				 Select 'Total:',Segmentid,SegmentName,Customerid,Date,CustomerName,Grpid,GrpName,GrpEmail,4,
				 Sum(isnull(BuyQty,0)) as BuyQtySum,Sum(isnull(SaleQty ,0)) as SaleQtySum,
				 Sum(isnull(TotBrkg,0)) as TotBrkgSum,Sum(isnull(SrvTaxBrkg,0)) as SrvTaxBrkgSum,
				 Sum(isnull(NetAmnt,0)) as NetAmntSum,Sum(isnull(NetValue,0)) as NetValueSum
				 From #TbCustomertrades Where StatusOrder =3 
				Group By Segmentid,SegmentName,Customerid,Date,CustomerName,Grpid,GrpName,GrpEmail
		End
		----------Per Client Sum
		Insert Into  #TbCustomertrades
		(TabName,Customerid,CustomerName,Grpid,GrpName,GrpEmail,StatusOrder,ScripName,Productid,SegmentName
		,BuyQty,SaleQty,TotBrkg,SrvTaxBrkg,NetAmnt,NetValue)

		Select case when @groupbyvalue in ('Broker') then  'Brokerrr Total' else 'Client Total' end,Customerid,CustomerName,Grpid,GrpName,GrpEmail,5,'ZZZZZZZZZZZ','ZZZZZZZZZZZ','ZZZZZZZZZZZ',
		Sum(isnull(BuyQty,0)) as BuyQtySum,Sum(isnull(SaleQty ,0)) as SaleQtySum,
				 Sum(isnull(TotBrkg,0)) as TotBrkgSum,Sum(isnull(SrvTaxBrkg,0)) as SrvTaxBrkgSum,
				 Sum(isnull(NetAmnt,0)) as NetAmntSum,Sum(isnull(NetValue,0)) as NetValueSum
		From #TbCustomertrades Where StatusOrder =3 Group By Customerid,CustomerName,Grpid,GrpName,GrpEmail
		----------Per Group Sum
		Insert Into  #TbCustomertrades
		(TabName,Grpid,GrpName,GrpEmail,StatusOrder,Customerid,CustomerName,SegmentName
		,BuyQty,SaleQty,TotBrkg,SrvTaxBrkg,NetAmnt,NetValue)

		Select 'Group/Branch Total:',Grpid,GrpName,GrpEmail,6,'ZZZZZZZZZZZ','ZZZZZZZZZZZ','ZZZZZZZZZZZ',
		Sum(isnull(BuyQty,0)) as BuyQtySum,Sum(isnull(SaleQty ,0)) as SaleQtySum,
				 Sum(isnull(TotBrkg,0)) as TotBrkgSum,Sum(isnull(SrvTaxBrkg,0)) as SrvTaxBrkgSum,
				 Sum(isnull(NetAmnt,0)) as NetAmntSum,Sum(isnull(NetValue,0)) as NetValueSum
		From #TbCustomertrades Where StatusOrder =3 Group By Grpid,GrpName,GrpEmail
		----------Per Grand
		Insert Into  #TbCustomertrades
		(TabName,Grpid,GrpName,GrpEmail,StatusOrder,Customerid,CustomerName,SegmentName
		,BuyQty,SaleQty,TotBrkg,SrvTaxBrkg,NetAmnt,NetValue)

		Select 'Grand Total:','ZZZZZZZZZZZ','ZZZZZZZZZZZ','ZZZZZZZZZZZ',7,'ZZZZZZZZZZZ','ZZZZZZZZZZZ','ZZZZZZZZZZZ',
		Sum(isnull(BuyQty,0)) as BuyQtySum,Sum(isnull(SaleQty ,0)) as SaleQtySum,
				 Sum(isnull(TotBrkg,0)) as TotBrkgSum,Sum(isnull(SrvTaxBrkg,0)) as SrvTaxBrkgSum,
				 Sum(isnull(NetAmnt,0)) as NetAmntSum,Sum(isnull(NetValue,0)) as NetValueSum
		From #TbCustomertrades Where StatusOrder =3 
		-----------------------------------------Sum End
		
---Select * from #TbCustomertrades
		
		
		
		----See Note 3----
		Alter Table #TbCustomertrades Add AvgViewID varchar(10)
		 
		Update #TbCustomertrades Set AvgViewID=CustTransactionid 
		Where CustTransactionid is Not null 
				and (Select CustomerTrades_AverageType From Trans_CustomerTrades
					 Where Customertrades_ID=CustTransactionid)>1		
		
		----End Note 3----
		--------------Record Fetch
		Select @SqlSelect='  
		Select Customerid,CustomerName,Case When len(GrpEmail)=0 Then null Else GrpEmail End as GrpEmail,Grpid,
		TabName as [Trade Date]
		,Case When (TabName=''Total:'' or TabName=''Client Total:'' or TabName=''Grand Total:'') Then null  
			  When SecurityType is null Then ScripName Else ScripName+'' [''+SecurityType+'']'' End  as [Scrip]
		'
		IF @Segment='ALL'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' 
			,Case When (isnull(SegmentName,''ZZZZZZZZZZZ'')=''ZZZZZZZZZZZ'' or TabName=''Total:'' or TabName=''Client Total:''  or TabName=''Grand Total:'') Then null Else SegmentName End as [Segmnt]'
		END
		IF @Settno='ALL' or @SettType='ALL'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,SettNo as [Sett]'
		END
		IF @SelectTerminalid<>'N'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,Terminalid  as [Terminal]'
		END
		IF @SelectTradeCode<>'N'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,ExchCustomerUcc  as [TrdCode]'
		END
		IF @SelectOrderNo<>'N'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,''''''''+Cast(OrderNumber as Varchar)  as [Order]'
		END
		IF @SelectOrderEntryTime<>'N'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,OrderEntryTime  as [OrderTime]'
		END
		IF @SelectTradeNo<>'N'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,TradeNumber  as [TradeNo]'
		END
		IF @SelectTradeEntryTime<>'N'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,convert(varchar(8),cast(TradeEntryTime as datetime),114)  as [TradeTime]'
		END
		IF @SelectCntrNo<>'N'
		BEGIN
			SELECT @SqlSelect=@SqlSelect+' ,CntrNo  as [CntrNo.]'
		END
		SELECT @SqlSelect=@SqlSelect+'
		,Case When isnull(BuyQty,0)=0 Then null Else dbo.fn_FormatNumber(CAST(isnull(BuyQty,0) AS VARCHAR(8000)),''N'') End as [Buy Qty]
		,Case When isnull(SaleQty,0)=0 Then null Else dbo.fn_FormatNumber(CAST(isnull(SaleQty,0) AS VARCHAR(8000)),''N'') End as [Sale Qty]
		,Case When isnull(MktPrice,0)=0 Then null Else dbo.fn_FormatNumber(CAST(isnull(MktPrice,0) AS VARCHAR(8000)),''N'') End as [Mkt Price]
		,BrkgType as [Type]
		,Case When isnull(UnitBrkg,0)=0 Then null Else dbo.fn_FormatNumber(CAST(isnull(UnitBrkg,0) AS VARCHAR(8000)),''N'') End as [Brkg]
		,dbo.fn_FormatNumber(CAST(isnull(TotBrkg,0) AS VARCHAR(8000)),''N'') as [Tot Brkg]
		,dbo.fn_FormatNumber(CAST(isnull(NetRatePerUnit,0) AS VARCHAR(8000)),''N'') as [Net Rate]
		,Case When isnull(NetAmnt,0)=0 Then null
			  When isnull(NetAmnt,0)<0 Then 
					''-''+dbo.fn_FormatNumber(CAST(isnull(abs(NetAmnt),0) AS VARCHAR(8000)),''N'')
			  Else
					dbo.fn_FormatNumber(CAST(isnull(NetAmnt,0) AS VARCHAR(8000)),''N'') 
			  End as [Net Value]
		,dbo.fn_FormatNumber(CAST(isnull(SrvTaxBrkg,0) AS VARCHAR(8000)),''N'') as [SrvTax]
		,SrvTaxMode as [Mode]
		,Case When isnull(NetValue,0)=0 Then null
			  When isnull(NetValue,0)<0 Then 
					''-''+dbo.fn_FormatNumber(CAST(isnull(abs(NetValue),0) AS VARCHAR(8000)),''N'')
			  Else
					dbo.fn_FormatNumber(CAST(isnull(NetValue,0) AS VARCHAR(8000)),''N'') 
			  End as [Net Amnt]
		,AvgViewID ExchTrade		 

		From #TbCustomertrades Order By 
		'
		If @OrderBy='1'----Group+Client+Instrument+TradeDate
		Begin
				SELECT @SqlSelect=@SqlSelect+' GrpName,CustomerName,SegmentName,ScripName,StatusOrder,Date '
		End
		If @OrderBy='2'----Group+Client+TradeDate+Instrument
		Begin
				SELECT @SqlSelect=@SqlSelect+' GrpName,CustomerName,SegmentName,Date,StatusOrder,TradeEntryTime,ScripName '
		End
		
		--if(@RptType='CntrScreen')
		--Begin
			
		--End
		
		
		Exec(@SqlSelect)
End --------------------------Report Type <>Pdf End

----------------Drop Table
Drop Table #TbCustomertrades
Drop Table #TbExchange 
END


















