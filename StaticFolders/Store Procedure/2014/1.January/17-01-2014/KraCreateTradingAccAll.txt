

ALTER PROCEDURE [dbo].[KraCreateTradingAccAll]
@fromdate varchar(20),
@todate varchar(20),
@ids varchar(max),
@mode varchar(10),
@authorizefor varchar(10),
@Userid varchar(10),
@Company varchar(max),
@output varchar(max),
@kycid varchar(10)

-- exec [KraCreateTradingAccAll] '','','18,19','Next','','','','',''
-- exec [KraCreateTradingAccAll] '','','18,19,20,21','next','','377','','','5'
-- exec [KraCreateTradingAccAll] '','','18','Create','deselect','377','',',,,,,20,21','5'
AS 
BEGIN
Declare @sql varchar(max),@authorizeValue int,@Clientinternalid varchar(max),@maxID varchar(20),
		@maxIDNO integer,@id2 varchar(11),@Staticcounter bigint,@Dynamiccounter bigint,@hold varchar(max),
		@Staticcountervirtual bigint,@Dynamiccountervirtual bigint,@Clientinternalidvirtualincreament varchar(max),
		@Clientinternalidvirtual varchar(max),@maxIDvirtual varchar(20),@maxIDNOvirtual integer,@id2virtual varchar(11),
		@Clientnamefirst varchar(2),@Clietucctemp varchar(10),@inceamentalucc varchar(10),@Clietucctempfirstcharacter varchar(5)
		
---------------------Declare Variable for Contact Person---------------------
Declare @Contactname varchar(150),@Contactophone varchar(50),@Contactrphone varchar(50),
		@Contactmobile varchar(50),@Contactemail varchar(50),@Contactdinuid varchar(20),@Contactpan varchar(15),
		@ContactAddress1 varchar(100),@ContactAddress2 varchar(100),@ContactAddress3 varchar(100),
		@Contactpin varchar(100),@Contactcountry varchar(100),@Contactstate varchar(100),@Contactcity varchar(100),
		@Contactinternalid varchar(10)
--------------------End Declare Variable for Contact Person-------------------
	------------------Table Creation for Dynamic UCC and Client InternalID Binding-----------------------------		
	Create Table #TempKycmain(Autoid int identity,Clientnamec varchar(250),clientidc varchar(10),ClientUcctemp varchar(10),Kycid int,
								Kycdob varchar(15),appdate varchar(15),appnumber varchar(20),clienttype varchar(15))
	Create Table #TempKycmainfirstletter(Autoidfl int identity,Clientname varchar(2),clientid varchar(10))
	------------------End Table Creation for Dynamic UCC and Client InternalID Binding-----------------------------		

select @authorizeValue = max(GlobalSettings_Value) from Config_GlobalSettings 
where GlobalSettings_Name='GS_KYCAUTH' and GlobalSettings_SegmentID=998
	If(@mode='S')
		Begin
			Select @sql='
			Select  kycmain_id, ltrim(rtrim(isnull(KYCMain_FirstName,'' '')))+'' ''+
			ltrim(rtrim(isnull(KYCMain_MiddleName,'' '')))+'' ''+
			ltrim(rtrim(isnull(KYCMain_LastName,'' ''))) as Clientname,
			KYCMain_DocNo,KYCMain_ApplicationNumber,
			case when isnull(KYCMain_ClientType,''I'')=''I'' then ''Individual'' 
			else ''Non-Individual'' end as clienttype, 
			case when isnull(KYCMain_Gender,''M'')=''M'' then ''Male'' 
			else ''Female'' end as Gender,isnull(KYCMain_FatherSpouseName,'''') as fathername,
			isnull(Convert(varchar(11),KYCMain_ApplicationDate,106),'''') as Appdate,
			isnull(Convert(varchar(11),KYCMain_DateOfBirth,106),'''') as Dob,
			isnull(Convert(varchar(11),KYCMain_ExportDateTime,106),'''') as exportdate,
			isnull(KYCMain_BatchNumber,'''') as batchnumber,
			(select ltrim(rtrim(isnull(USER_name,'' '')))+'' [ ''+
			ltrim(rtrim(isnull(user_loginid,'' '')))+'' ] '' from tbl_master_user
			where user_id=KYCMain_exportUser) as username,
			case when isnull((select count(KYCDetail_MainID) from master_kycdetail
			where KYCMain_ID=KYCDetail_MainID),0)>0 then ''Yes'' else ''No'' end as partner,
			''Create Account'' as createaccount
			 from Master_KYCMain
			where KYCMain_CreateUser in (select USER_ID from tbl_master_user where user_EntryProfile in (''C'',''P'',''F''))
			and  DATEADD(dd, 0, DATEDIFF(dd, 0, kycmain_applicationDate)) between '''+@fromdate+''' AND '''+@todate+'''
			and KYCMain_Companyid in ('+@Company+')
			and KYCMain_VerifiedUser is not null and KYCMain_VerifiedDateTime is not null 
			and KYCMain_ExistingClient=''N''
			and isnull(KYCMain_ClientUCC,'''')=''''
			'
		
		If (@authorizeValue=1)
			Begin
				Set @sql=@sql+'	and KYCMain_AuthUser1 is not null 
								and KYCMain_AuthDateTime1 is not null '
								
			End
		If (@authorizeValue=2)
			Begin
				Set @sql=@sql+'	and KYCMain_AuthUser1 is not null 
								and KYCMain_AuthDateTime1 is not null
								and KYCMain_AuthUser2 is not null 
								and KYCMain_AuthDateTime2 is not null 
								'
								
			End
		If (@authorizeValue=3)
			Begin
				Set @sql=@sql+'	and KYCMain_AuthUser1 is not null 
								and KYCMain_AuthDateTime1 is not null 
								and KYCMain_AuthUser2 is not null 
								and KYCMain_AuthDateTime2 is not null
								and KYCMain_AuthUser3 is not null 
								and KYCMain_AuthDateTime3 is not null'
								
			End

			Exec (@sql)
		End
	If(@mode='Systemucc')
		Begin
			exec sp_GenerateContactUCC @ids,@output
		
		End
	If(@mode='Generated')
		Begin
			Select @Clientinternalid=(select 'CL'+upper(left(KYCMain_FirstName,1)) as name 
									  from Master_KYCMain where KYCMain_ID=@kycid)
			select @maxID= max(cnt_internalid) from tbl_master_contact where cnt_internalid 
						   like @Clientinternalid+'%'
			if(@maxID is null)
				begin
					set @Clientinternalid=@Clientinternalid+'0000001'
				end
			else
				begin
					select @maxIDNO = RIGHT(@maxID,7)+1
						if(@maxIDNO<=9)
							begin
							set @id2=@Clientinternalid+'000000'
							end
						if(@maxIDNO>9 and @maxIDNO<=99)
							begin
							set @id2=@Clientinternalid+'00000'
							end
						if(@maxIDNO>99 and @maxIDNO<=999)
							begin
							set @id2=@Clientinternalid+'0000'
							end
						if(@maxIDNO>999 and @maxIDNO<=9999)
							begin
							set @id2=@Clientinternalid+'000'
							end
						if(@maxIDNO>9999 and @maxIDNO<=99999)
							begin
							set @id2=@Clientinternalid+'00'
							end
						if(@maxIDNO>99999 and @maxIDNO<=999999)
							begin
							set @id2=@Clientinternalid+'0'
						end
					
						set @Clientinternalid = @id2 + cast(@maxIDNO as varchar(10))
					end
					
					
					------------------Start Insertion of main Client Table (tbl_master_contact)-------------------
					insert into tbl_master_contact(cnt_internalId,cnt_ucc,cnt_branchid,cnt_legalStatus,cnt_firstName,
					cnt_middleName,cnt_lastName,cnt_contactType,cnt_dOB,cnt_BusinessComncDate,cnt_contactStatus,cnt_sex,CreateDate,CreateUser,
					cnt_maritalStatus,cnt_PlaceOfIncorporation,cnt_nationality,cnt_pep,cnt_InPersonVerificationDone,cnt_InPersonVerificationDate,
					cnt_InPersonVerificationBy,WebLogIn,PassWord,cnt_clienttype,cnt_profession,cnt_OtherOccupation)
					
					select @Clientinternalid,@ids,KYCMain_BranchID,KYCMain_TaxStatus,KYCMain_FirstName,KYCMain_MiddleName,
					KYCMain_LastName,'CL',case when KYCMain_ClientType='I' then KYCMain_DateOfBirth else '' end,
					case when KYCMain_ClientType='N' then KYCMain_BusinessComDate else '' end,
					'1',case when KYCMain_Gender='M' then '0' else '1' end,
					GETDATE(),@Userid,case when KYCMain_MaritalStatus='S' then 6 else 1 end,
					case when KYCMain_ClientType='N' then (select city_name from tbl_master_city 
					where city_id=KYCMain_PlaceOfInCorp) else '' end,
					case when KYCMain_Nationality='1' then '1' else (select cou_id from tbl_master_country 
					where cou_country=KYCMain_NationalityOther and cou_id<>'1') end,
					KYCMain_PeP,KYCMain_IPVDone,KYCMain_IPVDate,KYCMain_IPVDoneBy,'Yes',@ids,'Retail',KYCMain_Occupation,KYCMain_OccupationOther
				    from Master_KYCMain where KYCMain_ID=@kycid
				    ------------------End Insertion of main Client Table (tbl_master_contact)-------------------
				    
				    ------------------Start Insertion of finance Client Table (tbl_master_contactfinace)-------------------
				    Insert into tbl_master_contactfinance(cfc_cntId,cfc_contactType,cfc_EffectDate,cfc_AnnualIncomeRange,cfc_Networth)
				    Select @Clientinternalid,'contact',KYCMain_NetWorthDate,KYCMain_GAIncome,KYCMain_NetWorth
				    from Master_KYCMain where KYCMain_ID=@kycid
				    ------------------End Insertion of finance Client Table (tbl_master_contactfinace)-------------------
				    
				     if exists(select * from Master_KYCMain where KYCMain_ID=@kycid and len(rtrim(ltrim(isnull(KYCMain_PAN,''))))>0
							 and KYCMain_PANExempt='N')
						Begin
							------------------Start Insertion of registration Client Table (tbl_master_contactregistration)-------------------
							Insert into tbl_master_contactRegistration(crg_cntId,crg_contactType,crg_type,crg_Number,crg_verify,CreateDate,CreateUser)
							Select @Clientinternalid,'contact','PanCard',KYCMain_PAN,'Verified',GETDATE(),@Userid
							from Master_KYCMain where KYCMain_ID=@kycid
							------------------End Insertion of registration Client Table (tbl_master_contactregistration)-------------------
						End
					if exists(select * from Master_KYCMain where KYCMain_ID=@kycid and len(rtrim(ltrim(isnull(KYCMain_UID,''))))>0)
						Begin
							------------------Start Insertion of registration Client Table (tbl_master_contactregistration)-------------------
							Insert into tbl_master_contactRegistration(crg_cntId,crg_contactType,crg_type,crg_Number,crg_verify,CreateDate,CreateUser)
							Select @Clientinternalid,'contact','AdharCard',KYCMain_UID,'Verified',GETDATE(),@Userid
							from Master_KYCMain where KYCMain_ID=@kycid
							------------------End Insertion of registration Client Table (tbl_master_contactregistration)-------------------
						End
				    
				    
				    ------------------StartUpdate Document Table(tbl_master_document)-----------------------------------------
				    update tbl_master_document set doc_contactId=@Clientinternalid where doc_contactId in 
				    (select KYCMain_DocNo from Master_KYCMain where KYCMain_ID=@kycid)
				    ------------------End Update Document Table(tbl_master_document)-----------------------------------------
				    
				    ------------------Start Insert Email Table(tbl_master_email)-----------------------------------------
				    IF exists(select KYCMain_EmailID from Master_KYCMain where KYCMain_ID=@kycid and ISNULL(KYCMain_EmailID,'')<>'')
						Begin
							Insert Into tbl_master_email (eml_cntId,eml_entity,eml_type,eml_email,eml_facility,CreateDate,CreateUser)
							select @Clientinternalid,'Customer/Client','Official',KYCMain_EmailID,1,GETDATE(),@Userid
							from Master_KYCMain where KYCMain_ID=@kycid
						End
				    ------------------End Insert Email Table(tbl_master_email)-----------------------------------------
				    
				    ------------------Start Insert address Table(tbl_master_address)-----------------------------------------
				    IF exists(select KYCMain_CAddress1 from Master_KYCMain where KYCMain_ID=@kycid and ISNULL(KYCMain_CAddress1,'')<>'')
						Begin
							Insert Into tbl_master_address(add_cntId,add_entity,add_addressType,add_address1,add_address2,add_address3,
														   add_pin,add_city,add_state,add_country)
							select @Clientinternalid,'Customer/Client','Correspondence',KYCMain_CAddress1,KYCMain_CAddress2,KYCMain_CAddress3
								 ,KYCMain_CPin,KYCMain_CCity,KYCMain_CState,KYCMain_CCountry
								 from Master_KYCMain where KYCMain_ID=@kycid
						End
				    ------------------End Insert address Table(tbl_master_address)-----------------------------------------
				    
				    ------------------Start Insert address Table(tbl_master_address)-----------------------------------------
				    IF exists(select KYCMain_PAddress1 from Master_KYCMain where KYCMain_ID=@kycid and ISNULL(KYCMain_PAddress1,'')<>'')
						Begin
							Insert Into tbl_master_address(add_cntId,add_entity,add_addressType,add_address1,add_address2,add_address3,
														   add_pin,add_city,add_state,add_country)
							select @Clientinternalid,'Customer/Client','Registered',KYCMain_PAddress1,KYCMain_PAddress2,KYCMain_pAddress3
								 ,KYCMain_PPin,KYCMain_PCity,KYCMain_PState,KYCMain_PCountry
								 from Master_KYCMain where KYCMain_ID=@kycid
						End
				    ------------------End Insert address Table(tbl_master_address)-----------------------------------------
				    
				    ------------------Start Insert phonefax Table(tbl_master_phonefax)-----------------------------------------
				    IF exists(select KYCMain_Mobile from Master_KYCMain where KYCMain_ID=@kycid )
						Begin
							Insert Into tbl_master_phonefax(phf_cntId,phf_entity,phf_type,phf_countryCode,phf_areaCode,phf_phoneNumber,CreateDate,CreateUser)
							select @Clientinternalid,'Customer/Client','Office',KYCMain_OPhoneISD,KYCMain_OPhoneSTD,KYCMain_OPhone,GETDATE(),@Userid
							from Master_KYCMain where KYCMain_ID=@kycid
						End
				    ------------------End Insert phonefax Table(tbl_master_phonefax)-----------------------------------------
				    
				    ------------------Start Insert phonefax Table(tbl_master_phonefax)-----------------------------------------
				    IF exists(select KYCMain_Mobile from Master_KYCMain where KYCMain_ID=@kycid )
						Begin
							Insert Into tbl_master_phonefax(phf_cntId,phf_entity,phf_type,phf_countryCode,phf_areaCode,phf_phoneNumber,CreateDate,CreateUser)
							select @Clientinternalid,'Customer/Client','Residence',KYCMain_RPhoneISD,KYCMain_RPhoneSTD,KYCMain_RPhone,GETDATE(),@Userid
							from Master_KYCMain where KYCMain_ID=@kycid
						End
				    ------------------End Insert phonefax Table(tbl_master_phonefax)-----------------------------------------
				    
				    ------------------Start Insert phonefax Table(tbl_master_phonefax)-----------------------------------------
				    IF exists(select KYCMain_Mobile from Master_KYCMain where KYCMain_ID=@kycid )
						Begin
							Insert Into tbl_master_phonefax(phf_cntId,phf_entity,phf_type,phf_countryCode,phf_phoneNumber,CreateDate,CreateUser,phf_SMSFacility)
							select @Clientinternalid,'Customer/Client','Mobile',KYCMain_MobileISD,KYCMain_Mobile,GETDATE(),@Userid,1
							from Master_KYCMain where KYCMain_ID=@kycid
						End
				    ------------------End Insert phonefax Table(tbl_master_phonefax)-----------------------------------------
				    
				    ------------------Start Contact Person Insert for NonIndividual(tbl_master_contactPerson)----------------
				    If Exists (select * from Master_KYCDetail where KYCDetail_MainID=@kycid)
						Begin
						
							Select @Dynamiccounter=COUNT(KYCDetail_ID) from Master_KYCDetail 
													where KYCDetail_MainID=@kycid
							Set @Staticcounter=1
							Select @hold= coalesce(@hold+''',''', '') + Convert(varchar,KYCDetail_ID)
							from Master_KYCDetail where KYCDetail_MainID=@kycid
							--set @hold=''''+@hold+''''
							if(@Staticcounter=@Dynamiccounter)
							set @hold=''+@hold+','
							else
							set @hold=REPLACE(@hold,'''','')
							While(@Staticcounter<=@Dynamiccounter)
								Begin
									Set @Contactname=''Set @Contactophone='' Set @Contactrphone=''
									Set	@Contactmobile=''Set @Contactemail=''Set @Contactdinuid=''Set @Contactpan =''
									Set	@ContactAddress1 =''Set @ContactAddress2 =''Set @ContactAddress3 =''Set @Contactinternalid=''
									Set	@Contactpin =''Set @Contactcountry =''Set @Contactstate =''Set @Contactcity =''
									Select @Contactname=LTRIM(rtrim(isnull(KYCDetail_Name,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactophone=LTRIM(rtrim(isnull(KYCDetail_OPhone,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactrphone=LTRIM(rtrim(isnull(KYCDetail_RPhone,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactmobile=LTRIM(rtrim(isnull(KYCDetail_Mobile,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactemail=LTRIM(rtrim(isnull(KYCDetail_Email,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactpan=LTRIM(rtrim(isnull(KYCDetail_PAN,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactdinuid=LTRIM(rtrim(isnull(KYCDetail_DinUid,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
														
									exec ContactPersonInsertforInsCompany @Contactname,@Contactophone,@Contactrphone,@Contactmobile,@Contactemail,0,0,'Y',@Clientinternalid,@Userid,@Contactpan,@Contactdinuid
									Select @Contactinternalid=cp_contactId from tbl_master_contactPerson where cp_Din=@Contactdinuid and cp_Pan=@Contactpan and cp_agentInternalId=@Clientinternalid
															  and cp_name=@Contactname and cp_relationShip=0 and cp_designation=0 
									Select @ContactAddress1=LTRIM(rtrim(isnull(KYCDetail_Address1,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @ContactAddress2=LTRIM(rtrim(isnull(KYCDetail_Address2,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @ContactAddress3=LTRIM(rtrim(isnull(KYCDetail_Address3,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactpin=LTRIM(rtrim(isnull(KYCDetail_PIN,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactcity=LTRIM(rtrim(isnull(KYCDetail_City,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactstate=LTRIM(rtrim(isnull(KYCDetail_State,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactcountry=LTRIM(rtrim(isnull(KYCDetail_Country,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Insert Into tbl_master_address(add_cntId,add_addressType,add_address1,add_address2,add_address3
																   ,add_state,add_city,add_country,add_area,add_pin,CreateDate,CreateUser)
									Select @Contactinternalid,'Registered',@ContactAddress1,@ContactAddress2,@ContactAddress3,@Contactstate,
									@Contactcity,@Contactcountry,0,@Contactpin,GETDATE(),@Userid
									Set @Staticcounter=@Staticcounter+1
								End
								----------------------------While Loop End-------------------------------------------------
						End
				    ------------------End Contact Person Insert for NonIndividual(tbl_master_contactPerson)----------------
				    ------------------Update Kycmain Table ClientUCC Field------------------------------------------
				    Update Master_KYCMain set KYCMain_ClientUCC=@ids where KYCMain_ID=@kycid
				    ---------------End Updation--------------------------------------
				    exec KraCreateTradingAccAll @fromdate,@todate,'','S','',@Userid,@Company,@output,@kycid
		End
	If(@mode='Next')
		Begin
			If (@authorizefor='deselect')
				Begin
					Insert Into #TempKycmainfirstletter(Clientname)
					Select distinct left(isnull(KYCMain_FirstName,'')+' '+isnull(KYCMain_MiddleName,'')+' '+isnull(KYCMain_LastName,''),1)
					from Master_KYCMain where KYCMain_ID  in (select col from fnSplitReturnTable(@output,','))
					--Select @ids=
				End
			Else
				Begin
					Insert Into #TempKycmainfirstletter(Clientname)
					Select distinct left(isnull(KYCMain_FirstName,'')+' '+isnull(KYCMain_MiddleName,'')+' '+isnull(KYCMain_LastName,''),1)
					from Master_KYCMain where KYCMain_ID in (select col from fnSplitReturnTable(@ids,','))
				End
			Select @Dynamiccounter=COUNT(*) from #TempKycmainfirstletter 
			Set @Staticcounter=1
			While(@Staticcounter<=@Dynamiccounter)
				Begin
						Select @Clientinternalid=(select 'CL'+upper(Clientname) as name 
									  from #TempKycmainfirstletter where Autoidfl=@Staticcounter)
						select @maxID= max(cnt_internalid) from tbl_master_contact where cnt_internalid 
									   like @Clientinternalid+'%'
						if(@maxID is null)
							begin
								set @Clientinternalid=@Clientinternalid+'0000001'
							end
						else
							begin
								select @maxIDNO = RIGHT(@maxID,7)+1
									if(@maxIDNO<=9)
										begin
										set @id2=@Clientinternalid+'000000'
										end
									if(@maxIDNO>9 and @maxIDNO<=99)
										begin
										set @id2=@Clientinternalid+'00000'
										end
									if(@maxIDNO>99 and @maxIDNO<=999)
										begin
										set @id2=@Clientinternalid+'0000'
										end
									if(@maxIDNO>999 and @maxIDNO<=9999)
										begin
										set @id2=@Clientinternalid+'000'
										end
									if(@maxIDNO>9999 and @maxIDNO<=99999)
										begin
										set @id2=@Clientinternalid+'00'
										end
									if(@maxIDNO>99999 and @maxIDNO<=999999)
										begin
										set @id2=@Clientinternalid+'0'
									end
					
									set @Clientinternalid = @id2 + cast(@maxIDNO as varchar(10))
								end
								update #TempKycmainfirstletter set clientid=@Clientinternalid
								where Autoidfl=@Staticcounter
								Set @Staticcounter=@Staticcounter+1
					End------------While End-----------------------
						If(@authorizefor='deselect')
							Begin
								Insert Into #TempKycmain(Clientnamec,Kycid,Kycdob,appdate,appnumber,clienttype)
								Select  isnull(KYCMain_FirstName,'')+' '+isnull(KYCMain_MiddleName,'')+' '+isnull(KYCMain_LastName,''),KYCMain_ID,
								CONVERT(VARCHAR(11), KYCMain_DateOfBirth, 106),CONVERT(VARCHAR(11), KYCMain_ApplicationDate, 106),KYCMain_ApplicationNumber,
								Case When KYCMain_ClientType='I' then 'Individual' Else 'Non-Individual' End
								from Master_KYCMain where KYCMain_ID in (select col from fnSplitReturnTable(@output,','))
							End
						Else
								Begin
									Insert Into #TempKycmain(Clientnamec,Kycid,Kycdob,appdate,appnumber,clienttype)
									Select  isnull(KYCMain_FirstName,'')+' '+isnull(KYCMain_MiddleName,'')+' '+isnull(KYCMain_LastName,''),KYCMain_ID,
									CONVERT(VARCHAR(11), KYCMain_DateOfBirth, 106),CONVERT(VARCHAR(11), KYCMain_ApplicationDate, 106),KYCMain_ApplicationNumber,
									Case When KYCMain_ClientType='I' then 'Individual' Else 'Non-Individual' End
									from Master_KYCMain where KYCMain_ID in (select col from fnSplitReturnTable(@ids,','))
								End
							Select @Dynamiccountervirtual=COUNT(*) from #TempKycmainfirstletter 
							Set @Staticcountervirtual=1
							While(@Staticcountervirtual<=@Dynamiccountervirtual)
								Begin
									Select @Clientnamefirst=Clientname  from #TempKycmainfirstletter where Autoidfl=@Staticcountervirtual
									Select @Clientinternalidvirtual=clientid  from #TempKycmainfirstletter where Autoidfl=@Staticcountervirtual
									
									Select @Dynamiccounter=COUNT(*) from #TempKycmain 
									Set @Staticcounter=1
									While(@Staticcounter<=@Dynamiccounter)
										Begin
											select @maxID= clientid from #TempKycmainfirstletter,#TempKycmain where Clientname=left(Clientnamec ,1)
											   and Autoid=@Staticcounter order by Autoid
											   If Not Exists (select * from #TempKycmain where clientidc=@Clientinternalidvirtual 
											   and left(Clientnamec ,1)=@Clientnamefirst)
													Begin
														
														select @maxIDNO = RIGHT(@maxID,7)
														update #TempKycmain set clientidc=@Clientinternalidvirtual,
														ClientUcctemp=UPPER(@Clientnamefirst+RIGHT(@Clientinternalidvirtual,@kycid))
														where Autoid=@Staticcounter 
														and left(Clientnamec ,1)=@Clientnamefirst
														
														Select @Clietucctemp=UPPER(@Clientnamefirst+RIGHT(@Clientinternalidvirtual,@kycid))
														from #TempKycmain where Autoid=@Staticcounter 
														and left(Clientnamec ,1)=@Clientnamefirst
														
													End
												Else
													Begin
														select @maxIDNO = RIGHT(@maxID,7)+1
														if(@maxIDNO<=9)
															begin
																--set @id2virtual=@Clientinternalidvirtualincreament+'000000'
																Set @id2virtual='CL'+@Clientnamefirst+'000000'
															end
														if(@maxIDNO>9 and @maxIDNO<=99)
															begin
																Set @id2virtual='CL'+@Clientnamefirst+'00000'
															end
														if(@maxIDNO>99 and @maxIDNO<=999)
															begin
																Set @id2virtual='CL'+@Clientnamefirst+'0000'
															end
														if(@maxIDNO>999 and @maxIDNO<=9999)
															begin
																Set @id2virtual='CL'+@Clientnamefirst+'000'
															end
														if(@maxIDNO>9999 and @maxIDNO<=99999)
															begin
																Set @id2virtual='CL'+@Clientnamefirst+'00'
															end
														if(@maxIDNO>99999 and @maxIDNO<=999999)
															begin
																Set @id2virtual='CL'+@Clientnamefirst+'0'
															end
													
														set @Clientinternalidvirtualincreament = @id2virtual + cast(@maxIDNO as varchar(10))
														update #TempKycmain set clientidc=@Clientinternalidvirtualincreament,
														ClientUcctemp=UPPER(@Clientnamefirst+RIGHT(@Clientinternalidvirtualincreament,@kycid)) 
														where Autoid=@Staticcounter
														and left(Clientnamec ,1)=@Clientnamefirst
														
													
													
												 End
												 
												Set @Staticcounter=@Staticcounter+1
										End--------------Inner While End-----------
										
										Set @Staticcountervirtual=@Staticcountervirtual+1
										
								End--------------Outer While End-----------
								---------------------Again While Start For Ucc Checking (Data Structure)----------------------
								Declare @increamentcounter varchar(10),@lencounter int
								Select @Dynamiccountervirtual=COUNT(*) from #TempKycmain 
								Set @Staticcountervirtual=1
								While(@Staticcountervirtual<=@Dynamiccountervirtual)
								Begin
									Select @Clietucctempfirstcharacter=Left(ClientUcctemp,1) from #TempKycmain where Autoid=@Staticcountervirtual
									Select @Clietucctemp=ClientUcctemp from #TempKycmain where Autoid=@Staticcountervirtual
										
												While exists( select * from tbl_master_contact,tbl_master_contactExchange 
													where (cnt_UCC=@Clietucctemp or crg_tcode=@Clietucctemp) and cnt_internalId=crg_cntID) 
														 Begin
														 
															
															Select @Clietucctemp=max(ClientUcctemp) from #TempKycmain where ClientUcctemp 
																				like @Clietucctempfirstcharacter+'%'
															Select @increamentcounter=SUBSTRING(@Clietucctemp,2,LEN(@Clietucctemp))+1
															Select @lencounter=@kycid-LEN(@increamentcounter)
															
															Select @increamentcounter=REPLICATE('0',@lencounter)+cast(@increamentcounter as varchar(10))
															
															Select @Clietucctemp=@Clietucctempfirstcharacter+cast(@increamentcounter as varchar(10))
															update #TempKycmain set ClientUcctemp=@Clietucctemp
															where Autoid=@Staticcountervirtual 
															and left(Clientnamec,1)=@Clientnamefirst
															
														 End
												
									Set @Staticcountervirtual=@Staticcountervirtual+1
								End
								
								
								
								
								
								--------------------------------------------End--------------------------------------------------
								
								Select Kycid as kycmain_id,clientidc,Clientnamec as Clientname,ClientUcctemp as Gender,
								appnumber as KYCMain_ApplicationNumber,appdate as Appdate,Kycdob as Dob,clienttype as clienttype,
								'' as fathername,'' as exportdate,''  as username,'' as batchnumber, '' as partner
								from #TempKycmain
		End
	If(@mode='Create')
		Begin
			Create Table #Tempinsert(Rowid int identity,kycid int,clientid varchar(15),name varchar(250),ucc varchar(100),
								appnumber varchar(20),appdate varchar(20),dob varchar(20),Clienttype varchar(20),
								fathername varchar(20),exportdate varchar(20),username varchar(20),
								batchnumber varchar(20),partner varchar(20))
			Insert into #Tempinsert 
			exec KraCreateTradingAccAll '','',@ids,'Next','','','','',@kycid
			--select Rowid,kycid,clientid,ucc from #Tempinsert
			Select @Dynamiccountervirtual=COUNT(*) from #Tempinsert 
			Set @Staticcountervirtual=1
			While(@Staticcountervirtual<=@Dynamiccountervirtual)
				Begin
								Select @Clientinternalid=clientid from #Tempinsert where Rowid=@Staticcountervirtual
								Select @inceamentalucc=ucc from #Tempinsert where Rowid=@Staticcountervirtual
								Select @id2virtual=kycid from #Tempinsert where Rowid=@Staticcountervirtual
					
					------------------Insertion of main Client Table (tbl_master_contact)-------------------			
					insert into tbl_master_contact(cnt_internalId,cnt_ucc,cnt_branchid,cnt_legalStatus,cnt_firstName,
					cnt_middleName,cnt_lastName,cnt_contactType,cnt_dOB,cnt_BusinessComncDate,cnt_contactStatus,cnt_sex,CreateDate,CreateUser,
					cnt_maritalStatus,cnt_PlaceOfIncorporation,cnt_nationality,cnt_pep,cnt_InPersonVerificationDone,cnt_InPersonVerificationDate,
					cnt_InPersonVerificationBy,WebLogIn,PassWord,cnt_clienttype,cnt_profession,cnt_OtherOccupation)
					
					select @Clientinternalid,@inceamentalucc,KYCMain_BranchID,KYCMain_TaxStatus,KYCMain_FirstName,KYCMain_MiddleName,
					KYCMain_LastName,'CL',case when KYCMain_ClientType='I' then KYCMain_DateOfBirth else '' end,
					case when KYCMain_ClientType='N' then KYCMain_BusinessComDate else '' end,
					'1',case when KYCMain_Gender='M' then '0' else '1' end,
					GETDATE(),@Userid,case when KYCMain_MaritalStatus='S' then 6 else 1 end,
					case when KYCMain_ClientType='N' then (select city_name from tbl_master_city 
					where city_id=KYCMain_PlaceOfInCorp) else '' end,
					case when KYCMain_Nationality='1' then '1' else (select cou_id from tbl_master_country 
					where cou_country=KYCMain_NationalityOther and cou_id<>'1') end,
					KYCMain_PeP,KYCMain_IPVDone,KYCMain_IPVDate,KYCMain_IPVDoneBy,'Yes',@inceamentalucc,'Retail',KYCMain_Occupation,KYCMain_OccupationOther
					from Master_KYCMain where KYCMain_ID=@id2virtual
				    ------------------End Insertion of main Client Table (tbl_master_contact)-------------------
								
				    ------------------Start Insertion of finance Client Table (tbl_master_contactfinace)-------------------
				    Insert into tbl_master_contactfinance(cfc_cntId,cfc_contactType,cfc_EffectDate,cfc_AnnualIncomeRange,cfc_Networth)
				    Select @Clientinternalid,'contact',KYCMain_NetWorthDate,KYCMain_GAIncome,KYCMain_NetWorth
				    from Master_KYCMain where KYCMain_ID=@id2virtual
				    ------------------End Insertion of finance Client Table (tbl_master_contactfinace)-------------------
								
					if exists(select * from Master_KYCMain where KYCMain_ID=@id2virtual and len(rtrim(ltrim(isnull(KYCMain_PAN,''))))>0
							 and KYCMain_PANExempt='N')
						Begin
							------------------Start Insertion of registration Client Table (tbl_master_contactregistration)-------------------
							Insert into tbl_master_contactRegistration(crg_cntId,crg_contactType,crg_type,crg_Number,crg_verify,CreateDate,CreateUser)
							Select @Clientinternalid,'contact','PanCard',KYCMain_PAN,'Verified',GETDATE(),@Userid
							from Master_KYCMain where KYCMain_ID=@id2virtual
							------------------End Insertion of registration Client Table (tbl_master_contactregistration)-------------------
						End
					if exists(select * from Master_KYCMain where KYCMain_ID=@id2virtual and len(rtrim(ltrim(isnull(KYCMain_UID,''))))>0)
						Begin
							------------------Start Insertion of registration Client Table (tbl_master_contactregistration)-------------------
							Insert into tbl_master_contactRegistration(crg_cntId,crg_contactType,crg_type,crg_Number,crg_verify,CreateDate,CreateUser)
							Select @Clientinternalid,'contact','AdharCard',KYCMain_UID,'Verified',GETDATE(),@Userid
							from Master_KYCMain where KYCMain_ID=@id2virtual
							------------------End Insertion of registration Client Table (tbl_master_contactregistration)-------------------
						End
				    			
					
					
				    ------------------StartUpdate Document Table(tbl_master_document)-----------------------------------------
				    update tbl_master_document set doc_contactId=@Clientinternalid where doc_contactId in 
				    (select KYCMain_DocNo from Master_KYCMain where KYCMain_ID=@id2virtual)
				    ------------------End Update Document Table(tbl_master_document)-----------------------------------------
								
				    ------------------Start Insert Email Table(tbl_master_email)-----------------------------------------
				    IF exists(select KYCMain_EmailID from Master_KYCMain where KYCMain_ID=@id2virtual and ISNULL(KYCMain_EmailID,'')<>'')
						Begin
							Insert Into tbl_master_email (eml_cntId,eml_entity,eml_type,eml_email,eml_facility,CreateDate,CreateUser)
							select @Clientinternalid,'Customer/Client','Official',KYCMain_EmailID,'1',GETDATE(),@Userid
							from Master_KYCMain where KYCMain_ID=@id2virtual
						End
				    ------------------End Insert Email Table(tbl_master_email)-----------------------------------------
								
				    ------------------Start Insert address Table(tbl_master_address)-----------------------------------------
				     IF exists(select KYCMain_CAddress1 from Master_KYCMain where KYCMain_ID=@id2virtual and ISNULL(KYCMain_CAddress1,'')<>'')
						Begin
							Insert Into tbl_master_address(add_cntId,add_entity,add_addressType,add_address1,add_address2,add_address3,
														   add_pin,add_city,add_state,add_country)
							select @Clientinternalid,'Customer/Client','Correspondence',KYCMain_CAddress1,KYCMain_CAddress2,KYCMain_CAddress3
								 ,KYCMain_CPin,KYCMain_CCity,KYCMain_CState,KYCMain_CCountry
								 from Master_KYCMain where KYCMain_ID=@id2virtual
						End
				    ------------------End Insert address Table(tbl_master_address)-----------------------------------------
								
				    ------------------Start Insert address Table(tbl_master_address)-----------------------------------------
				    IF exists(select KYCMain_PAddress1 from Master_KYCMain where KYCMain_ID=@id2virtual and ISNULL(KYCMain_PAddress1,'')<>'')
						Begin
							Insert Into tbl_master_address(add_cntId,add_entity,add_addressType,add_address1,add_address2,add_address3,
														   add_pin,add_city,add_state,add_country)
							select @Clientinternalid,'Customer/Client','Registered',KYCMain_PAddress1,KYCMain_PAddress2,KYCMain_pAddress3
								 ,KYCMain_PPin,KYCMain_PCity,KYCMain_PState,KYCMain_PCountry
								 from Master_KYCMain where KYCMain_ID=@id2virtual
						End
				    ------------------End Insert address Table(tbl_master_address)-----------------------------------------
							
				    ------------------Start Insert phonefax Table(tbl_master_phonefax)-----------------------------------------
				    IF exists(select KYCMain_OPhone from Master_KYCMain where KYCMain_ID=@id2virtual)
						Begin
							Insert Into tbl_master_phonefax(phf_cntId,phf_entity,phf_type,phf_countryCode,phf_areaCode,phf_phoneNumber,CreateDate,CreateUser)
							select @Clientinternalid,'Customer/Client','Office',KYCMain_OPhoneISD,KYCMain_OPhoneSTD,KYCMain_OPhone,GETDATE(),@Userid
							from Master_KYCMain where KYCMain_ID=@id2virtual
						End
				    ------------------End Insert phonefax Table(tbl_master_phonefax)-----------------------------------------
							
				    ------------------Start Insert phonefax Table(tbl_master_phonefax)-----------------------------------------
				    IF exists(select KYCMain_RPhone from Master_KYCMain where KYCMain_ID=@id2virtual )
						Begin
							Insert Into tbl_master_phonefax(phf_cntId,phf_entity,phf_type,phf_countryCode,phf_areaCode,phf_phoneNumber,CreateDate,CreateUser)
							select @Clientinternalid,'Customer/Client','Residence',KYCMain_RPhoneISD,KYCMain_RPhoneSTD,KYCMain_RPhone,GETDATE(),@Userid
							from Master_KYCMain where KYCMain_ID=@id2virtual
						End
				    ------------------End Insert phonefax Table(tbl_master_phonefax)-----------------------------------------
							
				    ------------------Start Insert phonefax Table(tbl_master_phonefax)-----------------------------------------
				    IF exists(select KYCMain_Mobile from Master_KYCMain where KYCMain_ID=@id2virtual)
						Begin
							Insert Into tbl_master_phonefax(phf_cntId,phf_entity,phf_type,phf_countryCode,phf_phoneNumber,CreateDate,CreateUser,phf_SMSFacility)
							select @Clientinternalid,'Customer/Client','Mobile',KYCMain_MobileISD,KYCMain_Mobile,GETDATE(),@Userid,'1'
							from Master_KYCMain where KYCMain_ID=@id2virtual
						End
				    ------------------End Insert phonefax Table(tbl_master_phonefax)-----------------------------------------
							
				    ------------------Start Contact Person Insert for NonIndividual(tbl_master_contactPerson)----------------
				    If Exists (select * from Master_KYCDetail where KYCDetail_MainID=@id2virtual)
						Begin
						
							Select @Dynamiccounter=COUNT(*) from Master_KYCDetail 
													where KYCDetail_MainID=@id2virtual
							Set @Staticcounter=1
							Select @hold= coalesce(@hold+''',''', '') + Convert(varchar,KYCDetail_ID)
							from Master_KYCDetail where KYCDetail_MainID=@id2virtual
							--set @hold=''''+@hold+''''
							if(@Staticcounter=@Dynamiccounter)
							set @hold=''+@hold+','
							else
							set @hold=REPLACE(@hold,'''','')
							While(@Staticcounter<=@Dynamiccounter)
								Begin
									
									Set @Contactname=''Set @Contactophone='' Set @Contactrphone=''
									Set	@Contactmobile=''Set @Contactemail=''Set @Contactdinuid=''Set @Contactpan =''
									Set	@ContactAddress1 =''Set @ContactAddress2 =''Set @ContactAddress3 =''Set @Contactinternalid=''
									Set	@Contactpin =''Set @Contactcountry =''Set @Contactstate =''Set @Contactcity =''
									Select @Contactname=LTRIM(rtrim(isnull(KYCDetail_Name,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactophone=LTRIM(rtrim(isnull(KYCDetail_OPhone,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactrphone=LTRIM(rtrim(isnull(KYCDetail_RPhone,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactmobile=LTRIM(rtrim(isnull(KYCDetail_Mobile,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactemail=LTRIM(rtrim(isnull(KYCDetail_Email,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactpan=LTRIM(rtrim(isnull(KYCDetail_PAN,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactdinuid=LTRIM(rtrim(isnull(KYCDetail_DinUid,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
														
									exec ContactPersonInsertforInsCompany @Contactname,@Contactophone,@Contactrphone,@Contactmobile,@Contactemail,0,0,'Y',@Clientinternalid,@Userid,@Contactpan,@Contactdinuid
									Select @Contactinternalid=cp_contactId from tbl_master_contactPerson where cp_Din=@Contactdinuid and cp_Pan=@Contactpan and cp_agentInternalId=@Clientinternalid
															  and cp_name=@Contactname and cp_relationShip=0 and cp_designation=0 
									Select @ContactAddress1=LTRIM(rtrim(isnull(KYCDetail_Address1,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @ContactAddress2=LTRIM(rtrim(isnull(KYCDetail_Address2,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @ContactAddress3=LTRIM(rtrim(isnull(KYCDetail_Address3,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactpin=LTRIM(rtrim(isnull(KYCDetail_PIN,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactcity=LTRIM(rtrim(isnull(KYCDetail_City,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactstate=LTRIM(rtrim(isnull(KYCDetail_State,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Select @Contactcountry=LTRIM(rtrim(isnull(KYCDetail_Country,''))) from master_kycdetail
														Where KYCDetail_ID in (select dbo.fnSplit(@hold,',',@Staticcounter))
									Insert Into tbl_master_address(add_cntId,add_addressType,add_address1,add_address2,add_address3
																   ,add_state,add_city,add_country,add_area,add_pin,CreateDate,CreateUser)
									Select @Contactinternalid,'Registered',@ContactAddress1,@ContactAddress2,@ContactAddress3,@Contactstate,
									@Contactcity,@Contactcountry,0,@Contactpin,GETDATE(),@Userid
									Set @Staticcounter=@Staticcounter+1
								End
								----------------------------While Loop End-------------------------------------------------
						End
				    ------------------End Contact Person Insert for NonIndividual(tbl_master_contactPerson)----------------
				    ------------------Update Kycmain Table ClientUCC Field------------------------------------------
				    Update Master_KYCMain set KYCMain_ClientUCC=@inceamentalucc where KYCMain_ID=@id2virtual
				    ---------------End Updation--------------------------------------
					Set @Staticcountervirtual=@Staticcountervirtual+1
				End-------------While End--------------
			--exec KraCreateTradingAccAll @fromdate,@todate,'','S','',@Userid,@Company,@output,@kycid	
			exec KraCreateTradingAccAll '','',@ids,'Next',@authorizefor,'','',@output,@kycid
			
			
		End
   					drop table #TempKycmainfirstletter
					drop table #TempKycmain
	
End	
	




		

