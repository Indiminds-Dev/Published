
ALTER PROCEDURE [dbo].[Sp_SRVTAXSTATEMENT]
@Segmentid varchar(MAX),
@FromDate varchar(50),
@ToDate varchar(50),  
@Companyid varchar(100),
@Branch varchar(MAX),
@RptType VARCHAR(10),
@Consider varchar(20),
@AsPer varchar(20),
@SegmentBreakUp varchar(10)
AS
Begin
Set Nocount On

------Exec [Sp_SRVTAXSTATEMENT]
------'ALL'------@segmentid varchar(MAX),
------,'2011-07-26'-----@FromDate varchar(50),
------,'2011-07-28'-----@ToDate varchar(50),  
------,'COR0000002'-------@companyID varchar(100),
------,'129,1,130,131,204,153,198,161'-------@BRANCH varchar(MAX),
------,'Month'-----@REPORTTYPE VARCHAR(10),
------,'Trade Date'------@Consider varchar(20)
------,'CntrNo'-----@AsPer varchar(20)
------,'true'-----@SegmentBreakUp varchar(10)

---------------------------------------------------Notes---------------------------------------------------------
--Change 1: DematCharge was not considering when segment all. Create Distinct Segment Table and Join it when 
--Calculating DematCharge For All Segment

-------------------------------------------------End--Notes-------------------------------------------------------


------Change 1:
Create Table #DistinctSegment(SegmentID int,SegmentName Varchar(20))
if(@Segmentid<>'ALL')
Begin
	Insert into #DistinctSegment
	Select col,(Select 
	Exh_ShortName+'-'+Exch_SegmentID from
	(Select Exch_CompID,Exch_InternalID,Exh_ShortName,Exch_SegmentID from Tbl_Master_Exchange,Tbl_Master_CompanyExchange 
	Where Exh_CntId=Exch_ExchID and exch_internalId=col) as T1,Master_Exchange
	Where Exchange_ShortName=Exh_ShortName) from fnSplitReturnTable(@Segmentid,',')
End
else
Begin
	Insert into #DistinctSegment
	Select 
	exch_internalId,Exh_ShortName+'-'+Exch_SegmentID from
	(Select Exch_CompID,Exch_InternalID,Exh_ShortName,Exch_SegmentID from Tbl_Master_Exchange,Tbl_Master_CompanyExchange 
	Where Exh_CntId=Exch_ExchID and Exch_SegmentID in ('CM','FO','CDX')) as T1,Master_Exchange
	Where Exchange_ShortName=Exh_ShortName 
End

---------------Create Table and Variable Begin		
Declare @Sql varchar(MAX)
Create Table #TbConsider(Date Datetime,PayoutDate Datetime,SettNo varchar(10),SettType varchar(3),Segmentid varchar(10),ExchSegmentid varchar(10),SegmentName varchar(10))

Create Table #TbResult( StOrder int,TradeDate Datetime,TradeYear int,TradeMonth int,GrossEarning numeric(28,2),NetEarning numeric(28,2),
					   SrvTax numeric(28,2),EduCess numeric(28,2),HgrEduCess numeric(28,2),TotServTax numeric(28,2),[Type] varchar(50)
					   ,SegmentName varchar(10),CollectionType varchar(5),InclusiveStt numeric(28,4),InclusiveSrvTax numeric(28,4))
---------------Create Table and Variable End
		
		Select @Sql='
		Select Distinct Date,PayoutDate,exch_internalid,settlements_number,settlements_typesuffix,settlements_exchangesegmentid,SegmentName From  
		(Select Distinct '
		If @Consider='Trade Date'
		Begin
			Select @Sql=@Sql+' settlements_startdatetime as Date,settlements_startdatetime as PayoutDate'
		End
		If @Consider='Payout Date'
		Begin
			Select @Sql=@Sql+' settlements_startdatetime as Date,settlements_fundspayout as PayoutDate '
		End
		Select @Sql=@Sql+' ,exch_internalid,settlements_number,settlements_typesuffix,settlements_exchangesegmentid,SegmentName
		From master_settlements,(Select Distinct CASE 
										 WHEN EXCH_EXCHID=''EXN0000002'' and EXCH_SEGMENTID=''CM'' THEN ''1''
										 WHEN EXCH_EXCHID=''EXB0000001'' and EXCH_SEGMENTID=''CM'' THEN ''4''
										 WHEN EXCH_EXCHID=''EXC0000001'' and EXCH_SEGMENTID=''CM'' THEN ''15''
										 End as ExchangeSegmentId
										 ,CASE 
											 WHEN EXCH_SEGMENTID=''CM'' AND EXCH_EXCHID=''EXN0000002'' THEN ''NSE-CM''
											 WHEN EXCH_SEGMENTID=''CM'' AND EXCH_EXCHID=''EXB0000001'' THEN ''BSE-CM''
											 WHEN EXCH_SEGMENTID=''CM'' AND EXCH_EXCHID=''EXC0000001'' THEN ''CSE-CM''
										 End as SegmentName
										 ,exch_internalid From tbl_master_companyexchange
										 Where exch_segmentid=''CM'' and exch_compid='''+@companyID+''''
										 If @Segmentid<>'ALL'
										 Begin
											Select @Sql=@Sql+' and exch_internalid in ('+@Segmentid+') '
										 End
										Select @Sql=@Sql+'  
								) as bb
		Where settlements_exchangesegmentid=ExchangeSegmentId'
		If @Consider='Trade Date'
		Begin
			Select @Sql=@Sql+' and settlements_startdatetime '
		End
		If @Consider='Payout Date'
		Begin
			Select @Sql=@Sql+' and settlements_fundspayout '
		End
		Select @Sql=@Sql+' between '''+@FromDate+''' and '''+@ToDate+'''

		Union All

		Select Date,Date as PayoutDate,exch_internalid,settlements_number,settlements_typesuffix,settlements_exchangesegmentid,SegmentName From 
		(select dateadd(d, offset - 1,'''+@FromDate+''') as Date
		from (
			select row_number() over(order by s1.id) as offset
			from syscolumns s1, syscolumns s2
		) a where offset <= datediff(d,'''+@FromDate+''','''+@ToDate+''')
		Union All
		Select '''+@ToDate+''' as Date) as kk,(Select Distinct CASE 
													 WHEN EXCH_EXCHID=''EXN0000002'' and EXCH_SEGMENTID=''FO'' THEN ''2''
													 WHEN EXCH_EXCHID=''EXB0000001'' and EXCH_SEGMENTID=''FO'' THEN ''5''
													 WHEN EXCH_SEGMENTID=''COMM'' AND EXCH_EXCHID=''EXM0000001'' THEN ''7''
													 WHEN EXCH_SEGMENTID=''COMM'' AND EXCH_EXCHID=''EXI0000001'' THEN ''12''
													 WHEN EXCH_SEGMENTID=''COMM'' AND EXCH_EXCHID=''EXN0000004'' THEN ''9''
													 WHEN EXCH_SEGMENTID=''COMM'' AND EXCH_EXCHID=''EXN0000005'' THEN ''11''
													 WHEN EXCH_SEGMENTID=''COMM'' AND EXCH_EXCHID=''EXD0000001'' THEN ''10''
													 WHEN EXCH_SEGMENTID=''CDX'' AND EXCH_EXCHID=''EXM0000002'' THEN ''8''
													 WHEN EXCH_SEGMENTID=''CDX'' AND EXCH_EXCHID=''EXU0000001'' THEN ''13''
													 WHEN EXCH_SEGMENTID=''CDX'' AND EXCH_EXCHID=''EXB0000001'' THEN ''6''
													 WHEN EXCH_SEGMENTID=''CDX'' AND EXCH_EXCHID=''EXN0000002'' THEN ''3''
													 WHEN EXCH_SEGMENTID=''SPOT'' AND EXCH_EXCHID=''EXN0000006'' THEN ''14''
													 End as ExchangeSegmentId
													 ,CASE 
														 WHEN EXCH_SEGMENTID=''COMM'' AND EXCH_EXCHID=''EXM0000001'' THEN ''MCX-COMM''
														 WHEN EXCH_SEGMENTID=''COMM'' AND EXCH_EXCHID=''EXI0000001'' THEN ''ICEX-COMM''
														 WHEN EXCH_SEGMENTID=''COMM'' AND EXCH_EXCHID=''EXN0000004'' THEN ''NCDEX-COMM''
														 WHEN EXCH_SEGMENTID=''COMM'' AND EXCH_EXCHID=''EXN0000005'' THEN ''NMCE-COMM''
														 WHEN EXCH_SEGMENTID=''COMM'' AND EXCH_EXCHID=''EXD0000001'' THEN ''DGCX-COMM''
														 WHEN EXCH_SEGMENTID=''CDX'' AND EXCH_EXCHID=''EXM0000002'' THEN ''MCXSX-CDX''
														 WHEN EXCH_SEGMENTID=''CDX'' AND EXCH_EXCHID=''EXU0000001'' THEN ''USE-CDX''
														 WHEN EXCH_SEGMENTID=''CDX'' AND EXCH_EXCHID=''EXB0000001'' THEN ''BSE-CDX''
														 WHEN EXCH_SEGMENTID=''CDX'' AND EXCH_EXCHID=''EXN0000002'' THEN ''NSE-CDX''
														 WHEN EXCH_SEGMENTID=''SPOT'' AND EXCH_EXCHID=''EXN0000006'' THEN ''NSEL-SPOT''
														 WHEN EXCH_EXCHID=''EXN0000002'' AND EXCH_SEGMENTID=''FO'' THEN ''NSE-FO''
														 WHEN EXCH_EXCHID=''EXB0000001'' AND EXCH_SEGMENTID=''FO'' THEN ''BSE-FO''
													 End as SegmentName
													 ,exch_internalid From tbl_master_companyexchange
													 Where exch_segmentid<>''CM'' and exch_compid='''+@companyID+''''
													 If @Segmentid<>'ALL'
													 Begin
														Select @Sql=@Sql+' and exch_internalid in ('+@Segmentid+') '
													 End
													Select @Sql=@Sql+'  
											) as jj
		,master_settlements
		Where settlements_exchangesegmentid=ExchangeSegmentId
		and dbo.[fn_GetFinYear](Cast('''+@FromDate+''' as Datetime))=settlements_Finyear
		) as pp'


		Insert Into #TbConsider(Date,PayoutDate,Segmentid,SettNo,SettType,ExchSegmentid,SegmentName)Exec(@sql)
		
--		Select * into TbConsider from #TbConsider 

If(@RptType<>'Contract')
Begin
	
	
	----------------------------If Report Type='Date Wise' and As Per 'Contract Wise' and 'No Segment BreakUp' Begin-------------------------------------
	If (@RptType='Date' and @AsPer='CntrNo' and @SegmentBreakUp='false')
	Begin
			 ----------------------Collection Type : Brokerage
			 Select @Sql=
			' Select 5
			 ,Case When TradeDate is null Then InCluSiveTradeDate Else TradeDate End
			 ,TotalBrokerage
			 ,InclusiveStt,InclusivesrvTax
			,(isnull(TotalBrokerage,0)-isnull(InCluSiveSrvTax,0)-isnull(InclusiveStt,0))
			,ServiceTaxOnBrkg
			 ,EduCessOnBrkg
			 ,HgrEduCessOnBrkg
			 ,TotalSrvTaxBrkg
			 ,Convert(VARCHAR(11),TradeDate,106) 
			 From
			 (Select 
			  Sum(ISNULL(ContractNotes_TotalBrokerage,0)) AS TotalBrokerage
			 ,Sum(ISNULL(ContractNotes_ServiceTaxOnBrkg,0)) AS ServiceTaxOnBrkg
			 ,Sum(ISNULL(ContractNotes_EduCessOnBrkg,0)) AS EduCessOnBrkg
			 ,Sum(ISNULL(ContractNotes_HgrEduCessOnBrkg,0)) AS HgrEduCessOnBrkg
			 ,Sum(   ISNULL(ContractNotes_ServiceTaxOnBrkg,0)+
					ISNULL(ContractNotes_EduCessOnBrkg,0)+
					ISNULL(ContractNotes_HgrEduCessOnBrkg,0)
				)AS TotalSrvTaxBrkg
			 ,PayoutDate AS TradeDate
			 
			 From Trans_ContractNotes,#TbConsider
			 Where 
			 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By PayoutDate) as TbAllBrkg

			 Left Outer Join
			 
			(
			 Select InclusiveStt,InCluSiveSrvTax,InCluSiveTradeDate from
			 (Select Sum(    ISNULL(ContractNotes_ServiceTaxOnBrkg,0)+
							ISNULL(ContractNotes_EduCessOnBrkg,0)+
							ISNULL(ContractNotes_HgrEduCessOnBrkg,0)
					   ) AS InCluSiveSrvTax,
			 PayoutDate AS InCluSiveTradeDate
			 From Trans_ContractNotes,#TbConsider
			 Where ContractNotes_ServiceTaxMode=''I''
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By PayoutDate) T1
			 Left outer Join 
			 (Select Isnull(Sum(ContractNotes_STTAmount),0) AS InclusiveStt,PayoutDate AS InclusiveSttTradeDate
			 From Trans_ContractNotes,#TbConsider
			 Where ContractNotes_SttMode=''I''
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By PayoutDate) T2
			 On T1.InCluSiveTradeDate=T2.InclusiveSttTradeDate
			 ) as TbInCluSiveBrkg			 
			 
			 On(TradeDate=InCluSiveTradeDate)'
	         
			 Insert Into #TbResult(StOrder,TradeDate,GrossEarning,InclusiveStt,InclusiveSrvTax,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,[Type]) Exec(@Sql)
				
			--print @Sql
			 ----------------------Collection Type : Transaction Charges
			Select @Sql=
			'Select 10
			 ,Case When TradeDate is null Then InCluSiveTradeDate Else TradeDate End
			 ,TransactionCharges
			 ,(isnull(TransactionCharges,0)-isnull(InCluSiveSrvTax,0))
			 ,ServiceTaxOnTranCharge
			 ,EduCessOnTranCharge
			 ,HgrEduCessOnTranCharge
			 ,TotalSrvTaxTranCharge
			 ,Convert(VARCHAR(11),TradeDate,106) 
			 From
			 (Select 
			 Sum(ISNULL(ContractNotes_TransactionCharges,0)) AS TransactionCharges
			 ,Sum(ISNULL(ContractNotes_ServiceTaxOnTranCharge,0)) AS ServiceTaxOnTranCharge
			 ,Sum(ISNULL(ContractNotes_EduCessOnTranCharge,0)) AS EduCessOnTranCharge
			 ,Sum(ISNULL(ContractNotes_HgrEduCessOnTranCharge,0)) AS HgrEduCessOnTranCharge
			 ,Sum(  ISNULL(ContractNotes_ServiceTaxOnTranCharge,0)+
					ISNULL(ContractNotes_EduCessOnTranCharge,0)+
					ISNULL(ContractNotes_HgrEduCessOnTranCharge,0)
				)AS TotalSrvTaxTranCharge
			 ,PayoutDate AS TradeDate
			 From Trans_ContractNotes,#TbConsider
			 Where 
			 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By PayoutDate) as TbAllTranCharge

			 Left Outer Join
			 
			(Select Sum(    ISNULL(ContractNotes_ServiceTaxOnTranCharge,0)+
							ISNULL(ContractNotes_EduCessOnTranCharge,0)+
							ISNULL(ContractNotes_HgrEduCessOnTranCharge,0)
					   ) AS InCluSiveSrvTax,
			 PayoutDate AS InCluSiveTradeDate
			 From Trans_ContractNotes,#TbConsider
			 Where ContractNotes_TranChargeMode=''I''
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By PayoutDate) as TbInCluSiveTranCharge			 
			 
			 On(TradeDate=InCluSiveTradeDate)'
			 Insert Into #TbResult(StOrder,TradeDate,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,[Type]) Exec(@Sql)		 

			 ----------------------Collection Type : Demat Charges
			 Select @Sql=
			'Select 15
			 ,DematChargeSummary_BillDate
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_ServiceTax,0))
			 ,Sum(ISNULL(DematChargeSummary_EduCess,0))
			 ,Sum(ISNULL(DematChargeSummary_HgrEduCess,0))
			 ,Sum(  ISNULL(DematChargeSummary_ServiceTax,0)+
					ISNULL(DematChargeSummary_EduCess,0)+
					ISNULL(DematChargeSummary_HgrEduCess,0)
				)
			 ,Convert(VARCHAR(11),DematChargeSummary_BillDate,106) 
			 From Trans_DematChargeSummary
			 Where ISNULL(DematChargeSummary_ServiceTax,0)<>0 
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,DematChargeSummary_BillDate)) as datetime) between '''+@FromDate+''' and '''+@Todate+ ''''
			 If(@SegmentID<>'ALL')
				Select @Sql=@Sql+' and DematChargeSummary_Segment in ('+@Segmentid+') '
			 Select @Sql=@Sql+' and DematChargeSummary_BranchID  IN ('+@Branch+') and DematChargeSummary_CompanyID='''+@Companyid+'''
			 Group By DematChargeSummary_BillDate'
			 
			 print @Sql
			 
			 Insert Into #TbResult(StOrder,TradeDate,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,[Type]) Exec(@Sql)		 

			 -----------Insert Into [Type]
			 Insert Into #TbResult(StOrder,TradeDate,[Type],GrossEarning) 
			 Select Distinct 
						 Case When StOrder=5 Then  4
							  When StOrder=10 Then 9
							  When StOrder=15 Then 14
						 End
					,'1900-01-01'
					,Case When StOrder=5 Then 'Type : Brokerage'
						  When StOrder=10 Then 'Type : Transaction Charges'
						  When StOrder=15 Then 'Type : Demat Charges'
					End
					,99999999999999.99
			 From #TbResult		
			 -----------Insert Into Total
			 Insert Into #TbResult(StOrder,TradeDate,[Type],GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,InclusiveStt,InclusiveSrvTax) 
			 Select StOrder,'2222-12-31','Total:'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 ,Sum(isnull(InclusiveStt,0)),Sum(isnull(InclusiveSrvTax,0))
			 From #TbResult	Where StOrder in (5,10,15)	
			 Group By StOrder

			 Union All

			 Select 40,'2222-12-31','Grand Total:'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 ,Sum(isnull(InclusiveStt,0)),Sum(isnull(InclusiveSrvTax,0))
			 From #TbResult	Where StOrder in (5,10,15)	
			
			 ------------Result Fetch
			 Select [Type] as [Date]
			,CASE WHEN ISNULL(GrossEarning,0)=99999999999999.99 THEN 'Test' WHEN ISNULL(GrossEarning,0)=0 THEN NULL WHEN GrossEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(GrossEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(GrossEarning AS VARCHAR(8000)),'Y') END AS [Gross Earning]
			,CASE WHEN ISNULL(InclusiveStt,0)=0 THEN NULL WHEN InclusiveStt<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(InclusiveStt) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(InclusiveStt AS VARCHAR(8000)),'Y') END AS [Incl.Stt]
			,CASE WHEN ISNULL(InclusiveSrvTax,0)=0 THEN NULL WHEN InclusiveSrvTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(InclusiveSrvTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(InclusiveSrvTax AS VARCHAR(8000)),'Y') END AS [Incl.SrvTax]
			,CASE WHEN ISNULL(NetEarning,0)=0 THEN NULL WHEN NetEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(NetEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(NetEarning AS VARCHAR(8000)),'Y') END AS [Net Earning]
			,CASE WHEN ISNULL(SrvTax,0)=0 THEN NULL WHEN SrvTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(SrvTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(SrvTax AS VARCHAR(8000)),'Y') END AS [Service Tax]
			,CASE WHEN ISNULL(EduCess,0)=0 THEN NULL WHEN EduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(EduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(EduCess AS VARCHAR(8000)),'Y') END AS [Edu.Cess]
			,CASE WHEN ISNULL(HgrEduCess,0)=0 THEN NULL WHEN HgrEduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(HgrEduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(HgrEduCess AS VARCHAR(8000)),'Y') END AS [Hgr.Edu.Cess]
			,CASE WHEN ISNULL(TotServTax,0)=0 THEN NULL WHEN TotServTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(TotServTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(TotServTax AS VARCHAR(8000)),'Y') END AS [Total Serv.Tax]
			From #TbResult Order By StOrder,TradeDate

	End
	----------------------------If Report Type='Date Wise' and As Per 'Contract Wise' and 'No Segment BreakUp' End  -------------------------------------

	----------------------------If Report Type='Date Wise' and As Per 'Contract Wise' and 'Segment BreakUp' Begin-------------------------------------
	If (@RptType='Date' and @AsPer='CntrNo' and @SegmentBreakUp='true')
	Begin
			 ----------------------Collection Type : Brokerage
			 Select @Sql=
			' Select 5
			 ,Case When TradeDate is null Then InCluSiveTradeDate Else TradeDate End
			 ,TotalBrokerage
			 ,(isnull(TotalBrokerage,0)-isnull(InCluSiveSrvTax,0))
			 ,ServiceTaxOnBrkg
			 ,EduCessOnBrkg
			 ,HgrEduCessOnBrkg
			 ,TotalSrvTaxBrkg
			 ,Convert(VARCHAR(11),TradeDate,106) 
			 ,Case When SegmentName is null Then InCluSiveSegmentName Else SegmentName End
			 ,''1.B''
			 From
			 (Select 
			  Sum(ISNULL(ContractNotes_TotalBrokerage,0)) AS TotalBrokerage
			 ,Sum(ISNULL(ContractNotes_ServiceTaxOnBrkg,0)) AS ServiceTaxOnBrkg
			 ,Sum(ISNULL(ContractNotes_EduCessOnBrkg,0)) AS EduCessOnBrkg
			 ,Sum(ISNULL(ContractNotes_HgrEduCessOnBrkg,0)) AS HgrEduCessOnBrkg
			 ,Sum(   ISNULL(ContractNotes_ServiceTaxOnBrkg,0)+
					ISNULL(ContractNotes_EduCessOnBrkg,0)+
					ISNULL(ContractNotes_HgrEduCessOnBrkg,0)
				)AS TotalSrvTaxBrkg
			 ,PayoutDate AS TradeDate
			 ,SegmentName
			 From Trans_ContractNotes,#TbConsider
			 Where 
			 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By PayoutDate,SegmentName) as TbAllBrkg

			 Left Outer Join
			 
			(Select Sum(    ISNULL(ContractNotes_ServiceTaxOnBrkg,0)+
							ISNULL(ContractNotes_EduCessOnBrkg,0)+
							ISNULL(ContractNotes_HgrEduCessOnBrkg,0)
					   ) AS InCluSiveSrvTax
			 ,PayoutDate AS InCluSiveTradeDate
			 ,SegmentName AS InCluSiveSegmentName
			 From Trans_ContractNotes,#TbConsider
			 Where ContractNotes_ServiceTaxMode=''I''
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By PayoutDate,SegmentName) as TbInCluSiveBrkg			 
			 
			 On(TradeDate=InCluSiveTradeDate and SegmentName=InCluSiveSegmentName)'
			 Insert Into #TbResult(StOrder,TradeDate,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,[Type],SegmentName,CollectionType) Exec(@Sql)
				
			 ----------------------Collection Type : Transaction Charges
			 Select @Sql=
			'Select 10
			 ,Case When TradeDate is null Then InCluSiveTradeDate Else TradeDate End
			 ,TransactionCharges
			 ,(isnull(TransactionCharges,0)-isnull(InCluSiveSrvTax,0))
			 ,ServiceTaxOnTranCharge
			 ,EduCessOnTranCharge
			 ,HgrEduCessOnTranCharge
			 ,TotalSrvTaxTranCharge
			 ,Convert(VARCHAR(11),TradeDate,106)
			 ,Case When SegmentName is null Then InCluSiveSegmentName Else SegmentName End 
			 ,''2.T''
			 From
			 (Select 
			 Sum(ISNULL(ContractNotes_TransactionCharges,0)) AS TransactionCharges
			 ,Sum(ISNULL(ContractNotes_ServiceTaxOnTranCharge,0)) AS ServiceTaxOnTranCharge
			 ,Sum(ISNULL(ContractNotes_EduCessOnTranCharge,0)) AS EduCessOnTranCharge
			 ,Sum(ISNULL(ContractNotes_HgrEduCessOnTranCharge,0)) AS HgrEduCessOnTranCharge
			 ,Sum(  ISNULL(ContractNotes_ServiceTaxOnTranCharge,0)+
					ISNULL(ContractNotes_EduCessOnTranCharge,0)+
					ISNULL(ContractNotes_HgrEduCessOnTranCharge,0)
				)AS TotalSrvTaxTranCharge
			 ,PayoutDate AS TradeDate,SegmentName
			 From Trans_ContractNotes,#TbConsider
			 Where 
			 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By PayoutDate,SegmentName) as TbAllTranCharge

			 Left Outer Join
			 
			(Select Sum(    ISNULL(ContractNotes_ServiceTaxOnTranCharge,0)+
							ISNULL(ContractNotes_EduCessOnTranCharge,0)+
							ISNULL(ContractNotes_HgrEduCessOnTranCharge,0)
					   ) AS InCluSiveSrvTax,
			 PayoutDate AS InCluSiveTradeDate ,SegmentName AS InCluSiveSegmentName
			 From Trans_ContractNotes,#TbConsider
			 Where ContractNotes_TranChargeMode=''I''
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By PayoutDate,SegmentName) as TbInCluSiveTranCharge			 
			 
			 On(TradeDate=InCluSiveTradeDate and SegmentName=InCluSiveSegmentName)'
			 Insert Into #TbResult(StOrder,TradeDate,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,[Type],SegmentName,CollectionType) Exec(@Sql)		 

			 ----------------------Collection Type : Demat Charges
			 
			 
			 Select @Sql=
			'Select 15
			 ,DematChargeSummary_BillDate
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_ServiceTax,0))
			 ,Sum(ISNULL(DematChargeSummary_EduCess,0))
			 ,Sum(ISNULL(DematChargeSummary_HgrEduCess,0))
			 ,Sum(  ISNULL(DematChargeSummary_ServiceTax,0)+
					ISNULL(DematChargeSummary_EduCess,0)+
					ISNULL(DematChargeSummary_HgrEduCess,0)
				)
			 ,Convert(VARCHAR(11),DematChargeSummary_BillDate,106) 
			 ,SegmentName
			 ,''3.D''
			 From Trans_DematChargeSummary,#DistinctSegment
			 Where ISNULL(DematChargeSummary_ServiceTax,0)<>0 
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,DematChargeSummary_BillDate)) as datetime) between '''+@FromDate+''' and '''+@Todate+ '''
			 and DematChargeSummary_Segment=SegmentID and DematChargeSummary_BranchID  IN ('+@Branch+') and DematChargeSummary_CompanyID='''+@Companyid+'''
			 Group By DematChargeSummary_BillDate,SegmentName'
			 
			 Insert Into #TbResult(StOrder,TradeDate,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,[Type],SegmentName,CollectionType) Exec(@Sql)		 
		 


			 -----------Insert Into [Type]
			 Insert Into #TbResult(StOrder,TradeDate,[Type],GrossEarning,SegmentName,CollectionType) 
			 Select Distinct 
						 Case When StOrder=5 Then 3
							  When StOrder=10 Then 8
							  When StOrder=15 Then 13
						 End
					,'1900-01-01'
					,Case When StOrder=5  Then 'Type : Brokerage'
						  When StOrder=10 Then 'Type : Transaction Charges'
						  When StOrder=15 Then 'Type : Demat Charges'
					End
					,99999999999999.99,null,CollectionType
			 From #TbResult	
			 Union All
			 Select Distinct 
					StOrder
					,'1900-01-01'
					,'** '+SegmentName
					,99999999999999.99,SegmentName,CollectionType
			 From #TbResult			
			 -----------Insert Into Total
			 Insert Into #TbResult(CollectionType,SegmentName,StOrder,TradeDate,[Type],GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax) 
			 Select CollectionType,SegmentName,StOrder,'2222-12-31','Total'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder in (5,10,15) and 	GrossEarning<>99999999999999.99
			 Group By StOrder,SegmentName,CollectionType

			 Union All

			 Select CollectionType,'ZZZZZZ',StOrder
			 ,'2222-12-21','All Segment Total'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder  in (5,10,15)	and GrossEarning<>99999999999999.99
			 Group By StOrder,CollectionType 

			 Union All

			 Select '4.Z','ZZZZZZ',50
			 ,'2222-12-31','Grand Total'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder  in (5,10,15)	and GrossEarning<>99999999999999.99
			 
			

			 ------------Result Fetch
			 Select [Type] as [Date]
			,CASE WHEN ISNULL(GrossEarning,0)=99999999999999.99 THEN 'Test' WHEN ISNULL(GrossEarning,0)=0 THEN NULL WHEN GrossEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(GrossEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(GrossEarning AS VARCHAR(8000)),'Y') END AS [Gross Earning]
			,CASE WHEN ISNULL(NetEarning,0)=0 THEN NULL WHEN NetEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(NetEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(NetEarning AS VARCHAR(8000)),'Y') END AS [Net Earning]
			,CASE WHEN ISNULL(SrvTax,0)=0 THEN NULL WHEN SrvTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(SrvTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(SrvTax AS VARCHAR(8000)),'Y') END AS [Service Tax]
			,CASE WHEN ISNULL(EduCess,0)=0 THEN NULL WHEN EduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(EduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(EduCess AS VARCHAR(8000)),'Y') END AS [Edu.Cess]
			,CASE WHEN ISNULL(HgrEduCess,0)=0 THEN NULL WHEN HgrEduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(HgrEduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(HgrEduCess AS VARCHAR(8000)),'Y') END AS [Hgr.Edu.Cess]
			,CASE WHEN ISNULL(TotServTax,0)=0 THEN NULL WHEN TotServTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(TotServTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(TotServTax AS VARCHAR(8000)),'Y') END AS [Total Serv.Tax]
			From #TbResult Order By CollectionType,SegmentName,StOrder,TradeDate

	End
	----------------------------If Report Type='Date Wise' and As Per  'Contract Wise' and 'Segment BreakUp' End  -------------------------------------
	----------------------------If Report Type='Month Wise' and As Per 'Contract Wise' and 'No Segment BreakUp' Begin-------------------------------------
	If (@RptType='Month' and @AsPer='CntrNo' and @SegmentBreakUp='false')
	Begin
			 ----------------------Collection Type : Brokerage
			 Select @Sql=
			' Select 5
			 ,Case When TradeMonth is null Then TradeInCluSiveMonth Else TradeMonth End
			 ,Case When TradeYear is null Then TradeInCluSiveYear Else TradeYear End
			 ,TotalBrokerage
			 ,(isnull(TotalBrokerage,0)-isnull(InCluSiveSrvTax,0))
			 ,ServiceTaxOnBrkg
			 ,EduCessOnBrkg
			 ,HgrEduCessOnBrkg
			 ,TotalSrvTaxBrkg
			 From
			 (Select 
			  Sum(ISNULL(ContractNotes_TotalBrokerage,0)) AS TotalBrokerage
			 ,Sum(ISNULL(ContractNotes_ServiceTaxOnBrkg,0)) AS ServiceTaxOnBrkg
			 ,Sum(ISNULL(ContractNotes_EduCessOnBrkg,0)) AS EduCessOnBrkg
			 ,Sum(ISNULL(ContractNotes_HgrEduCessOnBrkg,0)) AS HgrEduCessOnBrkg
			 ,Sum(   ISNULL(ContractNotes_ServiceTaxOnBrkg,0)+
					ISNULL(ContractNotes_EduCessOnBrkg,0)+
					ISNULL(ContractNotes_HgrEduCessOnBrkg,0)
				)AS TotalSrvTaxBrkg
			 ,month(PayoutDate) AS TradeMonth
			 ,year(PayoutDate) as TradeYear

			 
			 From Trans_ContractNotes,#TbConsider
			 Where 
			 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By month(PayoutDate),year(PayoutDate)) as TbAllBrkg

			 Left Outer Join
			 
			(Select Sum(    ISNULL(ContractNotes_ServiceTaxOnBrkg,0)+
							ISNULL(ContractNotes_EduCessOnBrkg,0)+
							ISNULL(ContractNotes_HgrEduCessOnBrkg,0)
					   ) AS InCluSiveSrvTax
			 ,month(PayoutDate) AS TradeInCluSiveMonth
			 ,year(PayoutDate) as TradeInCluSiveYear
			 From Trans_ContractNotes,#TbConsider
			 Where ContractNotes_ServiceTaxMode=''I''
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By month(PayoutDate),year(PayoutDate)) as TbInCluSiveBrkg			 
			 
			 On(TradeMonth=TradeInCluSiveMonth and TradeYear=TradeInCluSiveYear)'
			Insert Into #TbResult(StOrder,TradeMonth,TradeYear,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax) Exec(@Sql)	 
				
			 ----------------------Collection Type : Transaction Charges
			 Select @Sql=
			'Select 10
			 ,Case When TradeMonth is null Then TradeInCluSiveMonth Else TradeMonth End
			 ,Case When TradeYear is null Then TradeInCluSiveYear Else TradeYear End
			 ,TransactionCharges
			 ,(isnull(TransactionCharges,0)-isnull(InCluSiveSrvTax,0))
			 ,ServiceTaxOnTranCharge
			 ,EduCessOnTranCharge
			 ,HgrEduCessOnTranCharge
			 ,TotalSrvTaxTranCharge
			 From
			 (Select 
			 Sum(ISNULL(ContractNotes_TransactionCharges,0)) AS TransactionCharges
			 ,Sum(ISNULL(ContractNotes_ServiceTaxOnTranCharge,0)) AS ServiceTaxOnTranCharge
			 ,Sum(ISNULL(ContractNotes_EduCessOnTranCharge,0)) AS EduCessOnTranCharge
			 ,Sum(ISNULL(ContractNotes_HgrEduCessOnTranCharge,0)) AS HgrEduCessOnTranCharge
			 ,Sum(  ISNULL(ContractNotes_ServiceTaxOnTranCharge,0)+
					ISNULL(ContractNotes_EduCessOnTranCharge,0)+
					ISNULL(ContractNotes_HgrEduCessOnTranCharge,0)
				)AS TotalSrvTaxTranCharge
			 ,month(PayoutDate) AS TradeMonth
			 ,year(PayoutDate) as TradeYear
			 From Trans_ContractNotes,#TbConsider
			 Where 
			 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By month(PayoutDate),year(PayoutDate)) as TbAllTranCharge

			 Left Outer Join
			 
			(Select Sum(    ISNULL(ContractNotes_ServiceTaxOnTranCharge,0)+
							ISNULL(ContractNotes_EduCessOnTranCharge,0)+
							ISNULL(ContractNotes_HgrEduCessOnTranCharge,0)
					   ) AS InCluSiveSrvTax
			 ,month(PayoutDate) AS TradeInCluSiveMonth
			 ,year(PayoutDate) as TradeInCluSiveYear
			 From Trans_ContractNotes,#TbConsider
			 Where ContractNotes_TranChargeMode=''I''
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By month(PayoutDate),year(PayoutDate)) as TbInCluSiveTranCharge			 
			 
			  On(TradeMonth=TradeInCluSiveMonth and TradeYear=TradeInCluSiveYear)'
			 Insert Into #TbResult(StOrder,TradeMonth,TradeYear,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax) Exec(@Sql)	 
			
			 ----------------------Collection Type : Demat Charges
			 Select @Sql=
			'Select 15
			 ,month(DematChargeSummary_BillDate) AS TradeInCluSiveMonth
			 ,year(DematChargeSummary_BillDate) as TradeInCluSiveYear
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_ServiceTax,0))
			 ,Sum(ISNULL(DematChargeSummary_EduCess,0))
			 ,Sum(ISNULL(DematChargeSummary_HgrEduCess,0))
			 ,Sum(  ISNULL(DematChargeSummary_ServiceTax,0)+
					ISNULL(DematChargeSummary_EduCess,0)+
					ISNULL(DematChargeSummary_HgrEduCess,0)
				)
			 From Trans_DematChargeSummary
			 Where ISNULL(DematChargeSummary_ServiceTax,0)<>0 
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,DematChargeSummary_BillDate)) as datetime) between '''+@FromDate+''' and '''+@Todate+ '''
			 and DematChargeSummary_Segment in ('+@Segmentid+') and DematChargeSummary_BranchID  IN ('+@Branch+') and DematChargeSummary_CompanyID='''+@Companyid+'''
			 Group By month(DematChargeSummary_BillDate),year(DematChargeSummary_BillDate)'
			Insert Into #TbResult(StOrder,TradeMonth,TradeYear,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax) Exec(@Sql)	 

			 --------Year and Month 
			 Update #TbResult Set [Type]=substring(datename(month,dateadd(month,TradeMonth- 1, 0)),1,3)+'-'+cast(right(TradeYear,2) as varchar)
			 From #TbResult 

			 -----------Insert Into [Type]
			 Insert Into #TbResult(StOrder,TradeYear,TradeMonth,[Type],GrossEarning) 
			 Select Distinct 
						 Case When StOrder=5 Then  4
							  When StOrder=10 Then 9
							  When StOrder=15 Then 14
						 End
					,1900,01
					,Case When StOrder=5 Then 'Type : Brokerage'
						  When StOrder=10 Then 'Type : Transaction Charges'
						  When StOrder=15 Then 'Type : Demat Charges'
					End
					,99999999999999.99
			 From #TbResult		
			 -----------Insert Into Total
			 Insert Into #TbResult(StOrder,TradeYear,TradeMonth,[Type],GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax) 
			 Select StOrder,2222,31,'Total:'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder in (5,10,15)	
			 Group By StOrder

			 Union All

			 Select 40,2222,31,'Grand Total:'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder in (5,10,15)	
			
			 ------------Result Fetch
			 Select [Type] as [Month]
			,CASE WHEN ISNULL(GrossEarning,0)=99999999999999.99 THEN 'Test' WHEN ISNULL(GrossEarning,0)=0 THEN NULL WHEN GrossEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(GrossEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(GrossEarning AS VARCHAR(8000)),'Y') END AS [Gross Earning]
			,CASE WHEN ISNULL(NetEarning,0)=0 THEN NULL WHEN NetEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(NetEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(NetEarning AS VARCHAR(8000)),'Y') END AS [Net Earning]
			,CASE WHEN ISNULL(SrvTax,0)=0 THEN NULL WHEN SrvTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(SrvTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(SrvTax AS VARCHAR(8000)),'Y') END AS [Service Tax]
			,CASE WHEN ISNULL(EduCess,0)=0 THEN NULL WHEN EduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(EduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(EduCess AS VARCHAR(8000)),'Y') END AS [Edu.Cess]
			,CASE WHEN ISNULL(HgrEduCess,0)=0 THEN NULL WHEN HgrEduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(HgrEduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(HgrEduCess AS VARCHAR(8000)),'Y') END AS [Hgr.Edu.Cess]
			,CASE WHEN ISNULL(TotServTax,0)=0 THEN NULL WHEN TotServTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(TotServTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(TotServTax AS VARCHAR(8000)),'Y') END AS [Total Serv.Tax]
			From #TbResult Order By StOrder,TradeYear,TradeMonth

	End
	----------------------------If Report Type='Month Wise' and As Per 'Contract Wise' and 'No Segment BreakUp' End  -------------------------------------
	----------------------------If Report Type='Month Wise' and As Per 'Contract Wise' and 'Segment BreakUp' Begin-------------------------------------
	If (@RptType='Month' and @AsPer='CntrNo' and @SegmentBreakUp='true')
	Begin
			 ----------------------Collection Type : Brokerage
			 Select @Sql=
			' Select 5
			 ,Case When TradeMonth is null Then TradeInCluSiveMonth Else TradeMonth End
			 ,Case When TradeYear is null Then TradeInCluSiveYear Else TradeYear End
			 ,TotalBrokerage
			 ,(isnull(TotalBrokerage,0)-isnull(InCluSiveSrvTax,0))
			 ,ServiceTaxOnBrkg
			 ,EduCessOnBrkg
			 ,HgrEduCessOnBrkg
			 ,TotalSrvTaxBrkg
			 ,Case When SegmentName is null Then InCluSiveSegmentName Else SegmentName End
			 ,''1.B''
			 From
			 (Select 
			  Sum(ISNULL(ContractNotes_TotalBrokerage,0)) AS TotalBrokerage
			 ,Sum(ISNULL(ContractNotes_ServiceTaxOnBrkg,0)) AS ServiceTaxOnBrkg
			 ,Sum(ISNULL(ContractNotes_EduCessOnBrkg,0)) AS EduCessOnBrkg
			 ,Sum(ISNULL(ContractNotes_HgrEduCessOnBrkg,0)) AS HgrEduCessOnBrkg
			 ,Sum(   ISNULL(ContractNotes_ServiceTaxOnBrkg,0)+
					ISNULL(ContractNotes_EduCessOnBrkg,0)+
					ISNULL(ContractNotes_HgrEduCessOnBrkg,0)
				)AS TotalSrvTaxBrkg
			 ,month(PayoutDate) AS TradeMonth
			 ,year(PayoutDate) as TradeYear
			 ,SegmentName
			 From Trans_ContractNotes,#TbConsider
			 Where 
			 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By month(PayoutDate),year(PayoutDate),SegmentName) as TbAllBrkg

			 Left Outer Join
			 
			(Select Sum(    ISNULL(ContractNotes_ServiceTaxOnBrkg,0)+
							ISNULL(ContractNotes_EduCessOnBrkg,0)+
							ISNULL(ContractNotes_HgrEduCessOnBrkg,0)
					   ) AS InCluSiveSrvTax
			 ,month(PayoutDate) AS TradeInCluSiveMonth
			 ,year(PayoutDate) as TradeInCluSiveYear
			 ,SegmentName AS InCluSiveSegmentName
			 From Trans_ContractNotes,#TbConsider
			 Where ContractNotes_ServiceTaxMode=''I''
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By month(PayoutDate),year(PayoutDate),SegmentName) as TbInCluSiveBrkg			 
			 
			 On(TradeMonth=TradeInCluSiveMonth and TradeYear=TradeInCluSiveYear and SegmentName=InCluSiveSegmentName)'
			 Insert Into #TbResult(StOrder,TradeMonth,TradeYear,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,SegmentName,CollectionType) Exec(@Sql)	 
		
			 ----------------------Collection Type : Transaction Charges
			 Select @Sql=
			'Select 10
			 ,Case When TradeMonth is null Then TradeInCluSiveMonth Else TradeMonth End
			 ,Case When TradeYear is null Then TradeInCluSiveYear Else TradeYear End
			 ,TransactionCharges
			 ,(isnull(TransactionCharges,0)-isnull(InCluSiveSrvTax,0))
			 ,ServiceTaxOnTranCharge
			 ,EduCessOnTranCharge
			 ,HgrEduCessOnTranCharge
			 ,TotalSrvTaxTranCharge
			 ,Case When SegmentName is null Then InCluSiveSegmentName Else SegmentName End 
			 ,''2.T''
			 From
			 (Select 
			 Sum(ISNULL(ContractNotes_TransactionCharges,0)) AS TransactionCharges
			 ,Sum(ISNULL(ContractNotes_ServiceTaxOnTranCharge,0)) AS ServiceTaxOnTranCharge
			 ,Sum(ISNULL(ContractNotes_EduCessOnTranCharge,0)) AS EduCessOnTranCharge
			 ,Sum(ISNULL(ContractNotes_HgrEduCessOnTranCharge,0)) AS HgrEduCessOnTranCharge
			 ,Sum(  ISNULL(ContractNotes_ServiceTaxOnTranCharge,0)+
					ISNULL(ContractNotes_EduCessOnTranCharge,0)+
					ISNULL(ContractNotes_HgrEduCessOnTranCharge,0)
				)AS TotalSrvTaxTranCharge
			 ,month(PayoutDate) AS TradeMonth
			 ,year(PayoutDate) as TradeYear,SegmentName
			 From Trans_ContractNotes,#TbConsider
			 Where 
			 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By month(PayoutDate),year(PayoutDate),SegmentName) as TbAllTranCharge

			 Left Outer Join
			 
			(Select Sum(    ISNULL(ContractNotes_ServiceTaxOnTranCharge,0)+
							ISNULL(ContractNotes_EduCessOnTranCharge,0)+
							ISNULL(ContractNotes_HgrEduCessOnTranCharge,0)
					   ) AS InCluSiveSrvTax
			 ,month(PayoutDate) AS TradeInCluSiveMonth
			 ,year(PayoutDate) as TradeInCluSiveYear,SegmentName AS InCluSiveSegmentName
			 From Trans_ContractNotes,#TbConsider
			 Where ContractNotes_TranChargeMode=''I''
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
			 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
			 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
			 Group By month(PayoutDate),year(PayoutDate),SegmentName) as TbInCluSiveTranCharge			 
			 
			 On(TradeMonth=TradeInCluSiveMonth and TradeYear=TradeInCluSiveYear and SegmentName=InCluSiveSegmentName)'

			 Insert Into #TbResult(StOrder,TradeMonth,TradeYear,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,SegmentName,CollectionType) Exec(@Sql)	 

			 ----------------------Collection Type : Demat Charges
			 Select @Sql=
			'Select 15
			 ,month(DematChargeSummary_BillDate) AS TradeInCluSiveMonth
			 ,year(DematChargeSummary_BillDate) as TradeInCluSiveYear
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_ServiceTax,0))
			 ,Sum(ISNULL(DematChargeSummary_EduCess,0))
			 ,Sum(ISNULL(DematChargeSummary_HgrEduCess,0))
			 ,Sum(  ISNULL(DematChargeSummary_ServiceTax,0)+
					ISNULL(DematChargeSummary_EduCess,0)+
					ISNULL(DematChargeSummary_HgrEduCess,0)
				)
			 ,SegmentName
			 ,''3.D''
			 From Trans_DematChargeSummary,#DistinctSegment
			 Where ISNULL(DematChargeSummary_ServiceTax,0)<>0 
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,DematChargeSummary_BillDate)) as datetime) between '''+@FromDate+''' and '''+@Todate+ '''
			 and DematChargeSummary_Segment=SegmentID and DematChargeSummary_BranchID  IN ('+@Branch+') and DematChargeSummary_CompanyID='''+@Companyid+'''
			 Group By month(DematChargeSummary_BillDate),year(DematChargeSummary_BillDate),SegmentName'
			 Insert Into #TbResult(StOrder,TradeMonth,TradeYear,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,SegmentName,CollectionType) Exec(@Sql)	 

			 --------Year and Month 
			 Update #TbResult Set [Type]=substring(datename(month,dateadd(month,TradeMonth- 1, 0)),1,3)+'-'+cast(right(TradeYear,2) as varchar)
			 From #TbResult 
			 -----------Insert Into [Type]
			 Insert Into #TbResult(StOrder,TradeYear,TradeMonth,[Type],GrossEarning,SegmentName,CollectionType) 
			 Select Distinct 
						 Case When StOrder=5 Then 3
							  When StOrder=10 Then 8
							  When StOrder=15 Then 13
						 End
					,1900,01
					,Case When StOrder=5  Then 'Type : Brokerage'
						  When StOrder=10 Then 'Type : Transaction Charges'
						  When StOrder=15 Then 'Type : Demat Charges'
					End
					,99999999999999.99,null,CollectionType
			 From #TbResult	
			 Union All
			 Select Distinct 
					StOrder
					,1900,01
					 ,'** '+SegmentName
					,99999999999999.99,SegmentName,CollectionType
			 From #TbResult			
			 -----------Insert Into Total
			 Insert Into #TbResult(CollectionType,SegmentName,StOrder,TradeYear,TradeMonth,[Type],GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax) 
			 Select CollectionType,SegmentName,StOrder,2222,31,'Total'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder in (5,10,15) and 	GrossEarning<>99999999999999.99
			 Group By StOrder,SegmentName,CollectionType

			 Union All

			 Select CollectionType,'ZZZZZZ',StOrder
			 ,2222,31,'All Segment Total'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder  in (5,10,15)	and GrossEarning<>99999999999999.99
			 Group By StOrder,CollectionType 

			 Union All

			 Select '4.Z','ZZZZZZ',50
			 ,2222,31,'Grand Total'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder  in (5,10,15)	and GrossEarning<>99999999999999.99
			 
			

			 ------------Result Fetch
			 Select [Type] as [Month]
			,CASE WHEN ISNULL(GrossEarning,0)=99999999999999.99 THEN 'Test' WHEN ISNULL(GrossEarning,0)=0 THEN NULL WHEN GrossEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(GrossEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(GrossEarning AS VARCHAR(8000)),'Y') END AS [Gross Earning]
			,CASE WHEN ISNULL(NetEarning,0)=0 THEN NULL WHEN NetEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(NetEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(NetEarning AS VARCHAR(8000)),'Y') END AS [Net Earning]
			,CASE WHEN ISNULL(SrvTax,0)=0 THEN NULL WHEN SrvTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(SrvTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(SrvTax AS VARCHAR(8000)),'Y') END AS [Service Tax]
			,CASE WHEN ISNULL(EduCess,0)=0 THEN NULL WHEN EduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(EduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(EduCess AS VARCHAR(8000)),'Y') END AS [Edu.Cess]
			,CASE WHEN ISNULL(HgrEduCess,0)=0 THEN NULL WHEN HgrEduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(HgrEduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(HgrEduCess AS VARCHAR(8000)),'Y') END AS [Hgr.Edu.Cess]
			,CASE WHEN ISNULL(TotServTax,0)=0 THEN NULL WHEN TotServTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(TotServTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(TotServTax AS VARCHAR(8000)),'Y') END AS [Total Serv.Tax]
			From #TbResult Order By CollectionType,SegmentName,StOrder,TradeYear,TradeMonth

	End
	----------------------------If Report Type='Month Wise' and As Per  'Contract Wise' and 'Segment BreakUp' End  -------------------------------------



	----------------------------If Report Type='Date Wise' and As Per 'Bill Wise' and 'No Segment BreakUp' Begin-------------------------------------
	If (@RptType='Date' and @AsPer='Bill' and @SegmentBreakUp='false')
	Begin

			 ----------------------Collection Type : Brokerage
			 Select @Sql=
			 ' Select 5,PayoutDate
			  ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			  ,Convert(VARCHAR(11),PayoutDate,106) 
			 From 
			 (
				  Select
				  PayoutDate
				 ,Sum(ISNULL(CMPositionSummary_DeliveryBrokerage,0)+ISNULL(CMPositionSummary_SqrOffBrokerage,0)) as GrossEarning
				 ,Sum(
					(ISNULL(CMPositionSummary_DeliveryBrokerage,0)+ISNULL(CMPositionSummary_SqrOffBrokerage,0))
					  -
					(ISNULL(CMPositionSummary_UnrealizedServTax,0)+ ISNULL(CMPositionSummary_UnrealizedEduCess,0)+ISNULL(CMPositionSummary_UnrealizedHgrEduCess,0))
					) as NetEarning
				 ,Sum(ISNULL(CMPositionSummary_ServTaxOnBrokerage,0)) as SrvTax
				 ,Sum(ISNULL(CMPositionSummary_EduCessOnBrokerage,0)) as EduCess
				 ,Sum(ISNULL(CMPositionSummary_HgrEduCessOnBrokerage,0)) as HgrEduCess
				 ,Sum(  ISNULL(CMPositionSummary_ServTaxOnBrokerage,0)+
						ISNULL(CMPositionSummary_EduCessOnBrokerage,0)+
						ISNULL(CMPositionSummary_HgrEduCessOnBrokerage,0)
					 ) as TotServTax
				 From Trans_CMPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,CMPositionSummary_TradeDate)) as datetime)=Date 
				 and CMPositionSummary_settlementnumber=SettNo and CMPositionSummary_SettlementType=SettType
				 AND CMPositionSummary_SegmentID=Segmentid AND CMPositionSummary_BranchID IN ('+@Branch+') AND CMPositionSummary_CompanyID='''+@Companyid+'''
				 Group By PayoutDate

				 Union All

				 Select 
				  PayoutDate
				 ,Sum(ISNULL(FOPositionSummary_TotalBrokerage,0))
				 ,Sum(
					(ISNULL(FOPositionSummary_TotalBrokerage,0))
					  -
					(ISNULL([FOPositionSummary_UnrealizedServTax],0)+ ISNULL([FOPositionSummary_UnrealizedEduCess],0)+ISNULL([FOPositionSummary_UnrealizedHgrEduCess],0))
					)
				 ,Sum(ISNULL(FOPositionSummary_ServiceTaxOnBrkg,0))
				 ,Sum(ISNULL(FOPositionSummary_EduCessOnBrkg,0))
				 ,Sum(ISNULL(FOPositionSummary_HgrEduCessOnBrkg,0))
				 ,Sum(  ISNULL(FOPositionSummary_ServiceTaxOnBrkg,0)+
						ISNULL(FOPositionSummary_EduCessOnBrkg,0)+
						ISNULL(FOPositionSummary_HgrEduCessOnBrkg,0)
					 )
				 From Trans_FOPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,FOPositionSummary_Date)) as datetime)=Date 
				 and FOPositionSummary_SettlementNumber=SettNo and FOPositionSummary_SettlementType=SettType
				 AND FOPositionSummary_SegmentID=Segmentid AND FOPositionSummary_BranchID IN ('+@Branch+') AND FOPositionSummary_CompanyID='''+@Companyid+'''
				 Group By PayoutDate


				 Union All

				 Select 
				 PayoutDate
				 ,Sum(ISNULL([COMPositionSummary_TotalBrokerage],0))
				 ,Sum(ISNULL([COMPositionSummary_TotalBrokerage],0))
				 ,Sum(ISNULL([COMPositionSummary_ServiceTaxOnBrkg],0))
				 ,Sum(ISNULL([COMPositionSummary_EduCessOnBrkg],0))
				 ,Sum(ISNULL([COMPositionSummary_HgrEduCessOnBrkg],0))
				 ,Sum(  ISNULL([COMPositionSummary_ServiceTaxOnBrkg],0)+
						ISNULL([COMPositionSummary_EduCessOnBrkg],0)+
						ISNULL([COMPositionSummary_HgrEduCessOnBrkg],0)
					 )
				 From [Trans_COMPositionSummary],#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,[COMPositionSummary_Date])) as datetime)=Date 
				 and [COMPositionSummary_SettlementNumber]=SettNo and [COMPositionSummary_SettlementType]=SettType
				 AND [COMPositionSummary_SegmentID]=Segmentid AND [COMPositionSummary_BranchID] IN ('+@Branch+') AND [COMPositionSummary_CompanyID]='''+@Companyid+'''
				 Group By PayoutDate
			 ) as kk Group By PayoutDate'

			 Insert Into #TbResult(StOrder,TradeDate,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,[Type]) Exec(@Sql)
				
			 ----------------------Collection Type : Transaction Charges
			 Select @Sql=
			'  Select 10,PayoutDate
			  ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			  ,Convert(VARCHAR(11),PayoutDate,106) 
			 From 

			 (
				  Select PayoutDate
				 ,Sum(ISNULL(CMPositionSummary_TranCharge,0)) as GrossEarning
				 ,Sum(ISNULL(CMPositionSummary_TranCharge,0)) as NetEarning
				 ,Sum(ISNULL(CMPositionSummary_ServTaxOnTranCharge,0)) as SrvTax
				 ,Sum(ISNULL(CMPositionSummary_EduCessOnTranCharge,0)) as EduCess
				 ,Sum(ISNULL(CMPositionSummary_HgrEduCessOnTranCharge,0)) as HgrEduCess
				 ,Sum(  ISNULL(CMPositionSummary_ServTaxOnTranCharge,0)+
						ISNULL(CMPositionSummary_EduCessOnTranCharge,0)+
						ISNULL(CMPositionSummary_HgrEduCessOnTranCharge,0)
					 ) as TotServTax
				 From Trans_CMPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,CMPositionSummary_TradeDate)) as datetime)=Date 
				 and CMPositionSummary_settlementnumber=SettNo and CMPositionSummary_SettlementType=SettType
				 AND CMPositionSummary_SegmentID=Segmentid AND CMPositionSummary_BranchID IN ('+@Branch+') AND CMPositionSummary_CompanyID='''+@Companyid+'''
				 Group By PayoutDate

				 Union All
				
				 Select PayoutDate
				 ,Sum(ISNULL([FOPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([FOPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([FOPositionSummary_ServiceTaxOnTranCharge],0))
				 ,Sum(ISNULL([FOPositionSummary_EduCessOnTranCharge],0))
				 ,Sum(ISNULL([FOPositionSummary_HgrEduCessOnTranCharge],0))
				 ,Sum(  ISNULL([FOPositionSummary_ServiceTaxOnTranCharge],0)+
						ISNULL([FOPositionSummary_EduCessOnTranCharge],0)+
						ISNULL([FOPositionSummary_HgrEduCessOnTranCharge],0)
					 )
				 From Trans_FOPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,FOPositionSummary_Date)) as datetime)=Date 
				 and FOPositionSummary_SettlementNumber=SettNo and FOPositionSummary_SettlementType=SettType
				 AND FOPositionSummary_SegmentID=Segmentid AND FOPositionSummary_BranchID IN ('+@Branch+') AND FOPositionSummary_CompanyID='''+@Companyid+'''
				 Group By PayoutDate

				 Union All
				
				 Select PayoutDate
				 ,Sum(ISNULL([COMPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([COMPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([COMPositionSummary_ServiceTaxOnTranCharge],0))
				 ,Sum(ISNULL([COMPositionSummary_EduCessOnTranCharge],0))
				 ,Sum(ISNULL([COMPositionSummary_HgrEduCessOnTranCharge],0))
				 ,Sum(  ISNULL([COMPositionSummary_ServiceTaxOnTranCharge],0)+
						ISNULL([COMPositionSummary_EduCessOnTranCharge],0)+
						ISNULL([COMPositionSummary_HgrEduCessOnTranCharge],0)
					 )
				 From [Trans_COMPositionSummary],#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,[COMPositionSummary_Date])) as datetime)=Date 
				 and [COMPositionSummary_SettlementNumber]=SettNo and [COMPositionSummary_SettlementType]=SettType
				 AND [COMPositionSummary_SegmentID]=Segmentid AND [COMPositionSummary_BranchID] IN ('+@Branch+') AND [COMPositionSummary_CompanyID]='''+@Companyid+'''
				 Group By PayoutDate
			 ) as bb  Group By PayoutDate'
			 Insert Into #TbResult(StOrder,TradeDate,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,[Type]) Exec(@Sql)		 

			 ----------------------Collection Type : Demat Charges
			 Select @Sql=
			'Select 15
			 ,DematChargeSummary_BillDate
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_ServiceTax,0))
			 ,Sum(ISNULL(DematChargeSummary_EduCess,0))
			 ,Sum(ISNULL(DematChargeSummary_HgrEduCess,0))
			 ,Sum(  ISNULL(DematChargeSummary_ServiceTax,0)+
					ISNULL(DematChargeSummary_EduCess,0)+
					ISNULL(DematChargeSummary_HgrEduCess,0)
				)
			 ,Convert(VARCHAR(11),DematChargeSummary_BillDate,106) 
			 From Trans_DematChargeSummary
			 Where ISNULL(DematChargeSummary_ServiceTax,0)<>0 
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,DematChargeSummary_BillDate)) as datetime) between '''+@FromDate+''' and '''+@Todate+ '''
			 and DematChargeSummary_Segment in ('+@Segmentid+') and DematChargeSummary_BranchID  IN ('+@Branch+') and DematChargeSummary_CompanyID='''+@Companyid+'''
			 Group By DematChargeSummary_BillDate'
			 
			 Insert Into #TbResult(StOrder,TradeDate,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,[Type]) Exec(@Sql)		 

			 -----------Insert Into [Type]
			 Insert Into #TbResult(StOrder,TradeDate,[Type],GrossEarning) 
			 Select Distinct 
						 Case When StOrder=5 Then  4
							  When StOrder=10 Then 9
							  When StOrder=15 Then 14
						 End
					,'1900-01-01'
					,Case When StOrder=5 Then 'Type : Brokerage'
						  When StOrder=10 Then 'Type : Transaction Charges'
						  When StOrder=15 Then 'Type : Demat Charges'
					End
					,99999999999999.99
			 From #TbResult		
			 -----------Insert Into Total
			 Insert Into #TbResult(StOrder,TradeDate,[Type],GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax) 
			 Select StOrder,'2222-12-31','Total:'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder in (5,10,15)	
			 Group By StOrder

			 Union All

			 Select 40,'2222-12-31','Grand Total:'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder in (5,10,15)	
			
			 ------------Result Fetch
			 Select [Type] as [Date]
			,CASE WHEN ISNULL(GrossEarning,0)=99999999999999.99 THEN 'Test' WHEN ISNULL(GrossEarning,0)=0 THEN NULL WHEN GrossEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(GrossEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(GrossEarning AS VARCHAR(8000)),'Y') END AS [Gross Earning]
			,CASE WHEN ISNULL(NetEarning,0)=0 THEN NULL WHEN NetEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(NetEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(NetEarning AS VARCHAR(8000)),'Y') END AS [Net Earning]
			,CASE WHEN ISNULL(SrvTax,0)=0 THEN NULL WHEN SrvTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(SrvTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(SrvTax AS VARCHAR(8000)),'Y') END AS [Service Tax]
			,CASE WHEN ISNULL(EduCess,0)=0 THEN NULL WHEN EduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(EduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(EduCess AS VARCHAR(8000)),'Y') END AS [Edu.Cess]
			,CASE WHEN ISNULL(HgrEduCess,0)=0 THEN NULL WHEN HgrEduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(HgrEduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(HgrEduCess AS VARCHAR(8000)),'Y') END AS [Hgr.Edu.Cess]
			,CASE WHEN ISNULL(TotServTax,0)=0 THEN NULL WHEN TotServTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(TotServTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(TotServTax AS VARCHAR(8000)),'Y') END AS [Total Serv.Tax]
			From #TbResult Order By StOrder,TradeDate

	End
	----------------------------If Report Type='Date Wise' and As Per 'Bill Wise' and 'No Segment BreakUp' End  -------------------------------------
	----------------------------If Report Type='Date Wise' and As Per 'Bill Wise' and 'Segment BreakUp' Begin-------------------------------------
	If (@RptType='Date' and @AsPer='Bill' and @SegmentBreakUp='true')
	Begin
			 ----------------------Collection Type : Brokerage
			 Select @Sql=
			 ' Select 5,PayoutDate
			  ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			  ,Convert(VARCHAR(11),PayoutDate,106) 
			  ,SegmentName
			  ,''1.B''
			  From 
			 (
				  Select
				  PayoutDate
				 ,Sum(ISNULL(CMPositionSummary_DeliveryBrokerage,0)+ISNULL(CMPositionSummary_SqrOffBrokerage,0)) as GrossEarning
				 ,Sum(
					(ISNULL(CMPositionSummary_DeliveryBrokerage,0)+ISNULL(CMPositionSummary_SqrOffBrokerage,0))
					  -
					(ISNULL(CMPositionSummary_UnrealizedServTax,0)+ ISNULL(CMPositionSummary_UnrealizedEduCess,0)+ISNULL(CMPositionSummary_UnrealizedHgrEduCess,0))
					) as NetEarning
				 ,Sum(ISNULL(CMPositionSummary_ServTaxOnBrokerage,0)) as SrvTax
				 ,Sum(ISNULL(CMPositionSummary_EduCessOnBrokerage,0)) as EduCess
				 ,Sum(ISNULL(CMPositionSummary_HgrEduCessOnBrokerage,0)) as HgrEduCess
				 ,Sum(  ISNULL(CMPositionSummary_ServTaxOnBrokerage,0)+
						ISNULL(CMPositionSummary_EduCessOnBrokerage,0)+
						ISNULL(CMPositionSummary_HgrEduCessOnBrokerage,0)
					 ) as TotServTax
				 ,SegmentName
				 From Trans_CMPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,CMPositionSummary_TradeDate)) as datetime)=Date 
				 and CMPositionSummary_settlementnumber=SettNo and CMPositionSummary_SettlementType=SettType
				 AND CMPositionSummary_SegmentID=Segmentid AND CMPositionSummary_BranchID IN ('+@Branch+') AND CMPositionSummary_CompanyID='''+@Companyid+'''
				 Group By PayoutDate,SegmentName

				 Union All

				 Select 
				  PayoutDate
				 ,Sum(ISNULL(FOPositionSummary_TotalBrokerage,0))
				 ,Sum(
					(ISNULL(FOPositionSummary_TotalBrokerage,0))
					  -
					(ISNULL([FOPositionSummary_UnrealizedServTax],0)+ ISNULL([FOPositionSummary_UnrealizedEduCess],0)+ISNULL([FOPositionSummary_UnrealizedHgrEduCess],0))
					)
				 ,Sum(ISNULL(FOPositionSummary_ServiceTaxOnBrkg,0))
				 ,Sum(ISNULL(FOPositionSummary_EduCessOnBrkg,0))
				 ,Sum(ISNULL(FOPositionSummary_HgrEduCessOnBrkg,0))
				 ,Sum(  ISNULL(FOPositionSummary_ServiceTaxOnBrkg,0)+
						ISNULL(FOPositionSummary_EduCessOnBrkg,0)+
						ISNULL(FOPositionSummary_HgrEduCessOnBrkg,0)
					 )
				 ,SegmentName
				 From Trans_FOPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,FOPositionSummary_Date)) as datetime)=Date 
				 and FOPositionSummary_SettlementNumber=SettNo and FOPositionSummary_SettlementType=SettType
				 AND FOPositionSummary_SegmentID=Segmentid AND FOPositionSummary_BranchID IN ('+@Branch+') AND FOPositionSummary_CompanyID='''+@Companyid+'''
				 Group By PayoutDate,SegmentName


				 Union All

				 Select 
				 PayoutDate
				 ,Sum(ISNULL([COMPositionSummary_TotalBrokerage],0))
				 ,Sum(ISNULL([COMPositionSummary_TotalBrokerage],0))
				 ,Sum(ISNULL([COMPositionSummary_ServiceTaxOnBrkg],0))
				 ,Sum(ISNULL([COMPositionSummary_EduCessOnBrkg],0))
				 ,Sum(ISNULL([COMPositionSummary_HgrEduCessOnBrkg],0))
				 ,Sum(  ISNULL([COMPositionSummary_ServiceTaxOnBrkg],0)+
						ISNULL([COMPositionSummary_EduCessOnBrkg],0)+
						ISNULL([COMPositionSummary_HgrEduCessOnBrkg],0)
					 )
				 ,SegmentName
				 From [Trans_COMPositionSummary],#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,[COMPositionSummary_Date])) as datetime)=Date 
				 and [COMPositionSummary_SettlementNumber]=SettNo and [COMPositionSummary_SettlementType]=SettType
				 AND [COMPositionSummary_SegmentID]=Segmentid AND [COMPositionSummary_BranchID] IN ('+@Branch+') AND [COMPositionSummary_CompanyID]='''+@Companyid+'''
				 Group By PayoutDate,SegmentName
			 ) as kk Group By PayoutDate,SegmentName Having Sum(isnull(GrossEarning,0))<>0'

			 Insert Into #TbResult(StOrder,TradeDate,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,[Type],SegmentName,CollectionType) Exec(@Sql)
			 ----------------------Collection Type : Transaction Charges
			  Select @Sql=
			  ' Select 10,PayoutDate
			  ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			  ,Convert(VARCHAR(11),PayoutDate,106)
			  ,SegmentName
			  ,''2.T'' 
			  From 

			 (
				  Select PayoutDate
				 ,Sum(ISNULL(CMPositionSummary_TranCharge,0)) as GrossEarning
				 ,Sum(ISNULL(CMPositionSummary_TranCharge,0)) as NetEarning
				 ,Sum(ISNULL(CMPositionSummary_ServTaxOnTranCharge,0)) as SrvTax
				 ,Sum(ISNULL(CMPositionSummary_EduCessOnTranCharge,0)) as EduCess
				 ,Sum(ISNULL(CMPositionSummary_HgrEduCessOnTranCharge,0)) as HgrEduCess
				 ,Sum(  ISNULL(CMPositionSummary_ServTaxOnTranCharge,0)+
						ISNULL(CMPositionSummary_EduCessOnTranCharge,0)+
						ISNULL(CMPositionSummary_HgrEduCessOnTranCharge,0)
					 ) as TotServTax
				 ,SegmentName
				 From Trans_CMPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,CMPositionSummary_TradeDate)) as datetime)=Date 
				 and CMPositionSummary_settlementnumber=SettNo and CMPositionSummary_SettlementType=SettType
				 AND CMPositionSummary_SegmentID=Segmentid AND CMPositionSummary_BranchID IN ('+@Branch+') AND CMPositionSummary_CompanyID='''+@Companyid+'''
				 Group By PayoutDate,SegmentName

				 Union All
				
				 Select PayoutDate
				 ,Sum(ISNULL([FOPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([FOPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([FOPositionSummary_ServiceTaxOnTranCharge],0))
				 ,Sum(ISNULL([FOPositionSummary_EduCessOnTranCharge],0))
				 ,Sum(ISNULL([FOPositionSummary_HgrEduCessOnTranCharge],0))
				 ,Sum(  ISNULL([FOPositionSummary_ServiceTaxOnTranCharge],0)+
						ISNULL([FOPositionSummary_EduCessOnTranCharge],0)+
						ISNULL([FOPositionSummary_HgrEduCessOnTranCharge],0)
					 )
				 ,SegmentName
				 From Trans_FOPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,FOPositionSummary_Date)) as datetime)=Date 
				 and FOPositionSummary_SettlementNumber=SettNo and FOPositionSummary_SettlementType=SettType
				 AND FOPositionSummary_SegmentID=Segmentid AND FOPositionSummary_BranchID IN ('+@Branch+') AND FOPositionSummary_CompanyID='''+@Companyid+'''
				 Group By PayoutDate,SegmentName

				 Union All
				
				 Select PayoutDate
				 ,Sum(ISNULL([COMPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([COMPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([COMPositionSummary_ServiceTaxOnTranCharge],0))
				 ,Sum(ISNULL([COMPositionSummary_EduCessOnTranCharge],0))
				 ,Sum(ISNULL([COMPositionSummary_HgrEduCessOnTranCharge],0))
				 ,Sum(  ISNULL([COMPositionSummary_ServiceTaxOnTranCharge],0)+
						ISNULL([COMPositionSummary_EduCessOnTranCharge],0)+
						ISNULL([COMPositionSummary_HgrEduCessOnTranCharge],0)
					 )
				 ,SegmentName
				 From [Trans_COMPositionSummary],#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,[COMPositionSummary_Date])) as datetime)=Date 
				 and [COMPositionSummary_SettlementNumber]=SettNo and [COMPositionSummary_SettlementType]=SettType
				 AND [COMPositionSummary_SegmentID]=Segmentid AND [COMPositionSummary_BranchID] IN ('+@Branch+') AND [COMPositionSummary_CompanyID]='''+@Companyid+'''
				 Group By PayoutDate,SegmentName
			 ) as bb Group By PayoutDate,SegmentName Having Sum(isnull(GrossEarning,0))<>0'
			 Insert Into #TbResult(StOrder,TradeDate,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,[Type],SegmentName,CollectionType) Exec(@Sql)		 

			 ----------------------Collection Type : Demat Charges
			 Select @Sql=
			'Select 15
			 ,DematChargeSummary_BillDate
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_ServiceTax,0))
			 ,Sum(ISNULL(DematChargeSummary_EduCess,0))
			 ,Sum(ISNULL(DematChargeSummary_HgrEduCess,0))
			 ,Sum(  ISNULL(DematChargeSummary_ServiceTax,0)+
					ISNULL(DematChargeSummary_EduCess,0)+
					ISNULL(DematChargeSummary_HgrEduCess,0)
				)
			 ,Convert(VARCHAR(11),DematChargeSummary_BillDate,106) 
			 ,SegmentName
			 ,''3.D''
			 From Trans_DematChargeSummary,#DistinctSegment
			 Where ISNULL(DematChargeSummary_ServiceTax,0)<>0 
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,DematChargeSummary_BillDate)) as datetime) between '''+@FromDate+''' and '''+@Todate+ '''
			 and DematChargeSummary_Segment=SegmentID and DematChargeSummary_BranchID  IN ('+@Branch+') and DematChargeSummary_CompanyID='''+@Companyid+'''
			 Group By DematChargeSummary_BillDate,SegmentName'
			 
			 Insert Into #TbResult(StOrder,TradeDate,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,[Type],SegmentName,CollectionType) Exec(@Sql)		 


			 -----------Insert Into [Type]
			 Insert Into #TbResult(StOrder,TradeDate,[Type],GrossEarning,SegmentName,CollectionType) 
			 Select Distinct 
						 Case When StOrder=5 Then 3
							  When StOrder=10 Then 8
							  When StOrder=15 Then 13
						 End
					,'1900-01-01'
					,Case When StOrder=5  Then 'Type : Brokerage'
						  When StOrder=10 Then 'Type : Transaction Charges'
						  When StOrder=15 Then 'Type : Demat Charges'
					End
					,99999999999999.99,null,CollectionType
			 From #TbResult	
			 Union All
			 Select Distinct 
					StOrder
					,'1900-01-01'
					 ,'** '+SegmentName
					,99999999999999.99,SegmentName,CollectionType
			 From #TbResult			
			 -----------Insert Into Total
			 Insert Into #TbResult(CollectionType,SegmentName,StOrder,TradeDate,[Type],GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax) 
			 Select CollectionType,SegmentName,StOrder,'2222-12-31','Total'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder in (5,10,15) and 	GrossEarning<>99999999999999.99
			 Group By StOrder,SegmentName,CollectionType

			 Union All

			 Select CollectionType,'ZZZZZZ',StOrder
			 ,'2222-12-21','All Segment Total'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder  in (5,10,15)	and GrossEarning<>99999999999999.99
			 Group By StOrder,CollectionType 

			 Union All

			 Select '4.Z','ZZZZZZ',50
			 ,'2222-12-31','Grand Total'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder  in (5,10,15)	and GrossEarning<>99999999999999.99
			 
			

			 ------------Result Fetch
			 Select [Type] as [Date]
			,CASE WHEN ISNULL(GrossEarning,0)=99999999999999.99 THEN 'Test' WHEN ISNULL(GrossEarning,0)=0 THEN NULL WHEN GrossEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(GrossEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(GrossEarning AS VARCHAR(8000)),'Y') END AS [Gross Earning]
			,CASE WHEN ISNULL(NetEarning,0)=0 THEN NULL WHEN NetEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(NetEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(NetEarning AS VARCHAR(8000)),'Y') END AS [Net Earning]
			,CASE WHEN ISNULL(SrvTax,0)=0 THEN NULL WHEN SrvTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(SrvTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(SrvTax AS VARCHAR(8000)),'Y') END AS [Service Tax]
			,CASE WHEN ISNULL(EduCess,0)=0 THEN NULL WHEN EduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(EduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(EduCess AS VARCHAR(8000)),'Y') END AS [Edu.Cess]
			,CASE WHEN ISNULL(HgrEduCess,0)=0 THEN NULL WHEN HgrEduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(HgrEduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(HgrEduCess AS VARCHAR(8000)),'Y') END AS [Hgr.Edu.Cess]
			,CASE WHEN ISNULL(TotServTax,0)=0 THEN NULL WHEN TotServTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(TotServTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(TotServTax AS VARCHAR(8000)),'Y') END AS [Total Serv.Tax]
			From #TbResult Order By CollectionType,SegmentName,StOrder,TradeDate

	End
	----------------------------If Report Type='Date Wise' and As Per  'Bill Wise' and 'Segment BreakUp' End  -------------------------------------
	----------------------------If Report Type='Month Wise' and As Per  'Bill Wise' and 'No Segment BreakUp' Begin-------------------------------------
	If (@RptType='Month' and @AsPer='Bill' and @SegmentBreakUp='false')
	Begin

			 ----------------------Collection Type : Brokerage
			 Select @Sql=
			 ' Select 5,TradeMonth,TradeYear
			  ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From 
			 (
				  Select
				 month(PayoutDate) AS TradeMonth
				 ,year(PayoutDate) as TradeYear
				 ,Sum(ISNULL(CMPositionSummary_DeliveryBrokerage,0)+ISNULL(CMPositionSummary_SqrOffBrokerage,0)) as GrossEarning
				 ,Sum(
					(ISNULL(CMPositionSummary_DeliveryBrokerage,0)+ISNULL(CMPositionSummary_SqrOffBrokerage,0))
					  -
					(ISNULL(CMPositionSummary_UnrealizedServTax,0)+ ISNULL(CMPositionSummary_UnrealizedEduCess,0)+ISNULL(CMPositionSummary_UnrealizedHgrEduCess,0))
					) as NetEarning
				 ,Sum(ISNULL(CMPositionSummary_ServTaxOnBrokerage,0)) as SrvTax
				 ,Sum(ISNULL(CMPositionSummary_EduCessOnBrokerage,0)) as EduCess
				 ,Sum(ISNULL(CMPositionSummary_HgrEduCessOnBrokerage,0)) as HgrEduCess
				 ,Sum(  ISNULL(CMPositionSummary_ServTaxOnBrokerage,0)+
						ISNULL(CMPositionSummary_EduCessOnBrokerage,0)+
						ISNULL(CMPositionSummary_HgrEduCessOnBrokerage,0)
					 ) as TotServTax
				 From Trans_CMPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,CMPositionSummary_TradeDate)) as datetime)=Date 
				 and CMPositionSummary_settlementnumber=SettNo and CMPositionSummary_SettlementType=SettType
				 AND CMPositionSummary_SegmentID=Segmentid AND CMPositionSummary_BranchID IN ('+@Branch+') AND CMPositionSummary_CompanyID='''+@Companyid+'''
				 Group By month(PayoutDate),year(PayoutDate)

				 Union All

				 Select 
				 month(PayoutDate) AS TradeMonth
				 ,year(PayoutDate) as TradeYear
				 ,Sum(ISNULL(FOPositionSummary_TotalBrokerage,0))
				 ,Sum(
					(ISNULL(FOPositionSummary_TotalBrokerage,0))
					  -
					(ISNULL([FOPositionSummary_UnrealizedServTax],0)+ ISNULL([FOPositionSummary_UnrealizedEduCess],0)+ISNULL([FOPositionSummary_UnrealizedHgrEduCess],0))
					)
				 ,Sum(ISNULL(FOPositionSummary_ServiceTaxOnBrkg,0))
				 ,Sum(ISNULL(FOPositionSummary_EduCessOnBrkg,0))
				 ,Sum(ISNULL(FOPositionSummary_HgrEduCessOnBrkg,0))
				 ,Sum(  ISNULL(FOPositionSummary_ServiceTaxOnBrkg,0)+
						ISNULL(FOPositionSummary_EduCessOnBrkg,0)+
						ISNULL(FOPositionSummary_HgrEduCessOnBrkg,0)
					 )
				 From Trans_FOPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,FOPositionSummary_Date)) as datetime)=Date 
				 and FOPositionSummary_SettlementNumber=SettNo and FOPositionSummary_SettlementType=SettType
				 AND FOPositionSummary_SegmentID=Segmentid AND FOPositionSummary_BranchID IN ('+@Branch+') AND FOPositionSummary_CompanyID='''+@Companyid+'''
				 Group By month(PayoutDate),year(PayoutDate)


				 Union All

				 Select 
				 month(PayoutDate) AS TradeMonth
				 ,year(PayoutDate) as TradeYear
				 ,Sum(ISNULL([COMPositionSummary_TotalBrokerage],0))
				 ,Sum(ISNULL([COMPositionSummary_TotalBrokerage],0))
				 ,Sum(ISNULL([COMPositionSummary_ServiceTaxOnBrkg],0))
				 ,Sum(ISNULL([COMPositionSummary_EduCessOnBrkg],0))
				 ,Sum(ISNULL([COMPositionSummary_HgrEduCessOnBrkg],0))
				 ,Sum(  ISNULL([COMPositionSummary_ServiceTaxOnBrkg],0)+
						ISNULL([COMPositionSummary_EduCessOnBrkg],0)+
						ISNULL([COMPositionSummary_HgrEduCessOnBrkg],0)
					 )
				 From [Trans_COMPositionSummary],#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,[COMPositionSummary_Date])) as datetime)=Date 
				 and [COMPositionSummary_SettlementNumber]=SettNo and [COMPositionSummary_SettlementType]=SettType
				 AND [COMPositionSummary_SegmentID]=Segmentid AND [COMPositionSummary_BranchID] IN ('+@Branch+') AND [COMPositionSummary_CompanyID]='''+@Companyid+'''
				 Group By month(PayoutDate),year(PayoutDate)
			 ) as kk Group By TradeMonth,TradeYear'

			
			Insert Into #TbResult(StOrder,TradeMonth,TradeYear,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax) Exec(@Sql)
				
			 ----------------------Collection Type : Transaction Charges
			 Select @Sql=
			'  Select 10,TradeMonth,TradeYear
			  ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			  
			 From 

			 (
				  Select month(PayoutDate) AS TradeMonth
				 ,year(PayoutDate) as TradeYear
				 ,Sum(ISNULL(CMPositionSummary_TranCharge,0)) as GrossEarning
				 ,Sum(ISNULL(CMPositionSummary_TranCharge,0)) as NetEarning
				 ,Sum(ISNULL(CMPositionSummary_ServTaxOnTranCharge,0)) as SrvTax
				 ,Sum(ISNULL(CMPositionSummary_EduCessOnTranCharge,0)) as EduCess
				 ,Sum(ISNULL(CMPositionSummary_HgrEduCessOnTranCharge,0)) as HgrEduCess
				 ,Sum(  ISNULL(CMPositionSummary_ServTaxOnTranCharge,0)+
						ISNULL(CMPositionSummary_EduCessOnTranCharge,0)+
						ISNULL(CMPositionSummary_HgrEduCessOnTranCharge,0)
					 ) as TotServTax
				 From Trans_CMPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,CMPositionSummary_TradeDate)) as datetime)=Date 
				 and CMPositionSummary_settlementnumber=SettNo and CMPositionSummary_SettlementType=SettType
				 AND CMPositionSummary_SegmentID=Segmentid AND CMPositionSummary_BranchID IN ('+@Branch+') AND CMPositionSummary_CompanyID='''+@Companyid+'''
				 Group By month(PayoutDate),year(PayoutDate)

				 Union All
				
				 Select  month(PayoutDate) AS TradeMonth
				 ,year(PayoutDate) as TradeYear
				 ,Sum(ISNULL([FOPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([FOPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([FOPositionSummary_ServiceTaxOnTranCharge],0))
				 ,Sum(ISNULL([FOPositionSummary_EduCessOnTranCharge],0))
				 ,Sum(ISNULL([FOPositionSummary_HgrEduCessOnTranCharge],0))
				 ,Sum(  ISNULL([FOPositionSummary_ServiceTaxOnTranCharge],0)+
						ISNULL([FOPositionSummary_EduCessOnTranCharge],0)+
						ISNULL([FOPositionSummary_HgrEduCessOnTranCharge],0)
					 )
				 From Trans_FOPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,FOPositionSummary_Date)) as datetime)=Date 
				 and FOPositionSummary_SettlementNumber=SettNo and FOPositionSummary_SettlementType=SettType
				 AND FOPositionSummary_SegmentID=Segmentid AND FOPositionSummary_BranchID IN ('+@Branch+') AND FOPositionSummary_CompanyID='''+@Companyid+'''
				 Group By month(PayoutDate),year(PayoutDate)

				 Union All
				
				 Select  month(PayoutDate) AS TradeMonth
				 ,year(PayoutDate) as TradeYear
				 ,Sum(ISNULL([COMPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([COMPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([COMPositionSummary_ServiceTaxOnTranCharge],0))
				 ,Sum(ISNULL([COMPositionSummary_EduCessOnTranCharge],0))
				 ,Sum(ISNULL([COMPositionSummary_HgrEduCessOnTranCharge],0))
				 ,Sum(  ISNULL([COMPositionSummary_ServiceTaxOnTranCharge],0)+
						ISNULL([COMPositionSummary_EduCessOnTranCharge],0)+
						ISNULL([COMPositionSummary_HgrEduCessOnTranCharge],0)
					 )
				 From [Trans_COMPositionSummary],#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,[COMPositionSummary_Date])) as datetime)=Date 
				 and [COMPositionSummary_SettlementNumber]=SettNo and [COMPositionSummary_SettlementType]=SettType
				 AND [COMPositionSummary_SegmentID]=Segmentid AND [COMPositionSummary_BranchID] IN ('+@Branch+') AND [COMPositionSummary_CompanyID]='''+@Companyid+'''
				 Group By month(PayoutDate),year(PayoutDate)
			 ) as bb  Group By TradeMonth,TradeYear'
			 Insert Into #TbResult(StOrder,TradeMonth,TradeYear,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax) Exec(@Sql)		 

			 ----------------------Collection Type : Demat Charges
			 Select @Sql=
			'Select 15
			 ,month(DematChargeSummary_BillDate) AS TradeInCluSiveMonth
			 ,year(DematChargeSummary_BillDate) as TradeInCluSiveYear
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_ServiceTax,0))
			 ,Sum(ISNULL(DematChargeSummary_EduCess,0))
			 ,Sum(ISNULL(DematChargeSummary_HgrEduCess,0))
			 ,Sum(  ISNULL(DematChargeSummary_ServiceTax,0)+
					ISNULL(DematChargeSummary_EduCess,0)+
					ISNULL(DematChargeSummary_HgrEduCess,0)
				)
			 From Trans_DematChargeSummary
			 Where ISNULL(DematChargeSummary_ServiceTax,0)<>0 
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,DematChargeSummary_BillDate)) as datetime) between '''+@FromDate+''' and '''+@Todate+ '''
			 and DematChargeSummary_Segment in ('+@Segmentid+') and DematChargeSummary_BranchID  IN ('+@Branch+') and DematChargeSummary_CompanyID='''+@Companyid+'''
			 Group By month(DematChargeSummary_BillDate),year(DematChargeSummary_BillDate)'
			 Insert Into #TbResult(StOrder,TradeMonth,TradeYear,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax) Exec(@Sql)	 

			  --------Year and Month 
			 Update #TbResult Set [Type]=substring(datename(month,dateadd(month,TradeMonth- 1, 0)),1,3)+'-'+cast(right(TradeYear,2) as varchar)
			 From #TbResult 

			 -----------Insert Into [Type]
			 Insert Into #TbResult(StOrder,TradeYear,TradeMonth,[Type],GrossEarning) 
			 Select Distinct 
						 Case When StOrder=5 Then  4
							  When StOrder=10 Then 9
							  When StOrder=15 Then 14
						 End
					,1900,01
					,Case When StOrder=5 Then 'Type : Brokerage'
						  When StOrder=10 Then 'Type : Transaction Charges'
						  When StOrder=15 Then 'Type : Demat Charges'
					End
					,99999999999999.99
			 From #TbResult		
			 -----------Insert Into Total
			 Insert Into #TbResult(StOrder,TradeYear,TradeMonth,[Type],GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax) 
			 Select StOrder,2222,31,'Total:'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder in (5,10,15)	
			 Group By StOrder

			 Union All

			 Select 40,2222,31,'Grand Total:'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder in (5,10,15)	
			
			 ------------Result Fetch
			 Select [Type] as [Month]
			,CASE WHEN ISNULL(GrossEarning,0)=99999999999999.99 THEN 'Test' WHEN ISNULL(GrossEarning,0)=0 THEN NULL WHEN GrossEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(GrossEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(GrossEarning AS VARCHAR(8000)),'Y') END AS [Gross Earning]
			,CASE WHEN ISNULL(NetEarning,0)=0 THEN NULL WHEN NetEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(NetEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(NetEarning AS VARCHAR(8000)),'Y') END AS [Net Earning]
			,CASE WHEN ISNULL(SrvTax,0)=0 THEN NULL WHEN SrvTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(SrvTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(SrvTax AS VARCHAR(8000)),'Y') END AS [Service Tax]
			,CASE WHEN ISNULL(EduCess,0)=0 THEN NULL WHEN EduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(EduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(EduCess AS VARCHAR(8000)),'Y') END AS [Edu.Cess]
			,CASE WHEN ISNULL(HgrEduCess,0)=0 THEN NULL WHEN HgrEduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(HgrEduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(HgrEduCess AS VARCHAR(8000)),'Y') END AS [Hgr.Edu.Cess]
			,CASE WHEN ISNULL(TotServTax,0)=0 THEN NULL WHEN TotServTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(TotServTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(TotServTax AS VARCHAR(8000)),'Y') END AS [Total Serv.Tax]
			From #TbResult Order By StOrder,TradeYear,TradeMonth


	End
	----------------------------If Report Type='Date Wise' and As Per 'Bill Wise' and 'No Segment BreakUp' End  -------------------------------------
	----------------------------If Report Type='Month Wise' and As Per 'Bill Wise' and 'Segment BreakUp' Begin-------------------------------------
	If (@RptType='Month' and @AsPer='Bill' and @SegmentBreakUp='true')
	Begin
			 ----------------------Collection Type : Brokerage
			 Select @Sql=
			 ' Select 5,TradeMonth,TradeYear
			  ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			  ,SegmentName
			  ,''1.B''
			  From 
			 (
				  Select
				  month(PayoutDate) AS TradeMonth
				 ,year(PayoutDate) as TradeYear
				 ,Sum(ISNULL(CMPositionSummary_DeliveryBrokerage,0)+ISNULL(CMPositionSummary_SqrOffBrokerage,0)) as GrossEarning
				 ,Sum(
					(ISNULL(CMPositionSummary_DeliveryBrokerage,0)+ISNULL(CMPositionSummary_SqrOffBrokerage,0))
					  -
					(ISNULL(CMPositionSummary_UnrealizedServTax,0)+ ISNULL(CMPositionSummary_UnrealizedEduCess,0)+ISNULL(CMPositionSummary_UnrealizedHgrEduCess,0))
					) as NetEarning
				 ,Sum(ISNULL(CMPositionSummary_ServTaxOnBrokerage,0)) as SrvTax
				 ,Sum(ISNULL(CMPositionSummary_EduCessOnBrokerage,0)) as EduCess
				 ,Sum(ISNULL(CMPositionSummary_HgrEduCessOnBrokerage,0)) as HgrEduCess
				 ,Sum(  ISNULL(CMPositionSummary_ServTaxOnBrokerage,0)+
						ISNULL(CMPositionSummary_EduCessOnBrokerage,0)+
						ISNULL(CMPositionSummary_HgrEduCessOnBrokerage,0)
					 ) as TotServTax
				 ,SegmentName
				 From Trans_CMPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,CMPositionSummary_TradeDate)) as datetime)=Date 
				 and CMPositionSummary_settlementnumber=SettNo and CMPositionSummary_SettlementType=SettType
				 AND CMPositionSummary_SegmentID=Segmentid AND CMPositionSummary_BranchID IN ('+@Branch+') AND CMPositionSummary_CompanyID='''+@Companyid+'''
				 Group By  month(PayoutDate),year(PayoutDate),SegmentName

				 Union All

				 Select 
				   month(PayoutDate) AS TradeMonth
				 ,year(PayoutDate) as TradeYear
				 ,Sum(ISNULL(FOPositionSummary_TotalBrokerage,0))
				 ,Sum(
					(ISNULL(FOPositionSummary_TotalBrokerage,0))
					  -
					(ISNULL([FOPositionSummary_UnrealizedServTax],0)+ ISNULL([FOPositionSummary_UnrealizedEduCess],0)+ISNULL([FOPositionSummary_UnrealizedHgrEduCess],0))
					)
				 ,Sum(ISNULL(FOPositionSummary_ServiceTaxOnBrkg,0))
				 ,Sum(ISNULL(FOPositionSummary_EduCessOnBrkg,0))
				 ,Sum(ISNULL(FOPositionSummary_HgrEduCessOnBrkg,0))
				 ,Sum(  ISNULL(FOPositionSummary_ServiceTaxOnBrkg,0)+
						ISNULL(FOPositionSummary_EduCessOnBrkg,0)+
						ISNULL(FOPositionSummary_HgrEduCessOnBrkg,0)
					 )
				 ,SegmentName
				 From Trans_FOPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,FOPositionSummary_Date)) as datetime)=Date 
				 and FOPositionSummary_SettlementNumber=SettNo and FOPositionSummary_SettlementType=SettType
				 AND FOPositionSummary_SegmentID=Segmentid AND FOPositionSummary_BranchID IN ('+@Branch+') AND FOPositionSummary_CompanyID='''+@Companyid+'''
				 Group By  month(PayoutDate),year(PayoutDate),SegmentName


				 Union All

				 Select 
				  month(PayoutDate) AS TradeMonth
				 ,year(PayoutDate) as TradeYear
				 ,Sum(ISNULL([COMPositionSummary_TotalBrokerage],0))
				 ,Sum(ISNULL([COMPositionSummary_TotalBrokerage],0))
				 ,Sum(ISNULL([COMPositionSummary_ServiceTaxOnBrkg],0))
				 ,Sum(ISNULL([COMPositionSummary_EduCessOnBrkg],0))
				 ,Sum(ISNULL([COMPositionSummary_HgrEduCessOnBrkg],0))
				 ,Sum(  ISNULL([COMPositionSummary_ServiceTaxOnBrkg],0)+
						ISNULL([COMPositionSummary_EduCessOnBrkg],0)+
						ISNULL([COMPositionSummary_HgrEduCessOnBrkg],0)
					 )
				 ,SegmentName
				 From [Trans_COMPositionSummary],#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,[COMPositionSummary_Date])) as datetime)=Date 
				 and [COMPositionSummary_SettlementNumber]=SettNo and [COMPositionSummary_SettlementType]=SettType
				 AND [COMPositionSummary_SegmentID]=Segmentid AND [COMPositionSummary_BranchID] IN ('+@Branch+') AND [COMPositionSummary_CompanyID]='''+@Companyid+'''
				 Group By  month(PayoutDate),year(PayoutDate),SegmentName
			 ) as kk Group By TradeMonth,TradeYear,SegmentName Having Sum(isnull(GrossEarning,0))<>0'

			  Insert Into #TbResult(StOrder,TradeMonth,TradeYear,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,SegmentName,CollectionType) Exec(@Sql)	 

			 ----------------------Collection Type : Transaction Charges
			  Select @Sql=
			  ' Select 10,TradeMonth,TradeYear
			  ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			  ,SegmentName
			  ,''2.T'' 
			  From 

			 (
				  Select month(PayoutDate) AS TradeMonth
				 ,year(PayoutDate) as TradeYear
				 ,Sum(ISNULL(CMPositionSummary_TranCharge,0)) as GrossEarning
				 ,Sum(ISNULL(CMPositionSummary_TranCharge,0)) as NetEarning
				 ,Sum(ISNULL(CMPositionSummary_ServTaxOnTranCharge,0)) as SrvTax
				 ,Sum(ISNULL(CMPositionSummary_EduCessOnTranCharge,0)) as EduCess
				 ,Sum(ISNULL(CMPositionSummary_HgrEduCessOnTranCharge,0)) as HgrEduCess
				 ,Sum(  ISNULL(CMPositionSummary_ServTaxOnTranCharge,0)+
						ISNULL(CMPositionSummary_EduCessOnTranCharge,0)+
						ISNULL(CMPositionSummary_HgrEduCessOnTranCharge,0)
					 ) as TotServTax
				 ,SegmentName
				 From Trans_CMPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,CMPositionSummary_TradeDate)) as datetime)=Date 
				 and CMPositionSummary_settlementnumber=SettNo and CMPositionSummary_SettlementType=SettType
				 AND CMPositionSummary_SegmentID=Segmentid AND CMPositionSummary_BranchID IN ('+@Branch+') AND CMPositionSummary_CompanyID='''+@Companyid+'''
				 Group By month(PayoutDate),year(PayoutDate),SegmentName

				 Union All
				
				 Select month(PayoutDate) AS TradeMonth
				 ,year(PayoutDate) as TradeYear
				 ,Sum(ISNULL([FOPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([FOPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([FOPositionSummary_ServiceTaxOnTranCharge],0))
				 ,Sum(ISNULL([FOPositionSummary_EduCessOnTranCharge],0))
				 ,Sum(ISNULL([FOPositionSummary_HgrEduCessOnTranCharge],0))
				 ,Sum(  ISNULL([FOPositionSummary_ServiceTaxOnTranCharge],0)+
						ISNULL([FOPositionSummary_EduCessOnTranCharge],0)+
						ISNULL([FOPositionSummary_HgrEduCessOnTranCharge],0)
					 )
				 ,SegmentName
				 From Trans_FOPositionSummary,#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,FOPositionSummary_Date)) as datetime)=Date 
				 and FOPositionSummary_SettlementNumber=SettNo and FOPositionSummary_SettlementType=SettType
				 AND FOPositionSummary_SegmentID=Segmentid AND FOPositionSummary_BranchID IN ('+@Branch+') AND FOPositionSummary_CompanyID='''+@Companyid+'''
				 Group By month(PayoutDate),year(PayoutDate),SegmentName

				 Union All
				
				 Select month(PayoutDate) AS TradeMonth
				 ,year(PayoutDate) as TradeYear
				 ,Sum(ISNULL([COMPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([COMPositionSummary_TranCharges],0))
				 ,Sum(ISNULL([COMPositionSummary_ServiceTaxOnTranCharge],0))
				 ,Sum(ISNULL([COMPositionSummary_EduCessOnTranCharge],0))
				 ,Sum(ISNULL([COMPositionSummary_HgrEduCessOnTranCharge],0))
				 ,Sum(  ISNULL([COMPositionSummary_ServiceTaxOnTranCharge],0)+
						ISNULL([COMPositionSummary_EduCessOnTranCharge],0)+
						ISNULL([COMPositionSummary_HgrEduCessOnTranCharge],0)
					 )
				 ,SegmentName
				 From [Trans_COMPositionSummary],#TbConsider
				 Where 
				 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,[COMPositionSummary_Date])) as datetime)=Date 
				 and [COMPositionSummary_SettlementNumber]=SettNo and [COMPositionSummary_SettlementType]=SettType
				 AND [COMPositionSummary_SegmentID]=Segmentid AND [COMPositionSummary_BranchID] IN ('+@Branch+') AND [COMPositionSummary_CompanyID]='''+@Companyid+'''
				 Group By month(PayoutDate),year(PayoutDate),SegmentName
			 ) as bb Group By TradeMonth,TradeYear,SegmentName Having Sum(isnull(GrossEarning,0))<>0'
			 Insert Into #TbResult(StOrder,TradeMonth,TradeYear,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,SegmentName,CollectionType) Exec(@Sql)	 

			 ----------------------Collection Type : Demat Charges
			 Select @Sql=
			'Select 15
			 ,month(DematChargeSummary_BillDate) AS TradeInCluSiveMonth
			 ,year(DematChargeSummary_BillDate) as TradeInCluSiveYear
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_GrossAmount,0))
			 ,Sum(ISNULL(DematChargeSummary_ServiceTax,0))
			 ,Sum(ISNULL(DematChargeSummary_EduCess,0))
			 ,Sum(ISNULL(DematChargeSummary_HgrEduCess,0))
			 ,Sum(  ISNULL(DematChargeSummary_ServiceTax,0)+
					ISNULL(DematChargeSummary_EduCess,0)+
					ISNULL(DematChargeSummary_HgrEduCess,0)
				)
			 ,SegmentName
			 ,''3.D''
			 From Trans_DematChargeSummary,#DistinctSegment
			 Where ISNULL(DematChargeSummary_ServiceTax,0)<>0 
			 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,DematChargeSummary_BillDate)) as datetime) between '''+@FromDate+''' and '''+@Todate+ '''
			 and DematChargeSummary_Segment=SegmentID and DematChargeSummary_BranchID  IN ('+@Branch+') and DematChargeSummary_CompanyID='''+@Companyid+'''
			 Group By month(DematChargeSummary_BillDate),year(DematChargeSummary_BillDate),SegmentName'
			 Insert Into #TbResult(StOrder,TradeMonth,TradeYear,GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,SegmentName,CollectionType) Exec(@Sql)	 


			--------Year and Month 
			 Update #TbResult Set [Type]=substring(datename(month,dateadd(month,TradeMonth- 1, 0)),1,3)+'-'+cast(right(TradeYear,2) as varchar)
			 From #TbResult 
			 -----------Insert Into [Type]
			 Insert Into #TbResult(StOrder,TradeYear,TradeMonth,[Type],GrossEarning,SegmentName,CollectionType) 
			 Select Distinct 
						 Case When StOrder=5 Then 3
							  When StOrder=10 Then 8
							  When StOrder=15 Then 13
						 End
					,1900,01
					,Case When StOrder=5  Then 'Type : Brokerage'
						  When StOrder=10 Then 'Type : Transaction Charges'
						  When StOrder=15 Then 'Type : Demat Charges'
					End
					,99999999999999.99,null,CollectionType
			 From #TbResult	
			 Union All
			 Select Distinct 
					StOrder
					,1900,01
					 ,'** '+SegmentName
					,99999999999999.99,SegmentName,CollectionType
			 From #TbResult			
			 -----------Insert Into Total
			 Insert Into #TbResult(CollectionType,SegmentName,StOrder,TradeYear,TradeMonth,[Type],GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax) 
			 Select CollectionType,SegmentName,StOrder,2222,31,'Total'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder in (5,10,15) and 	GrossEarning<>99999999999999.99
			 Group By StOrder,SegmentName,CollectionType

			 Union All

			 Select CollectionType,'ZZZZZZ',StOrder
			 ,2222,31,'All Segment Total'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder  in (5,10,15)	and GrossEarning<>99999999999999.99
			 Group By StOrder,CollectionType 

			 Union All

			 Select '4.Z','ZZZZZZ',50
			 ,2222,31,'Grand Total'
			 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
			 From #TbResult	Where StOrder  in (5,10,15)	and GrossEarning<>99999999999999.99
			 
			

			 ------------Result Fetch
			 Select [Type] as [Month]
			,CASE WHEN ISNULL(GrossEarning,0)=99999999999999.99 THEN 'Test' WHEN ISNULL(GrossEarning,0)=0 THEN NULL WHEN GrossEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(GrossEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(GrossEarning AS VARCHAR(8000)),'Y') END AS [Gross Earning]
			,CASE WHEN ISNULL(NetEarning,0)=0 THEN NULL WHEN NetEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(NetEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(NetEarning AS VARCHAR(8000)),'Y') END AS [Net Earning]
			,CASE WHEN ISNULL(SrvTax,0)=0 THEN NULL WHEN SrvTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(SrvTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(SrvTax AS VARCHAR(8000)),'Y') END AS [Service Tax]
			,CASE WHEN ISNULL(EduCess,0)=0 THEN NULL WHEN EduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(EduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(EduCess AS VARCHAR(8000)),'Y') END AS [Edu.Cess]
			,CASE WHEN ISNULL(HgrEduCess,0)=0 THEN NULL WHEN HgrEduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(HgrEduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(HgrEduCess AS VARCHAR(8000)),'Y') END AS [Hgr.Edu.Cess]
			,CASE WHEN ISNULL(TotServTax,0)=0 THEN NULL WHEN TotServTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(TotServTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(TotServTax AS VARCHAR(8000)),'Y') END AS [Total Serv.Tax]
			From #TbResult Order By CollectionType,SegmentName,StOrder,TradeYear,TradeMonth


	End
	----------------------------If Report Type='Month Wise' and As Per  'Bill Wise' and 'Segment BreakUp' End  -------------------------------------
End
Else
Begin
	----------------------Collection Type : Brokerage
	
	Alter Table #TbResult Add CustomerID Varchar(250),ContractNoteNumber int
	
	 Select @Sql=
	 'Select 5
	 ,Case When TradeDate is null Then InCluSiveTradeDate Else TradeDate End
	 ,(Select LTRIM(Rtrim(cnt_firstName))+LTRIM(RTRIM(cnt_middleName))+LTRIM(Rtrim(cnt_lastName))+'' [''+Ltrim(Rtrim(cnt_UCC))+'']''
	 from tbl_master_contact Where cnt_internalId=CustomerID) CustomerID
	 ,ContractNumber
	 ,TotalBrokerage
	 ,InclusiveStt,InclusivesrvTax
	 ,(isnull(TotalBrokerage,0)-isnull(InCluSiveSrvTax,0)-isnull(InclusiveStt,0))
	 ,ServiceTaxOnBrkg
	 ,EduCessOnBrkg
	 ,HgrEduCessOnBrkg
	 ,TotalSrvTaxBrkg
	 ,Convert(VARCHAR(11),TradeDate,106) 
	 From
	 (Select 
	 ContractNotes_CustomerID CustomerID,
	 ContractNotes_Number ContractNumber,

	  Sum(ISNULL(ContractNotes_TotalBrokerage,0)) AS TotalBrokerage
	 ,Sum(ISNULL(ContractNotes_ServiceTaxOnBrkg,0)) AS ServiceTaxOnBrkg
	 ,Sum(ISNULL(ContractNotes_EduCessOnBrkg,0)) AS EduCessOnBrkg
	 ,Sum(ISNULL(ContractNotes_HgrEduCessOnBrkg,0)) AS HgrEduCessOnBrkg
	 ,Sum(   ISNULL(ContractNotes_ServiceTaxOnBrkg,0)+
			ISNULL(ContractNotes_EduCessOnBrkg,0)+
			ISNULL(ContractNotes_HgrEduCessOnBrkg,0)
		)AS TotalSrvTaxBrkg
	 ,PayoutDate AS TradeDate
	 
	 From Trans_ContractNotes,#TbConsider
	 Where 
	 cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
	 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
	 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
	 Group By PayoutDate,ContractNotes_Number,ContractNotes_CustomerID) as TbAllBrkg

	 Left Outer Join
	 
	(
	 Select InclusiveStt,InCluSiveSrvTax,InCluSiveTradeDate,T1.ContractNotes_CustomerID,isnull(T1.ContractNotes_Number,T2.ContractNotes_Number) ContractNotes_Number from
	 (Select Sum(    ISNULL(ContractNotes_ServiceTaxOnBrkg,0)+
					ISNULL(ContractNotes_EduCessOnBrkg,0)+
					ISNULL(ContractNotes_HgrEduCessOnBrkg,0)
			   ) AS InCluSiveSrvTax,
	 PayoutDate AS InCluSiveTradeDate,
	 ContractNotes_CustomerID,ContractNotes_Number
	 From Trans_ContractNotes,#TbConsider
	 Where ContractNotes_ServiceTaxMode=''I''
	 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
	 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
	 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
	 Group By PayoutDate,ContractNotes_CustomerID,ContractNotes_Number
	 Union All
	 Select 
	 Null AS InCluSiveSrvTax,
	 PayoutDate AS InCluSiveTradeDate,
	 ContractNotes_CustomerID,ContractNotes_Number
	 From Trans_ContractNotes,#TbConsider
	 Where ContractNotes_ServiceTaxMode=''E''
	 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
	 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
	 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
	 Group By PayoutDate,ContractNotes_CustomerID,ContractNotes_Number) T1
	 Left Outer Join
	 (Select Isnull(Sum(ContractNotes_STTAmount),0) AS InclusiveStt,PayoutDate AS InclusiveSttTradeDate,
	 ContractNotes_CustomerID,ContractNotes_Number
	 From Trans_ContractNotes,#TbConsider
	 Where ContractNotes_SttMode=''I''
	 and cast(DATEADD(dd, 0, DATEDIFF(dd, 0,ContractNotes_TradeDate)) as datetime)=Date And ContractNotes_Status is null
	 and ContractNotes_settlementnumber=SettNo and ContractNotes_settlementtype=SettType
	 AND ContractNotes_SegmentID=Segmentid AND ContractNotes_BranchID IN ('+@Branch+') AND ContractNotes_CompanyID='''+@Companyid+'''
	 Group By PayoutDate,ContractNotes_CustomerID,ContractNotes_Number) T2
	 On T1.InCluSiveTradeDate=T2.InclusiveSttTradeDate
	 and T1.ContractNotes_CustomerID=T2.ContractNotes_CustomerID
	 and T1.ContractNotes_Number=T2.ContractNotes_Number

	 ) as TbInCluSiveBrkg			 
	 
	 On (TradeDate=InCluSiveTradeDate
		and CustomerID=ContractNotes_CustomerID
		and ContractNumber=ContractNotes_Number)'
     
	Insert Into #TbResult(StOrder,TradeDate,Customerid,ContractNoteNumber,GrossEarning,InclusiveStt,InclusiveSrvTax,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,[Type]) Exec(@Sql)
	
	print (@Sql)
	
	-----------Insert Into [Type]
	 Insert Into #TbResult(StOrder,TradeDate,[Type],GrossEarning) 
	 Select Distinct 
				 Case When StOrder=5 Then  4
					  When StOrder=10 Then 9
					  When StOrder=15 Then 14
				 End
			,'1900-01-01'
			,Case When StOrder=5 Then 'Type : Brokerage' End
			,99999999999999.99
	 From #TbResult		
	 -----------Insert Into Total
	 Insert Into #TbResult(StOrder,TradeDate,[Type],GrossEarning,NetEarning,SrvTax,EduCess,HgrEduCess,TotServTax,InclusiveStt,InclusiveSrvTax) 
	 Select StOrder,'2222-12-31','Total:'
	 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
	 ,Sum(isnull(InclusiveStt,0)),Sum(isnull(InclusiveSrvTax,0))
	 From #TbResult	Where StOrder in (5,10,15)	
	 Group By StOrder

	 Union All

	 Select 40,'2222-12-31','Grand Total:'
	 ,Sum(isnull(GrossEarning,0)),Sum(isnull(NetEarning,0)),Sum(isnull(SrvTax,0)),Sum(isnull(EduCess,0)),Sum(isnull(HgrEduCess,0)),Sum(isnull(TotServTax,0))
	 ,Sum(isnull(InclusiveStt,0)),Sum(isnull(InclusiveSrvTax,0))
	 From #TbResult	Where StOrder in (5,10,15)	
	
	 ------------Result Fetch
	 Select [Type] as [Date],CustomerID,ContractNoteNumber CntrNo
	,CASE WHEN ISNULL(GrossEarning,0)=99999999999999.99 THEN 'Test' WHEN ISNULL(GrossEarning,0)=0 THEN NULL WHEN GrossEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(GrossEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(GrossEarning AS VARCHAR(8000)),'Y') END AS [Gross Earning]
	,CASE WHEN ISNULL(InclusiveStt,0)=0 THEN NULL WHEN InclusiveStt<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(InclusiveStt) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(InclusiveStt AS VARCHAR(8000)),'Y') END AS [Incl.Stt]
	,CASE WHEN ISNULL(InclusiveSrvTax,0)=0 THEN NULL WHEN InclusiveSrvTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(InclusiveSrvTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(InclusiveSrvTax AS VARCHAR(8000)),'Y') END AS [Incl.SrvTax]
	,CASE WHEN ISNULL(NetEarning,0)=0 THEN NULL WHEN NetEarning<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(NetEarning) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(NetEarning AS VARCHAR(8000)),'Y') END AS [Net Earning]
	,CASE WHEN ISNULL(SrvTax,0)=0 THEN NULL WHEN SrvTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(SrvTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(SrvTax AS VARCHAR(8000)),'Y') END AS [Service Tax]
	,CASE WHEN ISNULL(EduCess,0)=0 THEN NULL WHEN EduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(EduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(EduCess AS VARCHAR(8000)),'Y') END AS [Edu.Cess]
	,CASE WHEN ISNULL(HgrEduCess,0)=0 THEN NULL WHEN HgrEduCess<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(HgrEduCess) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(HgrEduCess AS VARCHAR(8000)),'Y') END AS [Hgr.Edu.Cess]
	,CASE WHEN ISNULL(TotServTax,0)=0 THEN NULL WHEN TotServTax<0 THEN '-'+dbo.fn_FormatNumber(CAST(ABS(TotServTax) AS VARCHAR(8000)),'Y') ELSE dbo.fn_FormatNumber(CAST(TotServTax AS VARCHAR(8000)),'Y') END AS [Total Serv.Tax]
	From #TbResult Order By StOrder,TradeDate
End

Drop Table #TbResult
Drop Table #TbConsider
END

