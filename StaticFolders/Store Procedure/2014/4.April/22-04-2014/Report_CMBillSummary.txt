

ALTER PROCEDURE [dbo].[Report_CMBillSummary]
		@DateFrom Varchar(50),						
		@DateTo Varchar(50),						
		@GroupBy Varchar(10),						
		@GroupByID Varchar(Max),					
		@GroupByType Varchar(200),					
		@SegmentID Varchar(50),						
		@OrderBy char(1),							
		@ReportType char(1),						
		@ReportBy Char(1),							
		@PageNumber Varchar(10),					
		@PageSize Varchar(10),						
		@CompanyID	Varchar(10)										
						
AS
BEGIN	
	SET NOCOUNT ON;
			
	if(@ReportType='1')
		Begin	
				
				if OBJECT_ID('tempdb..#DisplayResult') is not null
						Drop Table #DisplayResult		
				Create Table #DisplayResult(AutoID int identity(1,1),Client varchar(500),SettNum varchar(10),BillDate DateTime,NetObligation numeric(28,2),STT numeric(28,2),TranCharge numeric(28,2),StampDuty numeric(28,2),DlvCharge numeric(28,2),SebiFee numeric(28,2),
											OtherCharge numeric(28,2),ServTax numeric(28,2),NetBillAmount numeric(28,2),Turnover numeric(28,2),TotalBrokerage numeric(28,2),UnrealizedServTax numeric(28,2),UnrealizedSTT numeric(28,2),StatusOrder int)		
				
				if OBJECT_ID('tempdb..#DisplayTable') is not null
						Drop Table #DisplayTable		
				Create Table #DisplayTable(CustomerID varchar(10),TrdDate DateTime,SettNum varchar(10),BillDate DateTime,NetObligation numeric(28,2),STT numeric(28,2),TranCharge numeric(28,2),StampDuty numeric(28,2),DlvCharge numeric(28,2),SebiFee numeric(28,2),
											OtherCharge numeric(28,2),ServTax numeric(28,2),NetBillAmount numeric(28,2),Turnover numeric(28,2),TotalBrokerage numeric(28,2),UnrealizedServTax numeric(28,2),UnrealizedSTT numeric(28,2))
					
				----Declare Section----
				Declare @BranchIDCounter int,@BranchIDMaxCounter int,@BranchID int,@Branch varchar(150) 
				Declare @GroupIDCounter int,@GroupIDMaxCounter int,@GroupID int,@Group varchar(150)
				Declare @CustomerIDCounter int,@CustomerIDMaxCounter int,@CustomerID Varchar(50),@Customer varchar(150) 
				Declare @TrdDateCounter int,@TrdDateMaxCounter int,@TrdDate Varchar(11) 
				
				Declare @counter int  
				Set @counter=0 
				
				if OBJECT_ID('tempdb..#DistinctBranchID') is not null
						Drop Table #DistinctBranchID		
				Create Table #DistinctBranchID(AutoBranchID int,BranchID int) 
				
				if OBJECT_ID('tempdb..#DistinctGroupID') is not null
						Drop Table #DistinctGroupID		
				Create Table #DistinctGroupID(AutoGroupID int,GroupID int)				
				
				if OBJECT_ID('tempdb..#DistinctCustomerID') is not null
						Drop Table #DistinctCustomerID		
				Create Table #DistinctCustomerID(AutoCustomerID int,CustomerID varchar(50)) 
				
				if OBJECT_ID('tempdb..#DistinctTrdDate') is not null
						Drop Table #DistinctTrdDate		
				Create Table #DistinctTrdDate(AutoTrdDateID int,TrdDate varchar(50)) 
				
				if(@OrderBy='1')
					Begin   --Customer,TradeDate
							Insert into #DisplayTable
							select 	CMPositionSummary_CustomerID As CustomerID,
									convert(varchar,CMPositionSummary_TradeDate,106) As TrdDate,
									ltrim(rtrim(CMPositionSummary_SettlementNumber))+'-'+ltrim(rtrim(CMPositionSummary_SettlementType)) As SettNum,
									convert(varchar,CMPositionSummary_SettlementDate,106) As BillDate,
									CMPositionSummary_NetObligation As NetObligation,
									isnull(CMPositionSummary_STT,0.00)+isnull(CMPositionSummary_STTRoundOff,0) As STT,
									isnull(CMPositionSummary_TranCharge,0.00) As TranCharge,
									isnull(CMPositionSummary_StampDutyDlv,0.00)+isnull(CMPositionSummary_StampDutySqr,0.00) As StampDuty,
									isnull(CMPositionSummary_DeliveryCharge,0.00) As DlvCharge,
									isnull(CMPositionSummary_SEBIFee,0.00) As SebiFee,
									isnull(CMPositionSummary_OtherCharges,0.00) As OtherCharge,
									isnull(CMPositionSummary_ServTaxOnBrokerage,0.00)+isnull(CMPositionSummary_ServTaxOnTranCharge,0.00)+isnull(CMPositionSummary_ServTaxOnDeliveryCharge,0.00)+
									isnull(CMPositionSummary_ServTaxOnOtherCharges,0.00)+isnull(CMPositionSummary_EduCessOnBrokerage,0.00)+isnull(CMPositionSummary_EduCessOnTranCharge,0.00)+
									isnull(CMPositionSummary_EduCessOnDeliveryCharge,0.00)+isnull(CMPositionSummary_EduCessOnOtherCharges,0.00)+isnull(CMPositionSummary_HgrEduCessOnBrokerage,0.00)+
									isnull(CMPositionSummary_HgrEduCessOnTranCharge,0.00)+isnull(CMPositionSummary_HgrEduCessOnDeliveryCharge,0.00)+
									isnull(CMPositionSummary_HgrEduCessOnOtherCharges,0.00) As ServTax,
									isnull(CMPositionSummary_NetSettlementObligation,0.00)+isnull(CMPositionSummary_BillRoundOff,0.00) As NetBillAmount,
									isnull(CMPositionSummary_TotalTO,0.00) As Turnover,
									isnull(CMPositionSummary_DeliveryBrokerage,0.00)+isnull(CMPositionSummary_SqrOffBrokerage,0.00) As TotalBrokerage,
									isnull(CMPositionSummary_UnrealizedServTax,0.00)+isnull(CMPositionSummary_UnrealizedEduCess,0.00)+
									isnull(CMPositionSummary_UnrealizedHgrEduCess,0.00) As UnrealizedServTax,
									isnull(CMPositionSummary_UnrealizedSTT,0.00) As UnrealizedSTT
							from Trans_CMPositionSummary 
							where CMPositionSummary_SegmentID=@SegmentID
									and CMPositionSummary_TradeDate between @DateFrom And @DateTo
									and CMPositionSummary_CustomerID like 'CL%'
									and CMPositionSummary_CustomerID in (Select col1 from dbo.GenericTableValueFunction('CLIENT',@GroupBy+'~'+@GroupByID+'~'+@GroupByType))
									and isnull(CMPositionSummary_BuyObligation,0.00)+isnull(CMPositionSummary_SellObligation,0.00)<>0.00
							order by CMPositionSummary_CustomerID,CMPositionSummary_TradeDate
					End
				Else
					Begin	 --TradeDate,Customer
							Insert into #DisplayTable
							select 	CMPositionSummary_CustomerID As CustomerID,
									convert(varchar,CMPositionSummary_TradeDate,106) As TrdDate,
									ltrim(rtrim(CMPositionSummary_SettlementNumber))+'-'+ltrim(rtrim(CMPositionSummary_SettlementType)) As SettNum,
									convert(varchar,CMPositionSummary_SettlementDate,106) As BillDate,
									CMPositionSummary_NetObligation As NetObligation,
									isnull(CMPositionSummary_STT,0.00)+isnull(CMPositionSummary_STTRoundOff,0) As STT,
									isnull(CMPositionSummary_TranCharge,0.00) As TranCharge,
									isnull(CMPositionSummary_StampDutyDlv,0.00)+isnull(CMPositionSummary_StampDutySqr,0.00) As StampDuty,
									isnull(CMPositionSummary_DeliveryCharge,0.00) As DlvCharge,
									isnull(CMPositionSummary_SEBIFee,0.00) As SebiFee,
									isnull(CMPositionSummary_OtherCharges,0.00) As OtherCharge,
									isnull(CMPositionSummary_ServTaxOnBrokerage,0.00)+isnull(CMPositionSummary_ServTaxOnTranCharge,0.00)+isnull(CMPositionSummary_ServTaxOnDeliveryCharge,0.00)+
									isnull(CMPositionSummary_ServTaxOnOtherCharges,0.00)+isnull(CMPositionSummary_EduCessOnBrokerage,0.00)+isnull(CMPositionSummary_EduCessOnTranCharge,0.00)+
									isnull(CMPositionSummary_EduCessOnDeliveryCharge,0.00)+isnull(CMPositionSummary_EduCessOnOtherCharges,0.00)+isnull(CMPositionSummary_HgrEduCessOnBrokerage,0.00)+
									isnull(CMPositionSummary_HgrEduCessOnTranCharge,0.00)+isnull(CMPositionSummary_HgrEduCessOnDeliveryCharge,0.00)+
									isnull(CMPositionSummary_HgrEduCessOnOtherCharges,0.00) As ServTax,
									isnull(CMPositionSummary_NetSettlementObligation,0.00)+isnull(CMPositionSummary_BillRoundOff,0.00) As NetBillAmount,
									isnull(CMPositionSummary_TotalTO,0.00) As Turnover,
									isnull(CMPositionSummary_DeliveryBrokerage,0.00)+isnull(CMPositionSummary_SqrOffBrokerage,0.00) As TotalBrokerage,
									isnull(CMPositionSummary_UnrealizedServTax,0.00)+isnull(CMPositionSummary_UnrealizedEduCess,0.00)+
									isnull(CMPositionSummary_UnrealizedHgrEduCess,0.00) As UnrealizedServTax,
									isnull(CMPositionSummary_UnrealizedSTT,0.00) As UnrealizedSTT
							from Trans_CMPositionSummary 
							where CMPositionSummary_SegmentID=@SegmentID
									and CMPositionSummary_TradeDate between @DateFrom And @DateTo
									and CMPositionSummary_CustomerID like 'CL%'
									and CMPositionSummary_CustomerID in (Select col1 from dbo.GenericTableValueFunction('CLIENT',@GroupBy+'~'+@GroupByID+'~'+@GroupByType))
									and isnull(CMPositionSummary_BuyObligation,0.00)+isnull(CMPositionSummary_SellObligation,0.00)<>0.00
							order by CMPositionSummary_TradeDate,CMPositionSummary_CustomerID
					End			
				
				--------Declaration for obmit column whose Value is Zero---------------------------------------------- 		
				Declare @GrandTotal_NetObligation Numeric(28,6),@GrandTotal_STT Numeric(28,6),@GrandTotal_TranCharge Numeric(28,6),@GrandTotal_StampDuty Numeric(28,6),@GrandTotal_DlvCharge Numeric(28,6),@GrandTotal_SebiFee Numeric(28,6)
						,@GrandTotal_OtherCharge Numeric(28,6),@GrandTotal_ServTax Numeric(28,6),@GrandTotal_NetBillAmount Numeric(28,6),@GrandTotal_Turnover Numeric(28,6),@GrandTotal_TotalBrokerage Numeric(28,6),@GrandTotal_UnrealizedServTax Numeric(28,6)
						,@GrandTotal_UnrealizedSTT Numeric(28,6)
				Declare @DSql Varchar(Max),@DetailRecordCount int				
				Set @DetailRecordCount=0
				------For TCODE
				 Declare @SegName varchar(30)
				 Select @SegName= exh_shortName+' - '+exch_segmentId 
				 From (Select Ltrim(Rtrim(Exch_CompID)) as CompanyID,
							 (Select Ltrim(RTrim(Cmp_Name)) from Tbl_Master_Company Where Cmp_InternalID=Exch_CompID) as Company,
												(Select ExchangeSegment_ID From Master_ExchangeSegments Where ExchangeSegment_ExchangeID=Exchange_ID and ExchangeSegment_Code=Exch_SegmentID) as [Session_ExchangeSegmentID],
												Exch_InternalID as [Session_UserSegID],Exh_ShortName,Exch_SegmentID from
												(Select Exch_CompID,Exch_InternalID,Exh_ShortName,Exch_SegmentID from Tbl_Master_Exchange,Tbl_Master_CompanyExchange 
												Where Exh_CntId=Exch_ExchID) as T1,Master_Exchange
												Where Exchange_ShortName=Exh_ShortName) as T1 
				 Where CompanyID=@CompanyID and Session_UserSegID=@SegmentID	
		
				If(@GroupBy='BRANCH')
					Begin
							---Update BranchID,BranchName
							Alter Table #DisplayTable Add BranchID int,BranchName varchar(150)						
							Update #DisplayTable Set BranchID=col6,BranchName=ltrim(rtrim(isnull(col7,'')))+' ['+ ltrim(rtrim(isnull(col8,'')))+']'		
								From (Select * from dbo.GenericTableValueFunction('CLIENT',@GroupBy+'~'+@GroupByID+'~'+@GroupByType)) t1	
								where CustomerID=col1	
								
							---Update ClientName With TCode
							Alter Table #DisplayTable Add ClientName varchar(150)						
							Update #DisplayTable Set ClientName=ltrim(rtrim(isnull(col3,'')))+' '+ ltrim(rtrim(isnull(col4,'')))+' '+ ltrim(rtrim(isnull(col5,''))) +' ['+ ltrim(rtrim(isnull(crg_TCode,'')))+']' 																		
							From (Select * from dbo.GenericTableValueFunction('CLIENT',@GroupBy+'~'+@GroupByID+'~'+@GroupByType)) t1,tbl_master_contactExchange
							where CustomerID=col1	and  crg_cntID=CustomerID and crg_exchange=@SegName
							
							------------------------
							Delete From #DistinctBranchID  
							
							Insert into #DistinctBranchID  
							Select ROW_NUMBER() OVER(ORDER By BranchID),BranchID  
							from #DisplayTable Where BranchID is not null Group By BranchID  
					
							Set @BranchIDCounter=1  
							Select @BranchIDMaxCounter =Count(*) From #DistinctBranchID  
							While(@BranchIDCounter<=@BranchIDMaxCounter) 
								Begin 
										Select @BranchID=BranchID from #DistinctBranchID 
										where AutoBranchID=@BranchIDCounter 
										
										Select @Branch=BranchName from #DisplayTable where BranchID=@BranchID
										---Branch Name
										Insert into #DisplayResult 
										Select '***Branch : '+@Branch,'','','0','0','0','0','0','0','0','0','0','0','0','0','0',@counter 
										
										-----------------------				
										If(@OrderBy='1')
											Begin
													Delete From #DistinctCustomerID  
										
													Insert into #DistinctCustomerID  
													Select ROW_NUMBER() OVER(ORDER By CustomerID),CustomerID  
													from #DisplayTable Where BranchID=@BranchID and CustomerID is not null Group By CustomerID  
											
													Set @CustomerIDCounter=1  
													Select @CustomerIDMaxCounter =Count(*) From #DistinctCustomerID  
													While(@CustomerIDCounter<=@CustomerIDMaxCounter) 
														Begin 
																Select @CustomerID=CustomerID from #DistinctCustomerID 
																where AutoCustomerID=@CustomerIDCounter 
																
																Select @Customer=ClientName from #DisplayTable where CustomerID=@CustomerID
																
																Set @counter=@counter+1 
																---Customer Name													
																Insert into #DisplayResult 
																Select '**Client : '+@Customer,'','','0','0','0','0','0','0','0','0','0','0','0','0','0',@counter 
																
																Delete From #DistinctTrdDate  
																
																Insert into #DistinctTrdDate  
																Select ROW_NUMBER() OVER(ORDER By TrdDate),TrdDate  
																from #DisplayTable  
																Where TrdDate is not null And CustomerID=@CustomerID 
																Group By TrdDate  
																
																Set @TrdDateCounter=1  
																Select @TrdDateMaxCounter =Count(*) From #DistinctTrdDate  
																
																While(@TrdDateCounter<=@TrdDateMaxCounter) 
																	Begin 
																			Select @TrdDate=Case when TrdDate='1900-01-01 00:00:00.000' then '' else Convert(Varchar,cast(TrdDate as DateTime),106) end  
																			from #DistinctTrdDate where AutoTrdDateID=@TrdDateCounter 
																		
																			--Trade Date--
																			Insert into #DisplayResult 
																			Select '*Trade Date : '+@TrdDate,'','','0','0','0','0','0','0','0','0','0','0','0','0','0',@counter 
																			
																			Set @counter=@counter+1 
																			
																			---Detail settlement Number wise---- 
																			Insert into #DisplayResult  
																			Select '',SettNum,BillDate,NetObligation,STT,TranCharge,StampDuty,DlvCharge,SebiFee,OtherCharge,ServTax,NetBillAmount,Turnover,TotalBrokerage,UnrealizedServTax,UnrealizedSTT,@counter  
																			From #DisplayTable 
																			Where TrdDate=@TrdDate and CustomerID=@CustomerID 
																			
																			Select @DetailRecordCount=COUNT(*) From #DisplayTable 
																			Where TrdDate=@TrdDate and CustomerID=@CustomerID 
																			
																			
																			if(@DetailRecordCount>1)
																				Begin
																					Set @counter=@counter+1 
																					
																					--Trade Date Wise Total--
																					Insert into #DisplayResult  
																					Select '*Trade Date Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),Sum(IsNull(DlvCharge,0)),Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),Sum(IsNull(TotalBrokerage,0)),Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter  
																					From #DisplayTable 
																					Where TrdDate=@TrdDate and CustomerID=@CustomerID 
																					Group By TrdDate 
																				End
																			Set @TrdDateCounter=@TrdDateCounter+1  
																			Set @counter=@counter+1 
																	End  
																	
																if(@DetailRecordCount>1)
																	Begin
																		Set @counter=@counter+1 
																		
																		---Customer wise Total
																		Insert into #DisplayResult  
																		Select '**Client Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),Sum(IsNull(DlvCharge,0)),Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),Sum(IsNull(TotalBrokerage,0)),Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter  
																		From #DisplayTable 
																		Where CustomerID=@CustomerID 
																		Group By CustomerID 
																	End
																
																Set @CustomerIDCounter=@CustomerIDCounter+1  
																Set @counter=@counter+1 
														End	
																								
											End
										Else
											Begin
													Delete From #DistinctTrdDate  

													Insert into #DistinctTrdDate  
													Select ROW_NUMBER() OVER(ORDER By TrdDate),TrdDate  from #DisplayTable  
													Where BranchID=@BranchID and TrdDate is not null Group By TrdDate  
													
													Set @TrdDateCounter=1 
													Select @TrdDateMaxCounter =Count(*) From #DistinctTrdDate  
													While(@TrdDateCounter<=@TrdDateMaxCounter) 
														Begin 
																Select @TrdDate=Case when TrdDate='1900-01-01 00:00:00.000' then '' else Convert(Varchar,cast(TrdDate as DateTime),106) end 
																from #DistinctTrdDate where AutoTrdDateID=@TrdDateCounter 
																
																--Tradedate Name
																Insert into #DisplayResult 
																Select '**Trade Date : '+@TrdDate,'','','0','0','0','0','0','0','0','0','0','0','0','0','0',@counter 
																
																Delete From #DistinctCustomerID  
																
																Insert into #DistinctCustomerID  
																Select ROW_NUMBER() OVER(ORDER By CustomerID),CustomerID  
																from #DisplayTable  Where CustomerID is not null And TrdDate=@TrdDate Group By CustomerID  
																
																Set @CustomerIDCounter=1  
																Select @CustomerIDMaxCounter =Count(*) From #DistinctCustomerID			
																While(@CustomerIDCounter<=@CustomerIDMaxCounter) 
																	Begin 
																			Select @CustomerID=CustomerID from #DistinctCustomerID 
																			where AutoCustomerID=@CustomerIDCounter 
																			
																			Select @Customer=ClientName from #DisplayTable where CustomerID=@CustomerID
																
																			---Customer Name
																			Insert into #DisplayResult 
																			Select '*Client : '+@Customer,'','','0','0','0','0','0','0','0','0','0','0','0','0','0',@counter 
																			
																			Set @counter=@counter+1  
																			
																			---Detail With settlement number
																			Insert into #DisplayResult  
																			Select '',SettNum,BillDate,NetObligation,STT,TranCharge,StampDuty,DlvCharge,SebiFee,OtherCharge,ServTax,
																					NetBillAmount,Turnover,TotalBrokerage,UnrealizedServTax,UnrealizedSTT,@counter  
																			From #DisplayTable Where CustomerID=@CustomerID and TrdDate=@TrdDate
																			
																			Select @DetailRecordCount=COUNT(*) From #DisplayTable 
																			Where TrdDate=@TrdDate and CustomerID=@CustomerID 
																			
																			
																			if(@DetailRecordCount>1)
																				Begin
																					Set @counter=@counter+1 
																					
																					---Customer wise total
																					Insert into #DisplayResult  
																					Select '*Client Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),
																							Sum(IsNull(DlvCharge,0)),Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),
																							Sum(IsNull(TotalBrokerage,0)),Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter  
																					From #DisplayTable Where CustomerID=@CustomerID and TrdDate=@TrdDate 
																					Group By CustomerID 
																				End
																				
																			Set @CustomerIDCounter=@CustomerIDCounter+1  
																			Set @counter=@counter+1 
																	End  
																
																If(@DetailRecordCount>1)
																	Begin
																		Set @counter=@counter+1 
																		
																		--Trade Date wise total
																		Insert into #DisplayResult  
																		Select '**Trade Date Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),Sum(IsNull(DlvCharge,0)),
																				Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),Sum(IsNull(TotalBrokerage,0)),
																				Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter  
																		From #DisplayTable Where TrdDate=@TrdDate Group By TrdDate 
																	End
																Set @TrdDateCounter=@TrdDateCounter+1  
																Set @counter=@counter+1 
														End  
													
											End	
										
										--------------------------------------
										Set @counter=@counter+1 
																							
										---Branch wise Total
										Insert into #DisplayResult  
										Select '***Branch Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),Sum(IsNull(DlvCharge,0)),Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),Sum(IsNull(TotalBrokerage,0)),Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter  
										From #DisplayTable 
										Where BranchID=@BranchID 
										Group By BranchID 
										
										Set @BranchIDCounter=@BranchIDCounter+1  
										Set @counter=@counter+1 
								End				
								----------------------------------------------------	
									
							---Grand Total
							Insert Into #DisplayResult 
							Select '****Grand Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),Sum(IsNull(DlvCharge,0)),Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),
													   Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),Sum(IsNull(TotalBrokerage,0)),Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter 
							From #DisplayTable  
							
							
							
							select  @GrandTotal_NetObligation=Max(Abs(NetObligation)),@GrandTotal_STT=Max(Abs(STT)),
									@GrandTotal_TranCharge=Max(Abs(TranCharge)),@GrandTotal_StampDuty=Max(Abs(StampDuty)),
									@GrandTotal_DlvCharge=Max(Abs(DlvCharge)),@GrandTotal_SebiFee=Max(Abs(SebiFee)),
									@GrandTotal_OtherCharge=Max(Abs(OtherCharge)),@GrandTotal_ServTax=Max(Abs(ServTax)),
									@GrandTotal_NetBillAmount=Max(Abs(NetBillAmount)),@GrandTotal_Turnover=Max(Abs(Turnover)),
									@GrandTotal_TotalBrokerage=Max(Abs(TotalBrokerage)),@GrandTotal_UnrealizedServTax=Max(Abs(UnrealizedServTax)),
									@GrandTotal_UnrealizedSTT=Max(Abs(UnrealizedSTT))
							from #DisplayResult 
																		
							Set @DSql='Select  AutoID,Case when Client=''1900-01-01 00:00:00.000'' then '''' else Client end as Client,SettNum
											   ,Case when BillDate=''1900-01-01 00:00:00.000'' then '''' else Convert(Varchar,BillDate,106) end as BillDate'
							if(Abs(@GrandTotal_NetObligation)>0.00)
								Set @DSql=@DSql+',case when isnull(NetObligation,0)=0 then NULL  when NetObligation<0 then ''-''+dbo.fn_FormatNumber(cast(abs(NetObligation) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(NetObligation as varchar(8000)),''N'')  end as NetObligation'
							if(Abs(@GrandTotal_STT)>0.00)
								Set @DSql=@DSql+',case when isnull(STT,0)=0 then NULL  when STT<0 then ''-''+dbo.fn_FormatNumber(cast(abs(STT) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(STT as varchar(8000)),''N'')  end as STT'
							if(Abs(@GrandTotal_TranCharge)>0.00)
								Set @DSql=@DSql+',case when isnull(TranCharge,0)=0 then NULL  when TranCharge<0 then ''-''+dbo.fn_FormatNumber(cast(abs(TranCharge) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(TranCharge as varchar(8000)),''N'')  end as TranCharge'
							if(Abs(@GrandTotal_StampDuty)>0.00)
								Set @DSql=@DSql+',case when isnull(StampDuty,0)=0 then NULL  when StampDuty<0 then ''-''+dbo.fn_FormatNumber(cast(abs(StampDuty) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(StampDuty as varchar(8000)),''N'')  end as StampDuty'
							if(Abs(@GrandTotal_DlvCharge)>0.00)
								Set @DSql=@DSql+',case when isnull(DlvCharge,0)=0 then NULL  when DlvCharge<0 then ''-''+dbo.fn_FormatNumber(cast(abs(DlvCharge) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(DlvCharge as varchar(8000)),''N'')  end as DlvCharge'
							if(Abs(@GrandTotal_SebiFee)>0.00)
								Set @DSql=@DSql+',case when isnull(SebiFee,0)=0 then NULL  when SebiFee<0 then ''-''+dbo.fn_FormatNumber(cast(abs(SebiFee) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(SebiFee as varchar(8000)),''N'')  end as SebiFee'
							if(Abs(@GrandTotal_OtherCharge)>0.00)
								Set @DSql=@DSql+',case when isnull(OtherCharge,0)=0 then NULL  when OtherCharge<0 then ''-''+dbo.fn_FormatNumber(cast(abs(OtherCharge) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(OtherCharge as varchar(8000)),''N'')  end as OtherCharge'
							if(Abs(@GrandTotal_ServTax)>0.00)
								Set @DSql=@DSql+',case when isnull(ServTax,0)=0 then NULL  when ServTax<0 then ''-''+dbo.fn_FormatNumber(cast(abs(ServTax) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(ServTax as varchar(8000)),''N'')  end as ServTax'
							if(Abs(@GrandTotal_NetBillAmount)>0.00)
								Set @DSql=@DSql+',case when isnull(NetBillAmount,0)=0 then NULL  when NetBillAmount<0 then ''-''+dbo.fn_FormatNumber(cast(abs(NetBillAmount) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(NetBillAmount as varchar(8000)),''N'')  end as NetBillAmount'
							if(Abs(@GrandTotal_Turnover)>0.00)
								Set @DSql=@DSql+',case when isnull(Turnover,0)=0 then NULL  when Turnover<0 then ''-''+dbo.fn_FormatNumber(cast(abs(Turnover) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(Turnover as varchar(8000)),''N'')  end as Turnover'
							if(Abs(@GrandTotal_TotalBrokerage)>0.00)
								Set @DSql=@DSql+',case when isnull(TotalBrokerage,0)=0 then NULL  when TotalBrokerage<0 then ''-''+dbo.fn_FormatNumber(cast(abs(TotalBrokerage) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(TotalBrokerage as varchar(8000)),''N'')  end as TotalBrokerage'
							if(Abs(@GrandTotal_UnrealizedServTax)>0.00)
								Set @DSql=@DSql+',case when isnull(UnrealizedServTax,0)=0 then NULL  when UnrealizedServTax<0 then ''-''+dbo.fn_FormatNumber(cast(abs(UnrealizedServTax) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(UnrealizedServTax as varchar(8000)),''N'')  end as UnrealizedServTax'
							if(Abs(@GrandTotal_UnrealizedSTT)>0.00)
								Set @DSql=@DSql+',case when isnull(UnrealizedSTT,0)=0 then NULL  when UnrealizedSTT<0 then ''-''+dbo.fn_FormatNumber(cast(abs(UnrealizedSTT) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(UnrealizedSTT as varchar(8000)),''N'')  end as UnrealizedSTT'				
																																					
							Set @DSql=@DSql+' From #DisplayResult'-- Order By StatusOrder'
						
							IF(@ReportBy='E')
								Begin										
										Execute sp_sqlexec @DSql
								End
							Else IF(@ReportBy='S')
								Begin
										set @DSql='Select *	 INTO #Results FROM ('+ @DSql+') t1														 									 
													 
													 SELECT * From #Results
													 WHERE AutoID BETWEEN ('+@PageNumber+' -1) * '+@PageSize+' + 1  AND ((( '+@PageNumber+' -1) * '+@PageSize+' + 1) + '+@PageSize+') - 1 
													 
													 Select case 
																when COUNT(*)%'+@PageSize+'>0 then Count(*)/'+@PageSize+'+1 
																							  else Count(*)/'+@PageSize+' 
																end as [PageCount] From #DisplayResult	
													 Select * From #Results Where Client=''****Grand Total''											
													 '													
										Execute sp_sqlexec @DSql
								End	
					End
				If(@GroupBy='GROUP')
					Begin
					
							Alter Table #DisplayTable Add GroupID int,GroupName varchar(150),GroupType varchar(150)						
							Update #DisplayTable Set GroupID=col6,GroupName=ltrim(rtrim(isnull(col7,'')))+' ['+ ltrim(rtrim(isnull(col8,'')))+']',GroupType=col9		
								From (Select * from dbo.GenericTableValueFunction('CLIENT',@GroupBy+'~'+@GroupByID+'~'+@GroupByType)) t1	
								where CustomerID=col1	
							
							Alter Table #DisplayTable Add ClientName varchar(150)						
							Update #DisplayTable Set ClientName=ltrim(rtrim(isnull(col3,'')))+' '+ ltrim(rtrim(isnull(col4,'')))+' '+ ltrim(rtrim(isnull(col5,'')))	+' ['+ ltrim(rtrim(isnull(crg_TCode,'')))+']' 																		
							From (Select * from dbo.GenericTableValueFunction('CLIENT',@GroupBy+'~'+@GroupByID+'~'+@GroupByType)) t1,tbl_master_contactExchange
							where CustomerID=col1	and  crg_cntID=CustomerID and crg_exchange=@SegName
							
							
							------------------------
							Delete From #DistinctGroupID  
							
							Insert into #DistinctGroupID  
							Select ROW_NUMBER() OVER(ORDER By GroupID),GroupID  
							from #DisplayTable Where GroupID is not null Group By GroupID  
					
							Set @GroupIDCounter=1  
							Select @GroupIDMaxCounter =Count(*) From #DistinctGroupID  
							While(@GroupIDCounter<=@GroupIDMaxCounter) 
								Begin 
										Select @GroupID=GroupID from #DistinctGroupID 
										where AutoGroupID=@GroupIDCounter 
										
										Select @Group=GroupName from #DisplayTable where GroupID=@GroupID
										---Branch Name
										Insert into #DisplayResult 
										Select '***Group : '+@Group,'','','0','0','0','0','0','0','0','0','0','0','0','0','0',@counter 
										
										-----------------------	
											
										If(@OrderBy='1')
											Begin
													Delete From #DistinctCustomerID  
										
													Insert into #DistinctCustomerID  
													Select ROW_NUMBER() OVER(ORDER By CustomerID),CustomerID  
													from #DisplayTable 
													Where GroupID=@GroupID and CustomerID is not null Group By CustomerID  
											
													Set @CustomerIDCounter=1  
													Select @CustomerIDMaxCounter =Count(*) From #DistinctCustomerID  
													While(@CustomerIDCounter<=@CustomerIDMaxCounter) 
														Begin 
																Select @CustomerID=CustomerID from #DistinctCustomerID 
																where AutoCustomerID=@CustomerIDCounter 
																
																Select @Customer=ClientName from #DisplayTable where CustomerID=@CustomerID
																---Customer Name
																Insert into #DisplayResult 
																Select '**Client : '+@Customer,'','','0','0','0','0','0','0','0','0','0','0','0','0','0',@counter 
																
																Delete From #DistinctTrdDate  
																
																Insert into #DistinctTrdDate  
																Select ROW_NUMBER() OVER(ORDER By TrdDate),TrdDate  
																from #DisplayTable  
																Where TrdDate is not null And CustomerID=@CustomerID 
																Group By TrdDate  
																
																Set @TrdDateCounter=1  
																Select @TrdDateMaxCounter =Count(*) From #DistinctTrdDate  
																
																While(@TrdDateCounter<=@TrdDateMaxCounter) 
																	Begin 
																			Select @TrdDate=Case when TrdDate='1900-01-01 00:00:00.000' then '' else Convert(Varchar,cast(TrdDate as DateTime),106) end  from #DistinctTrdDate 
																			where AutoTrdDateID=@TrdDateCounter 
																		
																			--Trade Date--
																			Insert into #DisplayResult 
																			Select '*Trade Date : '+@TrdDate,'','','0','0','0','0','0','0','0','0','0','0','0','0','0',@counter 
																			
																			Set @counter=@counter+1 
																			
																			---Detail settlement Number wise---- 
																			Insert into #DisplayResult  
																			Select '',SettNum,BillDate,NetObligation,STT,TranCharge,StampDuty,DlvCharge,SebiFee,OtherCharge,ServTax,NetBillAmount,Turnover,TotalBrokerage,UnrealizedServTax,UnrealizedSTT,@counter  
																			From #DisplayTable 
																			Where TrdDate=@TrdDate and CustomerID=@CustomerID 
																			
																			Select @DetailRecordCount=COUNT(*) From #DisplayTable 
																			Where TrdDate=@TrdDate and CustomerID=@CustomerID 
																			
																			
																			if(@DetailRecordCount>1)
																				Begin
																					Set @counter=@counter+1 
																					
																					--Trade Date Wise Total--
																					Insert into #DisplayResult  
																					Select '*Trade Date Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),Sum(IsNull(DlvCharge,0)),Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),Sum(IsNull(TotalBrokerage,0)),Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter  
																					From #DisplayTable 
																					Where TrdDate=@TrdDate and CustomerID=@CustomerID 
																					Group By TrdDate 
																				End
																			Set @TrdDateCounter=@TrdDateCounter+1  
																			Set @counter=@counter+1 
																	End  
																
																if(@DetailRecordCount>1)
																	Begin	
																		Set @counter=@counter+1 
																		
																		---Customer wise Total
																		Insert into #DisplayResult  
																		Select '**Client Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),Sum(IsNull(DlvCharge,0)),Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),Sum(IsNull(TotalBrokerage,0)),Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter  
																		From #DisplayTable 
																		Where CustomerID=@CustomerID 
																		Group By CustomerID 
																	End
																Set @CustomerIDCounter=@CustomerIDCounter+1  
																Set @counter=@counter+1 
														End										
											End
										Else
											Begin							
													
													
													Delete From #DistinctTrdDate  

													Insert into #DistinctTrdDate  
													Select ROW_NUMBER() OVER(ORDER By TrdDate),TrdDate  from #DisplayTable  
													Where GroupID=@GroupID and TrdDate is not null Group By TrdDate  
													
													Set @TrdDateCounter=1 
													Select @TrdDateMaxCounter =Count(*) From #DistinctTrdDate  
													While(@TrdDateCounter<=@TrdDateMaxCounter) 
														Begin 
																Select @TrdDate=Case when TrdDate='1900-01-01 00:00:00.000' then '' else Convert(Varchar,cast(TrdDate as DateTime),106) end 
																from #DistinctTrdDate where AutoTrdDateID=@TrdDateCounter 
																
																--Tradedate Name
																Insert into #DisplayResult 
																Select '**Trade Date : '+@TrdDate,'','','0','0','0','0','0','0','0','0','0','0','0','0','0',@counter 
																
																Delete From #DistinctCustomerID  
																
																Insert into #DistinctCustomerID  
																Select ROW_NUMBER() OVER(ORDER By CustomerID),CustomerID  
																from #DisplayTable  Where CustomerID is not null And TrdDate=@TrdDate Group By CustomerID  
																
																Set @CustomerIDCounter=1  
																Select @CustomerIDMaxCounter =Count(*) From #DistinctCustomerID			
																While(@CustomerIDCounter<=@CustomerIDMaxCounter) 
																	Begin 
																			Select @CustomerID=CustomerID from #DistinctCustomerID 
																			where AutoCustomerID=@CustomerIDCounter 
																			
																			Select @Customer=ClientName from #DisplayTable where CustomerID=@CustomerID
																
																			---Customer Name
																			Insert into #DisplayResult 
																			Select '*Client : '+@Customer,'','','0','0','0','0','0','0','0','0','0','0','0','0','0',@counter 
																			
																			Set @counter=@counter+1  
																			
																			---Detail With settlement number
																			Insert into #DisplayResult  
																			Select '',SettNum,BillDate,NetObligation,STT,TranCharge,StampDuty,DlvCharge,SebiFee,OtherCharge,ServTax,
																					NetBillAmount,Turnover,TotalBrokerage,UnrealizedServTax,UnrealizedSTT,@counter  
																			From #DisplayTable Where CustomerID=@CustomerID and TrdDate=@TrdDate
																			
																			
																			Select @DetailRecordCount=COUNT(*) From #DisplayTable 
																			Where TrdDate=@TrdDate and CustomerID=@CustomerID 
																			
																			if(@DetailRecordCount>1)
																				Begin
																					Set @counter=@counter+1 
																					
																					---Customer wise total
																					Insert into #DisplayResult  
																					Select '*Client Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),
																							Sum(IsNull(DlvCharge,0)),Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),
																							Sum(IsNull(TotalBrokerage,0)),Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter  
																					From #DisplayTable Where CustomerID=@CustomerID and TrdDate=@TrdDate 
																					Group By CustomerID 
																				End
																			Set @CustomerIDCounter=@CustomerIDCounter+1  
																			Set @counter=@counter+1 
																	End  
																
																if(@DetailRecordCount>1)
																	Begin
																		Set @counter=@counter+1 
																		
																		--Trade Date wise total
																		Insert into #DisplayResult  
																		Select '**Trade Date Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),Sum(IsNull(DlvCharge,0)),
																				Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),Sum(IsNull(TotalBrokerage,0)),
																				Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter  
																		From #DisplayTable Where TrdDate=@TrdDate Group By TrdDate 
																	End
																Set @TrdDateCounter=@TrdDateCounter+1  
																Set @counter=@counter+1 
														End  
													
											End		
										
							
							--------------------------------------
										Set @counter=@counter+1 
																							
										---Branch wise Total
										Insert into #DisplayResult  
										Select '***Group Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),Sum(IsNull(DlvCharge,0)),Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),Sum(IsNull(TotalBrokerage,0)),Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter  
										From #DisplayTable 
										Where GroupID=@GroupID 
										Group By GroupID 
										
										Set @GroupIDCounter=@GroupIDCounter+1  
										Set @counter=@counter+1 
								End				
								----------------------------------------------------
										
							
							---Grand Total
							Insert Into #DisplayResult 
							Select '****Grand Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),Sum(IsNull(DlvCharge,0)),Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),
													   Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),Sum(IsNull(TotalBrokerage,0)),Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter 
							From #DisplayTable  
							
							
							
							select  @GrandTotal_NetObligation=Max(Abs(NetObligation)),@GrandTotal_STT=Max(Abs(STT)),
									@GrandTotal_TranCharge=Max(Abs(TranCharge)),@GrandTotal_StampDuty=Max(Abs(StampDuty)),
									@GrandTotal_DlvCharge=Max(Abs(DlvCharge)),@GrandTotal_SebiFee=Max(Abs(SebiFee)),
									@GrandTotal_OtherCharge=Max(Abs(OtherCharge)),@GrandTotal_ServTax=Max(Abs(ServTax)),
									@GrandTotal_NetBillAmount=Max(Abs(NetBillAmount)),@GrandTotal_Turnover=Max(Abs(Turnover)),
									@GrandTotal_TotalBrokerage=Max(Abs(TotalBrokerage)),@GrandTotal_UnrealizedServTax=Max(Abs(UnrealizedServTax)),
									@GrandTotal_UnrealizedSTT=Max(Abs(UnrealizedSTT))
							from #DisplayResult 
																		
							Set @DSql='Select  AutoID,Case when Client=''1900-01-01 00:00:00.000'' then '''' else Client end as Client,SettNum
											   ,Case when BillDate=''1900-01-01 00:00:00.000'' then '''' else Convert(Varchar,BillDate,106) end as BillDate'
							if(Abs(@GrandTotal_NetObligation)>0.00)
								Set @DSql=@DSql+',case when isnull(NetObligation,0)=0 then NULL  when NetObligation<0 then ''-''+dbo.fn_FormatNumber(cast(abs(NetObligation) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(NetObligation as varchar(8000)),''N'')  end as NetObligation'
							if(Abs(@GrandTotal_STT)>0.00)
								Set @DSql=@DSql+',case when isnull(STT,0)=0 then NULL  when STT<0 then ''-''+dbo.fn_FormatNumber(cast(abs(STT) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(STT as varchar(8000)),''N'')  end as STT'
							if(Abs(@GrandTotal_TranCharge)>0.00)
								Set @DSql=@DSql+',case when isnull(TranCharge,0)=0 then NULL  when TranCharge<0 then ''-''+dbo.fn_FormatNumber(cast(abs(TranCharge) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(TranCharge as varchar(8000)),''N'')  end as TranCharge'
							if(Abs(@GrandTotal_StampDuty)>0.00)
								Set @DSql=@DSql+',case when isnull(StampDuty,0)=0 then NULL  when StampDuty<0 then ''-''+dbo.fn_FormatNumber(cast(abs(StampDuty) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(StampDuty as varchar(8000)),''N'')  end as StampDuty'
							if(Abs(@GrandTotal_DlvCharge)>0.00)
								Set @DSql=@DSql+',case when isnull(DlvCharge,0)=0 then NULL  when DlvCharge<0 then ''-''+dbo.fn_FormatNumber(cast(abs(DlvCharge) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(DlvCharge as varchar(8000)),''N'')  end as DlvCharge'
							if(Abs(@GrandTotal_SebiFee)>0.00)
								Set @DSql=@DSql+',case when isnull(SebiFee,0)=0 then NULL  when SebiFee<0 then ''-''+dbo.fn_FormatNumber(cast(abs(SebiFee) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(SebiFee as varchar(8000)),''N'')  end as SebiFee'
							if(Abs(@GrandTotal_OtherCharge)>0.00)
								Set @DSql=@DSql+',case when isnull(OtherCharge,0)=0 then NULL  when OtherCharge<0 then ''-''+dbo.fn_FormatNumber(cast(abs(OtherCharge) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(OtherCharge as varchar(8000)),''N'')  end as OtherCharge'
							if(Abs(@GrandTotal_ServTax)>0.00)
								Set @DSql=@DSql+',case when isnull(ServTax,0)=0 then NULL  when ServTax<0 then ''-''+dbo.fn_FormatNumber(cast(abs(ServTax) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(ServTax as varchar(8000)),''N'')  end as ServTax'
							if(Abs(@GrandTotal_NetBillAmount)>0.00)
								Set @DSql=@DSql+',case when isnull(NetBillAmount,0)=0 then NULL  when NetBillAmount<0 then ''-''+dbo.fn_FormatNumber(cast(abs(NetBillAmount) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(NetBillAmount as varchar(8000)),''N'')  end as NetBillAmount'
							if(Abs(@GrandTotal_Turnover)>0.00)
								Set @DSql=@DSql+',case when isnull(Turnover,0)=0 then NULL  when Turnover<0 then ''-''+dbo.fn_FormatNumber(cast(abs(Turnover) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(Turnover as varchar(8000)),''N'')  end as Turnover'
							if(Abs(@GrandTotal_TotalBrokerage)>0.00)
								Set @DSql=@DSql+',case when isnull(TotalBrokerage,0)=0 then NULL  when TotalBrokerage<0 then ''-''+dbo.fn_FormatNumber(cast(abs(TotalBrokerage) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(TotalBrokerage as varchar(8000)),''N'')  end as TotalBrokerage'
							if(Abs(@GrandTotal_UnrealizedServTax)>0.00)
								Set @DSql=@DSql+',case when isnull(UnrealizedServTax,0)=0 then NULL  when UnrealizedServTax<0 then ''-''+dbo.fn_FormatNumber(cast(abs(UnrealizedServTax) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(UnrealizedServTax as varchar(8000)),''N'')  end as UnrealizedServTax'
							if(Abs(@GrandTotal_UnrealizedSTT)>0.00)
								Set @DSql=@DSql+',case when isnull(UnrealizedSTT,0)=0 then NULL  when UnrealizedSTT<0 then ''-''+dbo.fn_FormatNumber(cast(abs(UnrealizedSTT) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(UnrealizedSTT as varchar(8000)),''N'')  end as UnrealizedSTT'				
																																					
							Set @DSql=@DSql+' From #DisplayResult'-- Order By StatusOrder'
						
							IF(@ReportBy='E')
								Begin										
										Execute sp_sqlexec @DSql
								End
							Else IF(@ReportBy='S')
								Begin
										set @DSql='Select *	 INTO #Results FROM ('+ @DSql+') t1														 									 
													 
													 SELECT * From #Results
													 WHERE AutoID BETWEEN ('+@PageNumber+' -1) * '+@PageSize+' + 1  AND ((( '+@PageNumber+' -1) * '+@PageSize+' + 1) + '+@PageSize+') - 1 
													 
													 Select case 
																when COUNT(*)%'+@PageSize+'>0 then Count(*)/'+@PageSize+'+1 
																							  else Count(*)/'+@PageSize+' 
																end as [PageCount] From #DisplayResult	
													 Select * From #Results Where Client=''****Grand Total''											
													 '													
										Execute sp_sqlexec @DSql
								End	
					End			
				If(@GroupBy='CLIENT')
					Begin	
							Alter Table #DisplayTable Add ClientName varchar(150)						
							Update #DisplayTable Set ClientName=ltrim(rtrim(isnull(col3,'')))+' '+ ltrim(rtrim(isnull(col4,'')))+' '+ ltrim(rtrim(isnull(col5,'')))+' ['+ ltrim(rtrim(isnull(crg_TCode,'')))+']' 																		
							From (Select * from dbo.GenericTableValueFunction('CLIENT',@GroupBy+'~'+@GroupByID+'~'+@GroupByType)) t1,tbl_master_contactExchange
							where CustomerID=col1	and  crg_cntID=CustomerID and crg_exchange=@SegName
							
											
							If(@OrderBy='1')
								Begin
										Delete From #DistinctCustomerID  
							
										Insert into #DistinctCustomerID  
										Select ROW_NUMBER() OVER(ORDER By CustomerID),CustomerID  
										from #DisplayTable Where CustomerID is not null Group By CustomerID  
								
										Set @CustomerIDCounter=1  
										Select @CustomerIDMaxCounter =Count(*) From #DistinctCustomerID  
										While(@CustomerIDCounter<=@CustomerIDMaxCounter) 
											Begin 
													Select @CustomerID=CustomerID from #DistinctCustomerID 
													where AutoCustomerID=@CustomerIDCounter 
													
													Select @Customer=ClientName from #DisplayTable where CustomerID=@CustomerID
													---Customer Name
													Insert into #DisplayResult 
													Select '**Client : '+@Customer,'','','0','0','0','0','0','0','0','0','0','0','0','0','0',@counter 
													
													Delete From #DistinctTrdDate  
													
													Insert into #DistinctTrdDate  
													Select ROW_NUMBER() OVER(ORDER By TrdDate),TrdDate  
													from #DisplayTable  
													Where TrdDate is not null And CustomerID=@CustomerID 
													Group By TrdDate  
													
													Set @TrdDateCounter=1  
													Select @TrdDateMaxCounter =Count(*) From #DistinctTrdDate  
													
													While(@TrdDateCounter<=@TrdDateMaxCounter) 
														Begin 
																Select @TrdDate=Case when TrdDate='1900-01-01 00:00:00.000' then '' else Convert(Varchar,cast(TrdDate as DateTime),106) end  from #DistinctTrdDate 
																where AutoTrdDateID=@TrdDateCounter 
									
																--Trade Date--
																Insert into #DisplayResult 
																Select '*Trade Date : '+@TrdDate,'','','0','0','0','0','0','0','0','0','0','0','0','0','0',@counter 
																
																Set @counter=@counter+1 
																
																---Detail settlement Number wise---- 
																Insert into #DisplayResult  
																Select '',SettNum,BillDate,NetObligation,STT,TranCharge,StampDuty,DlvCharge,SebiFee,OtherCharge,ServTax,NetBillAmount,Turnover,TotalBrokerage,UnrealizedServTax,UnrealizedSTT,@counter  
																From #DisplayTable 
																Where TrdDate=@TrdDate and CustomerID=@CustomerID 
																
																Select @DetailRecordCount=COUNT(*) From #DisplayTable 
																Where TrdDate=@TrdDate and CustomerID=@CustomerID 
																			
																if(@DetailRecordCount>1)
																	Begin
																		Set @counter=@counter+1 
																		
																		--Trade Date Wise Total--
																		Insert into #DisplayResult  
																		Select '*Trade Date Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),Sum(IsNull(DlvCharge,0)),Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),Sum(IsNull(TotalBrokerage,0)),Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter  
																		From #DisplayTable 
																		Where TrdDate=@TrdDate and CustomerID=@CustomerID 
																		Group By TrdDate 
																	End
																Set @TrdDateCounter=@TrdDateCounter+1  
																Set @counter=@counter+1 
														End  
													
													if(@DetailRecordCount>1)
														Begin	
															Set @counter=@counter+1 
															
															---Customer wise Total
															Insert into #DisplayResult  
															Select '**Client Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),Sum(IsNull(DlvCharge,0)),Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),Sum(IsNull(TotalBrokerage,0)),Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter  
															From #DisplayTable 
															Where CustomerID=@CustomerID 
															Group By CustomerID 
														End
													Set @CustomerIDCounter=@CustomerIDCounter+1  
													Set @counter=@counter+1 
											End										
								End
							Else
								Begin							
										
										
										Delete From #DistinctTrdDate  

										Insert into #DistinctTrdDate  
										Select ROW_NUMBER() OVER(ORDER By TrdDate),TrdDate  from #DisplayTable  
										Where TrdDate is not null Group By TrdDate  
										
										Set @TrdDateCounter=1 
										Select @TrdDateMaxCounter =Count(*) From #DistinctTrdDate  
										While(@TrdDateCounter<=@TrdDateMaxCounter) 
											Begin 
													Select @TrdDate=Case when TrdDate='1900-01-01 00:00:00.000' then '' else Convert(Varchar,cast(TrdDate as DateTime),106) end  from #DistinctTrdDate 
																where AutoTrdDateID=@TrdDateCounter 
					
													--Tradedate Name
													Insert into #DisplayResult 
													Select '**Trade Date : '+@TrdDate,'','','0','0','0','0','0','0','0','0','0','0','0','0','0',@counter 
													
													Delete From #DistinctCustomerID  
													
													Insert into #DistinctCustomerID  
													Select ROW_NUMBER() OVER(ORDER By CustomerID),CustomerID  
													from #DisplayTable  Where CustomerID is not null And TrdDate=@TrdDate Group By CustomerID  
													
													Set @CustomerIDCounter=1  
													Select @CustomerIDMaxCounter =Count(*) From #DistinctCustomerID			
													While(@CustomerIDCounter<=@CustomerIDMaxCounter) 
														Begin 
																Select @CustomerID=CustomerID from #DistinctCustomerID 
																where AutoCustomerID=@CustomerIDCounter 
																
																Select @Customer=ClientName from #DisplayTable where CustomerID=@CustomerID
													
																---Customer Name
																Insert into #DisplayResult 
																Select '*Client : '+@Customer,'','','0','0','0','0','0','0','0','0','0','0','0','0','0',@counter 
																
																Set @counter=@counter+1  
																
																---Detail With settlement number
																Insert into #DisplayResult  
																Select '',SettNum,BillDate,NetObligation,STT,TranCharge,StampDuty,DlvCharge,SebiFee,OtherCharge,ServTax,
																		NetBillAmount,Turnover,TotalBrokerage,UnrealizedServTax,UnrealizedSTT,@counter  
																From #DisplayTable Where CustomerID=@CustomerID and TrdDate=@TrdDate
																
																Select @DetailRecordCount=COUNT(*) From #DisplayTable 
																Where TrdDate=@TrdDate and CustomerID=@CustomerID 
																			
																
																if(@DetailRecordCount>1)
																	Begin
																		Set @counter=@counter+1 
																		
																		---Customer wise total
																		Insert into #DisplayResult  
																		Select '*Client Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),
																				Sum(IsNull(DlvCharge,0)),Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),
																				Sum(IsNull(TotalBrokerage,0)),Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter  
																		From #DisplayTable Where CustomerID=@CustomerID and TrdDate=@TrdDate 
																		Group By CustomerID 
																	End
																Set @CustomerIDCounter=@CustomerIDCounter+1  
																Set @counter=@counter+1 
														End  
													
													if(@DetailRecordCount>1)
														Begin
													
																Set @counter=@counter+1 
																
																--Trade Date wise total
																Insert into #DisplayResult  
																Select '**Trade Date Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),Sum(IsNull(DlvCharge,0)),
																		Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),Sum(IsNull(TotalBrokerage,0)),
																		Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter  
																From #DisplayTable Where TrdDate=@TrdDate Group By TrdDate 
														end
													Set @TrdDateCounter=@TrdDateCounter+1  
													Set @counter=@counter+1 
											End  
										
								End		
							---Grand Total
							Insert Into #DisplayResult 
							Select '***Grand Total','','',Sum(IsNull(NetObligation,0)),Sum(IsNull(STT,0)),Sum(IsNull(TranCharge,0)),Sum(IsNull(StampDuty,0)),Sum(IsNull(DlvCharge,0)),Sum(IsNull(SebiFee,0)),Sum(IsNull(OtherCharge,0)),
													   Sum(IsNull(ServTax,0)),Sum(IsNull(NetBillAmount,0)),Sum(IsNull(Turnover,0)),Sum(IsNull(TotalBrokerage,0)),Sum(IsNull(UnrealizedServTax,0)),Sum(IsNull(UnrealizedSTT,0)),@counter 
							From #DisplayTable  
							
							
							
							select  @GrandTotal_NetObligation=Max(Abs(NetObligation)),@GrandTotal_STT=Max(Abs(STT)),
									@GrandTotal_TranCharge=Max(Abs(TranCharge)),@GrandTotal_StampDuty=Max(Abs(StampDuty)),
									@GrandTotal_DlvCharge=Max(Abs(DlvCharge)),@GrandTotal_SebiFee=Max(Abs(SebiFee)),
									@GrandTotal_OtherCharge=Max(Abs(OtherCharge)),@GrandTotal_ServTax=Max(Abs(ServTax)),
									@GrandTotal_NetBillAmount=Max(Abs(NetBillAmount)),@GrandTotal_Turnover=Max(Abs(Turnover)),
									@GrandTotal_TotalBrokerage=Max(Abs(TotalBrokerage)),@GrandTotal_UnrealizedServTax=Max(Abs(UnrealizedServTax)),
									@GrandTotal_UnrealizedSTT=Max(Abs(UnrealizedSTT))
							from #DisplayResult 
		
																			
							Set @DSql='Select  AutoID,Case when Client=''1900-01-01 00:00:00.000'' then '''' else Client end as Client,SettNum
											   ,Case when BillDate=''1900-01-01 00:00:00.000'' then '''' else Convert(Varchar,BillDate,106) end as BillDate'
							if(Abs(@GrandTotal_NetObligation)>0.00)
								Set @DSql=@DSql+',case when isnull(NetObligation,0)=0 then NULL  when NetObligation<0 then ''-''+dbo.fn_FormatNumber(cast(abs(NetObligation) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(NetObligation as varchar(8000)),''N'')  end as NetObligation'
							if(Abs(@GrandTotal_STT)>0.00)
								Set @DSql=@DSql+',case when isnull(STT,0)=0 then NULL  when STT<0 then ''-''+dbo.fn_FormatNumber(cast(abs(STT) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(STT as varchar(8000)),''N'')  end as STT'
							if(Abs(@GrandTotal_TranCharge)>0.00)
								Set @DSql=@DSql+',case when isnull(TranCharge,0)=0 then NULL  when TranCharge<0 then ''-''+dbo.fn_FormatNumber(cast(abs(TranCharge) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(TranCharge as varchar(8000)),''N'')  end as TranCharge'
							if(Abs(@GrandTotal_StampDuty)>0.00)
								Set @DSql=@DSql+',case when isnull(StampDuty,0)=0 then NULL  when StampDuty<0 then ''-''+dbo.fn_FormatNumber(cast(abs(StampDuty) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(StampDuty as varchar(8000)),''N'')  end as StampDuty'
							if(Abs(@GrandTotal_DlvCharge)>0.00)
								Set @DSql=@DSql+',case when isnull(DlvCharge,0)=0 then NULL  when DlvCharge<0 then ''-''+dbo.fn_FormatNumber(cast(abs(DlvCharge) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(DlvCharge as varchar(8000)),''N'')  end as DlvCharge'
							if(Abs(@GrandTotal_SebiFee)>0.00)
								Set @DSql=@DSql+',case when isnull(SebiFee,0)=0 then NULL  when SebiFee<0 then ''-''+dbo.fn_FormatNumber(cast(abs(SebiFee) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(SebiFee as varchar(8000)),''N'')  end as SebiFee'
							if(Abs(@GrandTotal_OtherCharge)>0.00)
								Set @DSql=@DSql+',case when isnull(OtherCharge,0)=0 then NULL  when OtherCharge<0 then ''-''+dbo.fn_FormatNumber(cast(abs(OtherCharge) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(OtherCharge as varchar(8000)),''N'')  end as OtherCharge'
							if(Abs(@GrandTotal_ServTax)>0.00)
								Set @DSql=@DSql+',case when isnull(ServTax,0)=0 then NULL  when ServTax<0 then ''-''+dbo.fn_FormatNumber(cast(abs(ServTax) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(ServTax as varchar(8000)),''N'')  end as ServTax'
							if(Abs(@GrandTotal_NetBillAmount)>0.00)
								Set @DSql=@DSql+',case when isnull(NetBillAmount,0)=0 then NULL  when NetBillAmount<0 then ''-''+dbo.fn_FormatNumber(cast(abs(NetBillAmount) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(NetBillAmount as varchar(8000)),''N'')  end as NetBillAmount'
							if(Abs(@GrandTotal_Turnover)>0.00)
								Set @DSql=@DSql+',case when isnull(Turnover,0)=0 then NULL  when Turnover<0 then ''-''+dbo.fn_FormatNumber(cast(abs(Turnover) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(Turnover as varchar(8000)),''N'')  end as Turnover'
							if(Abs(@GrandTotal_TotalBrokerage)>0.00)
								Set @DSql=@DSql+',case when isnull(TotalBrokerage,0)=0 then NULL  when TotalBrokerage<0 then ''-''+dbo.fn_FormatNumber(cast(abs(TotalBrokerage) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(TotalBrokerage as varchar(8000)),''N'')  end as TotalBrokerage'
							if(Abs(@GrandTotal_UnrealizedServTax)>0.00)
								Set @DSql=@DSql+',case when isnull(UnrealizedServTax,0)=0 then NULL  when UnrealizedServTax<0 then ''-''+dbo.fn_FormatNumber(cast(abs(UnrealizedServTax) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(UnrealizedServTax as varchar(8000)),''N'')  end as UnrealizedServTax'
							if(Abs(@GrandTotal_UnrealizedSTT)>0.00)
								Set @DSql=@DSql+',case when isnull(UnrealizedSTT,0)=0 then NULL  when UnrealizedSTT<0 then ''-''+dbo.fn_FormatNumber(cast(abs(UnrealizedSTT) as varchar(8000)),''N'') else dbo.fn_FormatNumber(cast(UnrealizedSTT as varchar(8000)),''N'')  end as UnrealizedSTT'				
																																					
							Set @DSql=@DSql+' From #DisplayResult'-- Order By StatusOrder'
						
							IF(@ReportBy='E')
								Begin										
										Execute sp_sqlexec @DSql
								End
							Else IF(@ReportBy='S')
								Begin
										set @DSql='Select *	 INTO #Results FROM ('+ @DSql+') t1														 									 
													 
													 SELECT * From #Results
													 WHERE AutoID BETWEEN ('+@PageNumber+' -1) * '+@PageSize+' + 1  AND ((( '+@PageNumber+' -1) * '+@PageSize+' + 1) + '+@PageSize+') - 1 
													 
													 Select case 
																when COUNT(*)%'+@PageSize+'>0 then Count(*)/'+@PageSize+'+1 
																							  else Count(*)/'+@PageSize+' 
																end as [PageCount] From #DisplayResult	
													 Select * From #Results Where Client=''***Grand Total''											
													 '													
										Execute sp_sqlexec @DSql
								End	
					End
					----Client End

				----Delete Temporary Tables--------
				Drop Table #DistinctBranchID
				Drop Table #DistinctGroupID  
				Drop Table #DistinctCustomerID 
				Drop Table #DistinctTrdDate 
				Drop Table #DisplayTable	
				Drop Table #DisplayResult	
				
		End
End